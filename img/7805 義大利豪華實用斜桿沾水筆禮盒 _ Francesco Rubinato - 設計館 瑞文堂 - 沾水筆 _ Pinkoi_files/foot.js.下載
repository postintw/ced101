var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};var _slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break}}catch(err){_d=true;_e=err}finally{try{if(!_n&&_i["return"])_i["return"]()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr)){return arr}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i)}else{throw new TypeError("Invalid attempt to destructure non-iterable instance")}}}();var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true})}else{obj[key]=value}return obj}function _toConsumableArray(arr){if(Array.isArray(arr)){for(var i=0,arr2=Array(arr.length);i<arr.length;i++){arr2[i]=arr[i]}return arr2}else{return Array.from(arr)}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}function _possibleConstructorReturn(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return call&&(typeof call==="object"||typeof call==="function")?call:self}function _inherits(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass)}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass}define("dom/doc",function(require,exports){"use strict";var getScrollingBody=function(){return document.scrollingElement||(Modernizr.webkit?document.body:document.documentElement)};var getScrollTop=function(){return getScrollingBody().scrollTop};var lockBodyScroll=function(doLock){var body=$(getScrollingBody());body[doLock?"addClass":"removeClass"]("s-locked")};exports.getScrollingBody=getScrollingBody;exports.getScrollTop=getScrollTop;exports.lockBodyScroll=lockBodyScroll});define("dom/form",function(require,exports){"use strict";var _=require("underscore");var alertModal=require("ui/notification/alertModal");var NO_MULTIPLE_FILE="not support multiple file upload yet.";var pack=exports.pack=function($form,prefix){var data;if(prefix){data=_.clone(prefix)}else{data={}}if(!_.has($form,"find")){$form=$($form)}$form.find("[name]").each(function(idx,field){var val;if(field.getAttribute("type")==="file"){val=field.files;if(!field.getAttribute("multiple")){if(val[0]){val=val[0]}else{return true}}else{alertModal.show(NO_MULTIPLE_FILE)}}else{val=field.value}data[field.getAttribute("name")]=val});return data};var toFormData=exports.toFormData=function(data){var formData=new FormData;var value;for(var key in data){if(data.hasOwnProperty(key)){value=data[key];if(value===null){continue}if((typeof value==="undefined"?"undefined":_typeof(value))==="object"&&value.eq&&value.get){value=value.get(0)}if(_.isElement(value)){if(value.type&&value.type.toLowerCase()=="file"){if(!value.getAttribute("multiple")){if(value.files[0]){value=value.files[0]}else{continue}}else{alertModal.show(NO_MULTIPLE_FILE)}}else{value=value.value}}if(value!==null){formData.append(key,value)}}}return formData};var hasFile=exports.hasFile=function($form){return _.any($form.find('[type="file"]'),function(field){return field.value})};var smartPack=exports.smartPack=function($form,prefix){var data;if(Modernizr.ajaxfileupload&&hasFile($form)){data=toFormData(pack($form,prefix))}else{data=pack($form,prefix)}return data};var smartPost=function(url,data){var deferred;if($.isPlainObject(data)){deferred=$.post(url,data,"json")}else{deferred=$.ajax({url:url,data:data,processData:false,contentType:false,dataType:"json",type:"POST"})}return deferred};exports.post=function(url,$form,prefix){return smartPost(url,smartPack($form,prefix))};exports.validate={file:function(args){var defer=$.Deferred();var hasRuleMinShortSideLen=false;var counter=0;if(typeof args==="undefined"){throw new Error("you need to pass params to form.validate.file method, check the doc")}if(typeof args.files==="undefined"){throw new Error("files is required for form.validate.file method")}var files=args.files;var validFiles=[];var invalidFiles=[];if(!files.length){defer.resolve({files:files,validFiles:files,invalidFiles:files})}var allowedFileTypes={"image/jpeg":"jpg","image/png":"png","image/gif":"gif"};var rules=_.extend({sizeInMB:10,types:args.$fileInput.attr("accept")||".jpg,.png,.gif"},args.rules);var resolveFilesIfAllDone=function(counter,i){var file=files[i];if(file.isSizeValid!==false&&file.isTypeValid!==false&&(file.isShortSideLenValid!==undefined?file.isShortSideLenValid:true)){validFiles.push(file)}else{invalidFiles.push(file)}if(counter===files.length){defer.resolve({files:files,validFiles:validFiles,invalidFiles:invalidFiles})}};var validImageSideLength=function(i){var url=URL.createObjectURL(files[i]);var isShortSideLenValid=false;var img=new Image;img.onload=function(){if(hasRuleMinShortSideLen&&(img.width>=rules.minShortSideLen||img.height>=rules.minShortSideLen)){isShortSideLenValid=true}files[i].isShortSideLenValid=isShortSideLenValid;files[i].width=img.width;files[i].height=img.height;URL.revokeObjectURL(img.src);counter++;resolveFilesIfAllDone(counter,i)};img.src=url};if(rules.minShortSideLen!==undefined&&!isNaN(parseInt(rules.minShortSideLen,10))){if(typeof rules.minShortSideLen==="string"){rules.minShortSideLen=parseInt(rules.minShortSideLen,10)}if(rules.minShortSideLen>0){hasRuleMinShortSideLen=true}else{throw new Error("rule of hasRuleMinShortSideLen should be over 0")}}if(rules.sizeInMB!==undefined&&!isNaN(parseInt(rules.sizeInMB,10))){if(typeof rules.sizeInMB==="string"){rules.sizeInMB=parseInt(rules.sizeInMB,10)}if(rules.sizeInMB<0){throw new Error("rule of hasRuleMinShortSideLen should be over 0")}rules.size=rules.sizeInMB*Math.pow(1024,2)}rules.types=rules.types.replace(/\./gi,"").split(",");(function(){for(var i=0;i<files.length;i++){var fileType=allowedFileTypes[files[i].type];files[i].isSizeValid=files[i].size<rules.size;files[i].isTypeValid=_.contains(rules.types,fileType);if(Modernizr.filereader&&hasRuleMinShortSideLen){if(!files[i].isTypeValid){counter++;resolveFilesIfAllDone(counter,i)}else{validImageSideLength(i)}}else{counter++;resolveFilesIfAllDone(counter,i)}}})();return defer}}});define("dom/lazy",function(require,exports){"use strict";var _=require("underscore");var settings=require("settings");var Inviewport=require("ui/Inviewport");var rAF=require("ui/requestAnimation");var url=require("app/modules/url");var _sT;var delay=settings.get("mobile")?300:400;var findLazies=function(scopeEl){var _scopeEl=scopeEl;if(scopeEl===window){scopeEl=document.body}if(_scopeEl.$lazyEls){_scopeEl.$lazyEls=_scopeEl.$lazyEls.filter(".m-dom-lazy");return _scopeEl.$lazyEls}var $scopeEl=$(scopeEl);var $els=$scopeEl.find(".m-dom-lazy");if($els.length<=16){_scopeEl.$lazyEls=$els}return $els};var isShown=function(scrollEl,el,direction,buffer){var scrollTop;buffer=buffer||settings.get("mobile")&&direction!=="x"?window.innerHeight:200;scrollEl=scrollEl||window;if(direction==="x"){if(scrollEl===window){var scrollLeft=document.documentElement&&document.documentElement.scrollLeft||document.body.scrollLeft;var containerWidth=document.documentElement.clientWidth}else{var scrollLeft=scrollEl.scrollLeft;var containerWidth=scrollEl.offsetWidth}var eleLeft=0;var tempEl=el;while(1){eleLeft+=tempEl.offsetLeft;tempEl=tempEl.offsetParent;if(!tempEl||tempEl===scrollEl){break}}if(eleLeft<scrollLeft+containerWidth+buffer){return true}}else{if(scrollEl===window){scrollTop=_sT;var containerHeight=document.documentElement.clientHeight}else{scrollTop=scrollEl.scrollTop;var containerHeight=scrollEl.offsetHeight}var eleTop=0;var tempEl=el;while(1){eleTop+=tempEl.offsetTop;tempEl=tempEl.offsetParent;if(!tempEl||tempEl===scrollEl){break}}if(eleTop<scrollTop+containerHeight+buffer){return true}}return false};var check=function(scrollEl,scopeEl,direction,buffer){var $scrollEl=$(scrollEl);var stopit=false;var $lazyEls=findLazies(scopeEl);var sT=document.body.scrollTop||document.documentElement.scrollTop;var tasks=[];_sT=sT;if($lazyEls.length){$lazyEls.filter('[data-type="avatar"]').on("error",function(e){e.target.src=url.getFallbackAvator(e.target.getAttribute("data-id"))});$lazyEls.each(function(i,el){var elTop=$(el).offset().top;var elBottom=$(el).offset().top+$(el).height();if(elTop>sT-buffer||elBottom>sT){if(isShown(scrollEl,el,direction,buffer)){var $el=$(el);var tidSrc=$el.data("tid-src-160");var src=tidSrc?url.getItemImg(tidSrc,"160x160",{rev:$el.data("irev")}):$el.data("src");var alt=$el.data("alt");var bgSrc=$el.data("bg-src");var bgSrcs=[];$el.removeClass("m-dom-lazy");if(src){tasks.push(function(){$el.attr("src",src);if(alt){$el.attr("alt",alt)}})}if(bgSrc){if(/,/i.test(bgSrc)){bgSrcs=bgSrc.split(",");$el.css("background-image",_.map(bgSrcs,function(src){return"url("+src+")"}).join(", "))}else{tasks.push(function(){if(bgSrc.indexOf("url")<0){bgSrc="url("+bgSrc+")"}$el.css("background-image",bgSrc)})}}}else if(scrollEl.lazyStopImmediateCheck||direction==="x"){return false}}});rAF(function(){for(var i=0;i<tasks.length;i++){tasks[i]()}})}else{stopit=true}if(stopit){$scrollEl.off("scroll.domlazy"+scopeEl.lazyId);scrollEl.$lazyEls=null;scopeEl.lazyId=null}};var on=function(scrollEl,scopeEl,direction,buffer){if(settings.get("mobile")){$(scrollEl).on("scroll.domlazy"+scopeEl.lazyId,_.throttle(function(){check(scrollEl,scopeEl,direction,buffer)},direction==="x"?200:delay))}else{$(scrollEl).on("scroll.domlazy"+scopeEl.lazyId,_.throttle(function(){check(scrollEl,scopeEl,direction,buffer)},delay))}if(scopeEl===window||scopeEl!==window&&$(document).find(scopeEl).length){check(scrollEl,scopeEl,direction,buffer)}else{setTimeout(function(){check(scrollEl,scopeEl,direction,buffer)})}};var listen=function(opt_args){opt_args=opt_args||{};opt_args.buffer=opt_args.buffer||settings.get("mobile")&&opt_args.direction!=="x"?window.innerHeight:200;opt_args.scrollbody=opt_args.scrollbody||window;opt_args.direction=opt_args.direction||"y";if(opt_args.delay){delay=opt_args.delay}var scrollEl=$(opt_args.scrollEl).get(0)||window;var scopeEl=$(opt_args.scopeEl).get(0)||scrollEl;scrollEl.lazyStopImmediateCheck=opt_args.stopImmediateCheck;var id=_.uniqueId();if(scopeEl.lazyId){$(scrollEl).off("scroll.domlazy"+scopeEl.lazyId)}scopeEl.lazyId=id;scrollEl.$lazyEls=null;if(scrollEl===window){on(scrollEl,scopeEl,opt_args.direction,opt_args.buffer)}else{new Inviewport({el:scrollEl,buffer:opt_args.buffer,scrollbody:opt_args.scrollbody,cb:function(){on(scrollEl,scopeEl,opt_args.direction,opt_args.buffer)}})}};exports.listen=listen});define("storage/local",function(require,exports){"use strict";var cookie=require("net/cookie");var fallback=!window.localStorage;if(!fallback){if(Modernizr.webkit&&!Modernizr.chrome){try{localStorage.setItem("testSafariLocalstorage",1);if(!localStorage.getItem("testSafariLocalstorage")){fallback=true}else{localStorage.removeItem("testSafariLocalstorage")}}catch(e){fallback=true}}}var expired={};function parseSeconds(expiredIn){if(typeof expiredIn==="string"){var unit=expiredIn.substr(expiredIn.length-1,1);expiredIn=parseInt(expiredIn);switch(unit){case"S":break;case"M":expiredIn*=60;break;case"H":expiredIn*=60*60;break;case"d":expiredIn*=24*60*60;break;case"m":expiredIn*=30*24*60*60;break;case"y":expiredIn*=365*24*60*60;break;default:throw new Error("The unit of `expiredIn` parameter is not allowed.")}}return expiredIn}var set=function(key,value,opt_expiredIn){if(fallback){key="localStorage_"+key;cookie.set(key,escape(JSON.stringify(value)),opt_expiredIn?parseSeconds(opt_expiredIn):parseSeconds("1y"))}else{try{localStorage.setItem(key,JSON.stringify(value))}catch(e){fallback=true;key="localStorage_"+key;cookie.set(key,escape(JSON.stringify(value)))}}if(opt_expiredIn){opt_expiredIn=parseSeconds(opt_expiredIn);var now=(new Date).getTime();expired[key]=now+opt_expiredIn*1e3;set("_expired",expired)}};var del=function(key){if(fallback){key="localStorage_"+key;cookie.del(key)}else{localStorage.removeItem(key)}if(key in expired){delete expired[key];set("_expired",expired)}};var get=function(key,opt_default){if(key in expired){var now=(new Date).getTime();if(now>expired[key]){del(key);return undefined}}if(fallback){key="localStorage_"+key;var item=cookie.get(key);if(item){item=unescape(item)}}else{var item=localStorage.getItem(key)}if(!item){return typeof opt_default==="undefined"?null:opt_default}if(item==="undefined"){return undefined}if(window.JSON){return JSON.parse(item)}else{return $.parseJSON(item)}};var delOn=function(key,evts){var _delon=get("_delon")||{};if($.type(evts)==="string"){evts=[evts]}for(var i=0,l=evts.length;i<l;++i){var evt=evts[i];if(!_delon[evt]){_delon[evt]=[]}if($.inArray(evt,_delon[evt])===-1){_delon[evt].push(key)}}set("_delon",_delon)};var doDelOn=function(delevt){var _delon=get("_delon")||{};for(var evt in _delon){if(_delon.hasOwnProperty(evt)){if(evt===delevt){for(var i=0,l=_delon[evt].length;i<l;++i){del(_delon[evt][i])}delete _delon[evt]}}}set("_delon",_delon)};var clear=function(){var args=Array.prototype.slice.call(arguments);if(args.length){for(var i=0,l=args.length;i<l;++i){del(args[i])}}else{localStorage.clear()}};expired=get("_expired")||{};exports.get=get;exports.set=set;exports.del=del;exports.clear=clear;exports.delOn=delOn;exports.doDelOn=doDelOn;return exports});define("storage/session",function(require,exports){"use strict";var cookie=require("net/cookie");var fallback=!window.localStorage;if(!fallback){if(Modernizr.webkit&&!Modernizr.chrome){try{sessionStorage.setItem("testSafariSessionStorage",1);if(!sessionStorage.getItem("testSafariSessionStorage")){fallback=true}else{sessionStorage.removeItem("testSafariSessionStorage")}}catch(e){fallback=true}}}var expired={};function parseSeconds(expiredIn){if(typeof expiredIn==="string"){var unit=expiredIn.substr(expiredIn.length-1,1);expiredIn=parseInt(expiredIn);switch(unit){case"S":break;case"M":expiredIn*=60;break;case"H":expiredIn*=60*60;break;case"d":expiredIn*=24*60*60;break;case"m":expiredIn*=30*24*60*60;break;case"y":expiredIn*=365*24*60*60;break;default:throw new Error("The unit of `expiredIn` parameter is not allowed.")}}return expiredIn}var set=function(key,value){if(fallback){key="sessionStorage_"+key;cookie.set(key,escape(JSON.stringify(value)),parseSeconds("30m"))}else{try{sessionStorage.setItem(key,JSON.stringify(value))}catch(e){fallback=true;key="sessionStorage_"+key;cookie.set(key,escape(JSON.stringify(value)))}}};var del=function(key){if(fallback){key="sessionStorage_"+key;cookie.del(key)}else{sessionStorage.removeItem(key)}if(key in expired){delete expired[key];set("_expired",expired)}};var get=function(key,opt_default){if(key in expired){var now=(new Date).getTime();if(now>expired[key]){del(key);return undefined}}if(fallback){key="localStorage_"+key;var item=cookie.get(key);if(item){item=unescape(item)}}else{var item=sessionStorage.getItem(key)}if(!item){return typeof opt_default==="undefined"?null:opt_default}if(item==="undefined"){return undefined}if(window.JSON){return JSON.parse(item)}else{return $.parseJSON(item)}};expired=get("_expired")||{};exports.get=get;exports.set=set;return exports});define("css/styleSheets",function(require,exports){"use strict";var vendor=require("css/vendor");function insertRule(selector,prop,value){prop=vendor.css(prop);var cssRules;var existed=false;for(var i=0;i<document.styleSheets.length;i++){if(document.styleSheets[i].href&&document.styleSheets[i].href.indexOf("http")===0){if(document.styleSheets[i].href.indexOf(document.domain)===-1){continue}}if(document.styleSheets[i]["cssRules"]){cssRules="cssRules"}else if(document.styleSheets[i]["rules"]){cssRules="rules"}else{break}for(var j=0;j<document.styleSheets[i][cssRules].length;j++){if(document.styleSheets[i][cssRules][j].selectorText===selector){if(document.styleSheets[i][cssRules][j].style[prop]){document.styleSheets[i][cssRules][j].style[prop]=value;existed=true;break}}}if(!existed){if(document.styleSheets[i].insertRule){document.styleSheets[i].insertRule(selector+" {"+prop+": "+value+";}",document.styleSheets[i][cssRules].length)}else if(document.styleSheets[i].addRule){document.styleSheets[i].addRule(selector,prop+":"+value+";")}}}}exports.insertRule=insertRule});define("css/transitionend",function(require){"use strict";var _=require("underscore");var transitionPrefixed=null;var eventNames=["transitionend","transitionEnd","oTransitionEnd","webkitTransitionEnd","WebkitTransitionEnd","-webkit-transitionend","MSTransitionEnd"];var getTransitionendNames=function(){var d=$.Deferred();var r=d.then(function(p){return p});var $test=$('<div id="css-transitionend"></div>').appendTo(document.body);$test.css("height","0");$test.css("opacity","0");$test.css("transition","all 0.2s linear");$test.css("-webkit-transition","all 0.2s linear");$test.one(eventNames.join(" "),function(e){d.resolve(e.type);$test.remove()});$test.width();$test.css("height","1px");$test.css("opacity","1");return r};var getPrefix=getTransitionendNames();function transitionend($el,cb){var bind=function(){var isExecuted=false;var duration=$el.css("transition-duration");if(!Boolean(duration)||duration==="0s"){if(!isExecuted){isExecuted=true;cb()}}$el.one(transitionPrefixed,function(){if(!isExecuted){isExecuted=true;cb()}});if(Modernizr.webkit){return}if(duration){duration=duration.split(",");duration=parseFloat(_.max(duration,function(time){return parseFloat(time)}))*1e3;if(_.isNumber(duration)){setTimeout(function(){if(!isExecuted){isExecuted=true;cb()}},duration)}}};if(Modernizr.csstransitions){if(transitionPrefixed===null){getPrefix.done(function(p){transitionPrefixed=p;bind();getPrefix=null})}else{bind()}}else{cb()}}return transitionend});define("css/vendor",function(require,exports){var _=require("underscore");exports.dom=function(prop){return Modernizr.prefixed(prop)};exports.css=function(prop){return Modernizr.prefixed(prop.replace(/-([A-Za-z])/g,function(str,m1){return m1.toUpperCase()})).replace(/([A-Z])/g,function(str,m1){return"-"+m1.toLowerCase()}).replace(/^ms-/,"-ms-")};exports.convertCSSObj=function(styleObj){var _obj=_.clone(styleObj);_.map(_obj,function(prop,key){if(key=="transition"||key=="transform"){_.map(["-webkit-","-ms-","-o-"],function(prefix){_obj[prefix+key]=_obj[key]})}});return _obj}});define("ui/react/Inviewport",function(require){"use strict";var React=require("React");var _require=require("utils/Lazy"),LazyLoad=_require.LazyLoad;var Inviewport=function(props){var onVisible=props.onVisible,lazyContainer=props.lazyContainer,debug=props.debug;var debugClass=debug?"s-debug":"";var placeholder=React.createElement("span",{className:"inner"});return React.createElement("span",{className:"g-viewport-ref-line "+debugClass},React.createElement(LazyLoad,{width:"100%",offset:0,throttle:120,placeholder:placeholder,lazyContainer:lazyContainer,onVisible:onVisible},React.createElement("span",{className:"inner"})))};return Inviewport});define("ui/LazyImg",function(require){"use strict";var React=require("React");var _require2=require("utils/Lazy"),LazyLoad=_require2.LazyLoad;var _=require("underscore");var classNames=require("classnames");var settings=require("settings");var supportLoading=settings.get("browserLoading");return function LazyImg(props){var placeholder=React.createElement("img",{alt:"space",height:"auto",src:"//cdn04.pinkoi.com/pinkoi.site/space.gif",className:"img"});var lazyContainer=props.lazyContainer,className=props.className,offset=props.offset;var _React$useState=React.useState(false),_React$useState2=_slicedToArray(_React$useState,2),isLoaded=_React$useState2[0],setLoaded=_React$useState2[1];var lazyLoadProps={width:"100%",offset:offset||[0,200],lazyContainer:lazyContainer};if(!Modernizr.ie||!props.objectfit){lazyLoadProps.placeholder=placeholder}var imgProps=_.omit(props,"objectfit","lazyContainer","className");if(supportLoading){return React.createElement("img",_extends({className:classNames(className,{"g-lazy-fadein":isLoaded})},imgProps,{loading:"lazy",style:!isLoaded?{opacity:0}:null,onLoad:function(){setLoaded(true)}}))}return React.createElement(LazyLoad,lazyLoadProps,React.createElement("img",_extends({className:classNames(className,{"g-lazy-fadein":isLoaded})},imgProps,{style:!isLoaded?{opacity:0}:null,onLoad:function(){setLoaded(true)}})))}});define("ui/autoplay",function(require){"use strict";var _=require("underscore");var rAF=require("ui/requestAnimation");var rAFCancel=function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame||window.oCancelAnimationFrame||function(requestID){clearTimeout(requestID)}}();var Autoplay=function(config){var _config=_.extend({isLoops:true,duration:5e3,onDuration:null,onEnd:null,updateFreq:0,isEndSync:false},config);var _this={requestID:null,isPlay:false,forceEnd:false,state:{start:null,end:null,progress:0,lastUpdateTime:null,lastTime:null}};function timer(timestamp){if(!_this){return}var _state=_this.state;var _lastUpdateTime=_state.lastUpdateTime;if(!_state.start){_state.start=timestamp;_state.end=timestamp+_config.duration}_state.lastTime=timestamp;_this.requestID=rAF(timer);if(_this.isPlay){_state.progress=_config.duration-_state.end+timestamp}if(_this.isPlay&&!_this.forceEnd&&(!_lastUpdateTime||timestamp-_lastUpdateTime>=_config.updateFreq)){var prevUpdateTime=_lastUpdateTime?_lastUpdateTime:timestamp;_config.onDuration&&_config.onDuration(_state.progress?_state.progress/_config.duration:0,prevUpdateTime,timestamp);_state.lastUpdateTime=timestamp;if(_state.progress/_config.duration>1){_this.forceEnd=true}}else if(_this.isPlay&&_this.forceEnd&&timestamp-_lastUpdateTime>=_config.updateFreq){if(_config.isEndSync){_this.stop();_config.onEnd&&_config.onEnd().done(function(){_this.play()})}else{_this.stop();_config.onEnd&&_config.onEnd();_this.play()}}}_this.play=function(){var _state=_this.state;if(_this.isPlay){return}if(_state.end){_state.end=_state.lastTime+(_config.duration-_state.progress)}_this.isPlay=true;if(!_this.requestID){rAF(timer)}};_this.pause=function(){if(!_this.isPlay){return}_this.isPlay=false};_this.stop=function(){rAFCancel(_this.requestID);_this.isPlay=false;_this.requestID=null;_this.forceEnd=false;_this.reset()};_this.reset=function(){_this.state={start:null,end:null,progress:0,lastUpdateTime:null,lastTime:null}};return _this};return Autoplay});define("ui/backdrop",function(require,exports,model){"use strict";var transitionend=require("css/transitionend");var $backdrop=$('<div class="m-backdrop" style="display:none;"></div>');var isShown=false;var inShowing=false;var inHiding=false;var taskQueue=[];var loopId;function runQueuedTask(){if(!taskQueue.length){clearInterval(loopId);loopId=null;return}if(inShowing||inHiding){return}var task=taskQueue.shift();exports[task[0]](task[1])}function queueTask(task){taskQueue.push(task);if(!loopId){loopId=setInterval(runQueuedTask,10)}}exports.show=function(opt_args){opt_args=opt_args||{};if(isShown){return}isShown=true;if(inHiding||inShowing){queueTask(["show",opt_args]);return}if(!$backdrop.parent().length){$backdrop.appendTo(document.body)}inShowing=true;transitionend($backdrop,function(){inShowing=false});$backdrop.attr("class",opt_args.className?"m-backdrop "+opt_args.className:"m-backdrop");$backdrop[opt_args.loader?"addClass":"removeClass"]("with-loader");$backdrop.show();$backdrop.width();$backdrop.css({opacity:1});if(opt_args.isBlack){$backdrop.addClass("m-backdrop-black");$backdrop.css({opacity:.5})}if(opt_args.anywhereHide){$backdrop.one("click",function(){exports.hide()})}if(Modernizr.ios){$backdrop.on("touchmove",function(e){e.preventDefault()},false)}return exports};exports.hide=function(){exports.revertVeryTop();if(inShowing||inHiding){queueTask(["hide"]);return}inHiding=true;transitionend($backdrop,function(){isShown=false;inHiding=false;$backdrop.remove()});$backdrop.css({opacity:0}).off(".uibackdrop");$backdrop.width();if(!isShown){$backdrop.remove()}return exports};exports.toVeryTop=function(){$backdrop.addClass("m-backdrop-verytop")};exports.revertVeryTop=function(){$backdrop.removeClass("m-backdrop-verytop")};exports.onclick=function(cb){$backdrop.on("click.uibackdrop",function(evt){cb()});return exports};exports.isVisible=function(){return isShown}});define("ui/carousel",function(require,exports){"use strict";var _=require("underscore");var exports={};var carousel={};var rotate=function(carousel){};exports.add=function(container,itemEl,el){var cell=$(el);if(container.find(itemEl).length>0){container.find(itemEl+":first-child").before(cell)}else{container.removeClass("empty").html("");var clip=$('<div class="m-carousel-clip"></div>');var holder=$('<div class="m-carousel-holder"></div>');container.append(clip);clip.append(holder);holder.html(cell);return}var $holder=container.find(".m-carousel-holder");var $clip=container.find(".m-carousel-clip");var clipW=$clip.width();carousel[id].$lastItem=$holder.children().last();carousel[id].lastItemW=carousel[id].$lastItem.outerWidth();carousel[id].lastItemLeft=carousel[id].$lastItem.position().left;carousel[id].totalPage=Math.ceil((carousel[id].lastItemLeft+carousel[id].lastItemW)/clipW);carousel[id].page=2;container.find(".m-carousel-prev").trigger("click")};exports.render=function(container,itemEl,opt_arg){opt_arg=opt_arg?opt_arg:{};var id=_.uniqueId("c");carousel[id]={};carousel[id].$lastItem=null;carousel[id].lastItemW=null;carousel[id].lastItemLeft=null;carousel[id].page=1;carousel[id].totalPage=1;carousel[id].frozen=false;carousel[id].$carousel=container;if(carousel[id].$carousel.find(itemEl).length){var $holder=carousel[id].$carousel.find(".m-carousel-holder");var $prev=$('<div class="m-carousel-prev s-disabled" data-action="m-carousel-prev"></div>');var $next=$('<div class="m-carousel-next" data-action="m-carousel-next"></div>');var $clip=container.find(".m-carousel-clip");var clipW=$clip.width();var mouseOn=false;var timeInterval=1e6;var childrenPerPage=opt_arg.perpage?opt_arg.perpage:4;var height=carousel[id].$carousel.height();carousel[id].$lastItem=$holder.children().last();carousel[id].lastItemW=carousel[id].$lastItem.outerWidth();carousel[id].lastItemLeft=carousel[id].$lastItem.position().left;carousel[id].page=1;carousel[id].totalItem=$clip.find(".cell").length;carousel[id].totalPage=Math.round((carousel[id].lastItemLeft+carousel[id].lastItemW)/clipW);if(carousel[id].totalPage<2){$next.addClass("s-disabled")}if(opt_arg.startAt&&opt_arg.startAt>1){carousel[id].page=opt_arg.startAt;var gotoPage=carousel[id].page;gotoPage=gotoPage>carousel[id].totalPage?carousel[id].totalPage:gotoPage;var $lastChild=$holder.children().eq((gotoPage-1)*childrenPerPage);_.delay(function(){$holder.animate({left:-$lastChild.position().left},1e3);if(carousel[id].page===carousel[id].totalPage){$next.removeClass("s-disabled")}else{$prev.removeClass("s-disabled")}},1)}carousel[id].$carousel.on("auto."+id+" resume."+id,function(evt){setTimeout(function(){if(mouseOn){return}var $target=$(this);var action=$target.data("action");var gotoPage=carousel[id].page+1;var $lastChild;gotoPage=gotoPage>carousel[id].totalPage?carousel[id].totalPage:gotoPage;$lastChild=$holder.children().eq((gotoPage-1)*childrenPerPage);carousel[id].page=gotoPage;try{$holder.animate({left:-$lastChild.position().left},1e3)}catch(e){}$prev.removeClass("s-disabled");if(carousel[id].totalPage===1){$next.addClass("s-disabled")}if(carousel[id].page===1){$prev.addClass("s-disabled");$next.removeClass("s-disabled");carousel[id].$carousel.trigger("auto")}else if(carousel[id].page===carousel[id].totalPage){carousel[id].page=0;$next.addClass("s-disabled");carousel[id].$carousel.trigger("auto")}else if(carousel[id].page!==1){carousel[id].$carousel.trigger("auto")}},timeInterval)});carousel[id].$carousel.addClass("m-carousel");$holder.css("position","relative");carousel[id].$carousel.append($prev);carousel[id].$carousel.append($next);$prev.css("top",121);$next.css("top",121);if(carousel[id].totalItem>childrenPerPage){carousel[id].$carousel.trigger("auto")}carousel[id].$carousel.on("mouseenter",function(){mouseOn=true});carousel[id].$carousel.on("mouseleave",function(){if(carousel[id].frozen){return}carousel[id].frozen=true;setTimeout(function(){carousel[id].$carousel.trigger("resume");mouseOn=false;carousel[id].frozen=false},5e3)});carousel[id].$carousel.on("click."+id,"[data-action]",function(evt){var $target=$(this);var action=$target.data("action");var gotoPage;switch(action){case"m-carousel-prev":gotoPage=carousel[id].page-1;gotoPage=gotoPage<1?1:gotoPage;break;case"m-carousel-next":gotoPage=carousel[id].page+1;gotoPage=gotoPage>carousel[id].totalPage?carousel[id].totalPage:gotoPage;break}var $lastChild=$holder.children().eq((gotoPage-1)*childrenPerPage);if(!$lastChild.length){return}carousel[id].page=gotoPage;if($lastChild!==null){$holder.animate({left:-$lastChild.position().left},400)}$prev.removeClass("s-disabled");$next.removeClass("s-disabled");if(carousel[id].page===1){$prev.addClass("s-disabled")}if(carousel[id].totalPage===1||carousel[id].page===carousel[id].totalPage){$next.addClass("s-disabled")}})}};return exports});define("ui/copy",function(require,exports){"use strict";var bar=require("ui/notification/bar");var $textarea=$('<textarea style="position: relative; left: -100px; height: 0px; width: 0px;"></textarea>');$("body").append($textarea);var copy=exports.copy=function($e){$textarea.val($e.val()||$e.text()).select();try{if(document.execCommand("copy")){return true}}catch(err){}return false};var select=exports.select=function($e){var e=$e.get(0);var range;var selection;if(window.getSelection){range=document.createRange();selection=window.getSelection();range.selectNodeContents(e);selection.removeAllRanges();selection.addRange(range);return true}if(document.body.createTextRange){range=document.body.createTextRange();range.moveToElementText(e);range.select();return true}return false};var copyOrSelect=exports.copyOrSelect=function($e){if(copy($e)){return"copy"}else if(select($e)){return"select"}return""};exports.copyOrSelectAndBarPrompt=function($e,text){var methodName=copyOrSelect($e);if(methodName==="select"){bar.show(text)}return methodName}});define("ui/coverflow",function(require,exports){"use strict";var _=require("underscore");require("libs/jquery.mousewheel");var coverflow={current:0,link:false,scrollBuffer:false,isClick:false};coverflow.scrollHandler=function(e,$queue){if(coverflow.scrollBuffer){coverflow.scrollBuffer=false;return}coverflow.scrollBuffer=true;var left=e.target.scrollLeft,itemW=coverflow.itemW,order;if(!coverflow.isClick&&Math.abs(left-coverflow.scrollLeft)<coverflow.itemW/3){return}if(left>coverflow.scrollLeft){
order=Math.ceil(itemW?left/itemW:0)}else{order=Math.floor(itemW?left/itemW:0)}order=order<coverflow.items.length?order:coverflow.items.length-1;$queue.css("left",-(order*itemW)+coverflow.center);if(coverflow.current===order){coverflow.scrollBuffer=false;return}coverflow.scrollLeft=left;coverflow.current=order;for(var i=0;i<coverflow.items.length;i++){var $item=$(coverflow.items[i]);if(i<order){$item.addClass("s-past").removeClass("s-next").removeClass("s-current")}else if(i===order){$item.removeClass("s-past").removeClass("s-next").addClass("s-current");coverflow.link=$(coverflow.items[order]).attr("href")}else{$item.addClass("s-next").removeClass("s-past").removeClass("s-current")}}_.delay(function(){coverflow.scrollBuffer=false;coverflow.isClick=false},100)};exports.init=function($queue,itemSelector,opt){var total,items,$scroller,$wrapper=$('<div class="m-coverflow-wrapper"></div>'),$prev=$('<div class="m-coverflow-btn" data-click="prev"></div>'),$next=$('<div class="m-coverflow-btn" data-click="next"></div>');opt=opt||{};coverflow.items=$queue.find(itemSelector);items=coverflow.items;total=items.length;for(var i=0;i<total;i++){if(!i){coverflow.itemW=$(items[i]).outerWidth();coverflow.wrapperW=$queue.parent().outerWidth();$(items[i]).addClass("m-coverflow-item s-current")}else{$(items[i]).addClass("m-coverflow-item s-next")}}opt.indent=opt.indent?opt.indent:0;coverflow.center=(coverflow.wrapperW-coverflow.itemW)/2+opt.indent;$queue.addClass("m-coverflow").wrap($wrapper).width(coverflow.itemW*total+coverflow.center*2);$scroller=$wrapper.clone().append($queue.clone());$queue.css({left:Modernizr.csstransforms3d?coverflow.center:0});$scroller.addClass("m-coverflow-scroller").insertAfter($queue.parent());$prev.insertAfter($scroller);$next.insertAfter($prev);$scroller.on("scroll",function(e){coverflow.scrollHandler(e,$queue)});$("body").mousewheel(function(e,delta){if(e.target.id===$queue.attr("id")){$scroller.get(0).scrollLeft-=delta*coverflow.itemW;e.preventDefault()}});$prev.on("click",function(e){e.preventDefault();coverflow.isClick=true;if(coverflow.current>0){$scroller.animate({scrollLeft:coverflow.itemW*(coverflow.current-1)},100)}});$next.on("click",function(e){e.preventDefault();coverflow.isClick=true;if(coverflow.current<coverflow.items.length-1){$scroller.animate({scrollLeft:coverflow.itemW*(coverflow.current+1)},100)}});$scroller.on("click",function(e){e.preventDefault();if(coverflow.link){if(opt.ga){dataLayer.push(opt.ga);setTimeout(function(){location.href=coverflow.link},50)}else{location.href=coverflow.link}}});$(items[0]).addClass("m-coverflow-item s-current");$(items[1]).addClass("m-coverflow-item s-next");coverflow.link=$(items[0]).attr("href");if(total>2){$scroller.animate({scrollLeft:coverflow.itemW*(coverflow.current+1)},100)}};return exports});define("ui/cropper",function(require,exports){"use strict";var _=require("underscore");var alertModal=require("ui/notification/alertModal");var Export={};var cropper={};var i18n=require("i18n");cropper.markup=""+'<div class="transformer" style="background-image:url(<%= img.url %>);'+"background-position:<%= trans.left %> <%= trans.top %>;"+'width:<%= img.width %>;height:<%= img.height %>">'+'<img src="<%= img.url %>"/>'+'<span class="drag left top" data-direction="lefttop" draggable="true"></span>'+'<span class="drag right top" data-direction="righttop" draggable="true"></span>'+'<span class="drag left bottom" data-direction="leftbottom" draggable="true"></span>'+'<span class="drag right bottom" data-direction="rightbottom" draggable="true"></span>'+'<div id="transmove" class="transmove" draggable="true"></div>'+"</div>"+'<div id="item" class="item" style="background-image:url(<%= img.url %>);'+"background-position:<%= item.bg.x %> <%= item.bg.y %>;"+'width:<%= item.width %>px;height:<%= item.height %>px;">'+'<span id="itemmove" class="itemmove" draggable="false"></span>'+"</div>";cropper.destroy=function(wrap,el){wrap.unbind("click");this.backdrop.remove();wrap.remove();setTimeout(function(){el.removeClass("in-cropping")},1)};cropper.restore=function(el){var _item=cropper.original_data.item,_trans=cropper.original_data.trans;if(el!==undefined){cropper.el.css({"background-position":_item.bg.x+"px "+_item.bg.y+"px","background-size":_item.bg.width+"px "+_item.bg.height+"px"})}else{cropper.trans.css({top:_trans.top+"px",left:_trans.left+"px",width:_trans.width+"px",height:_trans.height+"px"});cropper.item.css({"background-position":_item.bg.x+"px "+_item.bg.y+"px","background-size":_item.bg.width+"px "+_item.bg.height+"px"})}};cropper.save=function(){var bp=cropper.item.css("background-position"),bs=cropper.item.css("background-size"),width=cropper.imgw,ratio=parseInt(bs.split(" ")[0],10)/width;ratio=Math.round(ratio*100);cropper.el.css("background-position",bp);cropper.el.css("background-size",bs);bp=bp.replace(/px/g,"");bp=bp.split(" ");bp[0]=Math.round(parseInt(bp[0],10));bp[1]=Math.round(parseInt(bp[1],10));bp=bp.join(":");Export.data={backgroundPosition:bp,ratio:ratio};$("body").trigger("cropper-save")};cropper.dragging=function(item,trans,e,ox,oy,imgw,imgh){var x,y,X,Y,minRight=parseInt(item.position().left,10)+parseInt(item.css("width"),10),minBottom=parseInt(item.position().top,10)+parseInt(item.css("height"),10),transBottom=parseInt(trans.position().top,10)+parseInt(trans.css("height"),10),transRight=parseInt(trans.position().left,10)+parseInt(trans.css("width"),10),outOfBound=false;x=e.x;y=e.y;X=x-ox;Y=y-oy;if(Math.abs(e.x-ox)>imgw){outOfBound=true}if(Math.abs(e.y-oy)>imgh){outOfBound=true}var prop="";if(transRight<minRight){prop+="l"}if(transBottom<minBottom){prop+="t"}if($.trim(prop)!==""){e.preventDefault();return}if(!outOfBound){if(Y>0){trans.css("top",0);Y=0}else{trans.css("top",Y)}if(X>0){trans.css("left",0);X=0}else{trans.css("left",X)}item.css("background-position",X+"px "+Y+"px")}};cropper.init=function(wrap,el,data){var drag=$(".drag"),trans=$(".transformer"),transmove=document.getElementById("transmove"),item=$("#item"),iw,ih,bp="background-position",bs="background-size",BORDER=1,ox,oy,dragbuffer,dragstartx,dragstarty,fixedCoordx,fixedCoordy,imgh,imgw,originalImgw,originalImgh,beforeDragImgw,beforeDragImgh,bFirstDrag=true,bFixWidth=false,bFixHeight=false,ratio,brAdjust,_init,loader=new Image,img=$(".transformer img");cropper.trans=trans;cropper.item=item;brAdjust=function(item,el,min,prop){el.addClass("ani");item.addClass("ani");if(el.width()<item.width()||el.height()<item.height()){cropper.restore();return}var itembp=item.css("background-position").split(" "),BORDER=1,adjustLeft=0-(parseInt(el.css("width"),10)-min.right)+BORDER+"px ",adjustTop=0-(parseInt(el.css("height"),10)-min.bottom)+BORDER+"px";if(prop==="lt"){el.css("left",adjustLeft);el.css("top",adjustTop)}else if(prop==="l"){adjustTop=itembp[1];el.css("left",adjustLeft)}else if(prop==="t"){adjustLeft=itembp[0];el.css("top",adjustTop)}item.css("background-position",adjustLeft+adjustTop);setTimeout(function(){el.removeClass("ani");item.removeClass("ani")},200)};_init=function(){var fixWidth,fixHeight;fixWidth=function(){bFixWidth=true;var height=Math.round(imgh*iw/imgw);if(data.item.bg.cover===true){trans.css({width:iw,height:height,top:0-Math.round(height-ih)/2+0,left:0+BORDER});cropper.item.css({"background-size":iw+"px "+height+"px","background-position":"0 "+(0-Math.round(height-ih)/2)+"px"})}cropper.original_data.item.bg.x=0;cropper.original_data.item.bg.y=0-Math.round(height-ih)/2;cropper.original_data.item.bg.width=iw;cropper.original_data.item.bg.height=height;cropper.original_data.trans.width=iw;cropper.original_data.trans.height=height;cropper.original_data.trans.top=0-Math.round(height-ih)/2;cropper.original_data.trans.left=0+BORDER};fixHeight=function(){bFixHeight=true;var width=Math.round(imgw*ih/imgh);if(data.item.bg.cover===true){trans.css({width:width,height:ih,top:0,left:0-(width-iw)/2});cropper.item.css({"background-size":width+"px "+ih+"px","background-position":0-(width-iw)/2+"px "+"0"})}cropper.original_data.item.bg.x=0-(width-iw)/2;cropper.original_data.item.bg.y=0;cropper.original_data.item.bg.width=width;cropper.original_data.item.bg.height=ih;cropper.original_data.trans.width=width;cropper.original_data.trans.height=ih;cropper.original_data.trans.top=0;cropper.original_data.trans.left=0-(width-iw)/2+BORDER};iw=parseInt(cropper.el.css("width"),10);ih=parseInt(cropper.el.css("height"),10);trans.addClass("init");item.addClass("init");$("#cropper").css({top:parseInt(cropper.el.position().top)+BORDER,left:parseInt(cropper.el.position().left)+BORDER});if(data.item.bg.cover===true){cropper.item.css(bs,"cover")}else{cropper.item.css(bp,data.item.bg.x+" "+data.item.bg.y);cropper.item.css(bs,data.item.bg.width+" "+data.item.bg.height);cropper.trans.css({opacity:.3,width:data.item.bg.width,height:data.item.bg.height,top:data.item.bg.y,left:data.item.bg.x})}if(iw>ih){if(imgw>imgh){if(imgw/iw<imgh/ih){fixWidth()}else{fixHeight()}}else{fixWidth()}}else{if(imgw>imgh){fixHeight()}else{if(imgw/iw<imgh/ih){fixWidth()}else{fixHeight()}}}};loader.addEventListener("load",function(e){imgw=e.target.width;imgh=e.target.height;originalImgw=imgw;originalImgh=imgh;cropper.imgw=imgw;ratio=imgw/imgh;_init()});loader.src=img.attr("src");drag.on("dragstart",function(e){trans.addClass("dragging");item.addClass("dragging");trans.removeClass("init");item.removeClass("init");dragbuffer=true;dragstartx=e.originalEvent.x;dragstarty=e.originalEvent.y;beforeDragImgw=parseInt(trans.css("width"),10);beforeDragImgh=parseInt(trans.css("height"),10);e.originalEvent.dataTransfer.effectAllowed="move";fixedCoordx=parseInt(trans.css("left"),10);fixedCoordy=parseInt(trans.css("top"),10)});drag.on("drag",function(e){var ev=e.originalEvent,direction=e.target.getAttribute("data-direction"),x=beforeDragImgw+(ev.x-dragstartx),y=beforeDragImgh+(ev.y-dragstarty),itembp=item.css("background-position"),dw,dh,delta={};if(direction==="lefttop"){x=beforeDragImgw+(dragstartx-ev.x);y=beforeDragImgh+(dragstarty-ev.y)}if(direction==="righttop"){x=beforeDragImgw+(ev.x-dragstartx);if(ev.y-dragstarty>0){y=beforeDragImgh-(ev.y-dragstarty)}else{y=beforeDragImgh+(ev.y-dragstarty)}}if(direction==="leftbottom"){if(ev.x-dragstartx>0){x=beforeDragImgw-(ev.x-dragstartx)}else{x=beforeDragImgw+(ev.x-dragstartx)}y=beforeDragImgh+(ev.y-dragstarty)}dw=Math.abs(x);dh=Math.abs(y);if(ev.x===0&&ev.y===0){return}if(dragbuffer){dragbuffer=false;return}e.stopPropagation();if(dw/dh<ratio){dw=dh*ratio}else{dh=dw*(1/ratio)}if(dw<originalImgw&&dh<originalImgh){imgw=dw;imgh=dh}else{return}item.css(bs,dw+"px "+dh+"px");trans.css({height:dh,width:dw});switch(direction){case"lefttop":if(bFirstDrag&&!bFixWidth){delta.top=-dh-(beforeDragImgh===ih?0:ih)+beforeDragImgh;delta.left=-(dw-beforeDragImgw)}else{delta.top=-dh+beforeDragImgh+fixedCoordy;delta.left=0-(dw-parseInt(beforeDragImgw,10))+fixedCoordx}item.css(bp,delta.left+"px "+delta.top+"px");trans.css({top:delta.top,left:delta.left});break;case"righttop":if(bFirstDrag&&!bFixWidth){delta.top=-dh-(beforeDragImgh===ih?0:ih)+beforeDragImgh;delta.left=-(beforeDragImgw-iw)}else{delta.top=-dh+beforeDragImgh+fixedCoordy;delta.left=fixedCoordx}item.css(bp,delta.left+"px "+delta.top+"px");trans.css({top:delta.top,left:delta.left});break;case"leftbottom":if(bFirstDrag&&!bFixHeight){delta.left=0-parseInt(dw-beforeDragImgw,10)}else{delta.left=0-parseInt(dw-beforeDragImgw,10)+fixedCoordx}item.css(bp,delta.left+"px "+item.css(bp).split(" ")[1]);trans.css({left:delta.left});break;default:if(bFixHeight){itembp=0-(parseInt(itembp[0],10)+trans.position().left)+"px "+(0-(parseInt(itembp[1],10)+trans.position().top))+"px"}else{itembp=0-parseInt(itembp[0],10)+"px "+(0-parseInt(itembp[1],10))+"px"}item.css(bp,itembp);break}});drag.on("dragend",function(e){trans.removeClass("dragging");item.removeClass("dragging");if(bFirstDrag){bFirstDrag=false}var prop="",min={},_trans={};min.left=parseInt(item.position().left,10)+BORDER;min.right=min.left+parseInt(item.css("width"),10)+BORDER;min.top=parseInt(item.position().top,10)+BORDER;min.bottom=min.top+parseInt(item.css("height"),10)+BORDER;_trans.top=parseInt(trans.position().top,10);_trans.bottom=_trans.top+parseInt(trans.css("height"),10);_trans.left=parseInt(trans.position().left,10);_trans.right=_trans.left+parseInt(trans.css("width"),10);e.preventDefault();if(_trans.left>min.left){prop+="r"}if(_trans.top>min.top){prop+="b"}if(_trans.right<min.right){prop+="l"}if(_trans.bottom<min.bottom){prop+="t"}if($.trim(prop)!==""){brAdjust(item,trans,min,prop)}});drag.on("dragover",function(e){e.preventDefault()});transmove.addEventListener("dragstart",function(e){trans.addClass("dragging");item.addClass("dragging");trans.removeClass("init");item.removeClass("init");e.dataTransfer.effectAllowed="move";ox=e.x-trans.position().left;oy=e.y-trans.position().top});transmove.addEventListener("drag",function(e){cropper.dragging(item,trans,e,ox,oy,imgw,imgh)});transmove.addEventListener("dragover",function(e){e.preventDefault()});transmove.addEventListener("dragend",function(e){trans.removeClass("dragging");item.removeClass("dragging");var prop="",min={},transRight,transBottom;min.right=parseInt(item.position().left,10)+parseInt(item.css("width"),10);min.bottom=parseInt(item.position().top,10)+parseInt(item.css("height"),10);transBottom=parseInt(trans.position().top,10)+parseInt(trans.css("height"),10);transRight=parseInt(trans.position().left,10)+parseInt(trans.css("width"),10);e.preventDefault();if(transRight<min.right){prop+="l"}if(transBottom<min.bottom){prop+="t"}if($.trim(prop)!==""){brAdjust(item,trans,min,prop)}});wrap.on("click",function(e){switch($(e.target).attr("data-action")){case"cropper-submit":e.preventDefault();cropper.save(trans);cropper.destroy(wrap,el);Export.getData(item,trans);break;case"cropper-cancel":e.preventDefault();$("body").trigger("cropper-cancel");cropper.destroy(wrap,el);break;case"cropper-restore":e.preventDefault();cropper.restore()}})};Export.getData=function(item,trans){var html="item background-size: "+item.css("background-size")+"<br>item background-position: "+item.css("background-size");if(trans!==undefined){html+="<br>trans width: "+trans.css("width")+"<br>trans height: "+trans.css("height")+"<br>trans left top (x,y): ("+trans.position().left+", "+trans.position().top+")"+"<br>trans right bottom (x,y): ("+(parseInt(trans.position().left,10)+parseInt(trans.css("width"),10))+", "+(parseInt(trans.position().top,10)+parseInt(trans.css("height"),10))+")"+"<br>item left top (x,y): ("+item.position().left+", "+item.position().top+")"+"<br>item right bottom (x,y): ("+(parseInt(item.position().left,10)+parseInt(item.css("width"),10))+", "+(parseInt(item.position().top,10)+parseInt(item.css("height"),10))+")"}return html};Export.render=function(el,img,container){el=$(el);cropper.el=el;el.addClass("in-cropping");var bp=el.css("background-position").split(" "),bs=el.css("background-size").split(" "),data={img:{url:img,width:0,height:0},item:{width:parseInt(el.css("width"),10),height:parseInt(el.css("height"),10),bg:{cover:false,width:bs[0],height:bs[1],x:bp[0],y:bp[1]}},trans:{top:0,left:0,width:0,height:0}},loadImg=new Image;if(data.item.bg.width==="cover"){data.item.bg.width=0;data.item.bg.height=0;data.item.bg.cover=true}loadImg.addEventListener("load",function(e){var wrap=$('<div id="cropper"></div>'),btnset=$('<div class="btnset"></div>');data.img.width=loadImg.width+"px";data.img.height=loadImg.height+"px";$(_.template(cropper.markup,data)).appendTo(wrap);cropper.submitBtn=$('<a role="button" class="m-button-tiny" data-action="cropper-submit">'+i18n.gettext("儲存")+"</a>");cropper.cancelBtn=$('<a role="button" data-action="cropper-cancel">'+i18n.gettext("取消")+"</a>");cropper.resetBtn=$('<a role="button" data-action="cropper-restore">'+i18n.gettext("重設")+"</a>");cropper.submitBtn.appendTo(btnset);cropper.cancelBtn.appendTo(btnset);cropper.resetBtn.appendTo(btnset);wrap.append(btnset);cropper.backdrop=$('<div id="cropper-backdrop" class="cropper-backdrop"></div>');cropper.backdrop.css("height",window.innerHeight+"px");cropper.backdrop.appendTo($("body"));wrap.appendTo($(container));wrap.addClass("cropper");cropper.init(wrap,el,data);$(window).on("resize",function(){cropper.backdrop.css("height",window.innerHeight+"px")});cropper.original_data=data});loadImg.addEventListener("error",function(e){alertModal.show("Image does not exist.")});loadImg.src=img};return Export});define("ui/discountBadge",function(require,exports){"use strict";var _=require("underscore");exports.processData=function(item){var discountBadgeText="";var discountBadgeClass="";if(!_.isEmpty(item.promo_badge)){var badge=item.promo_badge;discountBadgeClass="g-item-badge-"+badge.type_class;discountBadgeText=badge.text}return{discountBadgeText:discountBadgeText,discountBadgeClass:discountBadgeClass}};exports.render=function(item){var _data=exports.processData(item);var result="";if(_data.discountBadgeText){result=_.template('<div class="g-item-badge <%= discountBadgeClass %>"><div><%= discountBadgeText %></div></div>',_data)}return result}});define("ui/fillimg",function(require,exports){require("jquery.imagesloaded");return function(img,cellWidth,cellHeight){var $img=$(img);if(!img.is("img")){$img=$img.find("img").eq(0)}if(!cellWidth){var $parent=$img.parent();cellWidth=$parent.width();cellHeight=$parent.height()}$img.imagesLoaded(function($images){var $img=$images.eq(0);var w=$img.width();var h=$img.height();var ratio;if(cellWidth>w){ratio=cellWidth/w;w=cellWidth;h=h*ratio}if(cellHeight>h){ratio=cellHeight/h;h=cellHeight;w=w*ratio}var resizeRatio=Math.max(cellWidth/w,cellHeight/h);var reWidth=parseInt(w*resizeRatio);var reHeight=parseInt(h*resizeRatio);$img.css({width:reWidth,height:reHeight,top:-parseInt((reHeight-cellHeight)/2),left:-parseInt((reWidth-cellWidth)/2)})})}});define("ui/getShippingGeoOptions",function(require){"use strict";var enums=require("enums");var settings=require("settings");var getOptionByGeo=function(geo){if(!geo){return null}return{value:geo,label:enums.country[geo]}};var getShippingGeoOptions=function(){var options=[];var userGeoOption=getOptionByGeo(settings.get("geo"));if(userGeoOption!==null){options.push(userGeoOption)}var majorShippingCountrySet=new Set(enums.major_shipping_countries.filter(function(c){return c!=settings.get("geo")}));majorShippingCountrySet.forEach(function(c){options.push(getOptionByGeo(c))});options.push({label:"------",value:" ",disabled:true});var minorShippintCountries=Object.keys(enums.country).filter(function(c){return!majorShippingCountrySet.has(c)&&c!==settings.get("geo")&&c!=="0"});minorShippintCountries.sort();minorShippintCountries.forEach(function(c){options.push(getOptionByGeo(c))});return options};return getShippingGeoOptions});define("ui/heroBanner",function(require,exports){"use strict";var _=require("underscore");var settings=require("settings");var locale=settings.get("locale");var geo=settings.get("geo");var now=_.now();var isAvailable=function(data){var geos=_.pluck(data.geos,"geo");var locales=_.pluck(data.locales,"locale");var geoKey=geo;var geoObj;if(!data.published){return""}if(!_.contains(geos,"_ALL_")&&!_.contains(geos,geo)){return false}if(!_.contains(locale,"_ALL_")&&!_.contains(locales,locale)){return false}if(!_.contains(geos,geo)){geoKey="_ALL_"}geoObj=_.findWhere(data.geos,{geo:geoKey});if(geoObj.since!==null&&geoObj.since*1e3>now||geoObj.until!==null&&geoObj.until*1e3<now){return false}return true};var dataToHTML=function(data){var localeKey=locale;var locales=_.pluck(data.locales,"locale");if(!_.contains(locales,locale)){localeKey="_ALL_"}return _.template(["<li><a",'href="<%= href %>"','target="<%= target %>">','<img src="<%= src %>" style="width:100%" />',"</a></li>"].join(" "),_.extend(data,{src:_.findWhere(data.locales,{locale:localeKey}).src}))};var swipe=function($el){var count=$el.find("li").length;var $counters=$('<span class="counters"></span>');var pagination="";$el.on("changeActiveIndex",function(e){var index=$(e.target).data("vars").currentIndex;$counters.find(".s-active").removeClass("s-active");$counters.find('[data-counter="'+index+'"]').addClass("s-active")});_(count).times(function(n){if(n===0){pagination+='<span class="counter s-active" data-counter="0"></span>'}else{pagination+='<span class="counter" data-counter="'+n+'"></span>'}});$counters.append(pagination);$counters.insertAfter($el);$(document).ready(function(){$el.addClass("s-ready").itemslide({pan_threshold:.1,one_item:true,parent_width:true})})};exports.init=function($el,bannerData,isRotate){if(!bannerData||!bannerData.length){return}var filteredBanner=_.filter(bannerData,function(data){return isAvailable(data)});if(!filteredBanner.length){return}$el.show();if(isRotate){$el.html('<ul class="wrapper">'+_.map(_.sortBy(filteredBanner,"priority"),function(banner){return dataToHTML(banner)}).reverse().join("")+"</ul>");swipe($el.find(".wrapper"));return}$el.html('<ul class="wrapper">'+dataToHTML(filteredBanner[_.random(0,bannerData.length-1)])+"</ul>")}});define("ui/html5Upload",function(require,exports){"use strict";var _=require("underscore");var form=require("dom/form");var i18n=require("i18n");var settings=require("settings");var bar=require("ui/notification/bar");var backdrop=require("ui/backdrop");var request=require("net/request");var isMobile=settings.get("mobile");var SIZEUNITINMB=Math.pow(1024,2);var browserLinks={ie:{zh_TW:"http://windows.microsoft.com/zh-tw/internet-explorer/download-ie",zh_CN:"http://windows.microsoft.com/zh-cn/internet-explorer/download-ie",en:"http://windows.microsoft.com/en-us/internet-explorer/download-ie",ja:"http://windows.microsoft.com/ja-jp/internet-explorer/download-ie",th:"http://windows.microsoft.com/th-th/internet-explorer/download-ie"},chrome:"https://www.google.com/chrome/browser/desktop/"};var downloadText=_.template(""+'<div class="download-browser-tip">'+i18n.gettext('您使用的瀏覽器不支援照片上傳，建議更新您的瀏覽器來達到最佳瀏覽體驗，請點<a href="<%= downloadLink %>" target="_blank">此連結</a>前往下載。')+"</div>",{downloadLink:Modernizr.ie?browserLinks.ie[settings.get("locale")]:browserLinks.chrome});var containerTpl='<div id="m-html5-upload-container" class="m-html5-upload-container"></div>';var progressWrapTpl=['<div id="html5-upload-progress" class="html5-upload-progress">','<p id="html5-upload-progress-text">',i18n.gettext("正在上傳..."),"</p>",'<div class="html5-upload-progress-bar-wrap">','<div id="html5-upload-progress-bar" class="html5-upload-progress-bar"></div>',"</div>","</div>"].join("");var errWrapTpl='<div id="err-msgs" class="err-msgs"></div>';var errTpl='<div class="err-msg"><%= errMsg %></div>';var sizeErrTextTpl=i18n.gettext("檔案太大，檔案大小不能超過 <%= sizeLimit %> MB");var typeErrText=i18n.gettext("檔案格式有誤，請檢查圖檔格式是否為 JPG 或 PNG");var shortSideLenErrTpl=i18n.gettext("無法上傳：<%= filename %> 圖片尺寸為 <%= width %>px x <%= height %>px，上傳圖片寬度或高度至少有一邊需大於 <%= minShortSideLen %>px (最小限制)。");var shortSideLenOverTenErrTpl=i18n.gettext("無法上傳：上傳圖片寬度或高度至少有一邊需大於 <%= minShortSideLen %>px (最小限制)，請重新檢查 <%= filenamesStr %>。");var $errMsgs=$(errWrapTpl);var $progress=$(progressWrapTpl);var $progressText=$progress.find("#html5-upload-progress-text");var $progressBar=$progress.find("#html5-upload-progress-bar");exports.support=Modernizr.ajaxfileupload;exports.downloadTip=downloadText;exports.$progress=$progress;exports.initUI=function(args){var $wrapper;args=_.extend({error:true},args);if(args.wrapper===undefined){throw new Error("wrapper is required for html5Upload.initUI method")}if(typeof args.wrapper==="string"||_.isElement(args.wrapper)){$wrapper=$(args.wrapper)}else if(isMobile?$.zepto.isZ(args.wrapper):args.wrapper instanceof jQuery){$wrapper=args.wrapper}if(!$wrapper.length){throw new Error("wrapper doesn't match any elements")}if(args.progress){$wrapper.append($progress)}if(args.error){$wrapper.append($errMsgs)}return exports};exports.validate={file:function($fileInput,args){var defer=$.Deferred();var files=$fileInput[0].files;args=_.extend({sizeInMB:10},args);if(!files.length){defer.resolve({files:files,validFiles:files,invalidFiles:files})}form.validate.file({$fileInput:$fileInput,files:files,rules:args.rules}).done(function(result){var renderedErrMsgs=[];var invalidFiles=result.invalidFiles;defer.resolve(result);if(!invalidFiles.length){return}if(invalidFiles.length<10){(function(){$errMsgs.removeClass("over-ten");var renderedSizeErrText=_.template(sizeErrTextTpl,{sizeLimit:'<span class="err-highlight">'+(args.rules!==undefined&&!isNaN(parseInt(args.rules.sizeInMB,10))?args.rules.sizeInMB:args.sizeInMB)+"</span>"});for(var i=0;i<invalidFiles.length;i++){var file=invalidFiles[i];var errMsgObj={isSizeValid:['<span class="err-highlight">'+file.name+"</span>",renderedSizeErrText].join(" "),isTypeValid:['<span class="err-highlight">'+file.name+"</span>",typeErrText].join(" ")};if(args.rules&&args.rules.minShortSideLen){errMsgObj.isShortSideLenValid=_.template(shortSideLenErrTpl,{width:file.width,height:file.height,filename:'<span class="err-highlight">'+file.name+"</span>",minShortSideLen:'<span class="err-highlight">'+args.rules.minShortSideLen+"</span>"})}for(var key in file){if(file.hasOwnProperty(key)&&file[key]===false&&errMsgObj[key]!==undefined){renderedErrMsgs.push(_.template(errTpl,{errMsg:errMsgObj[key]}))}}}})()}else{(function(){var shortSideLenErrFilesArr;$errMsgs.addClass("over-ten");if(args.rules&&args.rules.minShortSideLen){shortSideLenErrFilesArr=[]}var renderedSizeErrText=_.template(sizeErrTextTpl,{sizeLimit:args.rules!==undefined&&!isNaN(parseInt(args.rules.sizeInMB,10))?args.rules.sizeInMB:args.sizeInMB});var sizeErrMsgArr=[renderedSizeErrText];var typeErrMsgArr=[typeErrText];var hasSizeErr=false;var hasTypeErr=false;var hasShortSideLenErr=false;for(var i=0;i<invalidFiles.length;i++){var _file=invalidFiles[i];if(_file.isSizeValid===false){if(!hasSizeErr){hasSizeErr=true}sizeErrMsgArr.push('<div class="err-highlight-with-block">'+_file.name+"</div>")}if(_file.isTypeValid===false){if(!hasTypeErr){hasTypeErr=true}typeErrMsgArr.push('<div class="err-highlight-with-block">'+_file.name+"</div>")}if(_file.isShortSideLenValid===false){if(!hasShortSideLenErr){hasShortSideLenErr=true}shortSideLenErrFilesArr.push('<div class="err-highlight-with-block">'+_file.name+"</div>")}}if(hasSizeErr){renderedErrMsgs.push(_.template(errTpl,{errMsg:sizeErrMsgArr.join(" ")}))}if(hasTypeErr){renderedErrMsgs.push(_.template(errTpl,{errMsg:typeErrMsgArr.join(" ")}))}if(hasShortSideLenErr){renderedErrMsgs.push(_.template(errTpl,{errMsg:_.template(shortSideLenOverTenErrTpl,{minShortSideLen:args.rules.minShortSideLen,filenamesStr:shortSideLenErrFilesArr.join("")})}))}})()}if(renderedErrMsgs.length){$errMsgs.append(renderedErrMsgs.join(" "))}});return defer}};exports.addErrMsgs=function(errMsg){$errMsgs.append(_.template(errTpl,{errMsg:errMsg}));return exports};exports.emptyErrMsgs=function(){$errMsgs.removeClass("over-ten").empty();return exports};exports.showUploadingUI=function(delayBackdropHide){backdrop.show({loader:true});bar.show(i18n.gettext("檔案正在上傳中，請耐心稍候片刻....."));$progress.show();$progressText.text(i18n.gettext("正在上傳..."));$(window).on("beforeunload.uiHtml5Upload",function(){return i18n.gettext("離開頁面後，將會立即停止上傳.......")});return exports};exports.showDoneUI=function(delayBackdropHide){$progressBar.css({width:"100%"});$progressText.text(i18n.gettext("上傳成功"));setTimeout(function(){backdrop.hide()},delayBackdropHide);bar.show(i18n.gettext("上傳成功"));$(window).off(".uiHtml5Upload");return exports};exports.showFailUI=function(delayBackdropHide){$progress.fadeOut();$progressText.text(i18n.gettext("✘ 上傳失敗，請重新整理網頁之後再試一次或稍後再試"));$errMsgs.append(_.template(errTpl,{errMsg:i18n.gettext("✘ 上傳失敗，請重新整理網頁之後再試一次或稍後再試")}));setTimeout(function(){backdrop.hide()},delayBackdropHide);$(window).off(".uiHtml5Upload");return exports};exports.updateProgress=function(oEvent,args){args=_.extend({reqSuccessCounter:0,reqQueue:[""]},args);if(oEvent.lengthComputable){var percentComplete=oEvent.loaded/oEvent.total;var progressWidth=Math.ceil((args.reqSuccessCounter+percentComplete)/args.reqQueue.length*95).toString()+"%";$progressBar.css({width:progressWidth})}};exports.send=function(args){var $inputEl;var $wrapper;var defer=$.Deferred();var $container=$(containerTpl);args=_.extend({progress:false,error:true,batch:false,delayBackdropHide:0},args);args=_.extend(args,{type:"POST"});if(args.url===undefined){throw new Error("url argument is required for html5Upload function")}if(args.wrapper===undefined){throw new Error("wrapper argument is required for html5Upload function")}if(args.inputEl&&!(typeof args.inputEl==="string"||_.isElement(args.inputEl)||(isMobile?$.zepto.isZ(args.inputEl):args.inputEl instanceof jQuery))){throw new Error("inputEl parameter should be a string or a element or a jQuery element or a Zepto element")}if(args.data===undefined){throw new Error("data argument is required for html5Upload function")}if(args.beforeSend!==undefined&&!_.isFunction(args.beforeSend)){throw new Error("beforeSend argument must be a function")}if(args.inputEl){if(typeof args.inputEl==="string"||_.isElement(args.inputEl)){$inputEl=$(args.inputEl)}else if(isMobile?$.zepto.isZ(args.inputEl):args.inputEl instanceof jQuery){$inputEl=args.inputEl}if(!$inputEl.length){throw new Error("inputEl doesn't match any elements")}}if(typeof args.wrapper==="string"||_.isElement(args.wrapper)){$wrapper=$(args.wrapper)}else if(isMobile?$.zepto.isZ(args.wrapper):args.wrapper instanceof jQuery){$wrapper=args.wrapper}if(!$wrapper.length){throw new Error("wrapper doesn't match any elements")}var _$container=$("#m-html5-upload-container");if(_$container.length){_$container.remove()}if(!$wrapper.hasClass("m-html5-upload-wrapper")){$wrapper.addClass("m-html5-upload-wrapper")}if(!exports.support){$wrapper.html(exports.downloadTip);return false}if(args.progress){$container.append($progress)}if(args.error){$container.append($errMsgs)}$wrapper.append($container);var afterFilesValidated=function(result){if(args.inputEl){var validFiles=result.validFiles;var invalidFiles=result.invalidFiles;if(args.batch){var reqSuccessCounter=0;var reqSizeLimit=11*SIZEUNITINMB;var reqQueue=[[]];var reqSizeCounter=0;for(var i=0;i<validFiles.length;i++){var file=validFiles[i];if(reqSizeCounter+file.size<=reqSizeLimit){reqQueue[reqQueue.length-1].push(file);reqSizeCounter+=file.size}else{reqQueue.push([]);reqQueue[reqQueue.length-1].push(file);reqSizeCounter=file.size}}}if(!validFiles.length){if(!invalidFiles.length){bar.show(i18n.gettext("請先從你的電腦中挑選幾張圖片"),{type:"info"})}return false}$inputEl.prop("disabled",true)}exports.showUploadingUI();if(args.beforeSend!==undefined){args.beforeSend()}var ajaxErrorCallback=function(req,statusText,responseText){if(args.inputEl){$inputEl.prop("disabled",false).val(null)}exports.showFailUI(args.delayBackdropHide);defer.reject(req,statusText,responseText)};var ajaxSuccessCallback=function(resp){if(resp.error){exports.addErrMsgs(resp.error.message);ajaxErrorCallback();return false}if(args.inputEl){$inputEl.prop("disabled",false).val(null)}exports.showDoneUI(args.delayBackdropHide);defer.resolve(resp)};var sendRequest=function(){var args_request={type:args.type,url:args.url,data:args.batch?reqQueue[reqSuccessCounter]:args.data,error:function(req,statusText,responseText){if(!args.batch){return ajaxErrorCallback(req,statusText,responseText)}reqSuccessCounter++;if(reqSuccessCounter===reqQueue.length){ajaxErrorCallback(req,statusText,responseText)}}};if(args.progress){args_request.progress=function(oEvent){var args_updateProgress;if(args.batch){args_updateProgress={reqSuccessCounter:reqSuccessCounter,reqQueue:reqQueue}}exports.updateProgress(oEvent,args_updateProgress)}}return request(args_request).done(function(resp){if(!args.batch){ajaxSuccessCallback(resp);return}reqSuccessCounter++;if(reqSuccessCounter===reqQueue.length){ajaxSuccessCallback(resp);return}sendRequest()})};sendRequest()};exports.emptyErrMsgs().$progress.hide();if(args.inputEl){exports.validate.file($inputEl,{rules:args.rules
}).done(afterFilesValidated)}else{afterFilesValidated()}return defer};return exports});define("ui/Infinitescroll",function(require,exports){"use strict";var Inviewport=require("ui/Inviewport");function Infinitescroll(indicator,fetch,currentPage){this.$indicator=$(indicator);this.fetch=fetch;this.page=currentPage||1;this.inviewport=new Inviewport({el:this.$indicator,cb:$.proxy(this._fetch,this),buffer:100})}Infinitescroll.prototype._fetch=function(){++this.page;var promise=this.fetch(this.page);return promise};return Infinitescroll});define("ui/inputListener",function(require,exports){"use strict";var _=require("underscore");var settings=require("settings");var addressIdentifier=/[縣市鄉鎮市區村里路段街巷弄號樓]/;var checkZhuyi=function(character){return character&&Boolean($.trim(character))&&_.contains(["ㄅ","ㄆ","ㄇ","ㄈ","ㄉ","ㄊ","ㄋ","ㄌ","ㄍ","ㄎ","ㄏ","ㄐ","ㄑ","ㄒ","ㄓ","ㄔ","ㄕ","ㄖ","ㄗ","ㄘ","ㄙ","ㄧ","ㄨ","ㄩ","ㄚ","ㄛ","ㄜ","ㄝ","ㄞ","ㄟ","ㄠ","ㄡ","ㄢ","ㄣ","ㄤ","ㄥ","ㄦ"],character)};var checkCacheIsValid=function(cache,val){if(cache&&val){return cache===val}return false};exports.bind=function($el,selector){if(!$el||!$el.length){$el=$(document.body||document.documentElement)}var events=["keydown","keyup","blur","change","contextmenu"];$el.on(events.join(" "),selector?selector:"",_.throttle(function(e){var $eT=$(e.target);var val=$eT.val();var inputValueType=$eT.data("input");var cache=$eT.attr("data-input-cache");var useCachedValue=checkCacheIsValid(cache,val);var isGoingToFireChangeEvt=false;if((e.type==="focusout"||e.type==="blur")&&!val){$eT.attr("data-input-cache","")}if(checkZhuyi(val.slice(-1))){return}if($eT.data("min")&&val.length<$eT.data("min")){return}if(inputValueType==="address"&&settings.get("locale")==="zh_TW"){if(!addressIdentifier.test(val)){return}}if(e.type==="keydown"){if(e.metaKey&&e.keyCode===86){if(!useCachedValue){isGoingToFireChangeEvt=true}}}else if(!useCachedValue){isGoingToFireChangeEvt=true}if(val.length<2){isGoingToFireChangeEvt=false}if(isGoingToFireChangeEvt){$el.trigger({type:"input-value-change",_target:$eT});if(cache!==val){$eT.attr("data-input-cache",val)}}},500));return $el}});define("ui/intlTranship",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var modal=require("ui/modal");var settings=require("settings");var isMobile=settings.get("mobile");var url=require("app/modules/url");var $transhipNoticeIframe;exports.$shippingNotice=function(){var $notice=$('<div id="whats-tranship" class="combined_rule"></div>').on("click",'[data-action="show-modal"]',function(e){e.preventDefault();exports.showNoticeModal()});return $notice}();exports.showShippingNotice=function(el,msg){if(msg===undefined){throw new Error("msg is required for showShippingNotice")}var $el;if(!el||!(typeof el==="string"||_.isElement(el)||(isMobile?$.zepto.isZ(el):el instanceof jQuery))){throw new Error("el parameter is required and it should be a string or a element or a jQuery element")}if(typeof el==="string"||_.isElement(el)){$el=$(el)}else if(isMobile?$.zepto.isZ(el):el instanceof jQuery){$el=el}$el.append(exports.$shippingNotice.html(msg));exports.$shippingNotice.show()};exports.hideShippingNotice=function(){exports.$shippingNotice.hide()};exports.$cartNotice=$(""+'<div class="group step-tranship">'+'<div class="step-tranship-confirm">'+'<input id="main-confirm-read-faq" class="main-confirm-read-faq confirm-checkbox" type="checkbox">'+i18n.gettext('<label for="main-confirm-read-faq">我已仔細閱讀 <a target="_blank" href="/faq/tranship">Pinkoi 國際轉運服務說明</a> 且瞭解相關規範。</label>')+"</div>"+($.inArray(settings.get("geo"),["CN","HK","MO"])!==-1?'<div class="step-tranship-confirm">'+'<input id="main-confirm-id-need" class="main-confirm-id-need confirm-checkbox" type="checkbox">'+'<label for="main-confirm-id-need">'+i18n.gettext("我了解寄至中國大陸的包裹，根據當地海關規定，部分類別商品在物流及通關過程中可能需要出示<b>身份證複印件</b>以順利通關。物流公司承諾收件人的身分證訊息僅用於通關檢查。")+"</label>"+"</div>":"")+"</div>");exports.showNoticeModal=function(){var noticeTpl=""+'<div class="tranship">'+'<img class="tranship-banner" src="'+url.getS3ObjectUrl("/pinkoi.site/general/tranship/img_cart_popup_tutorial@2x.png","cdn04")+'" alt="the banner of international shipping notice">'+'<div class="tranship-notice-wrap">'+'<div class="tranship-notice">'+'<p class="tranship-notice-p">'+i18n.gettext("在「我的購物車」頁面中，商品運送方式選擇")+"</p>"+'<img class="tranship-notice-img-1" src="'+url.getS3ObjectUrl("/pinkoi.site/general/tranship/img_cart_popup_tutorial_selector@2x.png","cdn04")+'" alt="'+i18n.gettext("寄往 Pinkoi 轉運中心台灣運費")+'">'+'<img class="tranship-notice-img-1 en" src="'+url.getS3ObjectUrl("/pinkoi.site/general/tranship/img_cart_popup_tutorial_selector_EN@2x.png","cdn04")+'" alt="'+i18n.gettext("寄往 Pinkoi 轉運中心台灣運費")+'">'+"</div>"+'<div class="tranship-notice">'+'<p class="tranship-notice-p">'+i18n.gettext("付款後在「已付款訂單」頁面按下")+"</p>"+'<img class="tranship-notice-img-2" src="'+url.getS3ObjectUrl("/pinkoi.site/general/tranship/img_cart_popup_tutorial_btn@2x.png","cdn04")+'" alt="'+i18n.gettext("通知轉運中心出貨")+'">'+'<img class="tranship-notice-img-2 en" src="'+url.getS3ObjectUrl("/pinkoi.site/general/tranship/img_cart_popup_tutorial_btn_EN@2x.png","cdn04")+'" alt="'+i18n.gettext("通知轉運中心出貨")+'">'+"</div>"+'<div class="tranship-notice">'+'<p class="tranship-notice-p">'+i18n.gettext("商品陸續抵達 Pinkoi 國際轉運中心，準備一次出貨囉！")+"</p>"+'<p class="tranship-notice-p">'+i18n.gettext('有疑問嗎？<a href="/faq/tranship" target="_blank">看完整服務說明</a>')+"</p>"+"</div>"+"</div>"+"</div>";return function(){modal.show(noticeTpl,{className:"m-tranship-notice-modal-wrap"})}}();exports.initNoticePage=function(){var $slides=$("#steps");var $stats=$("#m-carousel-stat").find("i");$("#close-btn").one("click.nTranshipNoticeCloseButton",function(){if(settings.get("isApp")){exports.removeWebview();return}exports.removeNoticeIframe()});$slides.on("changeActiveIndex",function(e){$stats.removeClass("s-active");$($stats[$slides.getActiveIndex()]).addClass("s-active")});$slides.itemslide({pan_threshold:.3,one_item:true,parent_width:true});$slides.addClass("s-ready");$(window).on("resize.transhipNotice",function(){$slides.reloadSlide()})};exports.removeNoticeIframe=function(){if($transhipNoticeIframe){$transhipNoticeIframe.remove();return}var $nTranshipNoticeIframeOnParent=$("#m-intl-tranship-iframe",parent.window.document);if(!$nTranshipNoticeIframeOnParent.length){return false}$nTranshipNoticeIframeOnParent.remove()};exports.removeWebview=function(){location.href="//api.pinkoi.com/app/close_webview"};exports.showNoticeIframe=function(){$transhipNoticeIframe=$('<iframe id="m-intl-tranship-iframe" class="m-intl-tranship-iframe m-fullscreen" src="/page/tranship_notice"></iframe>');$(document.body||document.documentElement).append($transhipNoticeIframe)};return exports});define("ui/Inviewport",function(require,exports){"use strict";var _=require("underscore");var types=require("utils/types");var Inviewport=function(args){var _this=this,id;this.$el=$(args.el);if(!this.$el.length){throw new Error("This DOM element is not existed.")}this.el=this.$el.get(0);this.cb=args.cb;this.buffer=typeof args.buffer!=="undefined"?args.buffer:10;this._id=_.uniqueId("uiInviewport");this.scrollbody=document.getElementById(args.scrollbody)||args.scrollbody||window;this.$scrollbody=$(this.scrollbody);this.scrollbody=this.$scrollbody.get(0);this.cacheHeight=this.$scrollbody.height();id=this._id;if(this.scrollbody===window){$(window).on("resize."+id,_.debounce(function(){_this.resize();if(_this.isShown){$(window).off("resize."+id)}},350))}this.on()};Inviewport.prototype.isShown=function(){var scrollbodyHeight=this.cacheHeight;if(this.scrollbody===window){var scrollTop=document.documentElement&&document.documentElement.scrollTop||document.body.scrollTop;var eleTop=this.$el.offset().top}else{var eleTop=0;var tempEl=this.el;while(1){eleTop+=tempEl.offsetTop;tempEl=tempEl.offsetParent;if(!tempEl||tempEl===this.scrollbody){break}}var scrollTop=this.scrollbody.scrollTop}if(eleTop<scrollbodyHeight+scrollTop+this.buffer){return true}return false};Inviewport.prototype.on=function(){if(!this._monitoring){this._monitoring=true;this._on()}else{return}var that=this;this.$scrollbody.on("scroll."+this._id,_.throttle(function(e){that._on()},350))};Inviewport.prototype._on=function(){if(this.isShown()&&this._monitoring){this.off();var deferred=this.cb.call(this);if(deferred===true){this.on()}else if(types.isDeferred(deferred)){var that=this;deferred.done(function(){that.on()})}}};Inviewport.prototype.off=function(){this._monitoring=false;this.$scrollbody.off("scroll."+this._id)};Inviewport.prototype.resize=function(){this.cacheHeight=this.$scrollbody.height()};return Inviewport});define("ui/localeNotice",function(require,exports){"use strict";var settings=require("settings");var urlparse=require("net/urlparse");var _=require("underscore");var request=require("net/request");var alertModal=require("ui/notification/alertModal");var modal;var r=require;modal=r(settings.get("mobile")?"mui/modal":"ui/modal");var tpl='<div class="m-locale-notice--content"><h2><%= text.description %></h2>'+"<form>"+'<div class="select-wrapper">'+"<%= locale %>"+"</div>"+'<div class="submit-wrapper">'+'<a data-click="submit" class="m-br-button m-br-button--primary m-br-button--lg s-fullwidth"><%= text.confirm %></a>'+"</div>"+"</form>"+"</div>";var selectElementTpl='<select class="m-select" name="<%= type %>" required>'+"<% for(var i=0; i< data.available.length; i++) { %>"+'<option value="<%= data.available[i].value %>" <%= (data.available[i].value === data.selected) ? "selected" : "" %>>'+"<%= data.available[i].name %> "+"</option>"+"<% } %>"+"</select>";exports.init=function(options){options=_.extend({delay:0},options);if(typeof options.delay!=="number"){throw new Error("options.delay need to be a number for localeNotice.init")}var lang=settings.get("suggestedLocale");if(urlparse.current().paths[0]==="about"){return}if(!lang){return}if(settings.get("lang")!==lang.locale.selected){setTimeout(function(){modal.show(_.template(tpl,{text:lang.text,locale:_.template(selectElementTpl,{data:lang.locale,type:"locale"})}),{anywhereHide:false,verticalCenter:true,backdrop:true,className:"m-locale-notice"});modal.on(Modernizr.touchevents?"touchstart":"click",'[data-click="submit"]',function(e){e.preventDefault();var $form=modal.$body.find("form");var dataForRequest={locale:$form.find('[name="locale"]').val()||$form.find('[name="locale"] option[selected]').attr("value")};request({type:"POST",url:"/apiv2/i18n/set_locale",data:dataForRequest}).done(function(resp){if(resp.error){return alertModal.error(resp.error)}if(resp.result[0]&&resp.result[0].link){location.href=resp.result[0].link}modal.hide()}).fail(function(){alertModal.error();modal.hide()})})},options.delay)}};return exports});define("ui/messageModal",function(require,exports){"use strict";var i18n=require("i18n");var _=require("underscore");var settings=require("settings");var modal=require("ui/modal");var request=require("net/request");var bar=require("ui/notification/bar");var url=require("app/modules/url");var cs=require("external/customerService");var messageLocaleTip=require("app/modules/messageLocaleTip");var login=require("mapp/pages/login");var uid=settings.get("uid");var tpl=['<div id="m-message-modal" class="m-message-modal">',"<h2>"+"<%= prompt %><span><%= heading %></span>"+"</h2>",'<div id="m-message-modal-dayoff_notes" class="g-info g-alert" style="display:none"></div>','<form id="m-message-modal-form" method="POST" enctype="multipart/form-data" action="/apiv2/message/send">',"<%= mutiplePhoto %>",'<div class="<% if (photo) { %>with-photo<% } %>">','<div class="form-section">','<label class="g-form-label">'+i18n.gettext("標題")+"</label>",'<input class="g-form-input" type="text" name="title" value="<%= title %>"/>',"</div>","<%= photo %>","</div>",'<div class="form-section">','<label class="g-form-label">'+i18n.gettext("訊息內容")+"</label>",'<textarea class="g-form-textarea" name="description" rows="7"><%= content %></textarea>',"</div>",'<div class="m-message-locale-tip g-info"></div>','<div class="form-section expand-syntax-section">'+'<a data-click="expand-syntax">'+i18n.gettext("使用特殊語法")+"?"+"</a>"+'<div class="expand-syntax">'+i18n.gettext("**粗體字** → 包含在兩對星號間的文字會變成粗體字")+"<br>",i18n.gettext("__底線字__ → 包含在兩對底線間的文字會自動畫底線")+"<br>",i18n.gettext("--刪除線-- → 包含在一對--間的文字會自動加上刪除線")+"<br>",i18n.gettext("http://example.com/picture.jpg → 貼上外站圖片網址會自動轉成圖片，提醒，如果你的外站圖片會自動阻擋外部連結，圖片將無法正確顯示（例如，Facebook 圖片連結就不能顯示）！建議使用 Flickr 相簿圖片連結")+"<br>",i18n.gettext("http://pinkoi.com/product/1qXQ92Ck → 貼上Pinkoi的網址會自動轉成超連結")+"<br>",settings.get("locale")==="zh_CN"?"http://v.youku.com/v_show/id_XOTUzOTI2NTg4.html 贴上優酷 youku 网址会自动转成影片，片长建议 30 秒以内，以免影响商品页下载速度":i18n.gettext("http://www.youtube.com/watch?v= Pa7dqxMOMv4 → 貼上 Youtube 網址會自動轉成影片，片長建議 30 秒以內，以免影響商品頁下載速度")+"</div>","</div>",'<div class="form-section">','<label class="g-form-label">'+i18n.gettext("上傳照片")+"</label>",'<input name="file" type="file">',"</div>",'<div class="m-message-modal-footer">',"<p>",i18n.gettext("透過 Pinkoi 以外管道聯繫或私下交易，會喪失 Pinkoi 保障買賣雙方之交易權益。"),"</p>",'<div class="footer-button"><input class="m-br-button m-br-button--lg m-br-button--primary" type="submit" value="',i18n.gettext("送出"),'"></div>',"</div>",'<input type="hidden" name="receiver" value="<%= to %>">','<input type="hidden" name="item" value="<%= tid %>">','<input type="hidden" name="oid" value="<%= oid %>">','<input type="hidden" name="contenttype" value="html">',"</form>","</div>"].join("");exports.show=function(opt,cb){if(!uid){login.loginModal(modal);return false}opt=opt||{};cb=cb||$.noop;opt.content=_.escape(opt.content||"");opt.heading="";opt.prompt=opt.prompt||(opt.oid?i18n.gettext("訂單有任何問題，在這裡直接發訊息討論吧！"):i18n.gettext("想了解更多商品購買細節？在這裡詢問設計師吧！"));opt.tid=opt.tid||settings.get("PAGE_TID")||"";opt.to=opt.to?opt.to:settings.get("PAGE_OWNER");opt.oid=opt.oid||"";opt.purpose=opt.purpose||"";opt.title=opt.title?_.escape(opt.title):settings.get("PAGE_TITLE")||"";var photo="";var mutiplePhoto="";if(opt.tid){var tids=opt.tid.split(",");if(tids.length===1){photo=_.template('<div class="photo-position"><img class="modal-upper-right" src="<%= photo %>"></div>',{photo:url.getItemImg(tids[0],"120x120")})}else{mutiplePhoto='<div class="mutiple-photo"><div class="thumbs">';for(var i=0;i<tids.length;++i){mutiplePhoto+=_.template('<img src="<%= photo %>">',{photo:url.getItemImg(tids[i],"80x80")})}mutiplePhoto+="</div></div>"}}function showVacationMessage(){var dayoff_notes=settings.get("dayoff_notes");var html=[];if(_.size(dayoff_notes)){for(var i=0,l=dayoff_notes.length;i<l;++i){var text=dayoff_notes[i].note;if(dayoff_notes[i].tss&&dayoff_notes[i].tss.length>1){text+=new Date(dayoff_notes[i].tss[0]*1e3).toLocaleDateString()+" ~ "+new Date(dayoff_notes[i].tss[1]*1e3).toLocaleDateString()}html.push(text)}}var $dayoff_notes=$("#m-message-modal-dayoff_notes");if(html.length){$dayoff_notes.html(html.join("<br>"));$dayoff_notes.show()}else{$dayoff_notes.hide()}}var html=_.template(tpl,{to:opt.to,title:opt.title,prompt:opt.prompt,tid:opt.tid,oid:opt.oid,heading:opt.heading,content:opt.content,photo:photo,mutiplePhoto:mutiplePhoto});modal.show(html,{anywhereHide:false,isOverflowHidden:false,className:"m-message-modal-close"});showVacationMessage();try{if(!!navigator.userAgent.match(/firefox/i)){document.documentElement.scrollTop=0}}catch(e){window.Sentry&&window.Sentry.captureException&&window.Sentry.captureException(e)}var $form=modal.$body.find("form");var $submitButton=$form.find("input[type=submit]");var $localeTip=$form.find(".m-message-locale-tip");if(opt.to){messageLocaleTip.init($localeTip,opt.to)}var submitForm=function(e){e.preventDefault();var title=$.trim($form.find('input[name="title"]').val());var description=$.trim($form.find("textarea").val());var file=$form.find('input[name="file"]')[0].files[0]||"";var isValid=true;if($submitButton.data("disabled")){return false}if(!title.length){bar.show(i18n.gettext("標題不能是空的哦"));isValid=false}if(!description.length&&!file){bar.show(i18n.gettext("內容不能是空的哦"));isValid=false}if(!isValid){return false}var data={title:title,description:description,receiver:opt.to,tid:opt.tid,oid:opt.oid,purpose:opt.purpose};if(Modernizr.ajaxfileupload){data.file=file}$submitButton.data("disabled",true);request({type:"POST",url:"/apiv2/message/send",data:data}).done(function(result){$submitButton.data("disabled",false);if(result.error){bar.show(result.error.message);return false}if(result.result){bar.show(i18n.gettext("已送出"));cb(result)}else{if(result.error){bar.show(result.error.message);return}else{pinkoi.error()}}modal.hide()})};modal.on("keyup keypress","input",function(e){var keyCode=e.keyCode||e.which;if(keyCode===13){e.preventDefault();return false}});modal.on("submit",submitForm);modal.on("click","[data-click]",function(e){var action=$(e.target).data("click");switch(action){case"customer-service-translate":modal.hide();cs.disableHelpCenter().show();break;case"expand-syntax":$($(e.target).next()).show();$(e.target).remove();break}})};exports.hide=function(){modal.hide()};return exports});define("ui/modal",function(require,exports){"use strict";var transitionend=require("css/transitionend");var backdrop=require("ui/backdrop");var settings=require("settings");var requestAnimation=require("ui/requestAnimation");var $body=$(settings.get("mobile")?document.body:document);var $modalBody=$('<div class="m-modal-desktop"></div>');var $modalClose=$('<div class="m-modal-close" data-click="m-modal-hide"></div>');var $modal=$('<div class="m-modal-desktop-wrap" style="display:none;"></div>');var _=require("underscore");$modal.append($modalBody);$modal.append($modalClose);var backdropIsShown;var hideCb;var hide=function(){if(!exports.isShown){return exports}document.documentElement.style.overflow="visible";exports.isShown=false;$(window).off(".uimodal");$modal.off(".uimodal");if(backdropIsShown){backdrop.hide();backdropIsShown=false}transitionend($modal,function(){if(hideCb){hideCb()}$modal.remove()});$modal.css({top:$body.scrollTop()-50,opacity:0});exports.hide();return exports};var show=function(html,optArgs){if(!html){throw new Error("html parameter is required")}optArgs=$.extend({withCloseBtn:true,disableAutoRePosition:false,anywhereHide:true},optArgs);if(!exports.isShown){$modal.appendTo(document.body)}$modal.off("click").on("click","[data-click]",function(evt){var action=$(evt.target).data("click");switch(action){case"m-modal-hide":exports.hide();break}});$modal.off(".uimodal");if(!optArgs.withCloseBtn){$modalClose.hide()}else{$modalClose.show()}$modal.attr("class",optArgs.className?"m-modal-desktop-wrap "+optArgs.className:"m-modal-desktop-wrap");if(optArgs.withBackdrop!==false){var config={isBlack:optArgs.blackBackdrop||false,className:optArgs.className||""};backdropIsShown=true;requestAnimation(function(){backdrop.show(config)})}if(optArgs.onHideCb){hideCb=optArgs.onHideCb}$modalBody.html(html);requestAnimation(function(){exports.rePosition(true,optArgs.width?{width:optArgs.width}:null);var bodyScrollTop=$body.scrollTop()||$(window).scrollTop();var modalHeight=$modal.height();var windowHeight=$(window).height();var windowInnerHeight=window.innerHeight;var supportCSSAnimation=Modernizr.cssanimations;requestAnimation(function(){$modal.css(supportCSSAnimation?{top:bodyScrollTop-50}:{top:bodyScrollTop-50,opacity:0});var t=bodyScrollTop+(windowHeight-modalHeight)/2;var isOverflow=windowInnerHeight<modalHeight;t=isOverflow?bodyScrollTop+10:t<0?0:t;$modal.css(supportCSSAnimation?{top:t}:{top:t,opacity:1});if(!isOverflow&&optArgs.isOverflowHidden!==false){document.documentElement.style.overflow="hidden"}optArgs.onShow&&optArgs.onShow()})});exports.isShown=true;if(!optArgs.disableAutoRePosition){$(window).on("resize.uimodal",function(){exports.rePosition()})}if(optArgs.anywhereHide!==false){backdrop.onclick(hide)}return exports};var on=function(evtType,selector,evtHandler){var _evtType=evtType.split(" ");var modifiedEvtType=[];for(var i=0,l=_evtType.length;i<l;++i){if(_evtType[i]){modifiedEvtType.push(_evtType[i]+".uimodal")}}$modal.on(modifiedEvtType.join(" "),selector,evtHandler);return exports};var rePosition=function(isSkipTop,opts){$modal.removeAttr("style");$modalBody.removeAttr("style");var doc=document.documentElement;var _modalWidth=Math.floor($modal.width()/2)*2;var modalHeight=$modal.height();var isOverflow=doc.clientHeight<modalHeight;var modalLeft=(doc.clientWidth-_modalWidth)/2;var modalWidth=_modalWidth>doc.clientWidth?doc.clientWidth-20:_modalWidth;var modalCssConf=_.extend({left:Modernizr.csstransforms?"50%":modalLeft,width:modalWidth,height:modalHeight,opacity:1},opts);if(!isSkipTop){var modalTop=$(settings.get("mobile")?document.body:document).scrollTop()+($(window).height()-modalHeight)/2;modalTop=modalTop<0?0:Math.round(modalTop);modalCssConf.top=modalTop}else{modalCssConf.top=20}$modal.css(modalCssConf);if(isOverflow){$modalBody.css({"overflow-y":"auto"})}else{$modalBody.height("auto");$modal.height("auto")}};exports.isShown=false;exports.show=show;exports.hide=hide;exports.on=on;exports.$body=$modalBody;exports.rePosition=rePosition});define("ui/referralIntroSlides",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var modal=require("ui/modal");var settings=require("settings");var $slidesIframe;var referralReward=settings.get("referral_reward");referralReward=_.extend({bonus_points:"",equivalent_currency:"",equivalent_currency_per_100_points:"",equivalent_currency_per_1000_points:""},referralReward);exports.showSlidesModal=function(){var slidesTpl=""+'<div class="referral-intro-slides">'+'<div id="n-referral-intro-slides-js" class="n-referral-intro-slides">'+'<div class="steps-wrap">'+'<ul id="steps" class="steps">'+"<li>"+'<i class="steps-banner steps-banner-1"></i>'+'<div class="steps-text">'+'<h3 class="steps-title">'+_.template(i18n.gettext("歡迎來到 Pinkoi !<br>送上見面禮 <%= referralReward.equivalent_currency %>"),{referralReward:referralReward})+"</h3>"+'<p class="steps-p">'+_.template(i18n.gettext(""+"歡迎來到 Pinkoi，你可以在這裡發掘許多來自亞洲的好設計！先送上紅利 <%= referralReward.bonus_points %>點，等同於 <%=  referralReward.equivalent_currency %>，可以馬上在結帳時折抵消費金額。"),{referralReward:referralReward})+"</p>"+"</div>"+"</li>"+"<li>"+'<i class="steps-banner steps-banner-2"></i>'+'<div class="steps-text">'+'<h3 class="steps-title">'+i18n.gettext("累積紅利享更多優惠")+"</h3>"+'<p class="steps-p">'+_.template(i18n.gettext("來輕鬆拿更多紅利吧。每 1000 點紅利可以折抵 <%= equivalent_currency_per_1000_points %> 。邀請朋友加入 Pinkoi，完成第一筆訂單，都可以獲得紅利喔。"),{equivalent_currency_per_1000_points:referralReward.equivalent_currency_per_1000_points})+"</p>"+"</div>"+"</li>"+"<li>"+'<i class="steps-banner steps-banner-3"></i>'+'<div class="steps-text">'+'<h3 class="steps-title">'+i18n.gettext("隨時隨地逛好設計")+"</h3>"+'<p class="steps-p">'+i18n.gettext("下載 Pinkoi APP 讓你隨時買設計，同時支援 iOS 和 Android 喔。")+"</p>"+'<p class="steps-p steps-explore-btn-wrap">'+'<a class="m-button-pink" data-click="m-modal-hide">'+i18n.gettext("開始逛逛")+"</a>"+"</p>"+"</div>"+"</li>"+"</ul>"+"</div>"+'<nav id="carousel-stat" class="carousel-stat">'+"<i></i>"+"<i></i>"+"<i></i>"+"</nav>"+'<a id="carousel-next-js" class="carousel-next" data-click="next-step">'+i18n.gettext("下一步")+"</a>"+"</div>"+"</div>";var $slides=$(slidesTpl);return function(){modal.show($slides,{className:"m-referral-intro-slides-modal-wrap"});var $steps=$slides.find("#steps");var $stats=$slides.find("#carousel-stat").find("i");var $carouselNext=$slides.find("#carousel-next-js");modal.on("click","[data-click]",function(e){var $this=$(this);var action=$this.data("click");if(!action){return}e.preventDefault();if(action==="next-step"){$steps.nextSlide()}});setTimeout(function(){$steps.on("changeActiveIndex",function(e){$stats.removeClass("s-active");$($stats[$steps.getActiveIndex()]).addClass("s-active");$carouselNext[$steps.getActiveIndex()>=2?"hide":"show"]()});$steps.itemslide({pan_threshold:.3,one_item:true,parent_width:true});$steps.addClass("s-ready")},10)}}();exports.initIntroPage=function(){var $slides=$("#steps");var $stats=$("#m-carousel-stat").find("i");$("#n-referral-intro-slides-js").on("click.nReferralIntroSlidesCloseButton",'[data-click="close"]',function(e){if(settings.get("isApp")){exports.removeWebview();return}exports.removeSlidesIframe()});$slides.on("changeActiveIndex",function(e){$stats.removeClass("s-active");$($stats[$slides.getActiveIndex()]).addClass("s-active")});$slides.itemslide({pan_threshold:.3,one_item:true,parent_width:true});$slides.addClass("s-ready");$(window).on("resize.referralIntroSlides",function(){$slides.reloadSlide()})};exports.removeSlidesIframe=function(){if($slidesIframe){$slidesIframe.remove();return}var $nReferralIntroSlidesIframeOnParent=$("#m-referral-intro-slides-iframe-js",parent.window.document);if(!$nReferralIntroSlidesIframeOnParent.length){return false}$nReferralIntroSlidesIframeOnParent.remove()};exports.removeWebview=function(){location.href="//api.pinkoi.com/app/close_webview"};exports.showSlidesIframe=function(){$slidesIframe=$('<iframe id="m-referral-intro-slides-iframe-js" class="m-referral-intro-slides-iframe m-fullscreen" src="/page/referral_intro_slides"></iframe>');$(document.body||document.documentElement).append($slidesIframe)};return exports});define("ui/requestAnimationCancel",function(){"use strict";var rAFCancel=function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame||window.oCancelAnimationFrame||function(requestID){clearTimeout(requestID)}}();return function(requestID){rAFCancel(requestID)}});define("ui/richtext",function(require,exports){"use strict";var url=require("app/modules/url");var regexProtocol=/(https?):\/\//i;var settings=require("settings");function replace(str,opt_args){opt_args=opt_args||{};if(!str){return}opt_args.italic=opt_args.hasOwnProperty("italic")?opt_args.italic:true;var output=str&&str.replace(/\n/g,"<br>");var hasFBImg=false;var imageonload="";var imageonerror="";output=output.replace(/__([^_\r\n<]+)__/gi,'<u class="m-richtext-el">$1</u>');output=output.replace(/\*\*([^\*\r\n<]+)\*\*/gi,'<b class="m-richtext-el">$1</b>');if(opt_args.italic){output=output.replace(/\*([^\*\r\n<]+)\*/gi,'<i class="m-richtext-el">$1</i>')}output=output.replace(/\-\-([^-\r\n<]+)\-\-/gi,'<del class="m-richtext-el">$1</del>');if(opt_args.imageonload){imageonload=' onload="'+opt_args.imageonload+'"'}if(opt_args.imageonerror){imageonerror=' onerror="'+opt_args.imageonerror+'"'}output=output.replace(/(https?:\/\/[=\.\+\-\_\/#\w\?\&%~;,:!\(\)]+)\s*(?:\(([^\)]+)\)*)*/gi,function(m,m1,m2){if(m1.indexOf("fbcdn")!==-1){hasFBImg=true}if(!m2&&/(?:\.png|\.jpg|\.jpeg|\.gif)/i.test(m1)){if(/http:\/\/s3-ap-southeast-1.amazonaws.com\/pinkoi\./i.test(m1)&&!/msg/i.test(m1)){m1=url.fix_s3_link_in_text(m1)}if(opt_args.lazy){return'<img class="m-libs-lazy m-richtext-el m-richtext-img" src="'+url.getS3ObjectUrl("/pinkoi.site/space.gif","cdn04")+'" data-src="'+m1+'" '+imageonload+" "+imageonerror+">"}else{return'<img class="m-richtext-el m-richtext-img" src="'+m1+'"'+imageonload+" "+imageonerror+">"}}else if(m2&&m2.indexOf("http")===0&&/(?:\.png|\.jpg|\.jpeg|\.gif)$/i.test(m2)){if(/http:\/\/s3-ap-southeast-1.amazonaws.com\/pinkoi\./i.test(m2)&&!/msg/i.test(m2)){m2=url.fix_s3_link_in_text(m2)}if(opt_args.lazy){return'<a class="m-richtext-el m-richtext-img-link" href="'+m1+'"><img class="m-libs-lazy m-richtext-el m-richtext-img" data-src="'+m2+'" '+imageonload+" "+imageonerror+"></a>"}else{return'<a class="m-richtext-el m-richtext-img-link" href="'+m1+'"><img class="m-richtext-el m-richtext-img" src="'+m2+'" '+imageonload+" "+imageonerror+"></a>"}}else if(m1.indexOf("youtube.com")!==-1&&m1.indexOf("v=")!==-1){var vid=m1.match(/v=([^&]+)/i)[1];return'<span class="m-richtext-video-wrap"><iframe class="m-richtext-el m-richtext-video" src="https://www.youtube.com/embed/'+vid+'" frameborder="0" allowfullscreen></iframe></span>'}else if(m1.indexOf("youtu.be")!==-1){var vid=m1.match(/(?:youtu\.be\/)([\w\-_]+)/i)[1];return'<span class="m-richtext-video-wrap"><iframe class="m-richtext-el m-richtext-video" src="https://www.youtube.com/embed/'+vid+'" frameborder="0" allowfullscreen></iframe></span>'}else if(m1.indexOf("v.youku.com")!==-1&&m1.indexOf("id_")!==-1){var vid=m1.match(/id_([^&]+).html/i)[1];return'<span class="m-richtext-video-wrap"><iframe class="m-richtext-el m-richtext-video" src="'+(settings.get("isAndroid")?"http":"https")+"://player.youku.com/embed/"+vid+'?autoplay=false" frameborder="0" allowfullscreen></iframe></span>'}else if(m1.indexOf("v.qq.com")!==-1){var vid=m1.match(/\/page\/([^&]+).html/i)[1];return'<span class="m-richtext-video-wrap"><iframe class="m-richtext-el m-richtext-video" frameborder="0" src="'+(settings.get("isAndroid")?"http":"https")+"://v.qq.com/iframe/player.html?vid="+vid+'&tiny=0&auto=0" allowfullscreen></iframe></span>'}else if(m1.indexOf("vimeo.com")!==-1){var vid=m1.match(/([\w\-_]+)$/i)[1];return'<span class="m-richtext-video-wrap"><iframe class="m-richtext-el m-richtext-video" src="https://player.vimeo.com/video/'+vid+'" frameborder="0" allowfullscreen></iframe></span>'}else{return m2?'<a class="m-richtext-el m-richtext-link" href="'+m1+'" target="_blank">'+(m2.length>35?m2.substr(0,35)+"...":m2)+"</a>":'<a class="m-richtext-el m-richtext-link" href="'+m1+'" target="_blank">'+(m1.length>40?m1.replace(regexProtocol,"").substr(0,35)+"...":m1.replace(regexProtocol,""))+"</a>"}});if(hasFBImg){output=output.replace(/&amp;/gi,"&")}if(opt_args.imageonload){location.hash=document.height}return output}exports.parse=replace;exports.replace=function(selector,opt_args){var $wrap=$(selector);var $els=$wrap.find(".m-richtext");$els.add($wrap.filter(".m-richtext")).each(function(i){var $el=$(this);if(opt_args&&opt_args.isios){$el.data("richtext",1).html(replace($el.text(),opt_args))}else{$el.data("richtext",1).html(replace($el.html(),opt_args))}})}});define("ui/scratchOff",function(require,exports){"use strict";var calculatePercentage=function(ctx,width,height){var pixels=ctx.getImageData(0,0,width,height);var filled=0;for(var i=0;i<pixels.data.length;i++){if(parseInt(pixels.data[i])===0){filled+=1}}return Math.round(filled/pixels.data.length*100)};var getBrushPos=function($canvas,xRef,yRef){var canvasRect=$canvas[0].getBoundingClientRect();return{x:Math.floor((xRef-canvasRect.left)/(canvasRect.right-canvasRect.left)*$canvas.width()),y:Math.floor((yRef-canvasRect.top)/(canvasRect.bottom-canvasRect.top)*$canvas.height())}};var drawDot=function(ctx,pos,radius){ctx.beginPath();ctx.arc(pos.x,pos.y,radius,0,2*Math.PI,true);ctx.fillStyle="#000";ctx.globalCompositeOperation="destination-out";ctx.fill()};var fixCursorPos=function(x,y,factor){if(Modernizr.testAllProps("zoom")){return{x:x/factor,y:y/factor}}else{return{x:x,y:y}}};exports.init=function(opt){var $container=$(opt.container);var $canvas=$('<canvas class="m-scratch-off-front"></canvas>');var width=$container.width();var height=$container.height();var ctx=$canvas[0].getContext("2d");var frontImage;var frontDesktopImage=new Image;var frontMobileImage=new Image;var revealResult=function(){if($canvas.fadeOut){$canvas.fadeOut(500,function(){$(this).remove()})}else{$canvas.remove()}};$container.append($canvas);$canvas[0].width=width;$canvas[0].height=height;frontMobileImage.src=opt.frontImageSrc.mobile;frontDesktopImage.src=opt.frontImageSrc.desktop;if(document.documentElement.clientWidth<=480){frontImage=frontMobileImage;$canvas.removeClass("desktop")}else{frontImage=frontDesktopImage;$canvas.addClass("desktop")}frontImage.onload=function(){ctx.drawImage(frontImage,0,0,frontImage.width,frontImage.height,0,0,width,height);$container.append(opt.backHtml);if(opt.onInitialize){opt.onInitialize()}};var brushRadius=15;$(window).resize(function(){if(document.documentElement.clientWidth<=480){if($container.hasClass("desktop")){var $back=$container.find(".m-scratch-off-back");width=$container.width();height=$container.height();
$canvas[0].width=width;$canvas[0].height=height;$back.hide();frontImage=frontMobileImage;ctx.clearRect(0,0,width,height);ctx.drawImage(frontImage,0,0,frontImage.width,frontImage.height,0,0,width,height);$back.show();$container.removeClass("desktop")}}else{if(!$container.hasClass("desktop")){var $back=$container.find(".m-scratch-off-back");width=$container.width();height=$container.height();$canvas[0].width=width;$canvas[0].height=height;$back.hide();frontImage=frontDesktopImage;ctx.clearRect(0,0,width,height);ctx.drawImage(frontImage,0,0,frontImage.width,frontImage.height,0,0,width,height);$back.show();$container.addClass("desktop")}}});var factor=1;if(Modernizr.testAllProps("zoom")){factor=$("div.m-scratch-off").css("zoom")}else{var transformMatrix=$("div.m-scratch-off").css("transform").split("(")[1].split(")")[0].split(",");factor=Math.sqrt(Math.pow(transformMatrix[0],2),Math.pow(transformMatrix[1],2))}$(window).resize(function(){if(Modernizr.testAllProps("zoom")){factor=$("div.m-scratch-off").css("zoom")}else{var transformMatrix=$("div.m-scratch-off").css("transform").split("(")[1].split(")")[0].split(",");factor=Math.sqrt(Math.pow(transformMatrix[0],2),Math.pow(transformMatrix[1],2))}});var isMouseDown=false;$canvas.on("mousedown",function(e){isMouseDown=e.which===1});$canvas.on("mouseup",function(e){if(e.which===1&&isMouseDown){isMouseDown=false}});$canvas.on("mouseleave",function(e){isMouseDown=false});$canvas.on("mousemove",function(e){var cursorPos=fixCursorPos(e.clientX,e.clientY,factor);var brushPos=getBrushPos($canvas,cursorPos.x,cursorPos.y);var leftBut=isMouseDown;if(leftBut){drawDot(ctx,brushPos,brushRadius/factor);if(calculatePercentage(ctx,width,height)>opt.threshold_pt){$canvas.unbind("mousemove");opt.onFinishing(revealResult)}}});$canvas.on("touchmove",function(e){e.preventDefault();if(e.targetTouches){var touch=e.targetTouches[0]}else{var touch=e.originalEvent.targetTouches[0]}if(touch){var cursorPos=fixCursorPos(touch.pageX,touch.pageY,factor);var brushPos=getBrushPos($canvas,cursorPos.x,cursorPos.y);drawDot(ctx,brushPos,brushRadius);if(calculatePercentage(ctx,width,height)>opt.threshold_pt){$canvas.unbind("touchmove");opt.onFinishing(revealResult)}}})};exports.calculatePercentage=calculatePercentage;exports.getBrushPos=getBrushPos;return exports});define("ui/scrollToTop",function(require,exports){"use strict";var _=require("underscore");var doc=require("dom/doc");var requestAnimation=require("ui/requestAnimation");var transitionend=require("css/transitionend");var settings=require("settings");var isShown=false;var inited=false;var $window=$(window);var $scrollBody=$window;var $el;var bodyScrollTop=function(top,hasAnimation,optCb){if(typeof top!=="number"){throw new Error("top is reuqired and need to be a number for scrollToTop.bodyScrollTop")}var $body={};if($scrollBody==$window){var $body=$(doc.getScrollingBody())}else{var $body=$scrollBody}if(hasAnimation&&"animate"in $body){$body.animate({scrollTop:top},1e3,function(){optCb&&optCb()})}else{$body.get(0).scrollTop=top;setTimeout(function(){optCb&&optCb()})}};var monitorScrolling=function(){var scrollTop=0;var isMobile=settings.get("mobile");var headerHasHidden=isMobile?$("#g-header").hasClass("hidden"):false;if($scrollBody==$window){scrollTop=doc.getScrollTop()}else{scrollTop=$scrollBody.scrollTop()}if(scrollTop>400){if(!isShown&&!headerHasHidden){isShown=true;requestAnimation(function(){$el.removeClass("hide");$("body").addClass("s-goTop-show");$scrollBody.trigger("m-scrollToTop-show");requestAnimation(function(){$el.addClass("show")})})}}if(isShown&&scrollTop<=400||headerHasHidden){isShown=false;requestAnimation(function(){transitionend($el,function(){$el.addClass("hide");$("body").removeClass("s-goTop-show")});$el.removeClass("show");$scrollBody.trigger("m-scrollToTop-hide")})}};var init=function(elAppendTo,scrollBody){if(inited){return}var $elAppendTo;if(scrollBody){if(!scrollBody instanceof $){$scrollBody=$(scrollBody)}else{$scrollBody=scrollBody}}if(typeof elAppendTo!=="undefined"){if(typeof elAppendTo==="string"||_.isElement(elAppendTo)){$elAppendTo=$(elAppendTo)}else if(elAppendTo instanceof jQuery){$elAppendTo=elAppendTo}}else{$elAppendTo=document.body}$el=$('<a class="m-scrollToTop hide"></a>').appendTo($elAppendTo);$el.on("click",function(){bodyScrollTop(0,!settings.get("mobile"));return false});inited=true;monitorScrolling();$scrollBody.on("scroll.ui/scrollToTop",_.throttle(monitorScrolling,350))};var off=function(){if(!inited){return}inited=false;isShown=false;$el.remove();$scrollBody.off(".ui/scrollToTop")};exports.init=init;exports.off=off;exports.bodyScrollTop=bodyScrollTop});define("ui/sidetab",function(require,exports){"use strict";var i18n=require("i18n");exports.init=function(cb){var $sidetab=$('<div class="g-sidetab"><div><b>'+i18n.gettext("聯絡設計師")+"</b></div></div>");$sidetab.on("click",function(){if(cb){if(typeof cb==="function"){cb()}else if(typeof cb==="string"){window.location.href=cb}}});$(document.body).append($sidetab)};return exports});define("ui/sticky",function(require,exports){"use strict";var _=require("underscore");var doc=require("dom/doc");var transitionend=require("css/transitionend");var documentBody=doc.getScrollingBody();var docH=$(documentBody).height();var BUFFER=10;var styles={fixToTop:{top:"0",bottom:"auto",position:"fixed"},fixToBottom:{top:"auto",bottom:"0",position:"fixed"},restore:{top:"0",position:"static"}};var getTop=function($el){return $el?$el.offset().top:0};var listener=function(){var that=this;$(window).on("scroll.ui.sticky-"+that.id,_.throttle(function(e){var ds=doc.getScrollTop();if(Math.abs(ds-that.y)>1&&that.y>=0){that.scrollHandler(ds>that.y?"down":"up")}that.y=ds},10))};var Sticky=function($selector,args){var id=_.uniqueId("");var $selector=$selector instanceof jQuery?$selector:$($selector);var $threshold=args.$threshold;var stickyHeight=0;var $bottomEl;var originalBottom;if(!$selector||!$selector.length){throw new Error("missing element to be sticky")}stickyHeight=$selector.height();if(stickyHeight<window.innerHeight&&args&&args.alignTo==="bottom"){throw new Error("sticky element is shorter than window's height")}$bottomEl=args.bottomEl&&args.bottomEl.length?args.bottomEl:$("#g-footer-nav");originalBottom=getTop($bottomEl);this.$el=$selector;if(!args.forcedInit&&getTop($selector)+stickyHeight>=originalBottom){this.restore();this.off();return}this.isFixed=false;this.alignTo=args.alignTo||"top";this.hasBufferAnimation=false;this.paddingBuffer=args.bottomPaddingTop||0;this.nonSticky={$bottomEl:$bottomEl,originalBottom:originalBottom};if(!$threshold||!$threshold.length){$selector.prev("i.m-sticky-anchor").remove();$threshold=$('<i class="m-sticky-anchor"></i>');$threshold.insertBefore($selector);this.$threshold=$threshold}setInterval(function(){var _docH=$(documentBody).height();if(docH!==_docH){docH=_docH;$(window).trigger("height-change")}},10);this.listener=listener;this.id=id;this.listener()};Sticky.prototype.fixSwitcher=function(){this.isFixed=!this.isFixed};Sticky.prototype.off=function(){if(!this.$el){return}$(window).off("scroll.ui.sticky");if(!this.isFixed){return}this.$el.css("position","static");this.fixSwitcher()};Sticky.prototype.doStick=function(direction,momentum){if(this.isFixed){return}this.fixSwitcher();var that=this;this.$el.css(styles[direction?direction:this.alignTo==="top"?"fixToTop":"fixToBottom"]).addClass("m-sticky-on"+(this.hasBufferAnimation?" s-transiting s-go-"+momentum:""));if(this.hasBufferAnimation){transitionend(this.$el,function(){that.$el.removeClass("s-transiting s-go-"+momentum)})}};Sticky.prototype.doHold=function(top){if(!this.isFixed){return}top=top||getTop(this.nonSticky.$bottomEl)-this.$el.height();this.$el.css({bottom:"auto",top:top,position:"absolute"});this.fixSwitcher()};Sticky.prototype.doShadow=function(){this.isFixed=false;if(getTop(this.$el)<doc.getScrollTop()){this.$el.css({top:getTop(this.$el)+"px",bottom:"auto",position:"absolute"})}};Sticky.prototype.restore=function(optIsForcedScrollToTop){this.$el.css(styles.restore).removeClass("m-sticky-on");this.isFixed=false;if(optIsForcedScrollToTop){documentBody.scrollTop=0}};Sticky.prototype.scrollHandler=function(direction){var scrollTop=doc.getScrollTop();var stickyTopOriginal=getTop(this.$threshold);if(scrollTop<=stickyTopOriginal){this.restore();return}var scrollBottom=scrollTop+window.innerHeight;var h=this.$el.outerHeight();var stickyTop=getTop(this.$el);var stickyBottom=stickyTop+h;var nonStickyBottom=getTop(this.nonSticky.$bottomEl)-this.paddingBuffer;var isStickyBottomAboveNonStickyBottom=nonStickyBottom>stickyBottom+BUFFER;var isStickyTopInViewport=scrollTop<=stickyTop;var isStickyBottomInViewport=scrollBottom>=stickyBottom;var isNonStickyBottomInViewport=scrollBottom>=nonStickyBottom;if(direction==="down"){if(isStickyBottomAboveNonStickyBottom){if(this.alignTo==="top"||isStickyBottomInViewport){this.doStick(null,direction);if(scrollTop>nonStickyBottom&&stickyBottom!==nonStickyBottom){this.doHold(nonStickyBottom-h)}return}}if(this.isFixed){this.doHold(stickyBottom>nonStickyBottom?nonStickyBottom-h:stickyBottom-h)}if(this.alignTo==="bottom"&&isNonStickyBottomInViewport){this.doHold(stickyBottom>nonStickyBottom?nonStickyBottom-h:stickyBottom-h);return}return}if(isStickyTopInViewport&&direction==="up"){this.doStick("fixToTop",direction);return}if(this.alignTo==="bottom"&&isStickyBottomAboveNonStickyBottom){this.doShadow();return}return};return Sticky});define("ui/storePolicyModal",function(require,exports){"use strict";var _=require("underscore");var request=require("net/request");var modal=require("ui/modal");var alertModal=require("ui/notification/alertModal");exports.show=function(sid,eventCategory){if(!sid){throw new Error("sid is required for storePolicyModal.show method")}request({url:"/apiv2/shop/get_info?sid="+sid+"&fields=policy_texts"}).done(function(resp){if(resp.error){alertModal.error(resp.error.message);return}var html=_.map(resp.result[0].policy_texts,function(section,sectionIndex){var sectionContent=_.map(section.items,function(rowContent,rowIndex){if(section.style==="bulleted_list"){return'<li class="'+section.style+'">'+rowContent+"</li>"}else{return'<div class="'+section.style+'">'+rowContent+"</div>"}});if(section.style==="bulleted_list"){return'<ul class="policy-row">'+sectionContent.join("")+"</ul>"}else{return'<div class="policy-row">'+sectionContent.join("")+"</div>"}});html='<div class="g-store-policy-modal">'+html.join("")+"</div>";modal.show(html);dataLayer.push({event:"ga",eventCategory:eventCategory,eventAction:"read return policy",nonInteraction:true});if(!Modernizr.csstransforms){document.documentElement.scrollTop=0}})};return exports});define("ui/tel",function(require,exports){"use strict";var _=require("underscore");var intltelinput=require("app/modules/intltelinput");var hideInvalidCountries=function($el,validCountries){if(!_.isArray(validCountries)||!validCountries.length){return}var $flagdropdown=$el.next();var countries=$flagdropdown.find(".country-list .country");for(var i=0;i<countries.length;i++){if(_.indexOf(validCountries,"+"+$(countries[i]).attr("data-dial-code"))<0){$(countries[i]).hide()}else if($(countries[i]).hasClass("preferred")){$(countries[i]).hide()}}};exports.intlTelFields=function(countryCodeSelector,telSelector,opt){opt=opt||{};var $telCountryCode=$(countryCodeSelector);var $tel=$(telSelector);intltelinput.init($telCountryCode);if(opt.onlyTheseCountries){hideInvalidCountries($telCountryCode,opt.onlyTheseCountries)}$telCountryCode.val($.trim($telCountryCode.val()));$telCountryCode.on("keyup",function(evt){var $field=$(this);var value=$.trim($field.val());var re=/[^\d\+]/g;if(re.test(value)){value=value.replace(re,"");$field.val(value)}if(value.indexOf("+")!==0){value="+"+value;$field.val(value)}re=/(.)\++/g;if(re.test(value)){value=value.replace(re,"$1");$field.val(value)}});$tel.on("keyup",function(evt){var $field=$(this);var value=$.trim($field.val());var re=/[^\d\+\ \-\(\)]/g;if(re.test(value)){$field.val(value.replace(re,""))}})};exports.concatTel=function(countryCodeSelector,telSelector){var $tel=$(telSelector);var $telCountryCode=$(countryCodeSelector);return $.trim($telCountryCode.val())+$.trim($tel.val())}});define("ui/toaster",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var settings=require("settings");var transitionend=require("css/transitionend");var requestAnimation=require("ui/requestAnimation");var facebook=require("external/facebook");var _$notificationWrap=$("#m-notification-wrap");var $notificationWrap=_$notificationWrap.length?_$notificationWrap:$('<div id="m-notification-wrap" class="m-notification-wrap"></div>');var show=function(html,optArgs){var $toasterWrap=$('<div class="m-notification-toaster-wrap"></div>');var $toaster=$('<div class="m-notification-toaster"></div>');var $close=$('<span class="m-notification-toaster-close"></span>');var $button=$('<a class="m-button-stretch"></a>');var $fbbutton=$('<a class="m-button-stretch"></a>');optArgs=optArgs||{};optArgs.withCloseBtn=optArgs.withCloseBtn||false;$toaster.removeClass("show");$toaster.html(html);var hide=function(){if(typeof optArgs.closeCb==="function"){optArgs.closeCb()}transitionend($toaster,function(){$toasterWrap.remove()});$toaster.removeClass("show")};if(optArgs.withCloseBtn){$toaster.addClass("with-close-btn").append($close);$close.one("click",function(){hide()})}if(optArgs.buttonLink&&optArgs.buttonText){$button.attr("href",optArgs.buttonLink).text(optArgs.buttonText);$toaster.append($button);$button.one("click",function(){hide()})}if(typeof optArgs.buttonCb==="function"&&optArgs.buttonText){$button.text(optArgs.buttonText);$toaster.append($button);$button.one("click",function(){optArgs.buttonCb();hide()})}if(optArgs.fbShare){optArgs.fbShare.cb=function(yon){if(yon){show(i18n.gettext("已經分享到你的塗鴉牆了"),{hide:true})}else{show(i18n.gettext("糟糕！發生不明錯誤，可能是你沒開放塗鴉牆"),{hide:true})}};$fbbutton.html(i18n.gettext("分享至 Facebook")).one("click",function(){facebook.publish(optArgs.fbShare);hide()});$toaster.append($fbbutton)}if(optArgs.hide!==false){transitionend($toaster,function(){setTimeout(function(){hide()},optArgs.delay?optArgs.delay:optArgs.withCloseBtn?15e3:1e4)})}$toaster.removeClass("left center");if(optArgs.hAlign&&_.contains(["left","center"],optArgs.hAlign)){$toaster.addClass(optArgs.hAlign)}if(optArgs.bottom){if(_.isNumber(optArgs.bottom)){$toaster.css("bottom",optArgs.bottom+"px")}else{$toaster.css("bottom",optArgs.bottom)}}if(optArgs.className){$toaster.addClass(optArgs.className)}$toasterWrap.append($toaster);if(settings.get("mobile")){$notificationWrap.append($toasterWrap)}else{$(document.body).append($toasterWrap)}requestAnimation(function(){$toaster.addClass("show")});return hide};if(settings.get("mobile")&&!_$notificationWrap.length){$(document.body).append($notificationWrap)}exports.show=show});define("ui/tooltip",function(require,exports){"use strict";var settings=require("settings");var _=require("underscore");var modal=require("ui/modal");var alertModal=require("ui/notification/alertModal");var isMobile=settings.get("mobile");var $tooltip;var $el;var pos;var offset;var isIgnoreElWidth;exports.on=false;exports.show=function(msg,el,optArgs){if(!msg||typeof msg!=="string"){throw new Error("msg parameter is required and it should be a string")}if(!el||!(typeof el==="string"||_.isElement(el)||(isMobile?$.zepto.isZ(el):el instanceof jQuery))){throw new Error("el parameter is required and it should be a string or a element or a jQuery element")}if(exports.on){exports.close()}optArgs=$.extend(true,{classNames:[],position:"rb",isWithDismiss:true,isForCheckbox:false,isIgnoreElWidth:false,offset:{top:0,left:0}},optArgs);if(!_.isArray(optArgs.classNames)){optArgs.classNames=[]}if(typeof el==="string"||_.isElement(el)){$el=$(el)}else if(isMobile?$.zepto.isZ(el):el instanceof jQuery){$el=el}if(!$el.length){throw new Error("$el doesn't match any elements")}offset=optArgs.offset;pos=optArgs.position;isIgnoreElWidth=optArgs.isIgnoreElWidth;optArgs.classNames.push("m-notification-tooltip");$tooltip=$('<div class="'+optArgs.classNames.join(" ")+'">'+msg+"</div>");if(optArgs.isForCheckbox){$tooltip.addClass("for-checkbox")}$tooltip.attr("data-pos",pos).appendTo(document.body);exports.rePosition();if(optArgs.isWithDismiss){$el.one("keydown.uiTooltip blur.uiTooltip change.uiTooltip",function(){exports.close($el)});setTimeout(function(){$(document.body).one("click.uiTooltip",function(){exports.close($el)})},0)}if(optArgs.className){$tooltip.addClass(optArgs.className)}if(typeof pinkoi!=="undefined"){if(pinkoi&&pinkoi.gmodal.isOpened()){$tooltip.addClass("on-gmodal");var throttled=_.throttle(exports.rePosition,10);$("#g_mod_modal.gmodal .wrap_").on("scroll.uiTooltip",throttled)}}if(modal.isShown){$tooltip.addClass("on-modal")}if(alertModal.isShown){$tooltip.addClass("on-alert-modal")}exports.on=true};exports.showInline=function(msg,el,optArgs){if(!msg||typeof msg!=="string"){throw new Error("msg parameter is required and it should be a string")}if(!el||!(typeof el==="string"||_.isElement(el)||(isMobile?$.zepto.isZ(el):el instanceof jQuery))){throw new Error("el parameter is required and it should be a string or a element or a jQuery element")}if(exports.on){exports.close()}optArgs=$.extend(true,{classNames:[],isWithDismiss:true,isForCheckbox:false,isIgnoreElWidth:false,isDisplayNormal:false,offset:{top:0,left:0}},optArgs);if(!_.isArray(optArgs.classNames)){optArgs.classNames=[]}if(typeof el==="string"||_.isElement(el)){$el=$(el)}else if(isMobile?$.zepto.isZ(el):el instanceof jQuery){$el=el}if(!$el.length){throw new Error("$el doesn't match any elements")}optArgs.classNames.push("m-notification-tooltip-inline");$tooltip=$('<div class="'+optArgs.classNames.join(" ")+'">'+msg+"</div>");if(optArgs.isForCheckbox){$tooltip.addClass("for-checkbox")}if(optArgs.isWithDismiss){$el.one("change.uiTooltip",function(){exports.close($el)})}$el.addClass("s-error");$tooltip.insertAfter($el);exports.on=true};exports.rePosition=function(){var iton=function(px){return Math.round(parseInt(px,10))};if(!isIgnoreElWidth&&isMobile){if(pos==="rb"){$tooltip.css("max-width",$el.width())}}var w=iton($el.outerWidth?$el.outerWidth():$el.width());var h=iton($el.outerHeight?$el.outerHeight():$el.height());var xy=[Math.round($el.offset().left),Math.round($el.offset().top)];var tootipWidth=$tooltip.outerWidth?$tooltip.outerWidth():$tooltip.width();var tootipHeight=$tooltip.outerHeight?$tooltip.outerHeight():$tooltip.height();var positions={r:function(){$tooltip.css({top:offset.top+xy[1]+Math.round(h/2)-Math.round(tootipHeight/2)+"px",left:offset.left+xy[0]+w+"px"})},rb:function(){$tooltip.css({top:offset.top+xy[1]+h+"px",left:offset.left+xy[0]+(w-iton(tootipWidth))+"px"})},lb:function(){$tooltip.css({top:offset.top+xy[1]+h+"px",left:offset.left+xy[0]+"px"})},cb:function(){$tooltip.css({top:offset.top+xy[1]+h+"px",left:offset.left+xy[0]+(w-iton(tootipWidth))/2+"px"})},ct:function(){$tooltip.css({top:offset.top+xy[1]-tootipHeight+"px",left:offset.left+xy[0]+(w-iton(tootipWidth))/2+"px"})}};if(positions[pos]){return positions[pos]()}throw new Error("lb, r, rb, cb, ct are positions allowed")};exports.close=function($el){if(!exports.on){return}exports.on=false;$tooltip.remove();$(document.body).off("click.uiTooltip");if($el){$el.removeClass("s-error");$el.off("keydown.uiTooltip blur.uiTooltip change.uiTooltip")}if(typeof pinkoi!=="undefined"){if(pinkoi&&pinkoi.gmodal.isOpened()){$("#g_mod_modal.gmodal .wrap_").off(".uiTooltip")}}};exports.init=function(){var modal=require("ui/modal");modal.$body.on("modal-hide",function(){exports.close()})};exports.init();return exports});define("ui/waterfall",function(reuire,exports){"use strict";var _=require("underscore");var Infinitescroll=require("ui/Infinitescroll");var $indicator;var $container;var fetch;var afterFetch;var getUrl;var getCellHeight;var renderCell;var cellWidth;var cellMargin;var cellTemplate;var preprocessRows;var postRender;var page;var pageLimit;var colsData;var parseAjax;var onpageLimit;var onBeforeRepaint;var containerPaddingLeft;var containerHeight=0;var infinitescroll;function init(args){page=args.page||0;pageLimit=args.pageLimit||50;pageLimit+=page;onpageLimit=args.onpageLimit||$.noop;parseAjax=args.parseAjax;getUrl=args.getUrl;afterFetch=args.afterFetch||$.noop;onBeforeRepaint=args.onBeforeRepaint||$.noop;$indicator=$(args.indicator);$container=$(args.container);var cellConfig=args.cellConfig;getCellHeight=cellConfig.height;if(typeof getCellHeight==="number"){var _getCellHeight=getCellHeight;getCellHeight=function(){return _getCellHeight}}cellWidth=cellConfig.width;cellMargin=cellConfig.margin;preprocessRows=args.preprocessRows;postRender=args.postRender;infinitescroll=new Infinitescroll($indicator,fetch);if(args.cellTemplate){cellTemplate=_.template($(args.cellTemplate).html())}prepareCols();return exports}function reConfig(args){var cellConfig=args.cellConfig;if(cellConfig.height){getCellHeight=cellConfig.height;if(typeof getCellHeight==="number"){var _getCellHeight=getCellHeight;getCellHeight=function(){return _getCellHeight}}}cellWidth=cellConfig.width||cellWidth;cellMargin=cellConfig.margin||cellMargin}function feed(rows){if(preprocessRows){preprocessRows(rows)}if(getCellHeight){var $fragment=$("<div/>")}for(var i=0,l=rows.length;i<l;++i){var minHeightCol=getMinHeightColIndex();var html;rows[i].desc=rows[i].description;if(rows[i].customizedHTML){html=rows[i].customizedHTML}else if(cellTemplate){html=cellTemplate(rows[i])}else{html=renderCell(rows[i])}var $dom=$(html);$dom.css({left:colsData[minHeightCol].left,top:colsData[minHeightCol].height});if(getCellHeight){$dom.appendTo($fragment);var height=getCellHeight(rows[i])}else{$container.append($dom);var height=$dom.outerHeight()}colsData[minHeightCol].height+=height+cellMargin.v;if(containerHeight<colsData[minHeightCol].height){containerHeight=colsData[minHeightCol].height;$container.css("height",containerHeight)}}if(getCellHeight){$container.append($fragment.children())}if(postRender){postRender()}}function getMinHeightColIndex(){var minHeightCol=0;var minHeight=colsData[0].height;for(var j=1,k=colsData.length;j<k;++j){if(colsData[j].height<minHeight){minHeight=colsData[j].height;minHeightCol=j}}return minHeightCol}function fetch(){page+=1;var deferred=new $.Deferred;var url=getUrl(page);var ajax=$.ajax({url:url});ajax.done(function(data){var rows=parseAjax(data);if(rows){feed(rows);deferred.resolve()}afterFetch(url)});if(page>=pageLimit){onpageLimit(page);return false}else{return deferred}}function prepareCols(){var containerW=$container.width();var colNum=Math.floor(containerW/cellWidth);while(1){var totalW=colNum*(cellWidth+cellMargin.h)-cellMargin.h;if(totalW>containerW){--colNum}else{containerPaddingLeft=Math.round((containerW-totalW)/2);break}}colsData=[];var left=containerPaddingLeft;for(var i=0;i<colNum;++i){colsData.push({height:0,left:left});left+=cellWidth+cellMargin.h}$container.css("height",0);containerHeight=0}function repaint(){prepareCols();$container.children().each(function(i,v){var $cell=$(this);var minHeightCol=getMinHeightColIndex();var height=parseInt($cell.outerHeight());$cell.css({left:colsData[minHeightCol].left,top:colsData[minHeightCol].height});colsData[minHeightCol].height+=height+cellMargin.v;if(containerHeight<colsData[minHeightCol].height){containerHeight=colsData[minHeightCol].height;$container.css("height",containerHeight)}})}$(window).on("resize",_.debounce(function(){onBeforeRepaint();repaint()},750));exports.init=init;exports.feed=feed;exports.reConfig=reConfig;exports.repaint=repaint});define("ui/notification/alertModal",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var cs=require("external/customerService");var transitionend=require("css/transitionend");var alertModalBackdrop=require("ui/notification/alertModalBackdrop");var Doc=require("dom/doc");_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var queue=[];var backdropIsShown;var $body=Doc.getScrollingBody();var $modalBody=$('<div class="m-modal-desktop"></div>');var $modal=$('<div class="m-modal-desktop-wrap" style="display:none;"></div>');$modal.append($modalBody);exports.isShown=false;var hide=function(){if(!exports.isShown||!queue.length){return exports}queue.splice(0,1);if(queue.length===0){document.documentElement.style.overflow="visible";exports.isShown=false;if(backdropIsShown){alertModalBackdrop.hide();backdropIsShown=false}}$(window).off(".uiAlertModal");$modal.off(".uiAlertModal");transitionend($modal,function(){$modal.hide();if(queue.length===0){$modal.remove();return}queue[0]()});$modal.css({top:$body.scrollTop-50,opacity:0});return exports};var rePosition=function(isSkipTop){$modal.removeAttr("style");$modalBody.removeAttr("style");var doc=document.documentElement;var _modalWidth=$modal.width();var modalHeight=$modal.height();var isOverflow=doc.clientHeight<modalHeight;var modalLeft=(doc.clientWidth-_modalWidth)/2;var modalWidth=_modalWidth>doc.clientWidth?doc.clientWidth-20:_modalWidth;var modalCssConf={left:Modernizr.csstransforms?"50%":modalLeft,width:modalWidth,height:isOverflow?modalHeight:"auto",opacity:1};if(!isSkipTop){var modalTop=$body.scrollTop+($(window).height()-modalHeight)/2;modalTop=modalTop<0?0:Math.round(modalTop);modalCssConf.top=modalTop}$modal.css(modalCssConf);if(isOverflow){$modalBody.css({"overflow-y":"scroll"})}else{$modalBody.height("auto")}return exports};var _show=function(content,args){if(!content||typeof content!=="string"){throw new Error("content paramter is required and should be a string")}args=_.extend({title:"",confirmCb:function(){return true},onHideCb:function(){return true}},args);var $alert=$('<div class="alert"></div>');$alert.append(""+(args.title?"<h2>"+args.title+"</h2>":"")+'<div class="content">'+content+"</div>");args.className="m-notification-alert-modal"+(args.className?" "+args.className:"");$alert.append(['<div class="confirm-btns-wrap">',args.type==="confirm"?'<a class="m-br-button m-br-button--sm m-br-button--secondary" data-click="m-modal-hide">'+i18n.gettext("取消")+"</a>":"",'<a class="m-br-button m-br-button--sm m-br-button--primary alert-confirm-btn" data-click="m-modal-ok">',args.yesText||i18n.gettext("確定"),"</a>","</div>"].join(""));if(!exports.isShown){$modal.appendTo(document.body)}$modal.off("click").on("click","[data-click]",function(evt){var action=$(evt.target).data("click");switch(action){case"m-modal-ok":var isValid=args.confirmCb();if(!isValid&&typeof isValid==="boolean"){break}hide();break;case"m-modal-hide":args.onHideCb();hide();break;case"customer-service":cs.disableHelpCenter().show();hide();break}});$modal.off(".uiAlertModal");if(args.withBackdrop!==false){var config={isBlack:args.blackBackdrop||false,className:args.className||""};backdropIsShown=true;alertModalBackdrop.show(config)}$modal.attr("class","m-modal-desktop-wrap "+(args.className||""));$modalBody.html($alert);rePosition(true);var bodyScrollTop=$body.scrollTop;$modal.css({top:bodyScrollTop-50,opacity:0}).show();var modalHeight=$modal.height();var t=bodyScrollTop+($(window).height()-modalHeight)/2;var isOverflow=document.documentElement.clientHeight<modalHeight;t=isOverflow?bodyScrollTop+10:t<0?0:t;$modal.css({top:t,opacity:1});document.documentElement.style.overflow="hidden";exports.isShown=true;$(window).on("resize.uiAlertModal",function(){rePosition()});return exports};var show=function(content,args){queue.push(function(){return _show(content,args)});if(queue.length===1){queue[0]()}return exports};var nextToShow=function(content,args){if(!queue.length){return show(content,args)}if(queue.length>=1){queue.splice(1,0,function(){return _show(content,args)})}return exports};var on=function(evtType,selector,evtHandler){var _evtType=evtType.split(" ");var modifiedEvtType=[];for(var i=0,l=_evtType.length;i<l;++i){if(_evtType[i]){modifiedEvtType.push(_evtType[i]+".uiAlertModal")}}$modal.on(modifiedEvtType.join(" "),selector,evtHandler);return exports};var error=function(errMsg,args){errMsg=errMsg||_.template(i18n.gettext("系統發生意外狀況...請重新整理網頁之後再試一次或稍後再試，或<a <%= scriptCallUservoice %>>按我直接連絡站方客服協助</a>！"),{scriptCallUservoice:'data-click="customer-service"'});show(errMsg,args);return exports};exports.show=show;exports.nextToShow=nextToShow;exports.hide=hide;exports.on=on;exports.rePosition=rePosition;exports.error=error;exports.$body=$modalBody;return exports});define("ui/notification/alertModalBackdrop",function(require,exports,model){"use strict";var transitionend=require("css/transitionend");var $backdrop=$('<div class="m-backdrop" style="display:none;"></div>');var _onhide=$.noop;var isShown=false;var inTransition=false;var transitionDeferred;exports.show=function(opt_args){opt_args=opt_args||{};if(isShown||isShown&&inTransition){return false}$backdrop.appendTo(document.body);inTransition=true;transitionDeferred=$.Deferred();transitionend($backdrop,function(){isShown=true;inTransition=false;transitionDeferred.resolve(isShown)});$backdrop.attr("class",opt_args.className?"m-backdrop "+opt_args.className:"m-backdrop");$backdrop[opt_args.loader?"addClass":"removeClass"]("with-loader");$backdrop.show();$backdrop.width();$backdrop.css({opacity:1});if(opt_args.isBlack){$backdrop.addClass("m-backdrop-black");$backdrop.css({opacity:.5})}if(opt_args.anywhereHide){$backdrop.one("click",function(){exports.hide()})}return exports};exports.hide=function(){if(isShown){inTransition=true;transitionDeferred=$.Deferred();transitionend($backdrop,function(){isShown=false;inTransition=false;$backdrop.remove();transitionDeferred.resolve(isShown)})}$backdrop.css({opacity:0}).off(".uiNotificationAlertModalBackdrop");$backdrop.width();if(!isShown){$backdrop.remove()}_onhide();_onhide=$.noop;return exports};exports.offclick=function(){$backdrop.off("click.uiNotificationAlertModalBackdrop");return exports};exports.onclick=function(cb){$backdrop.on("click.uiNotificationAlertModalBackdrop",function(evt){cb()});return exports};exports.onhide=function(cb){_onhide=cb;return exports};exports.isShown=function(){if(!inTransition){transitionDeferred=$.Deferred();transitionDeferred.resolve(isShown);return transitionDeferred}else{return transitionDeferred}}});define("ui/notification/bar",function(require,exports){"use strict";var settings=require("settings");var _=require("underscore");var transitionend=require("css/transitionend");var requestAnimation=require("ui/requestAnimation");var _$notificationWrap=$("#m-notification-wrap");var notificationWrap='<div id="m-notification-wrap" class="m-notification-wrap"></div>';var $notificationWrap=_$notificationWrap.length?_$notificationWrap:"";var barWrapTpl='<div class="bar-wrap"></div>';var barTpl=['<div class="bar">','<span class="<%= type %>"><%= content %></span>','<a class="bar-btn-close">X</a>',"</div>"].join("");var barsCount=0;if(!_$notificationWrap.length){$(document.body).append(notificationWrap);$notificationWrap=$("#m-notification-wrap")}var _hide=function($el,args){if(typeof $el==="undefined"){throw new Error("$el argument is required")}args=_.extend({className:"hide",transitionendCb:function(){return true}},args);transitionend($el,args.transitionendCb);requestAnimation(function(){$el.addClass(args.className)})};exports.show=function(content,args){if(!content){throw new Error("content paramter is required")}args=_.extend({type:"success"},args);_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var $bar=$(_.template(barTpl,{type:args.type,content:content}));var $barWrap="";if(!$bar.selector){$barWrap=$(barWrapTpl).append($bar.get())}else{$barWrap=$(barWrapTpl).append($bar)}if(!settings.get("mobile")&&barsCount>=1){var _$barWrapFirst=$notificationWrap.find(".bar-wrap:first-child");clearTimeout(_$barWrapFirst.find(".bar").data("hideSetTimeout"));_$barWrapFirst.remove();barsCount--}$bar.find(".bar-btn-close").on("click",function(e){
e.preventDefault();$bar.remove()});if(!$barWrap.selector){$notificationWrap.append($barWrap.get())}else{$notificationWrap.append($barWrap)}barsCount++;requestAnimation(function(){if(settings.get("mobile")){setTimeout(function(){_hide($bar,{transitionendCb:function(){$barWrap.remove();barsCount--}})},3e3)}else{$bar.data("hideSetTimeout",setTimeout(function(){_hide($bar,{transitionendCb:function(){$barWrap.remove();barsCount--}})},3e3))}requestAnimation(function(){$bar.addClass("show")})})};exports.hideAll=function(){barsCount=0;_hide($notificationWrap,{transitionendCb:function(){$notificationWrap.empty().removeClass("hide")}})};return exports});define("ui/notification/fixedModal",function(require,exports){"use strict";var _=require("underscore");var doc=require("dom/doc");var settings=require("settings");var $modalBody=$('<div class="m-fixed-modal-body"></div>');var $modal=$('<div class="m-fixed-modal-wrap" style="display:none;"></div>');$modal.append($modalBody);exports.isShown=false;exports.isAppended=false;var hide=function(){if(!exports.isShown){return exports}$modal.hide();return exports};var show=function(content,args){if(!content||typeof content!=="string"){throw new Error("content paramter is required and should be a string")}if(!args||_.isUndefined(args.top)&&_.isUndefined(args.bottom)){throw new Error("top or bottom is required")}args=_.extend({title:"",confirmCb:function(){return true},onHideCb:function(){return true}},args);var modalType=!_.isUndefined(args.top)&&args.top!=="auto"?"s-fixed-modal-top":"s-fixed-modal-bottom";if(args.top===0){modalType="s-fixed-modal-top-0"}var $alert=$('<div class="alert"></div>');var isMobile=settings.get("mobile");var crossMarkup='<div class="m-fixed-modal-cross" data-click="m-modal-hide"></div>';var buttonMarkup=['<div class="confirm-btns-wrap">',"<% if (buttonText.cancelText) { %>",'<a class="m-br-button m-br-button--secondary '+(isMobile?"m-br-button--sm":"m-br-button--lg"),'" data-click="m-modal-hide">',"<%= buttonText.cancelText %>","</a>","<% } %>",'<a class="m-br-button m-br-button--primary alert-confirm-btn '+(isMobile?"m-br-button--sm":"m-br-button--lg"),'" data-click="m-modal-ok">',"<%= buttonText.confirmText %>","</a>","</div>"].join("");args.content=content;$alert.append(_.template(['<h2><%= title ? title : "" %></h2>','<div class="content"><%= content %></div>'].join(""),args));if(args.crossVisible){$modal.append(crossMarkup)}if(args.type==="confirm"){$alert.append(_.template(buttonMarkup,args))}if(!exports.isAppended){$modal.appendTo(doc.getScrollingBody());exports.isAppended=true}$modal.off("click").on("click","[data-click]",function(evt){var action=$(evt.target).data("click");switch(action){case"m-modal-ok":var isValid=args.confirmCb();if(isValid===false){break}hide();break;case"m-modal-hide":args.hideCb&&args.hideCb();hide();break}});$modalBody.html($alert);$modal.attr("data-position-style",modalType).attr("data-drag-hide",true).addClass("s-animated").css({position:"fixed",bottom:_.isUndefined(args.bottom)?"auto":args.bottom,top:_.isUndefined(args.top)?"auto":args.top,zIndex:1000200,opacity:1}).show();exports.isShown=true;$modal.removeClass("s-animated");return exports};exports.show=show;exports.hide=hide;return exports});define("ui/notification/warningBar",function(require,exports){"use strict";var _=require("underscore");var $insertPoint=$("#gheader");exports.show=function(content,optArgs){if(!content){throw new Error("content is not defined")}optArgs=optArgs||{};var $bar=$('<div class="m-warning-bar"><span class="close" data-click="close"></span></div>');$bar.append('<div class="content">'+_.template(content,optArgs)+"</div>");if(optArgs.button){$bar.append(_.template('<div class="button-wrapper"><a class="button" data-click="button" href="<%= link ? link : "#"%>"><%= text %></a></div>',optArgs.button))}$bar.on("click","[data-click]",function(e){var $eT=$(e.currentTarget);var action=$eT.data("click");if(action==="close"){$bar.remove();if(optArgs.button&&optArgs.button.cb){optArgs.button.cb()}}else if($eT.is("a")&&action==="button"){e.preventDefault();if(optArgs.button&&optArgs.button.cb){optArgs.button.cb()}if(optArgs.button&&optArgs.button.link){location.href=optArgs.button.link}}});$bar.insertBefore($insertPoint)};return exports});define("utils/idPattern",function(require,exports){var checkIdPattern=function(id){var tab="ABCDEFGHJKLMNPQRSTUVXYWZIO";var A1=[1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,3];var A2=[0,1,2,3,4,5,6,7,8,9,0,1,2,3,4,5,6,7,8,9,0,1,2,3,4,5];var Mx=[9,8,7,6,5,4,3,2,1,1];if(id.length!==10){return false}var i=tab.indexOf(id.charAt(0));if(i===-1){return false}var sum=A1[i]+A2[i]*9;for(var i=1;i<10;i++){var v=parseInt(id.charAt(i));if(isNaN(v)){return false}sum=sum+v*Mx[i]}if(sum%10!==0){return false}return true};exports.check=checkIdPattern;return exports});define("utils/Lazy",function(require,exports){"use strict";var React=require("React");var ReactDom=require("ReactDOM");var PropTypes=require("prop-types");var _=require("underscore");var doc=require("dom/doc");var rAF=require("ui/requestAnimation");var rAFCancel=function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame||window.oCancelAnimationFrame||function(requestID){clearTimeout(requestID)}}();function transitionEndEventName(){var i,el=document.createElement("div"),transitions={transition:"transitionend",OTransition:"otransitionend",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(i in transitions){if(transitions.hasOwnProperty(i)&&el.style[i]!==undefined){return transitions[i]}}}function on(el,eventName,callback,opts){opts=opts||false;if(el.addEventListener){el.addEventListener(eventName,callback,opts)}else if(el.attachEvent){el.attachEvent("on"+eventName,function(e){callback.call(el,e||window.event)})}}function off(el,eventName,callback,opts){opts=opts||false;if(el.removeEventListener){el.removeEventListener(eventName,callback,opts)}else if(el.detachEvent){el.detachEvent("on"+eventName,callback)}}var defaultBoundingClientRect={top:0,right:0,bottom:0,left:0,width:0,height:0};var LISTEN_FLAG="data-lazyload-listened";var listeners=[];var isWindowScrollBind=false;var pending=[];var passiveEventSupported=false;try{var opts=Object.defineProperty({},"passive",{get:function(){passiveEventSupported=true}});window.addEventListener("test",null,opts)}catch(e){}var getPassiveEvent=function(useCapture){return passiveEventSupported?{capture:useCapture,passive:true}:useCapture};var handleSwitchVisible=function(visible,component){if(visible){if(!component.visible){if(component.props.once){pending.push(component)}component.visible=true;component.props.onVisible&&component.props.onVisible();component.forceUpdate()}}else if(!(component.props.once&&component.visible)){component.visible=false;if(component.props.unmountIfInvisible){component.forceUpdate()}}};var checkOverflowVisible=function(component,parent){var node=ReactDom.findDOMNode(component);var parentTop=void 0;var parentHeight=void 0;var parentLeft=void 0;var parentWidth=void 0;try{var _parent$getBoundingCl=parent.getBoundingClientRect();parentTop=_parent$getBoundingCl.top;parentHeight=_parent$getBoundingCl.height;parentWidth=_parent$getBoundingCl.width;parentLeft=_parent$getBoundingCl.left}catch(e){parentTop=defaultBoundingClientRect.top;parentHeight=defaultBoundingClientRect.height;parentLeft=defaultBoundingClientRect.left;parentWidth=defaultBoundingClientRect.width}var windowInnerHeight=window.innerHeight||document.documentElement.clientHeight;var windowInnerWidth=window.innerWidth||document.documentElement.clientWidth;var intersectionTop=Math.max(parentTop,0);var intersectionLeft=Math.max(parentLeft,0);var intersectionHeight=Math.min(windowInnerHeight,parentTop>0?parentTop+parentHeight:parentHeight)-intersectionTop;var intersectionWidth=Math.min(windowInnerWidth,parentLeft>0?parentLeft+parentWidth:parentWidth)-intersectionLeft;var top=void 0;var height=void 0;var left=void 0;var width=void 0;try{var _node$getBoundingClie=node.getBoundingClientRect();top=_node$getBoundingClie.top;height=_node$getBoundingClie.height;width=_node$getBoundingClie.width;left=_node$getBoundingClie.left}catch(e){top=defaultBoundingClientRect.top;height=defaultBoundingClientRect.height;left=defaultBoundingClientRect.left;width=defaultBoundingClientRect.width}var offsetTop=top-intersectionTop;var offsetLeft=left-intersectionLeft;var offsets=Array.isArray(component.props.offset)?component.props.offset:[component.props.offset,component.props.offset];var isVisibleLeft=offsets[0]>0?offsetLeft-offsets[0]<=intersectionWidth&&offsetLeft+width+offsets[0]>=0:offsetLeft-offsets[0]<=intersectionWidth&&offsetLeft+width-offsets[0]>=0;var isVisibleTop=offsets[1]>0?offsetTop-offsets[1]<=intersectionHeight&&offsetTop+height+offsets[1]>=0:offsetTop-offsets[1]<=intersectionHeight&&offsetTop+height-offsets[1]>=0;return isVisibleLeft&&isVisibleTop};var checkNormalVisible=function(component){var node=ReactDom.findDOMNode(component);if(!(node.offsetWidth||node.offsetHeight||node.getClientRects().length)){return false}var top=void 0;var elementHeight=void 0;try{var _node$getBoundingClie2=node.getBoundingClientRect();top=_node$getBoundingClie2.top;elementHeight=_node$getBoundingClie2.height}catch(e){top=defaultBoundingClientRect.top;elementHeight=defaultBoundingClientRect.height}var windowInnerHeight=window.innerHeight||document.documentElement.clientHeight;var offsets=Array.isArray(component.props.offset)?component.props.offset:[component.props.offset,component.props.offset];return top-offsets[0]<=windowInnerHeight&&top+elementHeight+offsets[1]>=0};var checkVisible=function(component){var node=ReactDom.findDOMNode(component);if(!(node instanceof HTMLElement)){return}var parent=component.parent;var overflow=component.overflow;var visible=overflow?checkOverflowVisible(component,parent):checkNormalVisible(component);handleSwitchVisible(visible,component)};var purgePending=function(){pending.forEach(function(component){var index=listeners.indexOf(component);if(index!==-1){listeners.splice(index,1)}});pending=[]};var lazyLoadHandler=function(e){if(!e){return}for(var i=0;i<listeners.length;++i){var listener=listeners[i];if(!listener){return}checkVisible(listener)}purgePending()};var finalLazyLoadHandler=null;var isString=function(string){return typeof string==="string"};var LazyLoad=function(_React$PureComponent){_inherits(LazyLoad,_React$PureComponent);function LazyLoad(props){_classCallCheck(this,LazyLoad);var _this2=_possibleConstructorReturn(this,(LazyLoad.__proto__||Object.getPrototypeOf(LazyLoad)).call(this,props));_this2.bindLazy=function(){if(_this2.bind){return}var _this2$props=_this2.props,lazyContainer=_this2$props.lazyContainer,throttle=_this2$props.throttle,resize=_this2$props.resize;var overflow=lazyContainer!==undefined;if(!isString(lazyContainer)){if(overflow&&(lazyContainer==null||!lazyContainer.current)){if(_this2.tryGetParentCount<1){_this2.tryGetLazyContainer=rAF(function(){_this2.bindLazy()});_this2.tryGetParentCount++;return}else{console.log("ERROR: lazyContainer get failure. lazyContainer replace to document");overflow=false}}}_this2.bind=true;_this2.overflow=overflow;if("IntersectionObserver"in window){var component=_this2;var lazyNode=ReactDom.findDOMNode(_this2);var offsets=Array.isArray(_this2.props.offset)?_this2.props.offset:[_this2.props.offset,_this2.props.offset];var option={rootMargin:offsets[1]+"px 0px 0px "+offsets[0]+"px"};_this2.lazyImageObserver=new IntersectionObserver(function(entries,observer){var visible=entries[0].isIntersecting;if(visible&&_this2.props.once){_this2.lazyImageObserver.unobserve(lazyNode)}handleSwitchVisible(visible,component)},option);_this2.lazyImageObserver.observe(lazyNode)}else{var node=ReactDom.findDOMNode(_this2);if(_this2.overflow){if(isString(lazyContainer)){lazyContainer=$(node).parents().find(lazyContainer)[0]}else{lazyContainer=lazyContainer.current&&ReactDom.findDOMNode(lazyContainer.current)}}var _parent=_this2.overflow?lazyContainer:doc.getScrollingBody();_this2.parent=_parent;var listenerCount=1+ +($(_parent).attr(LISTEN_FLAG)||0);finalLazyLoadHandler=throttle>0?_.throttle(lazyLoadHandler,_this2.props.throttle,{leading:true}):lazyLoadHandler;if(_this2.overflow){if(listenerCount===1){on(_parent,"scroll",finalLazyLoadHandler,_this2.passiveEvent);on(_parent,transitionEndEventName(),lazyLoadHandler,true)}$(_parent).attr(LISTEN_FLAG,listenerCount)}if(!isWindowScrollBind){scroll&&on(window,"scroll",finalLazyLoadHandler,getPassiveEvent(false));resize&&on(window,"resize",finalLazyLoadHandler,getPassiveEvent(false));isWindowScrollBind=true}listeners.push(_this2)}checkVisible(_this2)};_this2.visible=false;_this2.bind=false;_this2.overflow=false;_this2.tryGetLazyContainer=null;_this2.tryGetParentCount=0;_this2.passiveEvent=getPassiveEvent(_this2.props.scrollUseCapture);return _this2}_createClass(LazyLoad,[{key:"componentDidMount",value:function componentDidMount(){this.bindLazy()}},{key:"componentWillUnmount",value:function componentWillUnmount(){this.tryGetLazyContainer&&rAFCancel(this.tryGetLazyContainer);if(this.bindEnd){pending.push(this)}if("IntersectionObserver"in window){var lazyNode=ReactDom.findDOMNode(this);this.lazyImageObserver&&this.lazyImageObserver.unobserve(lazyNode)}else{if(this.props.overflow){var _parent2=this.parent;if(_parent2&&typeof _parent2.getAttribute==="function"){var listenerCount=+$(_parent2).attr(LISTEN_FLAG)-1;if(listenerCount===0){off(_parent2,"scroll",finalLazyLoadHandler,this.passiveEvent);off(_parent2,transitionEndEventName(),lazyLoadHandler,true);$(_parent2).attr(LISTEN_FLAG,0)}else{$(_parent2).attr(LISTEN_FLAG,listenerCount)}}}var index=listeners.indexOf(this);if(index!==-1){listeners.splice(index,1)}if(listeners.length===0){off(window,"resize",finalLazyLoadHandler,getPassiveEvent(false));off(window,"scroll",finalLazyLoadHandler,getPassiveEvent(false));isWindowScrollBind=false}}}},{key:"render",value:function render(){return this.visible?this.props.children:this.props.placeholder?this.props.placeholder:React.createElement("span",{style:{width:this.props.width||"auto",height:this.props.height||"auto",display:"inline-block"},className:"m-react-lazyload-placeholder"},React.createElement("img",{src:"//cdn04.pinkoi.com/pinkoi.site/space.gif",alt:"space",style:{width:"100%",height:this.props.height||"auto"}}))}}]);return LazyLoad}(React.PureComponent);LazyLoad.propTypes={once:PropTypes.bool,height:PropTypes.oneOfType([PropTypes.number,PropTypes.string]),offset:PropTypes.oneOfType([PropTypes.number,PropTypes.arrayOf(PropTypes.number)]),resize:PropTypes.bool,scroll:PropTypes.bool,children:PropTypes.node,throttle:PropTypes.oneOfType([PropTypes.number,PropTypes.bool]),placeholder:PropTypes.node,onVisible:PropTypes.func,lazyContainer:PropTypes.oneOfType([PropTypes.string,PropTypes.object]),scrollUseCapture:PropTypes.bool,unmountIfInvisible:PropTypes.bool};LazyLoad.defaultProps={once:true,offset:0,throttle:200,overflow:false,resize:false,scroll:true,scrollUseCapture:false,unmountIfInvisible:false};exports.LazyLoad=LazyLoad;exports.forceCheck=lazyLoadHandler});define("utils/campaign",function(require,exports){"use strict";var _=require("underscore");var cookie=require("net/cookie");var tidsMaxLen=20;var tag=function(campaignName,expireS){cookie.set("campaign",campaignName,expireS+"S")};var tagOrder=function(name,tid,expireS){if(!name||!tid||!expireS){return}expireS=expireS||600;var currentTs=parseInt(+new Date/1e3);var campaignData=cookie.get("c");if(campaignData){campaignData=JSON.parse(campaignData)}else{campaignData={}}if(!campaignData[name]){campaignData[name]={t:[],s:currentTs+expireS}}campaignData[name].t.unshift(tid);campaignData[name].t=_.uniq(campaignData[name].t);if(campaignData[name].t.length>tidsMaxLen){campaignData[name].t.length=tidsMaxLen}for(var name in campaignData){if(campaignData.hasOwnProperty(name)){if(currentTs>campaignData[name].s){delete campaignData[name]}}}cookie.set("c",JSON.stringify(campaignData),60*60*24*60+"S")};exports.tag=tag;exports.tagOrder=tagOrder});define("utils/date",function(require,exports){"use strict";var _=require("underscore");var settings=require("settings");var template=require("utils/template");var number=require("utils/number");var datetime=require("utils/datetime");var i18n=require("i18n");var locale=settings.get("locale");var geo=settings.get("geo");function timespanRaw(timestamp){if(timestamp instanceof Date){timestamp=timestamp.getTime()/1e3}else{timestamp=parseInt(timestamp,10)}var now=new Date;var secondDelta=now.getTime()/1e3-timestamp;secondDelta=secondDelta<0?0:secondDelta;var dayDelta=Math.floor(secondDelta/86400);if(dayDelta){if(dayDelta<7){return{type:"day",s:dayDelta}}else if(dayDelta>=7&&dayDelta<30){return{type:"week",s:Math.floor(dayDelta/7)}}else if(dayDelta<365&&dayDelta>=30){return{type:"month",s:Math.floor(dayDelta/30)}}else{return{type:"year",s:Math.floor(dayDelta/365)}}}else if(secondDelta){if(secondDelta<60){return{type:"second",s:Math.floor(secondDelta)}}else if(secondDelta<3600&&secondDelta>=60){return{type:"minute",s:Math.floor(secondDelta/60)}}else{return{type:"hour",s:Math.floor(secondDelta/3600)}}}else{return{type:"second",s:1}}}function timespan(timestamp,template){template=template||{};var result=timespanRaw(timestamp);var defaultTemplate={year:i18n.gettext("<%= s %> 年前"),month:i18n.gettext("<%= s %> 個月前"),week:i18n.gettext("<%= s %> 周前"),day:i18n.gettext("<%= s %> 天前"),hour:i18n.gettext("<%= s %> 小時前"),minute:i18n.gettext("<%= s %> 分鐘前"),second:i18n.gettext("<%= s %> 秒前")};return _.template(template[result.type]||defaultTemplate[result.type],{s:result.s})}function strftime(date,opt_format){var _date=date*1e3;if(typeof date==="number"){date=new Date(date*1e3)}var parts={Y:date.getFullYear(),m:number.zeroPad(date.getMonth()+1,2),d:number.zeroPad(date.getDate(),2),H:number.zeroPad(date.getHours(),2),i:number.zeroPad(date.getMinutes(),2),s:number.zeroPad(date.getSeconds(),2)};if(opt_format){return template(opt_format,parts)}if(locale==="zh_TW"||locale==="zh_CN"||locale==="ja"){if(geo==="MO"||geo==="HK"){return template("%(d)s/%(m)s/%(Y)s %(H)s:%(i)s",parts)}return template("%(Y)s/%(m)s/%(d)s %(H)s:%(i)s",parts)}else if(locale==="th"){return template("%(d)s/%(m)s/%(Y)s %(H)s:%(i)s",parts)}else{datetime.setLocale("en");return datetime.format("%H:%M:%S %b. %d, %Y",_date)}}var timeToEndOfDayInSec=function(){var current=new Date,tomorrow=new Date,gap;tomorrow.setDate(current.getDate()+1);tomorrow.setHours(0,0,0);gap=tomorrow.valueOf()-current.valueOf();return Math.floor(gap/1e3)};var dayDiff=function(endDateTS,startDateTS){if(!endDateTS||!startDateTS){return 0}return Math.ceil((endDateTS.getTime()-startDateTS.getTime())/(1e3*3600*24))};exports.timespan=timespan;exports.strftime=strftime;exports.timeToEndOfDayInSec=timeToEndOfDayInSec;exports.dayDiff=dayDiff});define("utils/dateExtend",function(require){"use strict";var settings=require("settings");var dateUtil=require("utils/date");var datetime=require("utils/datetime");var l10nFormat=/LT|L{1,4}/g;var formats={en:{LT:"%H:%M",L:"%Y/%m/%d",LL:"%Y/%m/%d (%a)",LLL:"%Y/%m/%d %H:%M",LLLL:"%Y/%m/%d (%a) %H:%M"},en_US:{LT:"%H:%M",L:"%m/%d/%Y",LL:"%m/%d/%Y (%a)",LLL:"%m/%d/%Y %H:%M",LLLL:"%m/%d/%Y (%a) %H:%M"},zh_TW:{LT:"%H:%M",L:"%Y/%m/%d",LL:"%Y/%m/%d (%a)",LLL:"%Y/%m/%d %H:%M",LLLL:"%Y/%m/%d (%a) %H:%M"},zh_HK:{LT:"%H:%M น.",L:"%d/%m/%Y",LL:"%d/%m/%Y (%a)",LLL:"%d/%m/%Y %H:%M",LLLL:"%d/%m/%Y (%a) %H:%M"},th:{LT:"%H:%M น.",L:"%d/%m/%Y",LL:"%d/%m/%Y (%a)",LLL:"%d/%m/%Y %H:%M น.",LLLL:"%d/%m/%Y (%a) %H:%M น."},ja:{LT:"%H:%M",L:"%Y/%m/%d",LL:"%Y/%m/%d (%a)",LLL:"%Y/%m/%d %H:%M",LLLL:"%Y/%m/%d (%a) %H:%M"}};var strftime=function(date,format,options){options=options||{};var _date;if(date instanceof Date){_date=date}else if(typeof date==="number"){_date=new Date(parseInt(date,10)*1e3)}else{throw Error("[strftime]: date should be `Date` or `number`")}var LOCALE=settings.get("locale");var LANG=settings.get("lang");var GEO=settings.get("geo");if(format&&l10nFormat.test(format)){var targetFormat={};switch(true){case LANG==="zh_HK":case LANG==="ja":case LANG==="th":targetFormat=formats[LANG];break;case LANG==="zh_TW":case LANG==="zh_CN":targetFormat=GEO==="US"?formats.en_US:formats.zh_TW;break;case LANG==="en":if(GEO==="US"){targetFormat=formats.en_US}else if(["HK","MO","TH"].indexOf(LANG)!==-1){targetFormat=formats.zh_HK}else{targetFormat=formats.en}}var localizedFormat=format.replace(l10nFormat,function(match){return targetFormat[match]});datetime.setLocale(LANG);return datetime.format(localizedFormat,_date)}var hasTime=options.hasTime!==undefined?!!options.hasTime:true;if(LOCALE==="en"){var dateFormat;var timeFormat=hasTime?" %H:%M":"";if(GEO==="CA"){dateFormat="%Y-%m-%d"}else if(GEO==="US"){dateFormat="%m-%d-%Y"}else{dateFormat="%d-%m-%Y"}return datetime.format(dateFormat+timeFormat,_date)}else{var formattedDate=dateUtil.strftime(_date,format);if(hasTime){return formattedDate.replace(/\//g,"-")}else{return formattedDate.split(" ")[0].replace(/\//g,"-")}}};return{timespan:dateUtil.timespan,strftime:strftime,timeToEndOfDayInSec:dateUtil.timeToEndOfDayInSec}});define("utils/datetime",function(require,exports){var settings=require("settings");var format=require("utils/format");var datetime={};var _ISO8601_PYDTF_RE=/(\d{4})-?(\d{2})?-?(\d{2})?[T ]?(\d{2})?:?(\d{2})?:?(\d{2})?(?:\.(\d+))?(Z|[+-]\d{2})?:?(\d{2})?/;datetime.parseISOString=function(s){if(typeof s!=="string"){return new Date(NaN)}var m=_ISO8601_PYDTF_RE.exec(s);if(m===null){return new Date(NaN)}var date=new Date(0);date.setUTCFullYear(m[1]||0);date.setUTCMonth((m[2]||1)-1);date.setUTCDate(m[3]||1);date.setUTCHours(m[4]||0);date.setUTCMinutes(m[5]||0);date.setUTCSeconds(m[6]||0);date.setUTCMilliseconds(("0."+(m[7]||0))*1e3);if(m[8]!=="Z"){if(m[8]||m[9]){date.setUTCHours(date.getUTCHours()-(m[8]||0)*1,date.getUTCMinutes()-(m[9]||0)*(-1+2*(m[8]>=0)))}else if(m[4]){date.setUTCMinutes(date.getUTCMinutes()+(new Date).getTimezoneOffset())}}return date};datetime.parse=function(s){if(s instanceof Date){return s}var date=datetime.parseISOString(s);if(!isNaN(date)){return date}return new Date(s)};var _zh_localeWeekdayAbbrNames=["日","一","二","三","四","五","六"];var _zh_localeMonthAbbrNames=[" 1"," 2"," 3"," 4"," 5"," 6"," 7"," 8"," 9","10","11","12"];var _zh_localeMonthNames=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];var _zh_localePeriodNames=["上午","下午"];var _en_localePeriodNames=["AM","PM"];datetime.localeWeekdayAbbrNames={zh_TW:_zh_localeWeekdayAbbrNames,zh_HK:_zh_localeWeekdayAbbrNames,zh_CN:_zh_localeWeekdayAbbrNames,en:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],ja:["日","月","火","水","土","金","木"],th:["อา","จ","อ","พ","พฤ","ศ","ส"]};datetime.localeWeekdayNames={zh_TW:["週日","週一","週二","週三","週四","週五","週六"],zh_HK:["週日","週一","週二","週三","週四","週五","週六"],zh_CN:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"],en:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],ja:["日曜日","月曜日","火曜日","水曜日","土曜日","金曜日","木曜日"],th:["อาทิตย์","จันทร์","อังคาร","พุธ","พฤหัสบดี","ศุกร์","เสาร์"]};datetime.localeMonthAbbrNames={zh_TW:_zh_localeMonthAbbrNames,zh_HK:_zh_localeMonthAbbrNames,zh_CN:_zh_localeMonthAbbrNames,en:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],ja:_zh_localeMonthAbbrNames,th:["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."]};datetime.localeMonthNames={zh_TW:_zh_localeMonthNames,zh_HK:_zh_localeMonthNames,zh_CN:_zh_localeMonthNames,en:["January","February","March","April","May","June","July","August","September","October","November","December"],ja:_zh_localeMonthNames,th:["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฏาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"]};datetime.localePeriodNames={zh_TW:_zh_localePeriodNames,zh_HK:_zh_localePeriodNames,zh_CN:_zh_localePeriodNames,en:_en_localePeriodNames,ja:_en_localePeriodNames,th:_en_localePeriodNames};datetime.locale=settings.get("lang")||"zh_TW";datetime.setLocale=function(locale){if(!locale){return locale}datetime.locale=locale;return locale};datetime.setLocale(datetime.locale);datetime.getLocale=function(){return datetime.locale};function _getFirstDateOfYear(date){return new Date(date.getFullYear(),0,1)}function _minus(date,base){return date.getTime()-base.getTime()}function _getDayOfYear(date,firstDateOfYear){return Math.floor(_minus(date,firstDateOfYear?firstDateOfYear:_getFirstDateOfYear(date))/(1e3*60*60*24))+1}function _getWeekOfYear(date,isWeekStartsOnMonday){var firstDate=_getFirstDateOfYear(date);var firstWeekDay=firstDate.getDay();var dayOfYear=_getDayOfYear(date,firstDate);return Math.floor((dayOfYear-1+(7+firstWeekDay-isWeekStartsOnMonday)%7)/7)+1*(firstWeekDay==isWeekStartsOnMonday)}function _splitTimezoneOffset(date){var offset=date.getTimezoneOffset();var sign=offset<0?"+":"-";offset=Math.abs(offset);var hour=Math.floor(offset/60);var min=offset%60;return[sign,hour,min]}var _DIRECTIVE_RE=/%(.)/g;datetime.format=function(template,date,disable_pad){if(!(date instanceof Date)){date=datetime.parse(date)}var pad;if(disable_pad){pad=function(c,w,s){return s}}else{pad=format.pad}return template.replace(_DIRECTIVE_RE,function(directive,c){switch(c){case"a":return datetime.localeWeekdayAbbrNames[datetime.locale][date.getDay()];case"A":return datetime.localeWeekdayNames[datetime.locale][date.getDay()];case"w":return date.getDay();case"d":return pad("0",2,date.getDate());case"b":return datetime.localeMonthAbbrNames[datetime.locale][date.getMonth()];case"B":return datetime.localeMonthNames[datetime.locale][date.getMonth()];case"m":return pad("0",2,date.getMonth()+1);case"y":return date.getYear();case"Y":return date.getFullYear();case"H":return pad("0",2,date.getHours());case"I":return pad("0",2,date.getHours()%12||12);case"p":return datetime.localePeriodNames[datetime.locale][(date.getHours()>=12)*1];case"M":return pad("0",2,date.getMinutes());case"S":return pad("0",2,date.getSeconds());case"f":return pad("0",3,date.getMilliseconds());case"z":var tzparts=_splitTimezoneOffset(date);return tzparts[0]+pad("0",2,tzparts[1])+pad("0",2,tzparts[2]);case"Z":return"UTC";case"j":return pad("0",3,_getDayOfYear(date));case"U":return pad("0",2,_getWeekOfYear(date,false));case"W":return pad("0",2,_getWeekOfYear(date,true));case"c":return date.toLocaleString();case"x":return date.toLocaleDateString();case"X":return date.toLocaleTimeString();default:return c}})};return datetime});define("utils/decodeHTMLEntities",function(){"use strict";var div=document.createElement("div");return function(content){if(content===undefined||content===true||content===false){return""}else{div.innerHTML=content;return div.textContent}}});define("utils/entity",function(){"use strict";return function(str){return str.replace(/&#39;/g,"'")}});define("utils/erbTemplate",function(require,exports){"use strict";var _=require("underscore");var erb=function(mapping){this.cache={};this.mapping=mapping};erb.prototype={generate:function(keyOrTpl,data){var templateString;var compiledTpl=this.cache[keyOrTpl];if(!compiledTpl){templateString=this.mapping[keyOrTpl];if(!templateString){templateString=keyOrTpl}compiledTpl=_.template(templateString,null,{variable:"$scope"});this.cache[keyOrTpl]=compiledTpl}return compiledTpl(data)}};return erb});define("utils/findIndex",function(require){"use strict";var _=require("underscore");return function(array,predicate){if(!_.isArray(array)){return-1}var length=array.length;var index=0;while(index<length){if(predicate(array[index])){return index}index++}return-1}});define("utils/format",function(require,exports){var _=require("underscore");var settings=require("settings");var format={};format.defaultCurrencyPattern="¤ #,###.##";format.pad=function(c,w,s){if(typeof s!=="string"){s=s.toString()}for(var i=w-s.length;i>0;i--){s=c+s}return s};format.localized=function(number,digits,currencySymbol,optTpl){if(!digits){digits=0}if(typeof number==="undefined"||(typeof number==="undefined"?"undefined":_typeof(number))==="object"){throw Error("the number is required")}var pattern=settings.get("currencyPattern")||format.defaultCurrencyPattern;var isSymbolTrailing=pattern.indexOf("¤")>pattern.lastIndexOf("#");var useCommaAsThousandsSeparator=pattern.indexOf(",")<pattern.indexOf(".");var decimalLength=digits;var blankSpace=" ";var separatorRegEx=/(\d)(?=(\d{3})+(?!\d))/g;currencySymbol=currencySymbol||"";if(typeof number==="number"){number=number.toFixed(decimalLength);number=number.toString()}if(!useCommaAsThousandsSeparator){number=number.replace(".",",")}number=number.replace(separatorRegEx,useCommaAsThousandsSeparator?"$1,":"$1.");if(optTpl){if(optTpl.symbol&&Boolean(currencySymbol)){currencySymbol=_.template(optTpl.symbol,{symbol:currencySymbol})}if(optTpl.number){number=_.template(optTpl.number,{number:number})}}if(!currencySymbol){return number}return isSymbolTrailing?[number,currencySymbol].join(blankSpace):[currencySymbol,number].join(blankSpace)};format.localizedCurrency=function(number,digits,optTpl){return format.localized(number,digits,settings.get("currencySymbol"),optTpl)};format.unescape=function(str){if(typeof str!=="string"){throw new Error("str is required and it need to be a string for format.unescape")}return str.replace(/&gt;/gi,">").replace(/&lt;/gi,"<").replace(/&amp;/gi,"&").replace(/&#39;/gi,"'").replace(/&quot;/gi,'"')};format.thousandsSep=format.localized;return format});define("utils/hash",function(require,exports){"use strict";function hash(str){var h=0;for(var i=0,len=str.length;i<len;i++){h=(h<<5)-h+str.charCodeAt(i);h=h&h}try{return h.toString(36)}catch(err){return""+h}}exports.hash=hash});define("utils/isJqueryObject",function(){return function(obj){return obj&&(obj instanceof jQuery||obj.constructor.prototype.jquery)}});define("utils/newline2br",function(exports){"use strict";exports.parse=function(text){if(text){return text.replace(/\r?\n/gi,"<br/>")}return text};return exports});define("utils/newline_placeholder",function(exports){"use strict";exports.placeholder=function(textarea,text){var wrapped=document.createElement("div");var placeholder=document.createElement("div");var cloned=textarea.cloneNode();wrapped.className+=" placeholder-wrapper";placeholder.className+=" placeholder-text";placeholder.innerHTML=text;wrapped.appendChild(cloned);wrapped.appendChild(placeholder);textarea.parentNode.replaceChild(wrapped,textarea);wrapped.addEventListener("input",function(e){if(e.target.value.length>0){placeholder.hidden=true}else{placeholder.hidden=false}})};return exports});define("utils/number",function(require,exports){"use strict";function zeroPad(integer,width,opt_padwith){opt_padwith=opt_padwith||"0";var str=String(integer);if(width>str.length){str=new Array(width-str.length+1).join(opt_padwith)+str}return str}exports.zeroPad=zeroPad});define("utils/objDecodeHTMLEntities",function(require){"use strict";var _=require("underscore");var decodeHTMLEntities=require("utils/decodeHTMLEntities");var dig=function(obj){return _.each(obj,function(_obj,key){if((typeof _obj==="undefined"?"undefined":_typeof(_obj))==="object"){return dig(_obj)}else if(typeof _obj==="string"){obj[key]=decodeHTMLEntities(_obj)}return _obj})};return function(obj){if(_.isUndefined(obj)){return obj}return dig(obj)}});define("utils/objpath",function(require,exports){var _=require("underscore");exports.defaults={valGetter:function($e){if($e.is("input, select")){return $e.val()}else{return $e.text()}},valSetter:function($e,val){if($e.is("input, select")){return $e.val(val)}else{return $e.text(val)}},pathGetter:function($e){return $e.data("utils-objpath-path")}};exports.composeObjectFromElements=function(elements,obj,valGetter,pathGetter){var obj=obj||{};var valGetter=valGetter||exports.defaults.valGetter;var pathGetter=pathGetter||exports.defaults.pathGetter;_.each(elements,function(elem){var $elem=$(elem);var keys=(pathGetter($elem)||"").split(".");
if(!keys.length)return;var val=valGetter($elem);if(!val)return;var parent_o=obj;for(var i=0,l=keys.length-1;i<l;i++){var k=keys[i];var o=parent_o[k];if(o===undefined)o=parent_o[k]={};parent_o=o}o[keys[l]]=val});return obj};exports.fillElementsFromObject=function(elements,obj,valSetter,pathGetter){var valSetter=valSetter||exports.defaults.valSetter;var pathGetter=pathGetter||exports.defaults.pathGetter;_.each(elements,function(elem){var $elem=$(elem);var keys=(pathGetter($elem)||"").split(".");if(!keys.length)return;var o=obj;for(var i=0,l=keys.length;i<l;i++){o=o[keys[i]];if(o===undefined)break}if(o!==undefined)valSetter($elem,o)})}});define("utils/pyformat",function(require,exports){"use strict";var re=/{([^}]+)}/g;return function(template,replacement){return template.replace(re,function(match,key,offset,str){return replacement[key]})}});define("utils/regexp",function(require,exports){"use strict";exports.tel=/^[\+\d()\- ]{8,}$/;exports.email=/^[A-Za-z0-9_\-']([A-Za-z0-9_\-']*[\.]*[A-Za-z0-9_\-']*){1,6}[A-Za-z0-9_\-']@[A-Za-z0-9\-]{2,63}(\.[A-Za-z0-9\-]{2,63})+$/i});define("utils/template",function(require,exports){"use strict";var convert={"%":function(val){return"%"},b:function(val){return String(parseInt(val).toString(2))},c:function(val){return String.fromCharCode(parseInt(val))},d:function(val){return String(parseInt(val)?parseInt(val):0)},u:function(val){return String(Math.abs(val))},f:function(val,p){return String(p>-1?Math.round(parseFloat(val)*Math.pow(10,p))/Math.pow(10,p):parseFloat(val))},o:function(val){return String(parseInt(val).toString(8))},s:function(val){return String(val)},x:function(val){return String(parseInt(val).toString(16)).toLowerCase()},X:function(val){return String(parseInt(val).toString(16)).toUpperCase()}};var re=/%(?:(\d+)?(?:\.(\d+))?|\(([^)]+)\))([%bcdufosxX])/g;return function(){var args=[].slice.call(arguments);var template=args[0];var replacement=args.slice(1);if(replacement.length===1&&_typeof(replacement[0])=="object"){replacement=replacement[0];return template.replace(re,function(match,width,pad,key,specifier,offset,str){return convert[specifier](replacement[key])})}else{var index=0;return template.replace(re,function(match,width,pad,key,specifier,offset,str){return convert[specifier](replacement[index++],pad)})}}});define("utils/test_datetime",function(require,exports){var datetime=require("utils/datetime");exports.test_nativeDate=function(){var inputs=["2013-08-29 18:12:34","2013-08-29T18:12:34","2013-08-29 18:12:34+08:00","2013-08-29T18:12:34+08:00"];var date=new Date(2013,8-1,29,18,12,34,0);var expectings=[date,date,date,date];console.log("Start to test native Date ...");var input,expecting,output;for(var i=0,l=inputs.length;i<l;i++){input=inputs[i];expecting=expectings[i];output=new Date(input);if(output.getTime()!==expecting.getTime()){console.error("Test Case",i+1,": expect",expecting,"but got",output)}}console.log("done.")};exports.test_parseISOString=function(){var inputs=["2013","2013-08","2013-08-28","2013-08-28T10:30Z","2013-08-28T10:30+00:00","2013-08-28T18:30:45+08:00","2013-08-28T18:30:45.123+08:00","2013-08-29 18:12:34","2013-08-29T18:12:34","2013-08-29 18:12:34+08:00","2013-08-29T18:12:34+08:00"];var date=new Date(2013,8-1,29,18,12,34,0);var expectings=[new Date("Tue Jan 01 2013 08:00:00 GMT+0800 (CST)"),new Date("Thu Aug 01 2013 08:00:00 GMT+0800 (CST)"),new Date("Wed Aug 28 2013 08:00:00 GMT+0800 (CST)"),new Date("Wed Aug 28 2013 18:30:00 GMT+0800 (CST)"),new Date("Wed Aug 28 2013 18:30:00 GMT+0800 (CST)"),new Date("Wed Aug 28 2013 18:30:45 GMT+0800 (CST)"),new Date(2013,8-1,28,18,30,45,123),date,date,date,date];console.log("Start to test datetime.parseISOString ...");var input,expecting,output;for(var i=0,l=inputs.length;i<l;i++){input=inputs[i];expecting=expectings[i];output=datetime.parseISOString(input);if(output.getTime()!==expecting.getTime()){console.error("Test Case",i+1,": expect",expecting,"but got",output)}}console.log("done.")};exports.test_format=function(){var date=new Date(2013,8-1,30,18,17,45,123);var inputs=[["en","%Y/%m/%d %H:%M:%S",date],["en","%Y-%m-%dT%H:%M:%S.%f%z",date],["en","%a %b %d %Y %H:%M:%S %Z%z",date],["zh","現在是%A的%p (%m/%d %H:%M:%S)。",date],["en","%%W: %W, %%U: %U",new Date(2012,1-1,1)],["en","%%W: %W, %%U: %U",new Date(2012,1-1,2)],["en","%%W: %W, %%U: %U",new Date(2012,1-1,3)],["en","%%W: %W, %%U: %U",new Date(2011,1-1,1)],["en","%%W: %W, %%U: %U",new Date(2011,1-1,2)],["en","%%W: %W, %%U: %U",new Date(2011,1-1,3)],["en","%%W: %W, %%U: %U",new Date(2011,1-1,4)],["en","%A","2013-08-19"],["en","%A",13768704e5]];var expectings=["2013/08/30 18:17:45","2013-08-30T18:17:45.123+0800","Fri Aug 30 2013 18:17:45 UTC+0800","現在是周五的下午 (08/30 18:17:45)。","%W: 00, %U: 01","%W: 01, %U: 01","%W: 01, %U: 01","%W: 00, %U: 00","%W: 00, %U: 01","%W: 01, %U: 01","%W: 01, %U: 01","Monday","Monday"];console.log("Start to test datetime.format ...");var input,expecting,output;for(var i=0,l=inputs.length;i<l;i++){input=inputs[i];expecting=expectings[i];datetime.setLocale(input[0]);output=datetime.format(input[1],input[2]);if(output!==expecting){console.error("Test Case",i+1,": expect",expecting,"but got",output)}}console.log("done.")}});define("utils/types",function(require,exports){"use strict";exports.isDeferred=function(v){return!!v&&$.isFunction(v.done)};exports.isJquery=function(v){if((typeof v==="undefined"?"undefined":_typeof(v))==="object"&&v.eq&&v.get){return true}return false}});define("utils/urlType",function(require){"user strict";var urlparse=require("net/urlparse");function getUrlType(inUrl){if(!inUrl){return}var url=urlparse.parse(inUrl.toLowerCase());if(!url.domain||!/pinkoi\.com$/.test(url.domain)){return}if(url.path&&url.paths.length>0){switch(url.paths[0]){case"":return"home";case"product":case"magz":case"window":case"wall":case"favlist":case"cart":case"my":case"foryou":return url.paths[0];case"store":return"shop";case"browse":return"browse result";case"search":return url.get("q")==="*"?"search star result":"search result";case"user":return"user page"}}}function getReferrerUrlType(){if(!("referrer"in document||!document.referrer)){return}return getUrlType(document.referrer)}function getCurrentUrlType(){return getUrlType(window.location.href)}return{getUrlType:getUrlType,getCurrentUrlType:getCurrentUrlType,getReferrerUrlType:getReferrerUrlType}});define("utils/withoutViolationContent",function(require){"use strict";var imageValidator=require("net/imageValidator");var isURLInWhitelist=function(input){var urlWhitelistRegex=RegExp(["pinkoi.com","pinkoi.events","pinkoi.me","pinkoi.life","usps.com","youtube.com","youtu.be","vimeo.com","v.qq.com","sf-express.com","7-11.com.tw","famiport.com.tw","post.gov.tw","chinapost.com.cn","hongkongpost.hk","canadapost.ca","japanpost.jp","thailandpost.co.th","macaupost.gov.mo","surveymonkey.com","roy.ptow","v.youku.com","postserv.post.gov.tw/webpost/CSController","eservice.7-11.com.tw/e-tracking/search.aspx","www.t-cat.com.tw/Inquire/Trace.aspx","www.hct.com.tw/searchgoods_index.aspx","www.sf-express.com/tw/tc","17track.net","yjcx.chinapost.com.cn/zdxt/yjcx","track.thailandpost.co.th/tracking/default.aspx","kerrytj.com/zh/default.aspx","e-can.com.tw/search_Goods.aspx","trackings.post.japanpost.jp/services/srv/search/input","toi.kuronekoyamato.co.jp/cgi-bin/tneko","k2k.sagawa-exp.co.jp/p/sagawa/web/okurijoinput.jsp","famiport.com.tw/distribution_search.asp","25431010.tw/Search.php","ezship.com.tw","zendesk.com/hc","pinkoi-events.github.io","apps.apple.com/tw/app/ez-way-%E6%98%93%E5%88%A9%E5%A7%94/id1127781971","play.google.com/store/apps/details?id=com.tradevan.android.forms&hl=zh_TW","photos.app.goo.gl"].join("|").replace(/\./g,"\\."),"i");return urlWhitelistRegex.test(input)};return function(input){var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var _options$allowURL=options.allowURL,allowURL=_options$allowURL===undefined?false:_options$allowURL,_options$allowTel=options.allowTel,allowTel=_options$allowTel===undefined?false:_options$allowTel,_options$allowTrackin=options.allowTrackingCode,allowTrackingCode=_options$allowTrackin===undefined?false:_options$allowTrackin;var inputClone=input;var emailR=/[a-zA-Z0-9._-]+(?:@|\W+at\W+)[a-zA-Z0-9.-]+(?:\.|\W+dot\W+)[a-zA-Z]{2,4}/gi;var emailM=inputClone.match(emailR);if(emailM){return false}inputClone=inputClone.replace(emailR,"");var urlR=/https?:\/\/[=\.\+\-\_\/#\w\?\&%~;,:!\(\)]+/gi;var urlM=inputClone.match(urlR);if(urlM&&!allowURL){for(var i=0;i<urlM.length;i++){if(!imageValidator.checkImageLink(urlM[i],{isShowMessage:false})){return false}else if(/(?:\.png|\.jpg|\.pdf|\.gif|\.jpeg)/i.test(urlM[i])){continue}else if(!isURLInWhitelist(urlM[i])){return false}}inputClone=inputClone.replace(urlR,"")}var urlR_2=/[a-zA-Z0-9\-]+\.(?:cc|com|org|net|tw)(?:\.tw)?[=\.\+\-\_\/#\w\?\&%~;,:!]*/gi;var urlM_2=inputClone.match(urlR_2);if(urlM_2&&!allowURL){for(var _i=0;_i<urlM_2.length;_i++){if(!isURLInWhitelist(urlM_2[_i])){return false}}inputClone=inputClone.replace(urlR_2,"")}var telR=/(?:[A-Za-z]{1,})?[\d\-\+ \(\)]+/gi;var telM=inputClone.match(telR);if(telM&&!allowTel){var telR_2=/0?\d{8,9}/gi;var telR_3=/^[A-Za-z]+/;var telR_4=/^202\d+/;for(var _i2=0;_i2<telM.length;_i2++){var tel=telM[_i2];var alphabeticalPrefix=tel.match(telR_3);if(alphabeticalPrefix&&alphabeticalPrefix[0].length===1){continue}var tooManyPlus=tel.match(/\+/g);if(tooManyPlus&&tooManyPlus.length>1){continue}var tooManyDash=tel.match(/\-/g);if(tooManyDash&&tooManyDash.length>3){continue}var t=tel.replace(/[\-\+ \(\)]/g,"");if(t.length<15){if(t.match(telR_2)){var tr=t.replace(/[a-zA-Z]+/g,"");if(allowTrackingCode&&(tr.length===11||tr.length===12)){continue}if(tr.match(telR_4)){continue}return false}}}}return true}});define("utils/react/getHTML",function(require){"use strict";var React=require("React");var _=require("underscore");return function(htmlString,tag,props){if(!htmlString||!tag){return null}var newProps=_.extend({},props,{dangerouslySetInnerHTML:{__html:htmlString.replace(/\n/g,"<br>")}});return React.createElement(tag,newProps)}});define("utils/react/getHTMLTextContent",function(require){var _=require("underscore");var React=require("React");var richtext=require("ui/richtext");var el=document.createElement("div");var isTextNodeHasContent=function(node){return!!node.data&&node.nodeType===Node.TEXT_NODE};var render=function(htmlString,options){if(!htmlString){return null}var configs=_.extend({tag:"div",maxNode:0,props:{}},options);var tag=configs.tag,maxNode=configs.maxNode,props=configs.props;var output=[];var count=0;var childNode=void 0;el.innerHTML=richtext.parse(htmlString);var childLength=el.childNodes.length;var limit=maxNode===0?childLength:maxNode;for(var i=0;i<childLength;i++){childNode=el.childNodes[i];if(count<limit&&isTextNodeHasContent(childNode)){output.push(React.createElement(tag,_.extend({},props,{key:count}),childNode.data));count=count+1}if(count===limit){break}}return output};var count=function(htmlString){if(!htmlString){return 0}el.innerHTML=richtext.parse(htmlString);var childLength=el.childNodes.length;var length=0;for(var i=0;i<childLength;i++){if(isTextNodeHasContent(el.childNodes[i])){length=length+1}}return length};return{render:render,count:count}});define("utils/react/renderToLayer",function(require){"use strict";var React=require("React");var ReactDOM=require("ReactDOM");var PropTypes=React.PropTypes;var RenderToLayer=React.createClass({displayName:"RenderToLayer",layer:null,propTypes:{onShow:PropTypes.func,onBeforeHide:PropTypes.func,children:PropTypes.node},componentDidMount:function(){this.props.onShow&&this.props.onShow()},componentDidUpdate:function(){this.props.onShow&&this.props.onShow()},componentWillUnmount:function(){this.unrenderLayer()},unrenderLayer:function(){var _this3=this;if(!this.layer){return}var onBeforeHide=this.props.onBeforeHide;var unmountLayer=function(){if(!_this3.props.appendEl){document.body.removeChild(_this3.layer)}else{_this3.props.appendEl.removeChild(_this3.layer)}_this3.layer=null};if(onBeforeHide){onBeforeHide(unmountLayer)}else{unmountLayer()}},render:function(){if(!this.layer){this.layer=document.createElement("div");if(!this.props.appendEl){document.body.appendChild(this.layer)}else{this.props.appendEl.appendChild(this.layer)}}var children=this.props.children;return ReactDOM.createPortal(children,this.layer)}});return RenderToLayer});define("track/ImpressionsLog",function(require){"use strict";var _class2,_temp;var _=require("underscore");var React=require("React");var decodeHTMLEntities=require("utils/decodeHTMLEntities");var Inviewport=require("ui/react/Inviewport");var _require3=require("track/marketplace/TrackingObserver"),trackingObserver=_require3.instance,IMPRESSION_ITEM=_require3.IMPRESSION_ITEM;var logQuqes={};var processor=null;var processorHandler=function(){if(!_.isEmpty(logQuqes)){_.map(logQuqes,function(quqe,key){var _items=_.clone(quqe.items);if(!quqe.category||!_items.length){return}var log={event:"ga:ee",eventCategory:quqe.category,eventAction:"item impression",eventLabel:quqe.label,ecommerce:{impressions:_items}};dataLayer.push(log);logQuqes[key].items=[]})}};$(window).on("beforeunload",function(){processor&&clearTimeout(processor);processorHandler()});$(window).blur(function(){processor&&clearTimeout(processor);processorHandler()});var ImpressionsLog=(_temp=_class2=function(_React$Component){_inherits(ImpressionsLog,_React$Component);function ImpressionsLog(props){_classCallCheck(this,ImpressionsLog);var _this4=_possibleConstructorReturn(this,(ImpressionsLog.__proto__||Object.getPrototypeOf(ImpressionsLog)).call(this,props));_this4.pushLog=function(){var _this4$props=_this4.props,category=_this4$props.category,label=_this4$props.label,items=_this4$props.items,listType=_this4$props.listType,autoParseItemType=_this4$props.autoParseItemType,position=_this4$props.position;var QuqeKey=category+(label?"-"+label:"")+(listType?"-"+listType:"");if(!category||!listType||_.isEmpty(items)){return}if(autoParseItemType==="product"){trackingObserver.update(IMPRESSION_ITEM,{items:items,position:position})}processor&&clearTimeout(processor);var _quqe={category:category,label:label,items:_.clone(items)};if(autoParseItemType){_quqe.items=_.map(items,function(item,index){var data={};if(autoParseItemType=="product"){data.id=item.tid;data.brand=item.owner;data.name=decodeHTMLEntities(item.title);data.list=listType;data.category=[item.category,item.subcategory].join("/")}else if("shop"){data.id=item.sid;data.name=decodeHTMLEntities(item.shop_name);data.list=listType}if(position){data.position=position}return data})}if(!logQuqes[QuqeKey]){_quqe.category=category;_quqe.label=label;logQuqes[QuqeKey]=_quqe}else{logQuqes[QuqeKey].items=logQuqes[QuqeKey].items.concat(_quqe.items)}processor=setTimeout(processorHandler,100)};_this4.state={debug:false};return _this4}_createClass(ImpressionsLog,[{key:"render",value:function render(){if(!this.props.items){return null}return this.props.children?React.createElement(React.Fragment,null,this.props.children&&React.Children.map(this.props.children,function(child,i){return child}),React.createElement(Inviewport,{lazyContainer:this.props.lazyContainer,onVisible:this.pushLog,debug:this.state.debug})):React.createElement(Inviewport,{lazyContainer:this.props.lazyContainer,onVisible:this.pushLog,debug:this.state.debug})}}]);return ImpressionsLog}(React.Component),_class2.defaultProps={category:"",label:"",listType:"",position:null,items:[],autoParseItemType:null},_temp);return ImpressionsLog});define("track/analytics",function(require,exports,module){"use strict";var inited;var bindLinks=function(){var body=document.documentElement||document.body;$(body).on("click","[data-ga-category]",function(e){var $eT=$(e.currentTarget);if($eT.data("ga-action")){var trackingObj={event:"ga",eventCategory:$eT.data("ga-category"),eventAction:$eT.data("ga-action"),nonInteraction:true};if($eT.data("ga-label")){trackingObj.eventLabel=$eT.data("ga-label")}if($eT.data("ga-value")){trackingObj.eventValue=$eT.data("ga-value")}dataLayer.push(trackingObj);if($eT.prop("data-ga-link")){e.preventDefault();setTimeout(function(){if($eT.attr("target")==="_blank"||Boolean(e.ctrlKey)||Boolean(e.metaKey)||e.which===2){window.open($eT.attr("href"))}else{location.href=$eT.attr("href")}},50)}}})};exports.init=function(){if(inited){return}inited=true;bindLinks()}});define("track/criteo",function(require,exports){var _=require("underscore");var settings=require("settings");var local=require("storage/local");var criteo=local.get("criteo");var data=null;var set=function(dataArray){data=dataArray};var send=function(criteo,trackEvent){if(!data){return}var _data=[];for(var i in data){if(data[i]){_data.push(_.clone(data[i]))}}_data.push({event:"setHashedEmail",email:criteo.hashedEmail});if(trackEvent){_data.push(trackEvent)}if(!settings.get("production")){console.group("%c CRITEO ","background:blue;color:white;");for(var i in _data){if(_data[i]){console.log(JSON.stringify(_data[i]))}}console.groupEnd()}window.criteo_q=window.criteo_q||[];window.criteo_q.push([]);window.criteo_q.push(_data)};var init=function(optTrackEvent){var deferred=new $.Deferred;var trackEvent=optTrackEvent||null;var uid=settings.get("uid");if(criteo){if(!criteo||criteo.uid!==uid||!criteo.hashedEmail){criteo=null}}deferred.done(function(_criteo){send(_criteo,trackEvent)});if(!uid){deferred.resolve({hashedEmail:""},trackEvent);return}if(criteo){deferred.resolve(criteo,trackEvent);return}$.ajax({type:"GET",url:"/apiv2/user/get?fields=email_hash"}).done(function(resp){if(!resp.error){criteo={hashedEmail:resp.result[0].email_hash,uid:uid};local.set("criteo",criteo);deferred.resolve(criteo,trackEvent)}})};exports.init=init;exports.set=set});define("track/criteoTags",function(require){"use strict";var settings=require("settings");var criteo=require("track/criteo");var lang=settings.get("lang");var mobile=settings.get("mobile");var _criteoAccount=18849;if(lang==="zh_HK"){_criteoAccount=61581}else if(lang==="ja"){_criteoAccount=41531}var init=function(){var events=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var options=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var _options$siteType=options.siteType,siteType=_options$siteType===undefined?mobile?"m":"d":_options$siteType,_options$criteoAccoun=options.criteoAccount,criteoAccount=_options$criteoAccoun===undefined?_criteoAccount:_options$criteoAccoun,_options$initOnSet=options.initOnSet,initOnSet=_options$initOnSet===undefined?true:_options$initOnSet;var baseEvents=[{event:"setAccount",account:criteoAccount},{event:"setSiteType",type:siteType}];criteo.set([].concat(baseEvents,_toConsumableArray(events)));if(initOnSet){criteo.init()}};return{init:init}});define("track/customTracking",function(require){"user strict";var settings=require("settings");var urlparse=require("net/urlparse");var urlType=require("utils/urlType");var decodeHTMLEntities=require("utils/decodeHTMLEntities");var isMobile=settings.get("mobile");function prepareGAData(category,args){var currentUrl=urlparse.current();var currentUrlType=urlType.getCurrentUrlType();var refUrlType;if(isMobile&&currentUrlType==="product"){if(window.history&&window.history.state&&window.history.state.data&&window.history.state.data.referrer){var referrerUrl=urlparse.buildUrlUponCurrent({query:window.history.state.data.referrer});refUrlType=urlType.getUrlType(referrerUrl)}}else{refUrlType=urlType.getReferrerUrlType()}var eventAction=[];if(currentUrlType){eventAction.push("on "+currentUrlType+" page")}if(currentUrlType=="product"&&refUrlType&&refUrlType!==currentUrlType){eventAction.push("from "+refUrlType+" page")}args=args||{};var actionSuffix=args.actionSuffix?" "+args.actionSuffix:"";var gad={event:"ga",eventCategory:category,eventAction:eventAction.join("/")+actionSuffix,eventLabel:args.label||currentUrl.get("exp","")};return gad}function sendEvent(args){if(!args.category){console.error("[customTracking]: Missing category.");return}var gad=prepareGAData(args.category,args);dataLayer.push(gad)}function sendAddToFav(args){var gad=prepareGAData("add to fav",args);dataLayer.push(gad)}function sendRemoveFromFav(args){var gad=prepareGAData("remove from fav",args);dataLayer.push(gad)}function sendAddToCart(args){var gad=prepareGAData("add to cart",args);dataLayer.push(gad)}function clickAddToCartWhileUserNotLogin(args){var gad=prepareGAData("add to cart (while user not login)",args);dataLayer.push(gad)}function clickFavWhileNotLogin(args){var gad=prepareGAData("add to fav (while user not login)",args);dataLayer.push(gad)}function getIntlShippingLabel(){var status=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var statusString=[];statusString.push(status.count);if(status.has_tracking){statusString.push("tracking_true")}else{statusString.push("tracking_false")}if(status.has_delivery_days){statusString.push("est_days_true")}else{statusString.push("est_days_false")}statusString.push(status.from_geo);return statusString.join("-")}function intlAddToCart(status){if(!status){return}if(status.from_geo&&status.from_geo!==settings.get("geo")){dataLayer.push({event:"ga",eventCategory:"Cross-Border",eventAction:"Add to Cart",eventLabel:status.shipping_status_label,nonInteraction:true})}}function intlViewProduct(status){if(!status){return}if(status.from_geo&&status.from_geo!==settings.get("geo")){dataLayer.push({event:"ga",eventCategory:"Cross-Border",eventAction:"View Product",eventLabel:status.shipping_status_label,nonInteraction:true})}}function logEEProductView(args,actionField){if(!args){return}dataLayer.push({event:"ga:ee",eventCategory:"Product",eventAction:"View product Page",eventLabel:"",ecommerce:{currencyCode:settings.get("currencySymbol"),detail:{actionField:!_.isEmpty(actionField)?actionField:{},products:[{id:args.tid,name:decodeHTMLEntities(args.name),price:args.price,brand:args.sid,variant:args.variant,category:[args.category,args.subcategory].join("/")}]}}})}function logEEAddToCart(args,actionField){if(!args){return}dataLayer.push({event:"ga:ee",eventCategory:"Product",eventAction:"add to cart",eventLabel:"",ecommerce:{currencyCode:settings.get("currencySymbol"),add:{actionField:!_.isEmpty(actionField)?actionField:{},products:[{id:args.tid,name:decodeHTMLEntities(args.name),price:args.price,brand:args.sid,variant:args.variant,category:[args.category,args.subcategory].join("/")}]}}})}function tempLog(log){var Http=new XMLHttpRequest;Http.open("GET","/tmp.log?"+$.param(log));Http.send()}return{sendEvent:sendEvent,sendAddToFav:sendAddToFav,sendRemoveFromFav:sendRemoveFromFav,sendAddToCart:sendAddToCart,clickAddToCartWhileUserNotLogin:clickAddToCartWhileUserNotLogin,clickFavWhileNotLogin:clickFavWhileNotLogin,intlViewProduct:intlViewProduct,intlAddToCart:intlAddToCart,getIntlShippingLabel:getIntlShippingLabel,logEEProductView:logEEProductView,logEEAddToCart:logEEAddToCart,tempLog:tempLog}});define("track/fbCustomAudiencePixel",function(require){"use strict";var settings=require("settings");var cookie=require("net/cookie");var _=require("underscore");var transformTid=function(tid){var prefix=void 0;var lang=settings.get("lang");if(lang==="zh_HK"){prefix="zh_TW_HKD_"}else if(lang==="ja"){prefix="ja_JPY_"}else if(lang==="th"){prefix="th_THB_"}else if(lang!=="zh_TW"){prefix="en_USD_"}else{prefix=""}return""+prefix+tid};var transformTids=function(tids){return _.map(tids,function(tid){return transformTid(tid)})};var itemContent=function(item){return{id:transformTid(item.tid||item.id),quantity:item.quantity||1}};var itemInfo=function(item){var sid=item.sid||item.owner||"NONE";var category=_.isUndefined(item.category)?"NONE":item.category;var subcategory=item.subcategory||"NONE";var array=[sid,category,subcategory];var string="_"+array.join("_")+"_";return string};var fixValue=function(value){return parseFloat(value).toFixed(2)};var send=function(trackName,trackContent){if(settings.get("isBot")){return}if(!window.fbq){!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version="2.0";n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,"script","//connect.facebook.net/en_US/fbevents.js")}var userInfo={external_id:cookie.get("b")||null,ge:null,em:null};if(settings.get("uid")){userInfo.ge=settings.get("fbq_gender");userInfo.em=settings.get("email")}fbq("init","886302098095315",userInfo);fbq("track","PageView");fbq("track",trackName,trackContent)};var dispatchPixelScore=function(targetTid){var fbPixelInfos=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var arr=fbPixelInfos.filter(function(pixelInfo){return pixelInfo.tid==targetTid});if(arr.length==0){return{}}var extendPixelInfo=arr[0];delete extendPixelInfo["tid"];return extendPixelInfo};var dispatchForAddingToWishlist=function(item){return{content_ids:[transformTid(item.tid)],content_type:"product",currency:settings.get("currency"),value:fixValue(item.price),contents:[itemContent(item)],item_info:[itemInfo(item)]}};var sendAddToWishlist=function(item){var fbPixelInfos=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];send("AddToWishlist",_extends({},dispatchForAddingToWishlist(item),dispatchPixelScore(item.tid,fbPixelInfos)))};var sendSearch=function(tids,search_string){var value=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;send("Search",{content_ids:transformTids(tids),content_type:"product",currency:settings.get("currency"),value:fixValue(value),search_string:search_string})};var dispatchForAddingToCart=function(item){return{content_name:"Shopping Cart",content_ids:[transformTid(item.tid)],content_type:"product",value:fixValue(item.price*item.quantity),currency:settings.get("currency"),contents:[itemContent(item)],item_info:[itemInfo(item)]}};var sendAddToCart=function(item){var fbPixelInfos=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];send("AddToCart",_extends({},dispatchForAddingToCart(item),dispatchPixelScore(item.tid,fbPixelInfos)))};return{send:send,transformTid:transformTid,sendAddToWishlist:sendAddToWishlist,sendSearch:sendSearch,sendAddToCart:sendAddToCart}});define("track/getGAProductListName",function(require){"use strict";return function(params){if(!params||!params.ref_entity&&!params.ref_sec){return""}var names=["ref_entity","ref_sec"];return names.reduce(function(result,name){if(params[name]){result=result?result+"__"+params[name]:params[name]}return result},"")}});define("external/adyen",function(require){"use strict";var settings=require("settings");var env=settings.get("production")?"live":"test";var version="3.1.0";var SDK_URL="https://checkoutshopper-"+env+".adyen.com/checkoutshopper/sdk/"+version+"/adyen.js";var STYLE_URL="https://checkoutshopper-"+env+".adyen.com/checkoutshopper/sdk/"+version+"/adyen.css";var styleTagId="adyen-sdk-stylesheet";var appendStyle=function(){if(document.getElementById(styleTagId)){return}var styleTag=document.createElement("link");var attrs={rel:"stylesheet",href:STYLE_URL};for(var k in attrs){if(attrs[k]){styleTag.setAttribute(k,attrs[k])}}styleTag.id=styleTagId;document.head.appendChild(styleTag)};var fetchSDK=function(){return new Promise(function(resolve,reject){if(window.AdyenCheckout){resolve()}else{appendStyle();require([SDK_URL],resolve,reject)}})};var _create=function(type,sdkConfig){var props=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return new Promise(function(resolve,reject){var checkout=void 0;var card=void 0;try{sdkConfig.environment=env;checkout=new window.AdyenCheckout(sdkConfig);card=checkout.create(type,props)}catch(e){reject(e);throw Error(e)}resolve(card)})};var create=function(type,sdkConfig,props){if(!sdkConfig){throw Error("[Adyen]: sdkConfig object is required.")}return new Promise(function(resolve,reject){fetchSDK().then(function(){return _create(type,sdkConfig,props)}).then(resolve).catch(reject)})};return{fetchSDK:fetchSDK,create:create}});define("external/applePay",function(require){"use strict";var _=require("underscore");var settings=require("settings");var canUseApplePay=function(){var deferred=$.Deferred();if(!window.ApplePaySession){return deferred.reject()}var geo=settings.get("geo");var matched=navigator.userAgent.match(/OS (\d*)_(\d*)(_\d*)? like Mac OS X/);var version=parseFloat([matched[1],matched[2]].join("."))||0;if(_.contains(["CN","MO","HK"],geo)&&(Modernizr.iphone||Modernizr.ipad)&&version>=11.2){deferred.resolve()}if(window.ApplePaySession.canMakePayments()){deferred.resolve()}else{deferred.reject()}return deferred};var canCheckoutWithApplePay=function(){var deferred=$.Deferred();canUseApplePay().then(function(){var merchantIdentifier="merchant.com.pinkoi";var promise=window.ApplePaySession.canMakePaymentsWithActiveCard(merchantIdentifier);promise.then(function(canMakePayments){if(canMakePayments){deferred.resolve()}else{deferred.reject()}})}).fail(deferred.reject);return deferred};return{canUseApplePay:canUseApplePay,canCheckoutWithApplePay:canCheckoutWithApplePay}});define("external/creditCardService",function(require){"use strict";var cookie=require("net/cookie");var settings=require("settings");var urlType=require("utils/urlType");var _=require("underscore");var LIMIT_AMOUNTS=5;var request=$.ajax;var _data={};var errorResolver=function(){var error=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(error.code===403&&error.detail==="need_login"){window.location.reload()}else{return error}};var isServiceAvailable=function(){var apis=arguments.length>0&&arguments[0]!==undefined?arguments[0]:_data.apis;return!_.isEmpty(apis)};var isPinkoiPayService=function(){var apis=arguments.length>0&&arguments[0]!==undefined?arguments[0]:_data.apis;if(_.isEmpty(apis)){throw Error("[isPinkoiPayService]: Do `fetchService` first.")}var apiPath=_.values(apis);return _.some(apiPath,function(path){return/pinkoi_pay/.test(path)})};var pushTracking=function(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var eventLabel=[];var currentUrlType=urlType.getCurrentUrlType();var refUrlType=urlType.getReferrerUrlType();if(currentUrlType){eventLabel.push("on "+currentUrlType+" page")}if(refUrlType){eventLabel.push("from "+refUrlType+" page")}var service=isPinkoiPayService()?"CUB":"Adyen";dataLayer.push({event:"ga",eventCategory:service+" credit card service",eventAction:options.eventAction,eventLabel:eventLabel.join(" / ")})};var getSessionId=function(){return cookie.get("phid")};var getLimitAmount=function(){return LIMIT_AMOUNTS};var fetchService=function(){var currentGeo=settings.get("geo");var currentLang=settings.get("lang");var geoChanged=_data.geo!==currentGeo;var langChanged=_data.lang!==currentLang;return new Promise(function(resolve,reject){if(!geoChanged&&!langChanged&&_data.apis){resolve(_data.apis);return}request({url:"/apiv2/credit_card"}).then(function(res){if(res.error){reject(errorResolver(res.error))}else{var _apis=res.result[0];var apis=void 0;if(isPinkoiPayService(_apis)){apis={list:_apis.list_card,bind:_apis.bind_card,remove:_apis.remove_card,check:"/apiv2/ext/pinkoi_pay_cb"}}else{apis={list:_apis.list_card,bind:_apis.finish_bind_card,remove:_apis.remove_card}}Object.assign(_data,{geo:currentGeo,lang:currentLang,apis:apis});resolve(apis)}}).fail(reject)})};var transformBindCardResponse=function(res){var acs_url=res.acs_url,redirect_to_url=res.redirect_to_url,next_step=res.next_step;var replaceUrl=function(url){return function(){location.replace(url)}};var replaceContent=function(content){$(document.body).append('<div style="height:0;overflow:hidden;">'+content+"</div>")};switch(true){case!!redirect_to_url:res.cb=replaceUrl(redirect_to_url);break;case!!next_step&&!!next_step.append_html:res.cb=replaceContent(next_step.append_html);break;case!!next_step&&!!next_step.url:res.cb=replaceUrl(next_step.url);break;case!!acs_url:res.cb=replaceUrl(acs_url);break}return res;
};var bindCreditCard=function(data){return new Promise(function(resolve,reject){var syncService=Promise.resolve(fetchService());syncService.then(function(apis){var args={type:"POST",url:"/apiv2"+apis.bind};if(data){args.data=JSON.stringify(data);args.contentType="application/json"}request(args).then(function(res){if(res.result&&res.result[0]){var response=transformBindCardResponse(res.result[0]);resolve(response);pushTracking({eventAction:"add credit card"})}if(res.error){reject(errorResolver(res.error))}}).fail(reject)},reject)})};var unbindCreditCard=function(card_id){return new Promise(function(resolve,reject){var syncService=Promise.resolve(fetchService());syncService.then(function(apis){request({url:"/apiv2"+apis.remove,type:"POST",data:{card_id:card_id}}).then(function(res){if(res.error){reject(errorResolver(res.error))}else{resolve();pushTracking({eventAction:"remove credit card"})}}).fail(reject)},reject)})};var fetchCreditCards=function(){return new Promise(function(resolve,reject){var syncService=Promise.resolve(fetchService());syncService.then(function(apis){request({url:"/apiv2"+apis.list,type:"GET"}).then(function(res){if(res.error){reject(errorResolver(res.error))}else{resolve(res)}}).fail(reject)},reject)})};var checkCreditCardBindingState=function(){return new Promise(function(resolve,reject){var syncService=Promise.resolve(fetchService());syncService.then(function(apis){if(!apis.check){resolve();return}var id=getSessionId();if(!id){resolve();return}request({url:apis.check+"?sessionId="+id,type:"GET"}).then(function(res){if(res.error){reject(errorResolver(res.error))}else if(res[0]&&res[0].action==="req_bind_card"){resolve()}else{reject()}}).fail(reject)},reject)})};return{getLimitAmount:getLimitAmount,getSessionId:getSessionId,fetchService:fetchService,isServiceAvailable:isServiceAvailable,isPinkoiPayService:isPinkoiPayService,bindCreditCard:bindCreditCard,unbindCreditCard:unbindCreditCard,fetchCreditCards:fetchCreditCards,checkCreditCardBindingState:checkCreditCardBindingState}});define("external/customerService",function(require,exports){"use strict";var settings=require("settings");var backdrop=require("ui/backdrop");var i18n=require("i18n");window.zESettings={webWidget:{chat:{suppress:false},helpCenter:{suppress:false,searchPlaceholder:{"*":i18n.gettext("請輸入關鍵字")}}}};function loadSdk(cb,withoutBackdrop){if(!window.zEmbed){var queue=[];window.zEmbed=function(){queue.push(arguments)};window.zE=window.zE||window.zEmbed;document.zendeskHost="pinkoi.zendesk.com";document.zEQueue=queue;window.zE(function(){window.zE.setLocale(settings.get("locale").replace("_","-"));window.zE.hide()});if(settings.get("uid")){$.get("/apiv2/user/meta").done(function(resp){if(!resp.error){window.zE(function(){window.zE.identify({name:resp.result[0].nick,email:resp.result[0].email})})}})}var sdkScript=document.createElement("script");sdkScript.type="text/javascript";sdkScript.src="https://assets.zendesk.com/embeddable_framework/main.js";!withoutBackdrop&&backdrop.show({loader:true});sdkScript.onload=function(){cb();!withoutBackdrop&&setTimeout(function(){backdrop.hide()},5e3)};var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(sdkScript,s)}else{cb()}}exports.show=function(withoutBackdrop){loadSdk(function(){window.zE(function(){window.zE.activate()})},withoutBackdrop)};exports.showBtn=function(withoutBackdrop){loadSdk(function(){window.zE(function(){window.zE.show()})},withoutBackdrop)};exports.disableChat=function(){window.zESettings.webWidget.chat.suppress=true;return exports};exports.disableHelpCenter=function(){window.zESettings.webWidget.helpCenter.suppress=true;return exports};exports.position=function(positionObj){window.zESettings.webWidget.position=positionObj;return exports}});define("external/facebook",function(require,exports){var i18n=require("i18n");var settings=require("settings");var Inviewport=require("ui/Inviewport");var alertModal=require("ui/notification/alertModal");var appId="197994114318";var userID;var deferred=$.Deferred();var state={hasOnloadedSDK:false,hasAppendSDK:false,hasInitFB:false,hasError:false,hasPermission:[]};var bindEvent=function(){FB.Event.subscribe("edge.create",function(res){dataLayer.push({event:"social",socialNetwork:"facebook",socialAction:"like",socialTarget:location.pathname})});FB.Event.subscribe("edge.remove",function(res){dataLayer.push({event:"social",socialNetwork:"facebook",socialAction:"unlike",socialTarget:location.pathname})});FB.Event.subscribe("message.send",function(res){dataLayer.push({event:"social",socialNetwork:"facebook",socialAction:"share",socialTarget:location.pathname})});FB.Event.subscribe("comment.create",function(res){dataLayer.push({event:"social",socialNetwork:"facebook",socialAction:"comment",socialTarget:location.pathname})})};var init=function(cb,args){args=args||{};deferred.done(function(){if(!state.hasInitFB){try{FB.init({appId:appId,channelUrl:"/media/xd_receiver_v2.htm",cookie:true,status:true,xfbml:false,oauth:true,frictionlessRequests:false,version:"v2.5"})}catch(e){state.hasError=true;console.log("FB.init error");console.log(state.hasAppendSDK,state.hasOnloadedSDK);console.log(e);return}if(!state.hasInitFB){bindEvent();cb(args);state.hasInitFB=true}}});if(state.hasError){return}if(state.hasOnloadedSDK||state.hasInitFB){cb(args);return}else{if(!state.hasAppendSDK){state.hasAppendSDK=true;var script=document.createElement("script"),locale=settings.get("facebook_language")||"en_US";script.async="async";script.src="//connect.facebook.net/"+locale+"/sdk.js";script.onload=function(){state.hasOnloadedSDK=true;deferred.resolve()};document.getElementsByTagName("head")[0].appendChild(script)}else if(state.hasOnloadedSDK){deferred.resolve()}}};var loginFB=function(cb,args){if(state.hasError){console.log("FB.init error (loginFB)");return}if(userID){cb(args);return}args=args||{};if(!args.hasOwnProperty("scope")){args.scope=[]}init(function(){FB.login(function(res){if(res.status==="connected"){userID=res.authResponse.userID;cb(args)}else{alertModal.show(i18n.gettext("請放心給予 Pinkoi 授權"))}},{scope:args.scope.join(",")})})};var requestPermission=function(cb,args){if(state.hasError){return}if(!args||!args.hasOwnProperty("scope")){throw"args.scope is necessary"}init(function(){FB.login(function(res){if(res.status==="connected"){userID=res.authResponse.userID;try{cb(args)}catch(e){alertModal.show(i18n.gettext("請放心給予 Pinkoi 授權"))}}else{alertModal.show(i18n.gettext("請放心給予 Pinkoi 授權"))}},{scope:args.scope.join(",")})})};var checkPermission=function(permissions,cb,args){if(state.hasError){return}var hasThePermission=false;FB.api(userID+"/permissions",function(res){if(res.data){for(var i in res.data){if(res.data[i].hasOwnProperty("permission")&&$.inArray(res.data[i].permission,permissions)>-1&&res.data[i].status==="granted"){hasThePermission=true;state.hasPermission.push(res.data[i].permission)}}if(hasThePermission){cb(args);return}args=args||{};args.scope=args.scope||[];for(var i=0;i<permissions.length;i++){args.scope.push(permissions[i])}requestPermission(cb,args)}})};var publishPack=function(args){if(!args.name){args.name=document.getElementsByTagName("title")[0].innerHTML}if(!args.link){args.link=location.href}if(!args.caption){args.caption="pinkoi.com"}if(!args.actions){args.actions=[{name:i18n.gettext("來逛 Pinkoi"),link:"http://pinkoi.com"}]}return args};var publish=function(args){if(state.hasError){return}var responseHandler,postHandler;responseHandler=function(res,args){if(args.cb){args.cb(res)}};postHandler=function(){FB.api(userID+"/feed","post",args,function(res){if(res.id){responseHandler(res,args)}else{alertModal.show(i18n.gettext("發生錯誤"));throw res.error}})};if(userID){if(!args||args.auto&&!args.message){return}args=publishPack(args);if(args.auto){if($.inArray("publish_actions",state.hasPermission)>0){postHandler()}else{checkPermission(["publish_actions"],function(){postHandler()})}}else{args.method="feed";FB.ui(args,function(res){if(!res.error){responseHandler(res,args)}else{throw res.error}})}}else{args.scope=["publish_actions"];init(function(){loginFB(function(){publish(args)})})}};var parseFBML=function(seletor,immediateRender){var $el=$(seletor);if($el.length){for(var i=0;i<$el.length;i++){if(!immediateRender){new Inviewport({el:$el.get(i),buffer:250,cb:function(){var _el=this.el;init(function(){FB.XFBML.parse(_el)})}})}else{init(function(){FB.XFBML.parse($el.get(i))})}}}};var ui=function(cb,args){init(function(){loginFB(function(args){FB.ui(args,function(res){if(!res.error&&cb){cb(res)}else if(res.error){throw res.error}})},args)},args)};exports.init=init;exports.publish=publish;exports.parseFBML=parseFBML;exports.requestPermission=requestPermission;exports.loginFB=loginFB;exports.appId=appId;exports.ui=ui});(function(){var e,t;e=function(){function e(e,t){var n,r;this.options={target:"instafeed",get:"popular",resolution:"thumbnail",sortBy:"none",links:!0,mock:!1,useHttp:!1};if((typeof e==="undefined"?"undefined":_typeof(e))=="object")for(n in e){r=e[n],this.options[n]=r}this.context=t!=null?t:this,this.unique=this._genKey()}return e.prototype.hasNext=function(){return typeof this.context.nextUrl=="string"&&this.context.nextUrl.length>0},e.prototype.next=function(){return this.hasNext()?this.run(this.context.nextUrl):!1},e.prototype.run=function(t){var n,r,i;if(typeof this.options.clientId!="string"&&typeof this.options.accessToken!="string")throw new Error("Missing clientId or accessToken.");if(typeof this.options.accessToken!="string"&&typeof this.options.clientId!="string")throw new Error("Missing clientId or accessToken.");return this.options.before!=null&&typeof this.options.before=="function"&&this.options.before.call(this),typeof document!="undefined"&&document!==null&&(i=document.createElement("script"),i.id="instafeed-fetcher",i.src=t||this._buildUrl(),n=document.getElementsByTagName("head"),n[0].appendChild(i),r="instafeedCache"+this.unique,window[r]=new e(this.options,this),window[r].unique=this.unique),!0},e.prototype.parse=function(e){var t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S;if((typeof e==="undefined"?"undefined":_typeof(e))!="object"){if(this.options.error!=null&&typeof this.options.error=="function")return this.options.error.call(this,"Invalid JSON data"),!1;throw new Error("Invalid JSON response")}if(e.meta.code!==200){if(this.options.error!=null&&typeof this.options.error=="function")return this.options.error.call(this,e.meta.error_message),!1;throw new Error("Error from Instagram: "+e.meta.error_message)}if(e.data.length===0){if(this.options.error!=null&&typeof this.options.error=="function")return this.options.error.call(this,"No images were returned from Instagram"),!1;throw new Error("No images were returned from Instagram")}this.options.success!=null&&typeof this.options.success=="function"&&this.options.success.call(this,e),this.context.nextUrl="",e.pagination!=null&&(this.context.nextUrl=e.pagination.next_url);if(this.options.sortBy!=="none"){this.options.sortBy==="random"?d=["","random"]:d=this.options.sortBy.split("-"),p=d[0]==="least"?!0:!1;switch(d[1]){case"random":e.data.sort(function(){return.5-Math.random()});break;case"recent":e.data=this._sortBy(e.data,"created_time",p);break;case"liked":e.data=this._sortBy(e.data,"likes.count",p);break;case"commented":e.data=this._sortBy(e.data,"comments.count",p);break;default:throw new Error("Invalid option for sortBy: '"+this.options.sortBy+"'.")}}if(typeof document!="undefined"&&document!==null&&this.options.mock===!1){a=e.data,this.options.limit!=null&&a.length>this.options.limit&&(a=a.slice(0,this.options.limit+1||9e9)),n=document.createDocumentFragment(),this.options.filter!=null&&typeof this.options.filter=="function"&&(a=this._filter(a,this.options.filter));if(this.options.template!=null&&typeof this.options.template=="string"){i="",o="",l="",v=document.createElement("div");for(m=0,b=a.length;m<b;m++){s=a[m],u=s.images[this.options.resolution].url,this.options.useHttp||(u=u.replace("http://","//")),o=this._makeTemplate(this.options.template,{model:s,id:s.id,link:s.link,image:u,caption:this._getObjectProperty(s,"caption.text"),likes:s.likes.count,comments:s.comments.count,location:this._getObjectProperty(s,"location.name")}),i+=o}v.innerHTML=i,S=[].slice.call(v.childNodes);for(g=0,w=S.length;g<w;g++){h=S[g],n.appendChild(h)}}else for(y=0,E=a.length;y<E;y++){s=a[y],f=document.createElement("img"),u=s.images[this.options.resolution].url,this.options.useHttp||(u=u.replace("http://","//")),f.src=u,this.options.links===!0?(t=document.createElement("a"),t.href=s.link,t.appendChild(f),n.appendChild(t)):n.appendChild(f)}document.getElementById(this.options.target).appendChild(n),r=document.getElementsByTagName("head")[0],r.removeChild(document.getElementById("instafeed-fetcher")),c="instafeedCache"+this.unique,window[c]=void 0;try{delete window[c]}catch(x){}}return this.options.after!=null&&typeof this.options.after=="function"&&this.options.after.call(this),!0},e.prototype._buildUrl=function(){var e,t,n;e="https://api.instagram.com/v1";switch(this.options.get){case"popular":t="media/popular";break;case"tagged":if(typeof this.options.tagName!="string")throw new Error("No tag name specified. Use the 'tagName' option.");t="tags/"+this.options.tagName+"/media/recent";break;case"location":if(typeof this.options.locationId!="number")throw new Error("No location specified. Use the 'locationId' option.");t="locations/"+this.options.locationId+"/media/recent";break;case"user":if(typeof this.options.userId!="number")throw new Error("No user specified. Use the 'userId' option.");if(typeof this.options.accessToken!="string")throw new Error("No access token. Use the 'accessToken' option.");t="users/"+this.options.userId+"/media/recent";break;default:throw new Error("Invalid option for get: '"+this.options.get+"'.")}return n=""+e+"/"+t,this.options.accessToken!=null?n+="?access_token="+this.options.accessToken:n+="?client_id="+this.options.clientId,this.options.limit!=null&&(n+="&count="+this.options.limit),n+="&callback=instafeedCache"+this.unique+".parse",n},e.prototype._genKey=function(){var e;return e=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},""+e()+e()+e()+e()},e.prototype._makeTemplate=function(e,t){var n,r,i,s,o;r=/(?:\{{2})([\w\[\]\.]+)(?:\}{2})/,n=e;while(r.test(n)){i=n.match(r)[1],s=(o=this._getObjectProperty(t,i))!=null?o:"",n=n.replace(r,""+s)}return n},e.prototype._getObjectProperty=function(e,t){var n,r;t=t.replace(/\[(\w+)\]/g,".$1"),r=t.split(".");while(r.length){n=r.shift();if(!(e!=null&&n in e))return null;e=e[n]}return e},e.prototype._sortBy=function(e,t,n){var r;return r=function(e,r){var i,s;return i=this._getObjectProperty(e,t),s=this._getObjectProperty(r,t),n?i>s?1:-1:i<s?1:-1},e.sort(r.bind(this)),e},e.prototype._filter=function(e,t){var n,r,i,s,o;n=[],i=function(e){if(t(e))return n.push(e)};for(s=0,o=e.length;s<o;s++){r=e[s],i(r)}return n},e}(),t=typeof exports!="undefined"&&exports!==null?exports:window,t.Instafeed=e}).call(this);define("external/uservoice",function(require,exports){"use strict";var cs=require("external/customerService");exports.showLightbox=function(){cs.disableChat().show()}});define("app/modules/RenderItems",function(require){"use strict";var _class3,_temp2;var React=require("React");var CardProduct=require("app/react/CardProduct");var cardFav=require("app/modules/cardFav");var _=require("underscore");var requestAnimation=require("ui/requestAnimation");var BUCKET_ROW_SIZE=60;var rAFCancel=function(){return window.cancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame||window.oCancelAnimationFrame||function(requestID){clearTimeout(requestID)}}();var queryHashMap=new Map;var getQueryHash=function(){var query=arguments.length>0&&arguments[0]!==undefined?arguments[0]:window.location.search;if(!queryHashMap.has(query)){queryHashMap.set(query,Date.now())}return queryHashMap.get(query)};var RenderItems=(_temp2=_class3=function(_React$Component2){_inherits(RenderItems,_React$Component2);function RenderItems(props){_classCallCheck(this,RenderItems);var _this5=_possibleConstructorReturn(this,(RenderItems.__proto__||Object.getPrototypeOf(RenderItems)).call(this,props));_this5.batchRafs=[];_this5.state={items:[]};_this5.appendItems=function(items,cb){_this5.setState(function(prevState){return{items:[].concat(_toConsumableArray(prevState.items),_toConsumableArray(items))}},cb)};_this5.batchSetItems=function(items){var division=BUCKET_ROW_SIZE/6;var bucket=[];var row=0;var i=0;while(i<items.length){if(i!==0&&i%division===0){row++}if(!bucket[row]){bucket[row]=[]}bucket[row].push(items[i]);i++}var processIndex=0;var currentBucket=void 0;var setItems=function(bucket){currentBucket=bucket[processIndex];var rAFId=requestAnimation(function(){if(currentBucket){_this5.appendItems(currentBucket,function(){processIndex++;setItems(bucket)})}});_this5.batchRafs.push(rAFId)};setItems(bucket)};_this5.handleFavClick=function(e,cardProps){var _fav=cardProps.fav;var _this=_this5;cardFav({method:_fav?"unfav":"fav",item:cardProps,tracking:{actionSuffix:""}}).done(function(data){_this.setState({items:_this.state.items.map(function(x){x=_.clone(x);if(x.tid===cardProps.tid){x.fav=!x.fav}return x})});if(!_fav){_this.props.onFav&&_this.props.onFav()}else{_this.props.onUnfav&&_this.props.onUnfav()}})};_this5.renderItem=function(items){var _this5$props$initInde=_this5.props.initIndex,initIndex=_this5$props$initInde===undefined?0:_this5$props$initInde;var position=initIndex;return _.map(items,function(item){position++;return React.createElement(CardProduct,_extends({},item,{key:item.key,onClickFavWithEvent:_this5.handleFavClick,preferImpressionsPosition:true,impressionsPosition:position,impressionsCategory:_this5.props.impressionsCategory,urlRef:true,lazy:true}))})};return _this5}_createClass(RenderItems,[{key:"updateItems",value:function updateItems(){var _props=this.props,items=_props.items,replaceAll=_props.replaceAll;var itemsWithKey=items.map(function(item,idx){item.key=getQueryHash()+"-"+idx.toString()+"-"+item.tid;return item});if(itemsWithKey.length<=BUCKET_ROW_SIZE||replaceAll){this.setState({items:itemsWithKey})}else{this.batchSetItems(itemsWithKey)}}},{key:"componentDidMount",value:function componentDidMount(){this.updateItems()}},{key:"componentDidUpdate",value:function componentDidUpdate(prevProps){var prevItems=prevProps.items;var propItems=this.props.items;if(!_.isEqual(prevItems,propItems)){this.updateItems()}}},{key:"componentWillUnmount",value:function componentWillUnmount(){this.batchRafs.forEach(function(rAFId){rAFCancel(rAFId)})}},{key:"render",value:function render(){var items=this.state.items;if(items.length===0){return null}return React.createElement("div",{className:"g-react-items-wrapper"},this.renderItem(items))}}]);return RenderItems}(React.Component),_class3.defaultProps={initIndex:0,items:[],impressionsCategory:null},_temp2);return RenderItems});define("app/modules/autoTranslate",function(require,exports){"use strict";var _=require("underscore");var settings=require("settings");var request=require("app/modules/request");var backdrop=require("ui/backdrop");var richtext=require("ui/richtext");var alertModal=require("ui/notification/alertModal");var bar=require("ui/notification/bar");var userLanguage=settings.get("locale");var getHTML;var gaHelper=function(lang,type){if(!type){return}var gaAction;if(lang==="en"){gaAction="Select English"}else if(lang===userLanguage){gaAction="Select User Language"}else{gaAction="Select Original Language"}dataLayer.push({event:"ga",eventCategory:"Auto Translate Switch ("+type+")",eventAction:gaAction,eventLabel:userLanguage,nonInteraction:true})};var cache={};var normalize=function(lang){if(lang==="zh_CN"||lang==="zh_TW"){return"zh"}else{return lang}};var replace=function(resp,$product){if(Boolean(resp.result[0].title)&&Boolean(resp.result[0].description)){$product.find('[data-translate="title"]').html(richtext.parse(resp.result[0].title));$product.find('[data-translate="description"]').html(richtext.parse(resp.result[0].description));$product.find('[data-translate="short_description"]').html(richtext.parse(resp.result[0].short_description))}};exports.productInit=function($el,$product,translationBox,tid){$el.append(getHTML(translationBox));$el.on("click","em",function(e){var params=JSON.parse($(e.target).attr("data-lang"));var key;var lang;if(!_.size(params)){return}lang=params.to_locale||params.force_locale;if(!lang){return}key=[lang,tid].join(".");gaHelper(lang,"Product");if(cache[key]){replace(cache[key],$product);$el.html(getHTML(cache[key].translation_box));return}if(settings.get("mobile")){backdrop.show()}request({url:"/apiv2/item/get?tid="+tid+"&fields=title,description,short_description&"+$.param(params)}).done(function(resp){backdrop.hide();if(!resp.error){if(Boolean(resp.result[0].description)){cache[key]=resp;$el.html(getHTML(cache[key].translation_box));replace(resp,$product)}}else{alertModal.error()}})})};exports.reviewInit=function(data,Sticky){if(!data.resp||!data.resp.result.length||!data.$el||!data.$wrap){return}if(!data.resp.translation_box){return}dataLayer.push({event:"ga",eventCategory:"Auto Translate Switch (Review)",eventAction:"Init",eventLabel:userLanguage,nonInteraction:true});var $el=data.$el;var $wrap=data.$wrap;var limit=data.limit||50;var $buttonWrap=$(getHTML(data.resp.translation_box,"review"));$buttonWrap.insertBefore($el);if(Sticky){new Sticky($buttonWrap.find(".m-auto-translate-button"),{bottomEl:$("#g-footer"),bottomPaddingTop:100,dynamicBottom:true})}$buttonWrap.on("click","em[data-lang]",function(e){var params=JSON.parse($(e.target).attr("data-lang"));var lang=params.to_locale;var key="review_"+lang;if(!lang){throw new Error("need an assigned langauge")}gaHelper(lang,"Review");if(cache[key]){if(cache[key].translation_box){$buttonWrap.html(getHTML(cache[key].translation_box,"review"))}$wrap.find("ul").remove();if(data.cb){data.cb(cache[key],$wrap)}return}if(settings.get("mobile")){backdrop.show()}request({url:"/apiv2/review/get?tid="+data.tid+"&makeup_by_sid="+data.sid+"&limit="+limit+"&"+$.param(params)}).done(function(resp){backdrop.hide();if(resp.error){return}cache["review_"+lang]=resp;$wrap.find("ul").remove();if(resp.translation_box){$buttonWrap.html(getHTML(resp.translation_box))}if(data.cb){data.cb(resp,$wrap)}})})};exports.storeInit=function($translationBox,translationBox,sid){if(translationBox){$translationBox=$($translationBox);$translationBox.html(getHTML(translationBox));$translationBox.on("click","em[data-lang]",function(evt){var $target=$(evt.target);var params=JSON.parse($target.attr("data-lang"));var key;if(!_.size(params)||!params.force_locale){return}key=["store",sid,params.force_locale].join(".");if(cache[key]){$translationBox.html(getHTML(cache[key].story_translation_box));$("#n-store-story").html(richtext.parse(cache[key].result[0].shop_story));return}request({url:"/apiv2/shop/get_info?sid="+sid+"&fields=shop_story&force_locale="+params.force_locale}).done(function(resp){if(resp.error){bar.show(resp.error.message,{type:"info"});return}cache[key]=resp;$translationBox.html(getHTML(cache[key].story_translation_box));$("#n-store-story").html(richtext.parse(cache[key].result[0].shop_story))})})}};exports.showNotice=function(reviewLanguage,toLanguage){var userLanguage=settings.get("locale");if(!reviewLanguage&&!toLanguage){return false}return normalize(reviewLanguage)!==normalize(userLanguage)};getHTML=function(translationBox,optClassName){if(!translationBox||!_.size(translationBox)||!translationBox.actions){return""}optClassName=optClassName||"";var markup=[];if(translationBox.title){markup.push(_.template('<div class="m-auto-translate-title"><%= title %></div>',{title:translationBox.title}))}for(var i in translationBox.actions){if(translationBox.actions[i]&&translationBox.actions[i].hasOwnProperty("params")&&translationBox.actions[i].hasOwnProperty("text")){markup.push(_.template("<em data-lang='<%= JSON.stringify(params) %>'><%= text %></em>",translationBox.actions[i]))}}return['<div class="m-auto-translate-button-wrapper '+optClassName+'">','<div class="m-auto-translate-button">'+markup.join("")+"</div>","</div>"].join("")}});define("app/modules/cardFav",function(require){var _=require("underscore");var bar=require("ui/notification/bar");var i18n=require("i18n");var point=require("app/globals/point");var TrackingObserver=require("track/marketplace/TrackingObserver");var settings=require("settings");var notification=require("app/modules/requestNotification");var modal=require("ui/modal");var request=require("mapp/modules/request");var trackingObserver=TrackingObserver.instance;var ADD_TO_FAV=TrackingObserver.ADD_TO_FAV;var REMOVE_FROM_FAV=TrackingObserver.REMOVE_FROM_FAV;var CLICK_FAV_WHEN_NOT_LOGIN=TrackingObserver.CLICK_FAV_WHEN_NOT_LOGIN;var parseData=function(args){if(!args){return}else if(args.hasOwnProperty("items")){var items=[];var tids=[];_.each(args.items,function(item){tids.push(item.tid);items.push({tid:item.tid,price:item.price,category:item.category,subcategory:item.subcategory,sid:item.owner})});return{payload:{tids:tids},items:items}}else if(args.hasOwnProperty("item")){return{payload:{tid:args.item.tid},items:[{tid:args.item.tid,price:args.item.price,category:args.item.category,subcategory:args.item.subcategory,sid:args.item.owner}],tracking:args.tracking}}};return function(args){var deferred=new $.Deferred;var mobile=settings.get("mobile")||args.forceToMobile;var requestData=parseData(args);if(settings.get("uid")){if(args.method==="unfav"){request({type:"POST",url:"/apiv2/item/unfav",data:requestData.payload}).done(function(){deferred.resolve();point.clearCache();bar.show(i18n.gettext("已移除"));trackingObserver.update(REMOVE_FROM_FAV,{gaTrackingData:requestData.tracking})})}else{request({type:"POST",url:"/apiv2/item/fav",data:requestData.payload}).done(function(resp){var data={};point.clearCache();if(resp.error){bar.show(resp.error.message);deferred.reject();return}if(resp.result&&resp.result[0]&&resp.result[0].reward){data.points=resp.result[0].reward.points;data.plus=resp.result[0].reward.plus}deferred.resolve(data);if(data.plus){bar.show([i18n.gettext("已加入慾望清單")," ",_.template(i18n.gettext("紅利點數 +<%= plus %>"),{plus:data.plus})].join(""))}else{bar.show(i18n.gettext("已加入慾望清單"))}trackingObserver.update(ADD_TO_FAV,{gaTrackingData:requestData.tracking,items:requestData.items,responseData:resp.result[0]});notification.favAndFollowRP()})}}else{trackingObserver.update(CLICK_FAV_WHEN_NOT_LOGIN,{gaTrackingData:requestData.tracking});if(mobile){location.href="/login?next="+encodeURIComponent(location.href)}else{require(["mapp/pages/login"],function(login){login.loginModal(modal)});deferred.reject()}}return deferred}});define("app/modules/cardScroll",function(require,exports){"use strict";var _=require("underscore");var transitionend=require("css/transitionend");var swipe=function($container,transformX){$container.css({transform:"translate(-"+transformX+"px, 0)"})};var lastCount=function($last){var width=0;var $children=$last.children();_.each($children,function(child){width+=$(child).outerWidth(true)});return width};var init=function(el,options){options=options||{};var $el=$(el);var arrowLeft=$el.find(".arrow.left");var arrowRight=$el.find(".arrow.right");var cardLength=$el.find(".card-container").length;var maxCount=cardLength-1;var cardWidth=$(el).width();var $container=$el.find(".scroll-container");var lastWidth=lastCount($el.find(".card-container").eq(maxCount));var fullWidth=cardWidth*maxCount+lastWidth;var limitWidth=fullWidth-cardWidth;var width=0;var index=0;var pagination_string=index+1+" / "+cardLength;var $pagination;var self={};self.hooks={};var hooks=["onInit","onResize","onPrevSlide","onNextSlide"];_.each(hooks,function(name){if(options[name]&&_.isFunction(options[name])){self.hooks[name]=options[name]}});function triggerEvent(){var name=arguments[0];var args=[].slice.call(arguments,1);self.hooks[name]&&self.hooks[name].apply(self,args)}function onResize(e){cardWidth=$(el).width();lastWidth=lastCount($el.find(".card-container").eq(maxCount));fullWidth=cardWidth*maxCount+lastWidth;limitWidth=fullWidth-cardWidth;width=0;index=0;swipe($container,width);triggerEvent("onResize")}function updatePagination(){if(options.pagination){pagination_string=index+1+" / "+cardLength;$pagination.text(pagination_string)}}$(window).resize(_.throttle(onResize,300));arrowRight.on("click",function(e){e.preventDefault();if(index<maxCount){index=index+1}else{index=0}width=index*cardWidth;if(width>=fullWidth){width=0}else if(width>=limitWidth){width=limitWidth}transitionend($container,function(){triggerEvent("onNextSlide",index)});updatePagination();swipe($container,width)});arrowLeft.on("click",function(e){e.preventDefault();if(index>0){index=index-1}else{index=maxCount}width=index*cardWidth;if(width===-cardWidth){width=limitWidth}else if(width<0){width=0}transitionend($container,function(){triggerEvent("onPrevSlide",index)});updatePagination();swipe($container,width)});if(maxCount===0){arrowRight.hide();arrowLeft.hide()}else{arrowRight.show();arrowLeft.show()}if(options.pagination){$el.append('<div class="pagination">'+pagination_string+"</div>");$pagination=$el.find(".pagination")}triggerEvent("onInit")};exports.init=init});define("app/modules/cart",function(require,exports){"use strict";var local=require("storage/local");var alertModal=require("ui/notification/alertModal");var numberBadge=require("app/modules/numberBadge");exports.updateNum=function(optNum){var cart_num=numberBadge.get({storageName:"g.cartNum",apiUrl:"/apiv2/cart/num",resultName:"cart_num",target:$("#gheader").find(".cart"),layerFunc:function(cartNum){dataLayer.push({cartNumbers:cartNum})}},optNum);$(window).trigger("updateNum:cart_num",{cart_num:cart_num})};exports.clearNum=function(){local.del("g.cartNum")};exports.noticeVacation=function(vacations){for(var sid in vacations){if(vacations.hasOwnProperty(sid)){var $target=$("#group_"+sid);if($target.length){$target.find('[name="shipping_method"]').on("change",function(){alertModal.show(vacations[sid])})}}}}});define("app/modules/engage",function(require,exports){"use strict";var _=require("underscore");var settings=require("settings");var hash=require("utils/hash");var local=require("storage/local");var urlparse=require("net/urlparse");var i18n=require("i18n");var whitelist=["browse","product","wall","magz","order"];var getPromoLogData=function(engagement){if(!engagement||!engagement.url){return}var pathBasePromoId=decodeURI(urlparse.getRelativePath(engagement.url,["ref","promo_tid"]));return{id:pathBasePromoId,name:engagement.title,position:"engagement"}};var render=function(args){if(exports.shown){return}var tpl=_.template(['<div class="m-engage m-engage-to-be-closed <%= button ? "m-engage-with-right" : "m-engage-not-with-right" %> <%= image ? "m-engage-with-left" : "m-engage-not-with-left" %> <%= expand ? "m-engage-expand" : "" %>" data-hash="<%= hashV %>" <% if (expire) {print(\'data-expire="\' + expire + \'"\');} %> data-url="<%= url ? url : "" %>">','<div class="m-engage-close" onclick="require(\'app/modules/engage\').close(this);">',i18n.gettext("關閉"),"</div>","<a <% if (url) {print('onclick=\"require(\\'app/modules/engage\\').link(this);\" class=\"m-engage-hasurl\"');} %>>",'<% if (image) { %><div class="m-engage-section m-engage-left"><div class="m-engage-image" style="background-image:url(\'<%= image %>\');"></div></div><% } %>','<div class="m-engage-section m-engage-middle">','<div class="m-engage-body">','<% if (title) { %><h3 class="m-engage-title"><%= title %></h3><% } %>',"<% if (description) { %><div class=\"m-engage-description <% if (image) {print('m-engage-hasimage')} %>\"><%= description %></div><% } %>","</div>","<% if (button) { %>",'<div class="m-engage-right m-engage-section"><div class="m-br-button m-br-button--lg m-br-button--primary m-engage-button"><%= button %></div></div>',"<% } %>","</div>","</a>","</div>"].join(""));
$("#gheader").after(tpl(args));$(".m-engage .m-engage-button").click(function(){dataLayer.push({event:"ga:ee",eventCategory:"enagage",eventAction:"promo click",eventLabel:"",ecommerce:{promoClick:{promotions:[getPromoLogData(args)]}}})});exports.shown=true};exports.close=function(el,options){options=options||{};var $engage=$(el).closest(".m-engage-to-be-closed");var hash=$engage.data("hash");var expire=$engage.data("expire")||"1m";var url=$engage.data("url")||"";var trackingValue=options.openUrl?"Open URL":"Close";local.set("m.engage."+hash,1,expire);dataLayer.push({event:"ga",eventCategory:"Engage Module",eventAction:trackingValue,eventLabel:url,nonInteraction:true});if(options.openUrl){setTimeout(function(){location.href=url},100)}if($engage.data("action")==="hide"){$engage.addClass("s-hidden")}else{$engage.remove()}exports.shown=false};exports.link=function(el){exports.close(el,{openUrl:true})};exports.show=function(engagements,expand){var engageSettings=settings.get("app/modules/engage")||{};if(engageSettings.disabled){return}var urlPath=urlparse.current().paths;if(!_.contains(whitelist,urlPath[0])){return}if(urlPath[0]==="magz"&&urlPath[1]==="1cqJQmrq"){return}var _engagements=_.shuffle(engagements);for(var i=0,l=_engagements.length;i<l;i++){var engagement=_engagements[i];if(!engagement){continue}var source=[engagement.url||"",engagement.title||"",engagement.button||"",String(engagement.tid)||"",String(engagement.oid)||""].join("");var hashV=hash.hash(source);if(!local.get("m.engage."+hashV)){if(engagement.url&&engagement.url===location.pathname){continue}render(_.extend({hashV:hashV,expire:null,image:null,title:null,description:null,url:null,button:null,expand:expand},engagement));dataLayer.push({event:"ga:ee",eventCategory:"enagage",eventAction:"promo impression",eventLabel:"",ecommerce:{promoView:{promotions:[getPromoLogData(engagement)]}}});break}}};exports.shown=false});define("app/modules/fav",function(require,exports){"use strict";var _=require("underscore");var request=require("mapp/modules/request");var i18n=require("i18n");var modal=require("ui/modal");var login=require("mapp/pages/login");var settings=require("settings");var bar=require("ui/notification/bar");var point=require("app/globals/point");var notification=require("app/modules/requestNotification");var TrackingObserver=require("track/marketplace/TrackingObserver");var trackingObserver=TrackingObserver.instance;var ADD_TO_FAV=TrackingObserver.ADD_TO_FAV;var REMOVE_FROM_FAV=TrackingObserver.REMOVE_FROM_FAV;exports.addFav=function(refs,params_d){var _params_d=_.clone(params_d)||{};_params_d.ref_sec="main";var params_d_string="?"+$.param(_params_d);return request({type:"POST",url:"/apiv2/item/fav"+params_d_string,data:{tid:refs.tid}}).done(function(resp,status,xhr){if(resp.error){return bar.show(resp.error.message,{type:"info"})}!refs.isDisableRequestNotification&&notification.favAndFollowRP();point.clearCache();if(resp.result[0].reward.plus>0){!refs.isDisableBar&&bar.show([i18n.gettext("已加入慾望清單")," ",_.template(i18n.gettext("紅利點數 +<%= plus %>"),{plus:resp.result[0].reward.plus})].join(""))}else{!refs.isDisableBar&&bar.show(i18n.gettext("已加入慾望清單"))}trackingObserver.update(ADD_TO_FAV,{gaTrackingDataIsRequired:false,item:refs,responseData:resp.result[0]})})};exports.removeFav=function(tid,cb,params_d){var _params_d=_.clone(params_d);_params_d.ref_sec="main";var params_d_string="?"+$.param(_params_d);if(!tid){throw new Error("need tid")}if(!settings.get("uid")){return login.loginModal(modal)}return request({type:"POST",url:"/apiv2/item/unfav"+params_d_string,data:{tid:tid}}).done(function(resp,status,xhr){if(resp.error){return bar.show(resp.error.message)}point.clearCache();trackingObserver.update(REMOVE_FROM_FAV,{gaTrackingDataIsRequired:false});bar.show(i18n.gettext("已移除"));if(cb){cb(resp,status,xhr)}})};exports.getFav=function(paramsObj,cb){paramsObj=$.extend({limit:999},paramsObj);var url="/apiv2/item/get_fav";var assembledUrl="?";$.each(paramsObj,function(key,value){assembledUrl=assembledUrl+key+"="+value+"&"});assembledUrl=url+assembledUrl.substr(0,assembledUrl.length-1);return request({type:"GET",url:assembledUrl}).done(function(resp,status,xhr){if(resp.error){return bar.show(resp.error.message)}if(cb){cb(resp,status,xhr)}})};exports.init=function(args){args=args||{};var offset=args.offset||{top:8,left:6};var binder=args.binder||document;var zoomboxCase=args.zoomboxCase;var $heart=$('<div class="g-fav-proxy" style="display:none;"></div>');var $hoverFav;var $favContainer;var hoverOffset;var zoomboxOffset;if(!zoomboxCase){$heart.appendTo("body")}if(zoomboxCase){$(binder).on("click","[data-click=zoombox]",function(){zoomboxOffset={top:offset.top,right:offset.left}})}$(binder).on("mouseenter","[data-hover]",function(){$hoverFav=$(this);$favContainer=$hoverFav.parent();hoverOffset={top:$favContainer.offset().top+offset.top,left:$favContainer.offset().left+$favContainer.width()-$heart.width()-offset.left};if($hoverFav.data("hover")==="fav"){if(zoomboxCase){if($favContainer.find(".g-fav-proxy").length===0&&$favContainer.find(".g-fav").length===0){$heart.css(zoomboxOffset).appendTo($favContainer).show()}}else{$heart.css(hoverOffset).show()}}}).on("mouseout","[data-hover], .g-fav-proxy",function(evt){if(!$(evt.relatedTarget).is("[data-hover], .g-fav-proxy")){if(zoomboxCase){$(this).parent().find(".g-fav-proxy").remove();return}$heart.hide()}}).on("click",".g-fav-proxy",function(evt){if($hoverFav.attr("data-hover")==="faved"){return}if(!settings.get("uid")){if(zoomboxCase){$favContainer.find(".g-fav-proxy").remove()}else{$heart.hide()}evt.preventDefault();login.loginModal(modal);return}$('<div class="g-fav"></div>').css({top:offset.top,right:offset.left}).appendTo($favContainer).show();$hoverFav.attr("data-hover","faved");if(zoomboxCase){$favContainer.find(".g-fav-proxy").remove()}else{$heart.hide()}var data=$hoverFav.data();exports.addFav(data,data.ref);if(zoomboxCase){evt.preventDefault()}})}});define("app/modules/favWindow",function(require){"use strict";var i18n=require("i18n");var settings=require("settings");var request=require("app/modules/request");var login=require("mapp/pages/login");var modal=require("ui/modal");var bar=require("ui/notification/bar");var MOBILE=settings.get("mobile");var ACTION_FAV="fav";var ACTION_UNFAV="unfav";var getText=function(action){var _textMap;var mobile=arguments.length>1&&arguments[1]!==undefined?arguments[1]:MOBILE;var textMap=(_textMap={},_defineProperty(_textMap,ACTION_FAV,mobile?i18n.gettext("已喜歡"):i18n.gettext("已加入喜歡的櫥窗")),_defineProperty(_textMap,ACTION_UNFAV,mobile?i18n.gettext("已移除"):i18n.gettext("已從喜愛的櫥窗中移除！")),_textMap);return textMap[action]};var _fav=function(action,tid){var options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return new Promise(function(resolve,reject){if(!settings.get("uid")){login.loginModal(modal);reject();return}request({type:"POST",url:"/api/window/"+action,data:{tid:tid}}).then(function(res){if(res.error){reject(res.error);return}bar.show(getText(action,options.mobile))}).fail(reject)})};var fav=function(tid,options){return _fav(ACTION_FAV,tid,options)};var unfav=function(tid,options){return _fav(ACTION_UNFAV,tid,options)};return{fav:fav,unfav:unfav}});define("app/modules/fluid-carousel",function(require,exports){"use strict";var _=require("underscore");var url=require("app/modules/url");var Inviewport=require("ui/Inviewport");var carousel={};var TRANSITION_TIME=500;carousel.on=function(w){if(!carousel.ison){carousel.divide()}else{if(carousel.getWrapW()<1e3){for(var i=0;i<carousel.$els.length;i++){var _carousel=$(carousel.$els[i].$el);carousel.resize(_carousel,carousel.$els[i].$item,carousel.getWrapW())}}}carousel.ison=true};carousel.resize=function(_carousel,$item,w){var pageW=Math.round(carousel.getWrapW()*(Math.ceil($item.length/8)+2));if(!carousel.ison){_carousel.wrap('<div class="m-carousel-outerwrapper m-carousel-adjust"><div class="inner"></div></div>')}_carousel.width(pageW);setTimeout(function(){$(".m-carousel-adjust").width(carousel.getWrapW())},10);_carousel.data("total-page",Math.ceil($item.length/8)+2);$(".section-carousel-wrapper").css(Modernizr.prefixed("transform"),"translate(-"+w+"px, 0)")};carousel.off=function(){if(!carousel.ison){return}carousel.ison=false;var _carousel;$(".m-carousel-adjust").width("auto");if(carousel.$els.length){for(var i=0;i<carousel.$els.length;i++){_carousel=$(carousel.$els[i].$el);if(carousel.$els[i].$item){for(var j=0;j<carousel.$els[i].$item.length;j++){if(_carousel){_carousel.append(carousel.$els[i].$item[j])}}$(carousel.$els[i].$el).removeAttr("style");$(carousel.$els[i].$el).width("auto")}}}$(".m-carousel-page").remove()};carousel.getWrapW=function(){return Math.round(document.body.clientWidth>1040?1e3:document.body.clientWidth*.96)};var loadImage=function($el){var imgs=$el.find("img[data-src]");for(var j=0;j<imgs.length;j++){var $img=$(imgs[j]);$img.attr("src",url.getItemImg($img.data("tid"),"320x320",{seq:$img.data("map")})).data("src","");$($img.parent().parent()).addClass("loaded")}};var lazyloader=function(){for(var i=0;i<carousel.$els.length;i++){var _$el=carousel.$els[i].$el;new Inviewport({el:_$el,buffer:100,cb:function(){loadImage($(this.el))}})}};carousel.divide=function(){var _carousel={};var pages=[];var quene=[];var w=carousel.getWrapW();for(var m=0;m<carousel.$els.length;m++){_carousel=$(carousel.$els[m].$el);var $item=$(_carousel.find(carousel.itemSelector));var firstPage;var lastPage;carousel.$els[m].$item=$item;for(var i=0;i<$item.length;i++){quene.push($item[i]);if(quene.length===8||i===$item.length-1){pages.push(quene);quene=[]}}for(var j=0;j<pages.length;j++){var $page=$('<div class="m-carousel-page m-carousel-adjust" style="width:'+w+'px"></div>');for(var k=0;k<pages[j].length;k++){$page.append(pages[j][k])}if(j===0){firstPage=$page.clone()}else if(j===pages.length-1){lastPage=$page.clone()}_carousel.append($page)}_carousel.append(firstPage);_carousel.prepend(lastPage);carousel.goToPage(_carousel,_.random(1,pages.length-2));carousel.resize(_carousel,$item,w);pages=[]}lazyloader()};carousel.goToPage=function(_carousel,page,reset){var w=carousel.getWrapW();if(w<768){return}var total=parseInt(_carousel.data("total-page"),10)-1;if(!reset&&_carousel.hasClass("no-transition")){return}if(page===total||page>total){setTimeout(function(){_carousel.addClass("no-transition");carousel.goToPage(_carousel,1,true)},TRANSITION_TIME)}else if(page===0||page<0){setTimeout(function(){_carousel.addClass("no-transition");carousel.goToPage(_carousel,total-1,true)},TRANSITION_TIME)}if(reset){setTimeout(function(){_carousel.removeClass("no-transition")},100)}_carousel.css(Modernizr.prefixed("transform"),"translate("+-w*page+"px, 0)");_carousel.data("now",page)};var resizeHandler=function(args){var w=carousel.getWrapW();if(w<768||!Modernizr.csstransforms){lazyloader();carousel.off()}else{carousel.on(w)}};var paginationHandler=function(random){var pagiMarkup='<span class="carousel-prev" data-action="carousel-prev"></span><span class="carousel-next" data-action="carousel-next"></span>';var pageIndicator=_.template(['<ol class="m-carousel-pagi-indicators">',"<% for(var i=1; i<=total_pages; i++) { %>","<% if (active_page === i) { %>",'<li data-page="<%= i %>" data-action="carousel-page" data-id="<%= carouselId %>" class="active">',"<% } else { %>",'<li data-page="<%= i %>" data-action="carousel-page" data-id="<%= carouselId %>">',"<% } %>","</li>","<% } %>","</ol>"].join("\n"));for(var i=0;i<carousel.$els.length;i++){var $pagi=$(pagiMarkup);var $_carousel=$(carousel.$els[i].$el);var $pagiWrap=$('<div class="m-carousel-pagi-wrapper"></div>');if($_carousel){$pagi.attr("id","m-carousel-pagi-"+i).data("id",i);$pagiWrap.insertAfter($_carousel.parent());$pagiWrap.append($pagi);var now=random?_.random(1,$_carousel.find(".m-carousel-page").length-2):1;if($_carousel.data("withIndicator")){$(pageIndicator({carouselId:i,total_pages:$_carousel.find(".m-carousel-page").length-2,active_page:now})).insertAfter($_carousel.parent())}$_carousel.data("now",now);carousel.goToPage($_carousel,now)}}carousel.$wrap.on("click","[data-action]",function(e){e.preventDefault();var $_carousel=$(carousel.$els[parseInt($(e.target).data("id"),10)].$el);var action=$(e.target).data("action");if(action==="carousel-prev"){var $target=$(e.target);var prevPage=parseInt($_carousel.data("now"),10)-1;var lastPage=parseInt($_carousel.data("total-page"),10)-2;if(prevPage<1){prevPage=lastPage}$target.parent().siblings(".m-carousel-pagi-indicators").find('li[data-page="'+prevPage+'"]').addClass("active").siblings().removeClass("active");carousel.goToPage($_carousel,prevPage);$target.data("frozen",true);return}if(action==="carousel-next"){var $target=$(e.target);var nextPage=parseInt($_carousel.data("now"),10)+1;var lastPage=parseInt($_carousel.data("total-page"),10)-2;if(nextPage>lastPage){nextPage=1}$target.parent().siblings(".m-carousel-pagi-indicators").find('li[data-page="'+nextPage+'"]').addClass("active").siblings().removeClass("active");carousel.goToPage($_carousel,nextPage);$target.data("frozen",true);return}if(action==="carousel-page"){var $target=$(e.target);var nextPage=parseInt($target.data("page"),10);var curPage=parseInt($_carousel.data("now"),10);if(nextPage!==curPage){$target.addClass("active").siblings().removeClass("active");carousel.goToPage($_carousel,nextPage)}return}if(action==="more"){var page=parseInt($(e.target).data("page"),10);var itemPerPage=document.body.clientWidth<481?4:6;var totalPage=Math.ceil($_carousel.find(".item").length/itemPerPage);$_carousel.addClass("on-"+page);page++;$(e.target).data("page",page);var items=$_carousel.find(".item");for(var i=0;i<itemPerPage*totalPage;i++){if($(items[i])){$(items[i]).addClass("on")}}$(e.target).remove();dataLayer.push({event:"ga",eventCategory:"Event More Button",eventAction:location.pathname,eventLabel:"Button More "+($(e.target).data("id")+1)});return}})};exports.init=function(args){var $el=$(args.el);var random=_.isUndefined(args.random)?true:args.random;carousel.$wrap=$(args.wrap);carousel.itemSelector=args.item;if(!$el||!carousel.$wrap){return}if(args.withIndicator){$el.data("withIndicator",true)}carousel.$els=[];for(var i=0;i<$el.length;i++){carousel.$els.push({$el:$($el[i]),now:0})}$(window).on("resize",function(e){resizeHandler()});resizeHandler();paginationHandler(random)}});define("app/modules/follow",function(require){var bar=require("ui/notification/bar");var i18n=require("i18n");var customTracking=require("track/customTracking");var request=require("mapp/modules/request");var modal=require("ui/modal");var login=require("mapp/pages/login");var settings=require("settings");var notification=require("app/modules/requestNotification");var alertModal=require("ui/notification/alertModal");return function(args){var deferred=new $.Deferred;if(settings.get("uid")){args.tracking=args.tracking||{};args.tracking.label=settings.get("mobile")?"mweb":"web";if(args.method==="unfollow"){request({type:"POST",url:"/apiv2/shop/unfav",data:{sid:args.sid}}).done(function(resp){if(resp.error){alertModal.error();deferred.reject();return}deferred.resolve();bar.show(i18n.gettext("已移除"));args.tracking.category="Cancel Followed Store";customTracking.sendEvent(args.tracking)})}else{request({type:"POST",url:"/apiv2/shop/fav",data:{sid:args.sid}}).done(function(resp){if(resp.error){alertModal.error();deferred.reject();return}deferred.resolve();bar.show(i18n.gettext("已加入慾望清單"));notification.favAndFollowRP();args.tracking.category="Follow the Store";customTracking.sendEvent(args.tracking)})}}else{login.loginModal(modal);deferred.reject()}return deferred}});define("app/modules/i18nAddress",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var settings=require("settings");var alertModal=require("ui/notification/alertModal");var request=require("net/request");var tooltip=require("ui/tooltip");var inputListener=require("ui/inputListener");var sid,countryList,shippingMethod,isShipToEverywhereElse=false;var isBuyerTheReceiver=true;var isConcat=false;var getFormData=function($form,role){role=role||"receiver";var data={};data[role]={};$form.find('.m-i18n-address-field[data-role="'+role+'"]').each(function(el){if($.trim(this.value)){data[role][$(this).attr("name")]=this.value}});return data};var formElementMarkup=function(inputData,role,formType){if(!inputData.field){return""}var countryTpl='<label class="required"><%= label %></label>'+'<select class="m-select m-i18n-address-field" data-type="country" '+'data-default="<%= currentCountry %>" '+'data-default-name="<%= currentCountryName %>" '+'data-role="<%= role %>" '+'data-geo="<%= currentCountry %>" '+'name="<%= field %>" class="m-i18n-address-field" required>'+"<% for(var i=0;i<countryList.length;i++) { %>"+'<option value="<%= countryList[i][0] %>" '+"<% if (currentCountry === countryList[i][0]) { %> selected <% } %>>"+"<%= countryList[i][1] %>"+"</option>"+"<% } %></select>"+'<% if (typeof note !== "undefined") { %>'+'<span class="shipping-notice">'+"<%= note %>"+"</span>"+"<% } %>";var inputTpl='<label class="<% if (type!== "hidden" && (typeof required === "undefined" || required)) { %> required <% } %>">'+"<%= label %></label>"+'<input type="<%= type %>" '+'class="m-i18n-address-field" '+'<% if (typeof autocomplete !== "undefined") { %>'+'data-autocomplete data-min="<%= autocomplete.min_value_length %>"'+' data-relatedfields="<%= autocomplete.to_fields.join(",") %>"'+' data-min="<%= autocomplete.min_value_length %>"'+"<% } %>"+'data-role="<%= role %>" name="<%= field %>" '+'data-geo="<%= currentCountry %>" '+'data-empty-notice="<%= notice %>" '+'data-lang="<%= formType %>" '+'placeholder="<% if (typeof placeholder !== "undefined") { %>'+'<%= placeholder %><% } %>" '+'value="<% if (typeof value !== "undefined") { %><%= value %><% } %>" '+'<% if (typeof required === "undefined" || required) { %> required <% } %>>'+'<% if (typeof note !== "undefined") { %><span class="footnote"><%= note %></span><% } %>';var selectTpl='<label class="required"><%= label %></label><select class="m-select m-i18n-address-field" '+'data-role="<%= role %>" '+'data-geo="<%= currentCountry %>" '+'name="<%= field %>" required>'+"<% for(var i=0;i<options.length;i++) { %>"+'<option value="<%= typeof options[i] === "object" ? options[i].value : options[i] %>" <%= (typeof value !== "undefined" && options[i] === value || (typeof options[i] === "object" && typeof value !== "undefined" && options[i].value === value)) ? "selected" : "" %>><%= typeof options[i] === "object" ? options[i].name : options[i] %></option>'+"<% } %></select>";inputData.label=inputData.label?inputData.label:"";inputData.role=role;inputData.currentCountry=settings.get("geo");inputData.formType=formType;if(inputData.field.indexOf("address_field_country")>-1){inputData.currentCountry=inputData.value;if(inputData.countryList){for(var j=0;j<countryList.length;j++){if(inputData.countryList[j][0]===inputData.value){inputData.currentCountryName=inputData.countryList[j][1];break}}}else{return""}return _.template(countryTpl,inputData)}else{inputData.notice=_.template(i18n.gettext("<%= fieldName %> 不能為空白"),{fieldName:inputData.label});if(inputData.note_locales&&!_.contains(inputData.note_locales,settings.get("locale"))){delete inputData.note}return _.template(inputData.options?selectTpl:inputTpl,inputData)}};var makeForm=function(res,$el,geo,order,cb){if(!res.form.length){return}var form=res.form;var warning=res.warning||"";var tool=res.tools||"";var tpl;tpl='<% if (warning) { %><span class="warning"><%= warning %>'+'<% if (tool[0]) { %><br/><a target="_blank" href="<%= tool[0].link %>"><%= tool[0].name %></a></span><% } %></span><% } %>'+'<div><ul><li><%= addressFields.join("</li><li>") %></li></ul></div>';$el.each(function(element){var $box=$(this);var role=$box.attr("data-role");var markup=[];var formType;formType=_.findWhere(form,{field:"address_form_type"}).value;for(var i=0;i<form.length;i++){if(form[i].field.indexOf("country")>-1&&res.form[i].options){form[i].countryList=res.form[i].options}else{form[i].countryList=countryList}form[i].currentCountry=geo;form[i].currentCountryName="";form[i].role=role;markup.push(formElementMarkup(form[i],role,formType))}$box.html(_.template(tpl,{warning:warning,tool:tool,addressFields:markup})).on("blur",'input[data-lang="localized_en"], input[data-lang="default"]',function(e){if(settings.get("locale")==="zh_TW"||settings.get("locale")==="zh_CN"){var val=$.trim(e.target.value),whitelist=[/。/g,/，/g,/（/g,/）/g,/>/g,/</g];for(var i=0;i<whitelist.length;i++){val=val.replace(whitelist[i],"")}if(val&&!/^[\)\(0-9a-zA-Z,.\/:& ~\''#－-]+$/gi.test(val)){tooltip.show(i18n.gettext("跨國寄送建議使用英文喔"),$(e.target),{position:"rb",isWithDismiss:false})}}}).on("click",function(){tooltip.close()});if(cb){cb()}})};var requestForForm=function($el,geo,role,order,cb){var url="/apiv2/cart/get_address_form?sid="+sid+"&role="+role;if(shippingMethod==="tranship"){url+="&ship_to_geo="+geo+"&tranship=true"}else if(role==="receiver"&&!isShipToEverywhereElse){url+="&shipping_method="+shippingMethod}else{if(geo){url+="&ship_to_geo="+geo}else{url+="&shipping_method="+shippingMethod}}request({url:url}).done(function(resp){if(!resp.error){makeForm(resp.result[0],$el,geo,order,cb)}else{alertModal.show(resp.error.message)}}).fail(function(){alertModal.error()})};var eventHandler=function(e){var $eT=$(e.target);var role=$eT.attr("data-role");if($eT.attr("data-type")==="country"){if(role==="buyer"||isShipToEverywhereElse||shippingMethod==="tranship"){var $form=$eT.closest(".m-i18n-address");requestForForm($form,$eT.val(),role)}else{$eT.val($eT.attr("data-default"));alertModal.show(_.template(i18n.gettext("要寄往<%= country %>以外的地區？"),{country:$eT.attr("data-default-name")}),{type:"confirm",confirmCb:function(){location.href="/cart"}})}}};exports.formElementMarkup=formElementMarkup;exports.init=function($el,order,countries,cb){if(!$el.length||!order){return}var role=$el.attr("data-role");sid=order.store;shippingMethod=order.shipping_method;if(settings.get("mobile")){countryList=countries[shippingMethod==="tranship"?"tranship":"nontranship"]}else{countryList=countries}isShipToEverywhereElse=_.contains(["everywhere else","everywhere else-paylater"],shippingMethod.toLowerCase());if(role==="receiver"&&_.contains(["sevenpickup","sevenpickupc2c","sevenpayatpickup","famiportpickup"],shippingMethod)){if(cb){cb()}return}requestForForm($el,isShipToEverywhereElse?"":settings.get("geo"),role,order,cb);$el.on("change focusout",function(e){e.preventDefault();e.type==="change"&&eventHandler(e);if(!Boolean(e.target.value)){var relatedfields=$(e.target).data("relatedfields");if(!relatedfields){return}var checkRelatedSelectors=relatedfields.split(",");var relatedInput;if(checkRelatedSelectors){checkRelatedSelectors='[name="'+checkRelatedSelectors.join('"],[name="')+'"]'}relatedInput=$el.find(checkRelatedSelectors);for(var i=0;i<relatedInput.length;i++){$(relatedInput).val("")}}});$el.on("change",function(e){$(e.target).data("is-user-input",$(e.target).val()?true:false)});inputListener.bind($el,"[data-autocomplete]").on("input-value-change",function(e){var $eT=$(e._target[0]);var role=$eT.data("role");var checkRelatedSelectors=$eT.data("relatedfields").split(",");var relatedInput;if($eT.val().length<$eT.data("min")){return}if(checkRelatedSelectors){checkRelatedSelectors='[name="'+checkRelatedSelectors.join('"],[name="')+'"]'}relatedInput=$el.find(checkRelatedSelectors);if(relatedInput.length){for(var i=0;i<relatedInput.length;i++){var aV=$(relatedInput[i]).data("autocomplete-value");var isSelect=$(relatedInput[i]).is("select");var v=$(relatedInput[i]).val();if(v&&aV&&aV!==v&&!isSelect){return}}}request({type:"POST",url:"/apiv2/cart/autocomplete_address_form",timeout:1e3,data:getFormData($el,role)[role]}).done(function(resp){if(resp.error){alertModal.error();return}var fields=resp.result[0].autocompleted_field_maps;if(!_.size(fields)){return}for(var field in fields){if(!fields[field]){continue}var $field=$el.find('[name="'+field+'"]');if($field.length&&!$field.data("is-user-input")){$field.val(fields[field]);$field.data("autocomplete-value",fields[field])}}})})};exports.concatAddress=function($form,role){var data={};var deferred=$.Deferred();if(role){data["receiver"]=getFormData($form,"receiver")["receiver"];if(role==="buyer"){data["buyer"]=getFormData($form,"buyer")["buyer"]}}if(isConcat){_.delay(function(){deferred.resolve(data,data.receiver.concat_address)},1);return deferred}if(!_.size(data[role])){deferred.reject()}else{$.ajax({type:"POST",data:data[settings.get("mobile")?role:"receiver"],url:"/apiv2/cart/get_address_preview"}).done(function(resp){if(resp.result){deferred.resolve(data,resp.result[0].address)}else{alertModal.show(resp.error.message);deferred.resolve(data,_.values(data[role]).join(""))}})}return deferred};var moveAddressToBuyer=function($from,$to){var $fromInputs=$from.find("select, input"),$toTarget,name,type;for(var i=0;i<$fromInputs.length;i++){name=$($fromInputs[i]).attr("name");type=$($fromInputs[i]).data("type");if(!settings.get("mobile")&&(type==="name"||type==="tel"||type==="telLocal")){$toTarget=$($to.find('[data-type="'+type+'"]'))}else{$toTarget=$($to.find('[name="'+name+'"]'))}if($toTarget.length&&($toTarget.val()===$toTarget.attr("default_val")||!$.trim($toTarget.val()))){$toTarget.val($fromInputs[i].value)}}};exports.bindSwitcher=function($el,$receiver,$buyer,cb){$el.on("change",function(e){isBuyerTheReceiver=e.target.checked;if(!settings.get("mobile")){if(isBuyerTheReceiver){moveAddressToBuyer($buyer,$receiver)}else{moveAddressToBuyer($receiver,$buyer);cb()}}})};exports.moveAddressToBuyer=moveAddressToBuyer});define("app/modules/intltelinput",function(require,exports){"use strict";var _=require("underscore");var settings=require("settings");exports.init=function(target,option){var $target=$(target);var baseOption={autoHideDialCode:false,preferredCountries:_.uniq([((option?option.country:null)||settings.get("geo")).toLowerCase(),"tw","hk","cn","us","jp","th","my","au","mo","sg","ca"])};if(option){for(var attr in option){if(option.hasOwnProperty(attr)){baseOption[attr]=option[attr]}}}if($target.length){$target.intlTelInput(baseOption)}};exports.countryCode=function(target,option){exports.init(target,option);var $target=$(target);if(!$target.length){return}var $listData=$target.closest(".intl-tel-input").find(".country-list");var $selectCountryData=$target.intlTelInput("getSelectedCountryData");$target.closest(".intl-tel-input").find("input").val($selectCountryData.name);$listData.on("click",function(){$selectCountryData=$target.intlTelInput("getSelectedCountryData");var $intlInput=$(this).closest(".intl-tel-input").find("input");$intlInput.val($selectCountryData.name);$intlInput.data("country",$selectCountryData.iso2.toUpperCase())});$target.on("click",function(){$target.intlTelInput("showDropdown")});return{updateFlag:function(country){$target.intlTelInput("selectCountry",country.toLowerCase());var $intlInput=$target.closest(".intl-tel-input").find("input");$selectCountryData=$target.intlTelInput("getSelectedCountryData");$intlInput.val($selectCountryData.name);$intlInput.data("country",$selectCountryData.iso2.toUpperCase())}}}});define("app/modules/item",function(require,exports){"use strict";exports.discountPrice=function(price,discount){if(!discount){return price}return Math.ceil(price*(discount/100))}});define("app/modules/itemNote",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var erbTemplate=require("utils/erbTemplate");var bar=require("ui/notification/bar");var alertModal=require("ui/notification/alertModal");var request=require("net/request");var defaultTemplateContext={$:$,_:_,i18n:i18n,intl:{"更新註記":i18n.gettext("更新註記"),"Pinkoi 管理員紀錄":i18n.gettext("Pinkoi 管理員紀錄"),"增加":i18n.gettext("增加")}};var erb=new erbTemplate({itemNoteComponent:"".concat('<div class="m-item-note">','<button type="button" class="update-note action-button"><%=$scope.i18n.gettext("更新註記")%></button>','<label for="note-container"><%=$scope.i18n.gettext("Pinkoi 管理員紀錄")%> : </label>','<div class="note-container"/>','<div class="editor-container"/>',"</div>"),itemNoteEditor:"".concat('<textarea name="description" class="inline"></textarea>','<div class="editor-controller">','<button class="m-button-small" name="add"><%=$scope.i18n.gettext("增加")%></button>',"</div>"),noteRecordComponent:"".concat('<div class="note">',"<% if($scope.editable) { %>",'<span class="remove">','<button type="button" class="action-button" >X</button>',"</span>","<% } %>",'<prev data-nid="<%= $scope.note.nid %>"><%= $scope.note.description %></prev>',"</div>")});var onError={unkonwFail:function(xhr,statusText,err){alertModal.error(_.template("Failure: <%= status %> <%= responseText %>")(_.pick(xhr,"status","responseText")))},general:function(error){alertModal.error(_.template("Failure: <%= code %> <%= message %>")(_.pick(error,"code","message")))}};var onEvent={noteAddClick:function(evt){evt.preventDefault();var self=evt.data.self;var $notes=self.$container.find(".note-container");var $updateNote=self.$container.find(".update-note");var $description=self.$container.find('textarea[name="description"]');$notes.append(erb.generate("noteRecordComponent",_.defaults({note:{nid:undefined,description:$description.val()},editable:self.options.editable},defaultTemplateContext)));if(!$updateNote.is(":visible")){$updateNote.show()}self.changeset.addNote({nid:"",description:$description.val()});$description.val("")},noteRemoveClick:function(evt){evt.preventDefault();var self=evt.data.self;var $removeButton=$(this);var $note=$removeButton.closest(".note").find("prev");var $updateNote=self.$container.find(".update-note");$removeButton.closest(".note").remove();if(!$updateNote.is(":visible")){$updateNote.show()}self.changeset.removeNote({nid:$note.data("nid"),description:$note.text()})},updateNoteClick:function(evt){evt.preventDefault();var self=evt.data.self;if(!!self.inUpdate){return}self.inUpdate=true;var postData={tid:self.tid,add:self.changeset.add,remove:self.changeset.remove};request({type:"POST",url:"/apiv2/item/post_notes",data:JSON.stringify(postData),contentType:"application/json;charset=utf-8",dataType:"json"}).done(function(res){if(res.error){onError.general(res.error);return}bar.show("note updated.");self.changeset.reset();self.show()}).fail(onError.unkonwFail).always(function(){self.inUpdate=false})}};var noteChangeset=function(){this.add=[];this.remove=[]};noteChangeset.prototype={addNote:function(note){this.add.push(note)},removeNote:function(note){var targetNote=_.findWhere(this.add,note);if(typeof targetNote!=="undefined"){this.add=_.without(this.add,targetNote);return}this.remove.push(note)},reset:function(){this.add=[];this.remove=[]}};var note=function(container,tid,opts){this.$container=$(container);this.tid=tid;this.options=_.extend({editable:false},opts);this.changeset=new noteChangeset};note.prototype={fetchNote:function(){var self=this;var deferredReq=$.Deferred();request({type:"GET",url:"/apiv2/item/get_notes?".concat($.param({tid:self.tid})),dataType:"json"}).done(function(res){if(res.error){return deferredReq.reject(res.error)}deferredReq.resolve(res.result)}).fail(function(xhr,state,error){deferredReq.reject({code:xhr.status,message:xhr.responseText})});return deferredReq.promise()},show:function(notesData){var self=this;var itemNoteComponent=erb.generate("itemNoteComponent",defaultTemplateContext);var deferNotes=$.Deferred();this.$container.html(itemNoteComponent);if(!notesData){this.fetchNote(this.tid).done(function(data){deferNotes.resolve(data)}).fail(deferNotes.reject)}else{deferNotes.resolve(notesData)}deferNotes.done(function(notes){var $notes=self.$container.find(".note-container");notes.forEach(function(note,idx,array){$notes.append(erb.generate("noteRecordComponent",_.defaults({note:note,editable:self.options.editable},defaultTemplateContext)));
});if(self.options.editable){self.$container.find(".editor-container").html(erb.generate("itemNoteEditor",defaultTemplateContext))}}).fail(onError.general);this.$container.on("click",'button[name="add"]',{self:this},onEvent.noteAddClick);this.$container.on("click",".remove button",{self:this},onEvent.noteRemoveClick);this.$container.on("click","button.update-note",{self:this},onEvent.updateNoteClick)}};return note});define("app/modules/loginBanner",function(require,exports){"use strict";var _=require("underscore");var settings=require("settings");var modal=require("ui/modal");var login=require("mapp/pages/login");var urlType=require("utils/urlType");var local=require("storage/local");var urlparse=require("net/urlparse");var isMobile=settings.get("mobile");var gLANG=settings.get("lang");var defaultTitle='立即註冊，首購不限金額現折 <span class="hightlight">5%</span>';var eventCategory="loginBanner";var loginBtnOneLocale={zh_TW:"Facebook 註冊",zh_HK:"Facebook 註冊",zh_CN:"微博注册",en:"Sign in with Facebook",ja:"Facebookログイン",th:"Sign in with Facebook"};var loginBtnTwoLocale={zh_TW:"快速建立帳號",zh_HK:"電郵註冊",zh_CN:"微信注册",en:"Register",ja:"新規会員登録",th:"สร้างบัญชีใหม่"};var bannerTemplate=['<div class="m-login-banner">','<div class="m-login-banner__block">','<div class="m-login-banner__center">','<div class="m-login-banner__title"><%= title %></div>','<div class="m-login-banner__actions">',"<% if (isCN) { %>",'<a class="m-br-button m-br-button--lg m-login-banner__btn m-login-banner__btn--weibo" href="/apiv2/account/weibo_oauth"><%= loginBtnOne %></a>','<a class="m-br-button m-br-button--lg m-br-button--purchase m-login-banner__btn m-login-banner__btn--weixin" href="/apiv2/account/weixin_oauth"><%= loginBtnTwo %></a>',"<% } else { %>",'<a class="m-br-button m-br-button--lg m-login-banner__btn m-login-banner__btn--fb" href="/apiv2/account/facebook_oauth"><%= loginBtnOne %></a>','<a class="m-br-button m-br-button--lg m-br-button--purchase m-login-banner__btn m-login-banner__btn--signup" href="#signup"><%= loginBtnTwo %></a>',"<% } %>","</div>","</div>",'<div class="m-login-banner__close"></div>',"</div>","</div>"].join("");var actions=function(){var eventLabel="on"+urlType.getCurrentUrlType();$(".m-login-banner__btn--fb").click(function(){dataLayer.push({event:"ga",eventCategory:eventCategory,eventAction:"click facebook button",eventLabel:eventLabel})});$(".m-login-banner__btn--signup").click(function(){dataLayer.push({event:"ga",eventCategory:eventCategory,eventAction:"click signup button",eventLabel:eventLabel});if(isMobile){location.href="/login?next="+encodeURIComponent(location.href)+"#signup"}else{_.delay(function(){login.loginModal(modal)},10)}});$(".m-login-banner__btn--weibo").click(function(){dataLayer.push({event:"ga",eventCategory:eventCategory,eventAction:"click weibo button",eventLabel:eventLabel})});$(".m-login-banner__btn--weixin").click(function(){dataLayer.push({event:"ga",eventCategory:eventCategory,eventAction:"click weixin button",eventLabel:eventLabel})});$(".m-login-banner__close").click(function(){dataLayer.push({event:"ga",eventCategory:eventCategory,eventAction:"click close button",eventLabel:eventLabel});$("#gheader .m-login-banner").fadeOut();local.set("g.loginBanner.closed",true,"1d")})};function shouldLoginBannerDisplay(){var inErrorPage=!!document.querySelector("#s-skip-login-modal");var url=urlparse.current();var promptLoginModal=url.get("next")||url.get("_login");return!inErrorPage&&!promptLoginModal}exports.actions=actions;exports.init=function(args){if(!shouldLoginBannerDisplay()){return}var bannerTitle=args.title||defaultTitle;var isClose=local.get("g.loginBanner.closed")||false;function showBanner(){$("#gheader .login").after(_.template(bannerTemplate,{title:bannerTitle,loginBtnOne:loginBtnOneLocale[gLANG],loginBtnTwo:loginBtnTwoLocale[gLANG],isCN:gLANG==="zh_CN"}));actions();$("#gheader .m-login-banner").fadeIn();_.delay(function(){$("#gheader .m-login-banner").fadeOut()},15e3)}if(!settings.get("uid")&&!isClose){_.delay(function(){showBanner()},1e3)}}});define("app/modules/messageLocaleTip",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var settings=require("settings");var request=require("app/modules/request");var toSellerMsgTpl=i18n.gettext("此設計師使用<%= receiverLanguage %>，建議以<%= suggestedLanguage %>與設計師溝通，縮短等待時間。如需協助，<%= emailLink %>請來信</a>。");var toBuyerMsgTpl=i18n.gettext("此會員使用<%= receiverLanguage %>，建議以<%= suggestedLanguage %>與會員溝通，縮短等待時間。如需協助，<%= emailLink %>請來信</a>。");var isSameLanguage=function(suggestedLanguage,receiverLanguage){if(suggestedLanguage==receiverLanguage){return true}else if(suggestedLanguage.indexOf("zh")>-1&&receiverLanguage.indexOf("zh")>-1){return true}else{return false}};var getSuggestedLanguage=function(language){if(language==="ja"&&settings.get("locale")==="zh_TW"){return"英文或日文"}return i18n.gettext("英文")};exports.init=function(tipWrapper,receiverUid,options){options=options||{};var $tipWrapper=$(tipWrapper);var onCheckReceiver=options.onCheckReceiver;var onRequestService=options.onRequestService;_.isFunction(onCheckReceiver)&&onCheckReceiver(true);request({url:"/apiv2/user/get?fields=seller,locale&uid="+receiverUid}).done(function(resp){_.isFunction(onCheckReceiver)&&onCheckReceiver(false);if(resp.result){var result=resp.result[0];if(!isSameLanguage(settings.get("locale"),result.locale)){$tipWrapper.html(_.template(result.seller&&!options.isForcedBuyer?toSellerMsgTpl:toBuyerMsgTpl,{receiverLanguage:result.locale_name,suggestedLanguage:getSuggestedLanguage(result.locale),emailLink:settings.get("locale")==="th"||result.locale==="th"?'<a href="mailto:th-community@pinkoi.com">':'<a data-click="customer-service-translate">'}));$tipWrapper.show();$tipWrapper.on("click","[data-click]",function(){if(!settings.get("mobile")){"pinkoi"in window&&pinkoi.gmodal.close()}require(["external/customerService"],function(c){_.isFunction(onRequestService)&&onRequestService();c.disableHelpCenter().show()})})}}}).fail(function(error){_.isFunction(onCheckReceiver)&&onCheckReceiver(false)})}});define("app/modules/messenger",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var erbTemplate=require("utils/erbTemplate");var alertModal=require("ui/notification/alertModal");var alertModal=require("ui/notification/alertModal");var date=require("utils/date");var domForm=require("dom/form");var request=require("net/request");var defaultTemplateContext={$:$,_:_,date:date,i18n:i18n,intl:{"站內信":i18n.gettext("站內信"),"自動翻譯":i18n.gettext("自動翻譯"),"繁體中文":i18n.gettext("繁體中文"),"附加圖片或檔案":i18n.gettext("附加圖片或檔案")}};var erb=new erbTemplate({messageContainer:"".concat('<div class="m-messenger">','<div class="header">','<h1><%=$scope.i18n.gettext("站內信")%></h1>','<div class="translation-pod">','<%=$scope.i18n.gettext("自動翻譯")%>','<a class="translate", data-tolocale="zh_TW"><%=$scope.i18n.gettext("繁體中文")%></a>','<a class="translate", data-tolocale="en">English</a>',"</div>","</div>","<%= $scope.messageBoxComponent %>","<%= $scope.editorComponent %>","</div>"),editorComponent:"".concat('<div class="message-editor">','<form method="POST" enctype="multipart/form-data" action="/apiv2/message/send">','<div class="editor-container">','<textarea name="description" class="inline"></textarea>','<div class="editor-controller">',"<% if (Modernizr.ajaxfileupload) { %>",'<div class="attachment">','<div class="file">','<span><%=$scope.i18n.gettext("附加圖片或檔案")%></span>','<input name="file" type="file" accept=".png,.jpg,.gif,.ai,.psd,.bmp,.eps,.cdr,.pdf">',"</div>","</div>","<% } %>",'<button class="m-button-small submit"><%=$scope.i18n.gettext("回覆訊息")%></button>',"</div>","</div>","</form>","</div>"),messageBoxComponent:"".concat('<div class="message-box">','<div class="conversation" data-created="<%= $scope.message.created %>">','<div class="v-row">','<div class="avatar h-cell">','<img src="<%= $scope.message.sender_avatar %>">',"</div>",'<div class="h-cell expand">','<span class="nick"><%= $scope.message.sender_nick %></span>','<span class="created"><%= $scope.date.strftime($scope.message.created) %></span>','<div class="content">',"<%=pinkoi.magicText.replace($scope.message.description, {imgMaxW:560, italic:false})%>","</div>","</div>","</div>","</div>","<% $scope.message.reply.forEach(function(msg, idx, array) { %>",'<div class="conversation" data-created="<%= msg.created %>">','<div class="v-row">','<div class="avatar h-cell">','<img src="<%= msg.sender_avatar %>">',"</div>",'<div class="h-cell expand">','<span class="nick"><%= msg.sender_nick %></span>','<span class="created"><%= $scope.date.strftime(msg.created) %></span>','<div class="content">',"<%=pinkoi.magicText.replace(msg.description, {imgMaxW:560, italic:false})%>","</div>","</div>","</div>","</div>","<% }) %>","</div>")});var onError={unknow:function(xhr,statusText,err){alertModal.show(_.template("Failure: <%= status %> <%= responseText %>")(_.pick(xhr,"status","responseText")))},general:function(error){alertModal.show(_.template("Failure: <%= code %> <%= message %>")(_.pick(error,"code","message")))}};var onEvent={sendMessage:function(evt){evt.preventDefault();var self=evt.data.self;var $container=self.$container;var meta=self.meta;var $form=$(this).closest("form");var url=$form.attr("action");domForm.post(url,$form,meta).done(function(res){if(res.error){return onError.general(res.error)}self.fetchMessage(res.result[0].mid,function(err,message){if(err){return onError.general(err)}self.message=message;self.show($container);$container.trigger("message.afterSend",res.result[0])})}).fail(onError.unknow)},translate:function(evt){evt.preventDefault();var $button=$(this);var self=evt.data.self;var mid=self.meta.mid;var toLocale=$button.data("tolocale");if(!!$button.data("translated")){return}$button.html(i18n.gettext("翻譯中..."));request({type:"GET",url:"/apiv2/translation/message?".concat($.param({mid:mid,to_locale:toLocale}))}).done(function(res){if(res.error){return onError.general(res.error)}var translatedMessage=res.result[0];$button.html(i18n.gettext("已翻譯")).addClass("translated").data("translated",true);self.$container.find(".conversation").each(function(idx,elem){var $content=$(elem).find(".content");if(idx===0){$content.html(pinkoi.magicText.replace(translatedMessage.description,{imgMaxW:560,italic:false}))}else{$content.html(pinkoi.magicText.replace(translatedMessage.reply[idx-1].description,{imgMaxW:560,italic:false}))}})})}};var messenger=function(meta,msg){this.meta=meta;this.message=msg};messenger.prototype={fetchMessage:function(mid,cb){this.meta.mid=mid;request({type:"GET",url:"/apiv2/message/get?".concat($.param({mid:this.meta.mid})),dataType:"json"}).done(function(result){if(result.error){return cb(result.error)}var message=result.result[0];cb(null,message)}).fail(function(xhr,state,throwError){cb(xhr.responseText)})},show:function(container){var messageBox;var editor;this.$container=$(container);if(this.message){messageBox=erb.generate("messageBoxComponent",_.defaults({message:this.message},defaultTemplateContext))}editor=erb.generate("editorComponent",defaultTemplateContext);this.$container.html(erb.generate("messageContainer",_.defaults({messageBoxComponent:messageBox,editorComponent:editor},defaultTemplateContext)));if(this.message){this.enableTranslation(true);this.scrollToLatest()}this.$container.find('form[action="/apiv2/message/send"]').submit({self:this},onEvent.sendMessage);this.$container.on("click",".translation-pod a.translate",{self:this},onEvent.translate);return this},on:function(eventType,handler){this.$container.on(eventType,handler)},enableTranslation:function(enable){var $pod=this.$container.find(".translation-pod");if(!!enable){$pod.css("display","inline-block")}else{$pod.css("display","none")}},scrollToLatest:function(){var $messageBox=this.$container.find(".message-box");$messageBox.scrollTop($messageBox[0].scrollHeight)}};return messenger});define("app/modules/navigation",function(require,exports){"use strict";var i18n=require("i18n");var _=require("underscore");var urlparse=require("net/urlparse");var settings=require("settings");var allCategories;var subMaps;var $nav;var $allCat;var subTpl=['<div class="sub-categories">',"<% _.each(subMap, function(column, index) { %>",'<div class="sub-column">',"<% _.each(column, function(group) { %>","<ul>",'<li class="sub-title"><%= group.group_name %></li>',"<% _.each(group.subcategories, function(sub) { %>",'<li><a href="/browse?category=<%= category.cid %>&subcategory=<%= sub.id %>&ref_sec=topnavigation" data-sid="<%= sub.id %>"><%= sub.name %></a></li>',"<% }) %>","</ul>","<% }) %>","<% if ((index + 1) === subMap.length) { %>",'<a class="all-category" href="/browse?category=<%= category.cid %>"><%= allName %></a>',"<% } %>","</div>","<% }) %>","</div>"].join("");var getPromoLogData=function(href,promoCopywriting){if(!href){return}var pathBasePromoId=decodeURI(urlparse.getRelativePath(href,["ref","promo_tid"]));return{id:pathBasePromoId,name:promoCopywriting||pathBasePromoId,position:"topnavigation"}};var extendSubData=function(data){var allName=_.template(i18n.gettext("所有 <%= cname %>"),{cname:data.category.name});var extendData={current:"/"+urlparse.current().paths[0],currentpath:urlparse.current().path,allName:allName};return _.extend(data,extendData)};var renderSubCategory=function(cid){var $subList=$allCat.find(".category-subs");var category=_.find(allCategories,function(category){return category.cid===cid});var subMap={category:category,subMap:subMaps[cid]};$subList.html(_.template(subTpl,extendSubData(subMap)))};var renderAllCategoies=function(){$allCat=$nav.find(".nav-first-li .all-categories");var $catList=$allCat.find(".nav-category-li");var $subList=$allCat.find(".category-subs");var cid=null;var catFirst=$catList.first();cid=catFirst.data("cid");catFirst.addClass("hover");renderSubCategory(cid);$subList.addClass("active");$catList.hover(function(){var $this=$(this);$this.addClass("hover-flag");_.delay(function(){if($this.hasClass("hover-flag")){$catList.removeClass("hover");$this.addClass("hover");if(cid!==$this.data("cid")){$subList.removeClass("active");cid=$this.data("cid")}renderSubCategory(cid);_.delay(function(){$subList.addClass("active")},10)}},200)},function(){$(this).removeClass("hover-flag")})};var bindTracking=function(){$nav.find(".hot-categories .hot-subs a").on("click",function(e){var href=$(this).attr("href");var index=$(this).closest(".hot-categories").attr("data-index");if(_.isUndefined(href)||_.isUndefined(index)){return}dataLayer.push({event:"ga",eventCategory:"webSubNav",eventAction:"hotCategory"+index,eventLabel:href,nonInteraction:true})});$nav.find(".campaign-link").on("click",function(e){var $this=$(this);var promoCopywriting=$this.find("span").text();var promoData=getPromoLogData($this.attr("href"),promoCopywriting);dataLayer.push({event:"ga:ee",eventCategory:"navigation",eventAction:"promo click",eventLabel:"",ecommerce:{promoClick:{promotions:[promoData]}}})});$nav.find(".hot-categories .hot-banner a").on("click",function(e){var href=$(this).attr("href");var index=$(this).closest(".hot-categories").attr("data-index");if(_.isUndefined(href)||_.isUndefined(index)){return}dataLayer.push({event:"ga",eventCategory:"webSubNav",eventAction:"hotCategory"+index,eventLabel:href+"&from_banner",nonInteraction:true})})};var renderHotBanners=function($list,banners,cid){var $hotBanners=$list.find(".hot-banner .banner");var supportLoading=settings.get("browserLoading");_.each($hotBanners,function(element,index){var banner=banners[index];var bannerImage='<img class="m-libs-lazy" data-src="'+banner.image+'" alt="'+banner.subcat_name+'">';if(supportLoading){bannerImage='<img loading="lazy" src="'+banner.image+'" alt="'+banner.subcat_name+'">'}$(element).attr("href","/browse?promo_tid="+banner.promo_tid+"&category="+cid+"&subcategory="+banner.subcat_id);$(element).find(".image").append(bannerImage);$(element).find(".text").html(banner.subcat_name)})};var renderHotSubCategories=function(categories,hotBanners){_.delay(function(){_.each(categories,function(category,index){var cid=category.cid;var $list=$nav.find('.nav-first-li[data-cid="'+cid+'"]');var $secondList=$list.find(".hot-categories .hot-subs");var subMap={category:category,subMap:subMaps[cid]};renderHotBanners($list,hotBanners[cid],cid);$secondList.append(_.template(subTpl,extendSubData(subMap)));if(index===4){bindTracking()}})},10)};var renderNewBadgeDot=function(){var $detectNewList=$nav.find('.nav-first-li[data-detect="new"]');$detectNewList.each(function(index,element){var $this=$(element);if($this.find(".new-badge").length>0){$this.addClass("has-new-badge")}})};var naviHover=function(){var lastIndex=null;var delayIn=null;$nav.find(".nav-first-li").each(function(index,item){$(item).data("index",index);$(item).addClass("nav-first-li--"+index)});$nav.find(".nav-first-li").hover(function(){var $this=$(this);var $subMenu=$this.find(".nav-second");$this.data("hovering",true);delayIn&&clearTimeout(delayIn);delayIn=setTimeout(function(){if(!$this.data("hovering")){return}if(lastIndex!==null&&lastIndex!==$this.data("index")){var $prevItem=$nav.find(".nav-first-li--"+lastIndex);var $prevSubItem=$nav.find(".nav-first-li--"+lastIndex).find(".nav-second");$prevItem.removeClass("hover").data("hovering",false);$prevSubItem.animate({opacity:0},200,function(){$prevSubItem.find(".nav-second").hide()})}lastIndex=$this.data("index");$subMenu.show().animate({opacity:1},200,function(){var isCampaignsNav=$this.hasClass("campaigns-nav");$this.addClass("hover");if(isCampaignsNav){var $promosLink=$this.find(".campaign-link");var promos=[];$promosLink.each(function(index,promoLinkEl){var $promoLink=$(promoLinkEl);var promoCopywriting=$promoLink.find("span").text();var promoData=getPromoLogData($promoLink.attr("href"),promoCopywriting);promoData&&promos.push(promoData)});dataLayer.push({event:"ga:ee",eventCategory:"navigation",eventAction:"promo impression",eventLabel:"",ecommerce:{promoView:{promotions:promos}}})}})},200)},function(){var $this=$(this);$this.data("hovering",false);setTimeout(function(){var $subMenu=$this.find(".nav-second");if($this.data("hovering")){return}$this.removeClass("hover");$subMenu.animate({opacity:0},200,function(){$subMenu.hide()})},300)})};var updateUserPhotoBadge=function(data){var $navHeader=$("#gheader");var $user=$navHeader.find(".header-right .user");var $userPhoto=$user.find(".image");var msgCount=$user.data("msg-cnt")||0;var nsCount=data&&data.ns_num?data.ns_num:0;var userBageCount=msgCount+nsCount;if(data&&data.ns_num){$user.data("ns-cnt",data.ns_num)}if(data&&data.msg_num){$user.data("ns-msg",data.msg_num)}if(userBageCount>0){var _userBageCount=userBageCount;if(userBageCount>99){_userBageCount="99+"}if(userBageCount>0){$userPhoto.append('<div class="badge">'+_userBageCount+"</div>")}}};var init=function(config){$nav=$("#g-navigation");naviHover();allCategories=config.allCategories;subMaps=config.subMaps;renderHotSubCategories(config.hotCategories,config.hotBanners);renderAllCategoies();renderNewBadgeDot();$("#gheader .header-right .notification").on("click",function(){dataLayer.push({event:"ga",eventCategory:"webSubNav",eventAction:"clickNavNotification",eventLabel:"icon",nonInteraction:true})});$("#gheader .js-nav-ns").on("click",function(){dataLayer.push({event:"ga",eventCategory:"webSubNav",eventAction:"clickNavNotification",eventLabel:"textLink",nonInteraction:true})})};exports.updateUserPhotoBadge=updateUserPhotoBadge;exports.init=init});define("app/modules/notification",function(require,exports){"use strict";var local=require("storage/local");var request=require("net/request");var i18n=require("i18n");var _=require("underscore");var urlparse=require("net/urlparse");var alertModal=require("ui/notification/alertModal");var url=require("app/modules/url");var decodeHTMLEntities=require("utils/decodeHTMLEntities");var numberBadge=require("app/modules/numberBadge");var navigation=require("app/modules/navigation");var updateNum=function(optNum){numberBadge.get({storageName:"g.notiNum",apiUrl:"/apiv2/nc/query_unread_count",resultName:"unread_count",target:$("#gheader").find(".notification .image, #gheader .js-nav-ns"),cb:function(ns_num){navigation.updateUserPhotoBadge({ns_num:ns_num})}},optNum)};var dialogOpenTpl=['<div class="m-notice-dialog">','<div class="m-notice-dialog__container">','<div class="m-notice-dialog__border">','<a class="m-notice-dialog__header" href="/notification">','<div class="m-notice-dialog__title">',i18n.gettext("最新通知"),"</div>",'<div class="m-notice-dialog__all">',i18n.gettext("看全部"),"</div>","</a>"];var dialogCloseTpl=["</div>","</div>","</div>"];function renderDialog(notices){var $target=$("#gheader").find(".notification");var noticeTpl=["<div>","<% _.each(notices, function(notice) { %>",'<div class="m-noti-msg',"<% if (!notice.read) { %>"," s-unread","<% } %>",'">','<div class="m-noti-msg__link" data-content="<%= notice.content_key %>" data-id="<%= notice.noti_id %>">','<div class="m-noti-msg__image">','<img loading="lazy" src="<%= notice.image_url %>" alt="user avatar">',"</div>",'<div class="m-noti-msg__content">','<div class="m-noti-msg__text">','<div class="m-noti-msg__title"><%= decodeHTMLEntities(notice.title_text) %></div>',"<% if (notice.content_html) { %>",'<div class="m-noti-msg__desc"><%= notice.desc %></div>',"<% } %>","</div>",'<div class="m-noti-msg__bottom">','<div class="m-noti-msg__tag"><%= notice.cat_tag %></div>','<div class="m-noti-msg__time"><%= notice.received_str %></div>',"</div>","</div>","</div>","</div>","<% }) %>","</div>"];var dialogTemplate=_.flatten([dialogOpenTpl,noticeTpl,dialogCloseTpl]).join("");$target.append(_.template(dialogTemplate,{notices:notices,decodeHTMLEntities:decodeHTMLEntities}));$target.find(".m-noti-msg__link").click(function(e){var contentKey=$(this).attr("data-content");var id=$(this).attr("data-id");if(!id){return}request({type:"POST",url:"/apiv2/nc/mark_noti_read",data:{noti_id:id}}).then(function(resp){if(resp.error){alertModal.error();return false}if(contentKey){location.href="/notification?content_key="+contentKey}})})}function renderEmpty(){var $target=$("#gheader").find(".notification");var emptyTpl=['<div class="m-notice-dialog--empty">','<div class="m-notice-dialog--empty__image">','<img loading="lazy" src="<%= emptyImage %>" />',"</div>",'<div class="m-notice-dialog--empty__title"><%= emptyText %></div>',"</div>"];var dialogTemplate=_.flatten([dialogOpenTpl,emptyTpl,dialogCloseTpl]).join("");$target.append(_.template(dialogTemplate,{emptyImage:url.getS3ObjectUrl("/pinkoi.site/modules/empty_state/order_v2.png","cdn04"),emptyText:i18n.gettext("還沒有收到通知")}))}function getNoticeDialog(){request({type:"GET",url:"/apiv2/nc/list_cats?from_dialog=1"}).then(function(resp){if(resp.error){alertModal.error();return false}var latestNotice=[];_.each(resp.result[0].latest_notis,function(notice,index){if(index>=5){return}if(notice.content_html){notice.desc=notice.content_html}if(!notice.action_url){notice.action_url=urlparse.buildUrlUponCurrent({path:"/notification"})}latestNotice.push(notice)});if(latestNotice.length>=1){renderDialog(latestNotice)}else{renderEmpty()}})}exports.clearNum=function(){local.del("g.notiNum")};exports.init=function(){if(urlparse.current().paths[0]!=="notification"){updateNum();_.delay(function(){getNoticeDialog()},500)}}});define("app/modules/numberBadge",function(require,exports){"use strict";var local=require("storage/local");var _=require("underscore");var pageOriginBadge={};var _require4=require("app/modules/visibilityChange"),bindVisibilityChange=_require4.bindVisibilityChange;function renderToBadge(options,updateNum){var $target=options.target;var $badge=$target.find(".badge");var hasBadge=!!$badge.length;options.layerFunc&&options.layerFunc(updateNum);if(updateNum){var _updateNum=updateNum;if(_updateNum>99){_updateNum="99+"}if(hasBadge){$badge.html(_updateNum)}else{$('<div class="badge">'+_updateNum+"</div>").appendTo($target);options.cb&&options.cb(updateNum)}return updateNum}else if(updateNum===0&&hasBadge){$badge.remove();options.cb&&options.cb(0);return 0}}function numberBadge(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var optNum=arguments[1];if(!options||!options.storageName||!options.apiUrl||!options.resultName||!options.target){return}if($.type(optNum)!=="undefined"){optNum=parseInt(optNum);local.set(options.storageName,optNum,"60S")}var updateNum=local.get(options.storageName);if($.type(updateNum)!=="number"){$.get(options.apiUrl,function(resp){if(resp&&resp.result){return numberBadge(options,resp.result[0][options.resultName])}})}else{pageOriginBadge[options.storageName.toString()]={options:options,number:updateNum};return renderToBadge(options,updateNum)}}var listenInit=true;function listenBadgeStorage(){_.delay(function(){if(!listenInit){return}var targetExistKeys=[];_.each(pageOriginBadge,function(origin,key){if(origin.options.target.length>0){targetExistKeys.push(key)}});if(targetExistKeys.length>0){bindVisibilityChange("numberbadge",function(){_.each(targetExistKeys,function(existKey){var originBadge=pageOriginBadge[existKey.toString()];if(local.get(existKey)!=originBadge.number){numberBadge(originBadge.options)}});listenInit=false})}},1e3)}exports.get=numberBadge;exports.listen=listenBadgeStorage});define("app/modules/pincode",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var settings=require("settings");var request=require("net/request");var tel=require("ui/tel");var tooltip=require("ui/tooltip");var alertModal=require("ui/notification/alertModal");var isMobile=settings.get("mobile");var backdrop=require("ui/backdrop");var modal;var trimCountryCode=function(phoneNumber){return phoneNumber.replace("+886","")};var updateAddressAndMobile=function(data,defer){request({type:"POST",url:"/apiv2/store/update",data:data}).done(function(resp){if(resp.error){alertModal.show(resp.error.message);defer.reject();return}modal.hide();defer.resolve()})};var askAddressAndMobile=function(data){if(_.isUndefined(data)){throw new Error("You need data from the result of /apiv2/store/get.")}if(data.mobile){data.mobile=trimCountryCode(data.mobile)}var modalTemplate=_.template(['<div class="m-pincode">','<h3 class="m-modal-title modal-title">設計館資訊</h3>','<p class="desc">我們留意到你沒有填寫以下兩欄設計館基本資料喔！這些資料是設計館必填基本資料，同時也會成為 7-11 交貨便寄件人資訊。為避免影響出貨以設計師權益，請先補齊以下資訊。</p>','<div class="form-fields">','<label for="m-pincode-personal-name">真實姓名</label>','<input id="m-pincode-personal-name" name="personal_name" value="<%= personal_name %>" required>','<label for="m-pincode-mobile">手機號碼</label>','<input id="m-pincode-mobile-country" name="mobile-country" value="+886" disabled>','<input id="m-pincode-mobile" name="mobile" value="<%= mobile %>" required>',"</div>",'<div class="form-footer '+(isMobile?"m-button-group":"")+'">',isMobile?'<a class="m-button-gray" data-action="cancel">取消</a>':"",isMobile?'<a class="m-button-pink" data-action="submit">儲存</a>':'<a class="m-button" data-action="submit">儲存</a>',"</div>","</div>"].join(""),data);var askAddressAndMobileDefer=$.Deferred();modal.show(modalTemplate,{anywhereHide:false,withCloseBtn:true,onHideCb:function(){askAddressAndMobileDefer.reject()}}).on("click","[data-action]",function(e){var $fields=modal.$body.find("input[required]");var action=$(e.target).data("action");var isAborted=false;var packedData={};switch(action){case"submit":_.each($fields,function(field){if(!field.value&&!isAborted){tooltip.show(i18n.gettext("請勿留空"),$(field));isAborted=true}else{packedData[field.name]=field.value}});if(!isAborted){packedData.country_calling_code="+886";updateAddressAndMobile(packedData,askAddressAndMobileDefer)}break;default:modal.hide();askAddressAndMobileDefer.reject()}});backdrop.show();tel.intlTelFields("#m-pincode-mobile-country","#m-pincode-mobile");return askAddressAndMobileDefer};var getPincode=function(oid,defer){backdrop.show();request({type:"POST",url:"/apiv2/order/get_pincode",data:{oid:oid}}).done(function(resp){backdrop.hide();if(resp.error){alertModal.show(resp.error.message);defer.reject();return}if(resp.result[0]&&resp.result[0].pincode){defer.resolve(resp.result[0].pincode)}defer.reject()});return};var checkAddress=function(oid,_modal){if(!_modal){throw new Error("_modal is required")}modal=_modal;var defer=$.Deferred();var data={sid:settings.get("uid"),fields:"personal_name,mobile"};backdrop.show();request({url:"/apiv2/store/get?"+$.param(data)}).done(function(resp){var result;var isValid=false;backdrop.hide();if(resp.error){alertModal.error(resp.error.message);defer.reject();return}result=resp.result[0];isValid=_.every(result,function(value){return value&&value.length});if(result.tel){delete result.tel}if(isValid){getPincode(oid,defer)}else{askAddressAndMobile(result).done(function(){getPincode(oid,defer)}).fail(function(){defer.reject()})}});return defer};exports.get=checkAddress});define("app/modules/request",function(){"use strict";function request(args){return $.ajax(args)}return request});define("app/modules/requestNotification",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var settings=require("settings");var sw=require("net/serviceWorker");var fixedModal=require("ui/notification/fixedModal");var backdrop=require("ui/backdrop");var meter=require("app/globals/meter");var url=require("app/modules/url");var hasNoServiceWorkerORNotifactionAPI=Boolean(!window.hasOwnProperty("Notification")||!navigator.serviceWorker);function urlBase64ToUint8Array(base64String){var padding="=".repeat((4-base64String.length%4)%4);var base64=(base64String+padding).replace(/\-/g,"+").replace(/_/g,"/");var rawData=window.atob(base64);var outputArray=new Uint8Array(rawData.length);for(var i=0;i<rawData.length;++i){outputArray[i]=rawData.charCodeAt(i)}return outputArray}var VAPID=settings.get("production")?"BE-a0OghK9q1OitWWNsYlxTuaAyFKM-feaVb2WzJZ5uTtkvi1TPJ0-l_JbB5f7x_9wAJyJE-pf3kZ-GjYRUvM2w":"BO952CK_dmJZTt_7Bu_BEymxGJSQE1zsPLRA_5EDf2fiOW0oDlXK1yuYCXxvr_GieyiN7npK4pdh5HuHd3Jq_HM";var notify=function(swReg,objCopyrightText){setTimeout(function(){if(objCopyrightText.welcome&&objCopyrightText.welcome.title&&objCopyrightText.welcome.body){swReg.showNotification(objCopyrightText.welcome.title,{tag:"welcome",icon:url.getS3ObjectUrl("/pinkoi.site/general/favicon/favicon_192x192.png","cdn04"),data:objCopyrightText.welcome.data,body:objCopyrightText.welcome.body})}},1e3)};var track=function(trackObj){if(!_.isUndefined(trackObj.count)){dataLayer.push({event:"ga",eventCategory:[trackObj.key,"(PN permission)"].join(" "),eventAction:[trackObj.title,trackObj.description].join(" - "),eventLabel:[trackObj.action,_.template("(<%= count %>)",trackObj)].join(" "),nonInteraction:true})}else{dataLayer.push({event:"ga",eventCategory:[trackObj.key,"(PN permission)"].join(" "),eventAction:[trackObj.title,trackObj.description].join(" - "),eventLabel:trackObj.action,nonInteraction:true})}};var softRequestPermission=function(objCopyrightText,args){var deferred=new $.Deferred;var isMobile=settings.get("mobile");track($.extend({key:objCopyrightText.key,action:"Show soft request modal",title:objCopyrightText.title,description:objCopyrightText.description},args));fixedModal.show(objCopyrightText.description,{title:objCopyrightText.title,bottom:isMobile?0:"auto",top:isMobile?"auto":0,type:"confirm",crossVisible:true,buttonText:{cancelText:"",confirmText:i18n.gettext("開啟通知")},confirmCb:function(){track($.extend({key:objCopyrightText.key,action:"Click on OK of soft request modal",title:objCopyrightText.title,description:objCopyrightText.description},args));fixedModal.hide();deferred.resolve()},hideCb:function(){track($.extend({key:objCopyrightText.key,action:"Click on No of soft request modal",title:objCopyrightText.title,description:objCopyrightText.description},args));fixedModal.hide();deferred.reject()}});return deferred};var askForPermission=function(objCopyrightText,args){var deferred=$.Deferred();
navigator.serviceWorker.register("/media/js/sw.js").then(function(swReg){track($.extend({key:objCopyrightText.key,action:"Show browser popup",title:objCopyrightText.title,description:objCopyrightText.description},args));swReg.pushManager.getSubscription().then(function(subscription){if(!subscription){swReg.pushManager.subscribe({userVisibleOnly:true,applicationServerKey:urlBase64ToUint8Array(VAPID)}).then(function(sub){sw.registerSubscription(sub,objCopyrightText.key);deferred.resolve();track($.extend({key:objCopyrightText.key,action:"Click on Allow (browser opup)",title:objCopyrightText.title,description:objCopyrightText.description},args));notify(swReg,objCopyrightText)})["catch"](function(error){track($.extend({key:objCopyrightText.key,action:"Click on Block (browser popup)",title:objCopyrightText.title,description:error},args));deferred.reject()})}else{sw.registerSubscription(subscription,objCopyrightText.key);deferred.resolve()}})})["catch"](function(error){console.log("Service Worker Error",error)});return deferred};var isAvailableToRequest=function(optDeferred){var deferred=optDeferred||$.Deferred();if(!settings.get("isInNotificationBucket")){deferred.reject();return false}if(hasNoServiceWorkerORNotifactionAPI){deferred.reject();return false}if(_.contains(["denied","granted"],Notification.permission)){deferred.resolve();return false}return true};var requestPermission=function(objCopyrightText,args){var deferred=$.Deferred();var clickOnOKHandler=function(deferred){if(!settings.get("mobile")&&objCopyrightText.finalWords){_.delay(function(){fixedModal.show(objCopyrightText.finalWords,{top:"22px"});backdrop.show()},10)}askForPermission(objCopyrightText,args).done(function(){fixedModal.hide();backdrop.hide();deferred.resolve();if(args.isInPage){$(objCopyrightText.el).remove()}}).fail(function(){fixedModal.hide();backdrop.hide();if(args.isInPage){$(objCopyrightText.el).remove()}})};if(!isAvailableToRequest(deferred)){return deferred}if(!args.isInPage){if(!objCopyrightText||!objCopyrightText.title||!objCopyrightText.description){throw Error("You need a set of title and description to initiate a permission modal.")}if(!settings.get("mobile")&&!objCopyrightText.finalWords){throw Error("You need finalWords to initiate a permission modal.")}}else{if(!objCopyrightText||!objCopyrightText.el||!objCopyrightText.html){throw Error("You need an element and html to insert into a message block.")}}if(!args.isInPage){softRequestPermission(objCopyrightText,args).done(function(){clickOnOKHandler(deferred)}).fail(function(){deferred.reject();fixedModal.hide()})}else{$(objCopyrightText.el).html(objCopyrightText.html).on("click","[data-click]",function(e){clickOnOKHandler(deferred)});if(args.countImpression){dataLayer.push({event:"ga",eventCategory:[objCopyrightText.key,"(PN permission)"].join(" "),eventAction:[objCopyrightText.title,objCopyrightText.content].join(" - "),eventLabel:["Impression",settings.get("uid")?"(login)":"(non-login)"].join(" "),nonInteraction:true})}}return deferred};exports.requestPermission=requestPermission;var syncUpToken=function(){if(hasNoServiceWorkerORNotifactionAPI||Notification.permission!=="granted"){return}navigator.serviceWorker.register("/media/js/sw.js").then(function(swReg){swReg.pushManager.getSubscription().then(function(subscription){if(!subscription){swReg.pushManager.subscribe({userVisibleOnly:true,applicationServerKey:urlBase64ToUint8Array(VAPID)}).then(function(sub){sw.registerSubscription(sub)})["catch"](function(error){console.log(error)})}else{sw.registerSubscription(subscription)}})})["catch"](function(error){console.log("Service Worker Error",error)})};exports.isAvailableToRequest=isAvailableToRequest;exports.syncUpToken=syncUpToken;exports.favAndFollowRP=function(){if(!settings.get("isInNotificationBucket")){return}var key="fav-and-follow";meter.set(key,{checkpoints:[0,10],iteration:10});meter.count(key).done(function(count){requestPermission({title:"想獲得最新優惠資訊？",description:"開啟通知得到 Pinkoi 第一手優惠消息與活動快訊",finalWords:"最後一個步驟！點擊「允許」，立即獲得最新優惠活動訊息",welcome:{title:"嘿！感謝你的允許",body:"我們會開始提供更多好設計相關資訊！"}},{key:key,count:count}).done(function(){meter.terminate(key)})})};exports.pageviewRP=function(){if(!isAvailableToRequest()){return}var key="product-shop-pageview";meter.set(key,{remainder:5,iteration:10});meter.count(key).done(function(count){requestPermission({title:"別錯過任何最新消息！",description:"開啟通知就可以獲得 Pinkoi 最新活動、設計館優惠相關專屬資訊",finalWords:"最後一個步驟！點擊「允許」，就能收到第一手 Pinkoi 優惠活動與最新趨勢相關資訊",welcome:{title:"嘿！感謝你的允許",body:"我們會開始提供更多好設計相關資訊！"}},{key:key,count:count}).done(function(){meter.terminate(key)})})}});define("app/modules/searchHistory",function(require,exports){"use strict";var _=require("underscore");var local=require("storage/local");var STORAGE_KEY="n.search.history";var MAX_AMOUNT=10;exports.add=function(query){var q=_.escape(query);var searchHistory=local.get(STORAGE_KEY)||[];var queryPos=searchHistory.indexOf(q);if(queryPos===-1){searchHistory.push(q);if(searchHistory.length>=MAX_AMOUNT){var lastPos=searchHistory.length-1;var amount=lastPos-MAX_AMOUNT+1;searchHistory.splice(0,amount)}local.set(STORAGE_KEY,searchHistory,"3m")}else{searchHistory.splice(queryPos,1);searchHistory.push(q);local.set(STORAGE_KEY,searchHistory,"3m")}};exports.STORAGE_KEY=STORAGE_KEY});define("app/modules/share",function(require,exports){"use strict";var settings=require("settings");var facebook=require("external/facebook");var urlparse=require("net/urlparse");return function(replaceSelector,args,optExclude){optExclude=optExclude||{};var className=args.size===40?"m-share-size-40":"m-share-size-32";var $share=$('<div class="m-share '+className+'"></div>');var html="<ul>";var shareMapByGEO={TW:[["facebook","fbmessenger","twitter","pinterest","weibo"],["line","fbmessenger","facebook","twitter","weibo"]],HK:[["facebook","fbmessenger","email","twitter","pinterest","weibo"],["whatsapp","line","facebook","fbmessenger","weibo","email"]],MO:[["facebook","fbmessenger","email","twitter","pinterest","weibo"],["whatsapp","line","facebook","fbmessenger","weibo","email"]],CN:[["weibo","email","facebook","twitter"],["weibo","email","facebook","twitter"]],JP:[["facebook","fbmessenger","twitter","hatena","pinterest","email"],["line","facebook","fbmessenger","twitter","hatena","email"]],TH:[["facebook","fbmessenger","twitter","email","pinterest"],["line","facebook","fbmessenger","twitter","email"]]};var shareMapByLocale={en:[["facebook","twitter","email","fbmessenger"],["whatsapp","facebook","fbmessenger","line","twitter","gplus","email"]],other:[["facebook","twitter","email","pinterest","fbmessenger"],["facebook","twitter","whatsapp","email","fbmessenger","line"]]};var utmTermObj={product:"product",store:"store",window:"window",topic:"topic",inv:"referral_program",magz:"magz",event:"event"};var web=0;var mweb=1;var isMobile=settings.get("mobile");var platform=isMobile?mweb:web;var geo=settings.get("geo");var locale=settings.get("locale")==="en"?"en":"other";var shareList=(shareMapByGEO[geo]||shareMapByLocale[locale])[platform];var parseArgUrl=urlparse.parse(args.url);var path_first=parseArgUrl.paths[0];var utmQuery={utm_medium:isMobile?"mweb_share":"web_share",utm_source:"",utm_term:utmTermObj[path_first]?utmTermObj[path_first]:"others"};var utmUrl=args.url;var shareGenerators={whatsapp:function(){if(!optExclude.whatsapp){utmUrl=urlparse.mergeQuery(args.url,_extends({},utmQuery,{utm_source:"Whatsapp"}));html+='<li class="whatsapp-wrapper"><a data-social="Whatsapp" class="m-share-btn-js m-share-whatsapp" href="whatsapp://send?text='+encodeURIComponent(args.title)+" "+encodeURIComponent(utmUrl)+'">Whatsapp</a></li>'}},line:function(){if(!optExclude.line){utmUrl=urlparse.mergeQuery(args.url,_extends({},utmQuery,{utm_source:"Line"}));html+='<li class="line-wrapper"><a data-social="Line" class="m-share-btn-js m-share-line" href="http://line.naver.jp/R/msg/text/?'+encodeURIComponent(args.title+" "+utmUrl)+'" target="_blank">Line</a></li>'}},facebook:function(){if(!optExclude.facebook){utmUrl=urlparse.mergeQuery(args.url,_extends({},utmQuery,{utm_source:"Facebook"}));html+='<li><a data-social="Facebook" class="m-share-btn-js m-share-facebook" href="http://facebook.com/sharer.php?u='+encodeURIComponent(utmUrl)+'" target="_blank">Facebook</a></li>'}},fbmessenger:function(){if(!optExclude.fbmessenger){if(isMobile){utmUrl=urlparse.mergeQuery(args.url,_extends({},utmQuery,{utm_source:"Messenger"}));html+='<li><a data-social="FBMessenger" class="m-share-btn-js m-share-fbmessenger" href="fb-messenger://share?link='+encodeURIComponent(utmUrl)+"&app_id="+encodeURIComponent(facebook.appId)+'">Facebook Messenger</a></li>'}else{!window.FB&&facebook.init(function(){});utmUrl=urlparse.mergeQuery(args.url,_extends({},utmQuery,{utm_source:"Messenger"}));html+='<li><a data-social="FBMessenger" data-click="fbmessenger-dialog" data-link="'+encodeURIComponent(utmUrl)+'" class="m-share-btn-js m-share-fbmessenger">Facebook Messenger</a></li>'}}},twitter:function(){var twitterAccounts={ja:"PinkoiJP",th:"PinkoiTh","default":"pinkoi"};var account=twitterAccounts[settings.get("lang")]||twitterAccounts.default;utmUrl=urlparse.mergeQuery(args.url,_extends({},utmQuery,{utm_source:"Twitter"}));if(!optExclude.twitter){html+='<li><a data-social="Twitter" class="m-share-btn-js m-share-twitter" href="https://twitter.com/share?text='+encodeURIComponent(args.title)+"&url="+encodeURIComponent(utmUrl)+"&via="+account+'" target="_blank">Twitter</a></li>'}},email:function(){var emailBody;utmUrl=urlparse.mergeQuery(args.url,_extends({},utmQuery,{utm_source:"Email"}));if(Modernizr.iphone){emailBody=args.title+'<br><a href="'+utmUrl+'">'+utmUrl+'</a><br><br><a href="'+utmUrl+'">'+args.imgTag+"</a>"}else{emailBody=args.title+" "+utmUrl}if(!optExclude.email){html+='<li><a data-social="Email" class="m-share-btn-js m-share-email" href="mailto:?subject='+encodeURIComponent(args.title)+"&body="+encodeURIComponent(emailBody)+'" target="_blank">Email</a></li>'}},pinterest:function(){if(!optExclude.pinterest){utmUrl=urlparse.mergeQuery(args.url,_extends({},utmQuery,{utm_source:"Pinterest"}));html+='<li><a data-social="Pinterest" class="m-share-btn-js m-share-pinterest" href="//pinterest.com/pin/create/button/?url='+encodeURIComponent(utmUrl)+"&description="+encodeURIComponent(args.title)+"&media="+encodeURIComponent(args.img)+'" target="_blank">Pinterest</a></li>'}},gplus:function(){if(!optExclude.gplus){utmUrl=urlparse.mergeQuery(args.url,_extends({},utmQuery,{utm_source:"Gplus"}));html+='<li><a class="m-share-btn-js m-share-gplus" href="https://plus.google.com/share?url='+encodeURIComponent(utmUrl)+'" target="_blank">G+</a></li>'}},weibo:function(){if(!optExclude.weibo){utmUrl=urlparse.mergeQuery(args.url,_extends({},utmQuery,{utm_source:"Weibo"}));html+='<li><a data-social="Weibo" class="m-share-btn-js m-share-weibo" href="http://service.weibo.com/share/share.php?url='+encodeURIComponent(utmUrl)+"&title="+encodeURIComponent(args.title+" "+utmUrl)+'" target="_blank">Weibo</a></li>'}},hatena:function(){if(!optExclude.hatena){utmUrl=urlparse.mergeQuery(args.url,_extends({},utmQuery,{utm_source:"Hatena"}));html+='<li><a class="m-share-btn-js m-share-hatena" href="http://b.hatena.ne.jp/entry/'+encodeURIComponent(utmUrl)+'" target="_blank">Hatena</a></li>'}},mixi:function(){if(!optExclude.mixi){utmUrl=urlparse.mergeQuery(args.url,_extends({},utmQuery,{utm_source:"Mixi"}));html+='<li><a class="m-share-btn-js m-share-mixi" href="https://mixi.jp/simplepost/voice?status='+encodeURIComponent(utmUrl)+'" target="_blank">Mixi</a></li>'}}};args.title=args.title?args.title:document.title;args.url=args.url?args.url:location.href;args.imgTag=args.img?'<img src="'+args.img+'">':"";var currentShareModule;for(var i=0;i<shareList.length;i++){currentShareModule=shareList[i];if(shareGenerators[currentShareModule]){shareGenerators[currentShareModule]()}else{console.error("we don't have '"+currentShareModule+"' share module, please fix this before get online")}}html+="</ul></div>";$share.append(html);$(replaceSelector).replaceWith($share);$share.on("click",".m-share-btn-js",function(){var $shareBtn=$(this);var socialNetwork=$shareBtn.data("social");var action=$shareBtn.data("click");if(socialNetwork){dataLayer.push({event:"social",socialNetwork:socialNetwork.toLowerCase(),socialAction:"share",socialTarget:location.pathname})}if(action){if(action==="fbmessenger-dialog"){FB.ui({method:"send",link:decodeURIComponent($shareBtn.data("link"))})}}})}});define("app/modules/shopManagerAgent",function(require){"use strict";var _=require("underscore");var request=require("app/react/request");var data=require("app/data");var settings=require("settings");var successHandler=function(res,promise){var status=res.status,result=res.result,error=res.error;if(status==="!ok"){promise.reject()}else if(error){promise.reject(error)}else if(result&&result[0]&&(result[0].err||result[0].error)){var errorObj=result[0].err||result[0].error||{};promise.reject(_.extend({},errorObj,{message:result[0].msg||result[0].message}))}else{promise.resolve(res)}};var errorHandler=function(error,promise){promise.reject(error)};var agentPost=function(options){var promise=$.Deferred();var url=options.url,data=options.data,isJSON=options.isJSON,hasFile=options.hasFile;var settings={url:url,type:"POST",data:isJSON?JSON.stringify(data):data};if(isJSON){settings.contentType="application/json"}if(hasFile){settings.processData=false;settings.contentType=false}request(settings).then(function(res){return successHandler(res,promise)}).fail(function(res){return errorHandler(res,promise)});return promise};var agentFetch=function(options){var promise=$.Deferred();request(options).then(function(res){return successHandler(res,promise)}).fail(function(res){return errorHandler(res,promise)});return promise};var Order={getList:function(request){return agentFetch({url:"/apiv2/order/order_list?"+$.param(request)})},fetch:function(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var params=options.params;return agentFetch({url:"/apiv2/order/order_detail?"+$.param(params)})},cancel:function(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var oid=options.oid,reason=options.reason;return agentPost({url:"/apiv2/order/canceled",data:{oid:oid,reason:reason}})},scheduled:function(orders){return agentPost({url:"/apiv2/order/notice_scheduled",data:{bulk:orders},isJSON:true})},expNotice:function(orders){return agentPost({url:"/apiv2/order/notice_exp_coming",data:{bulk:orders},isJSON:true})},ship:function(orders){return agentPost({url:"/apiv2/order/notice_shipped",data:{bulk:orders},isJSON:true})},expFinish:function(orders){return agentPost({url:"/apiv2/order/notice_exp_done",data:{bulk:orders},isJSON:true})},received:function(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var oid=options.oid;return agentPost({url:"/apiv2/order/received",data:{oid:oid}})},getCarriers:function(){return agentFetch({url:"/apiv2/shop/get_preferred_carriers"})},deleteCustomCarrier:function(data){return agentPost({url:"/apiv2/shop/delete_preferred_carriers",data:data,isJSON:true})},getPincode:function(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var oid=options.oid;return agentPost({url:"/apiv2/order/get_pincode",data:{oid:oid}})},updateSevenC2COrder:function(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var oid=options.oid,store_id=options.store_id,receiver_name=options.receiver_name,receiver_tel=options.receiver_tel;return agentPost({url:"/apiv2/order/update_seven_c2c_order",data:{oid:oid,store_id:store_id,receiver_name:receiver_name,receiver_tel:receiver_tel}})},permitTranships:function(orders){return agentPost({url:"/apiv2/order/permit_tranships",data:{bulk:orders},isJSON:true})}};var SevenStores={search:function(request){return agentFetch({url:"/api/shipping/sevenStores?"+$.param(request)})},validateStore:function(storeId){return agentFetch({url:"/apiv2/seven/validate_store?store_id="+storeId})}};var Notes={create:function(notes){return agentPost({url:"/apiv2/order/add_note",data:{bulk:notes},isJSON:true})},fetch:function(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var oid=options.oid;return agentFetch({url:"/apiv2/order/get_notes?oid="+oid})},"delete":function(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var oid=options.oid,idx=options.idx;return agentPost({url:"/apiv2/order/delete_note",data:{oid:oid,idx:idx}})}};var Reviews={bulk_add:function(reviews){return agentPost({url:"/apiv2/review/bulk_add",data:{bulk:reviews},isJSON:true})},add:function(review){return agentPost({url:"/apiv2/review/add",hasFile:true,data:review})}};var Messages={send:function(data){return agentPost({url:"/apiv2/message/send",hasFile:true,data:data})}};var Refund={fetch:function(params){return agentFetch({url:"/apiv2/refund2/list?"+$.param(params)})},request:function(request){return agentPost({url:"/apiv2/refund2/request",data:request,isJSON:true})},quick_refund:function(request){return agentPost({url:"/apiv2/refund2/quick_refund",data:request,isJSON:true})},calculate:function(request){return agentPost({url:"/apiv2/refund2/calculate",data:request,isJSON:true})},approve:function(request){return agentPost({url:"/apiv2/refund2/approve",data:request,isJSON:true})},decline:function(request){return agentPost({url:"/apiv2/refund2/decline",data:request,isJSON:true})},markReceived:function(request){return agentPost({url:"/apiv2/refund2/mark_received",data:request,isJSON:true})},markRefunded:function(request){return agentPost({url:"/apiv2/refund2/mark_refunded",data:request,isJSON:true})},markFailed:function(request){return agentPost({url:"/apiv2/refund2/mark_failed",data:request,isJSON:true})},pinkoiMarkRefunded:function(request){return agentPost({url:"/apiv2/refund2/approve_n_mark_received",data:request,isJSON:true})},askRInfo:function(request){return agentPost({url:"/apiv2/refund2/ask_rinfo",data:request,isJSON:true})},updateRInfo:function(request){return agentPost({url:"/apiv2/refund2/update_rinfo",data:request,isJSON:true})},hasOldRefund:function(role){return agentFetch({url:"/apiv2/refund/has_request_needs_action?role="+role})}};var Listing={upsert:function(request){return agentPost({url:"/apiv2/listing/upsert",data:request,isJSON:true})},getEditData:function(tid){return agentFetch({url:"/apiv2/listing/get_edit_data?tid="+tid})},getFoodManufacturerList:function(sid){return agentFetch({url:"/apiv2/listing/get_manufacturer_list?sid="+sid})},upsertFoodManufacturer:function(data){return agentPost({url:"/apiv2/listing/upsert_manufacturer",data:data,isJSON:true})},deleteFoodManufacturer:function(mid){return agentPost({url:"/apiv2/listing/delete_manufacturer",data:{mid:mid},isJSON:true})},getRawShippingData:function(tid){if(tid){return new Promise(function(resolve,reject){request({url:"/apiv2/listing/get_raw_shipping?tid="+tid}).done(function(resp){var result=resp&&resp.result&&resp.result[0];resolve(result)}).fail(function(error){reject(error)})})}else{var getTWShippingOfShopProcess=function(){return new Promise(function(resolve,reject){request({type:"GET",url:"/apiv2/shop/get_tw_shipping"}).done(function(resp){if(!resp.error){var result=resp.result[0];resolve(result.methods)}else{reject(resp.error)}}).fail(function(error){reject(error)})})};var getIntlShippingList=data.fetchShippingList();var getShippingProcesses=[settings.get("allow_use_tw_shipping")?getTWShippingOfShopProcess():new Promise(function(resolve){resolve()}),getIntlShippingList];var getRawShippingWithoutTidProcess=function(resolve,reject){Promise.all(getShippingProcesses).then(function(response){var _response=_slicedToArray(response,2),shopTWShipping=_response[0],intlShippingList=_response[1];resolve({shipping:{},shipping_profiles:intlShippingList,spid:"default",tw_shipping_methods:shopTWShipping||[]})}).catch(function(error){return reject(error)})};return new Promise(getRawShippingWithoutTidProcess)}},deleteUserImage:function(id){return agentPost({url:"/apiv2/listing/delete_listing_gallery",data:{fid:id}})}};return{Order:Order,SevenStores:SevenStores,Notes:Notes,Reviews:Reviews,Messages:Messages,Refund:Refund,Listing:Listing}});define("app/modules/sizechart",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var url=require("app/modules/url");var settings=require("settings");var PATH=url.getS3ObjectUrl("/pinkoi.site/panel/sizechart_v4/","cdn04");var isInited=false;var cache={content:null,chart:null,type:null};exports.sizechart={size_category_map:{shoulder:i18n.gettext("肩寬"),chest:i18n.gettext("胸寬"),waist:i18n.gettext("腰圍"),butt:i18n.gettext("臀圍"),thigh:i18n.gettext("大腿寬"),neck:i18n.gettext("頸圍"),foot:i18n.gettext("腳圍"),shirt_length:i18n.gettext("衣長"),sleeve_length:i18n.gettext("袖長"),skirt_length:i18n.gettext("裙長"),lower_dress_length:i18n.gettext("下擺"),pants_width:i18n.gettext("褲管寬"),pants_length:i18n.gettext("褲長"),foot_length:i18n.gettext("腳長"),foot_width:i18n.gettext("腳寬"),wrist:i18n.gettext("手腕圍"),ring_inner_diameter:i18n.gettext("內徑"),ring_inner_circumference:i18n.gettext("內圍"),animal_length:i18n.gettext("身長")},model:{cat:{size:{unit:"cm",category:["neck","chest","animal_length"]}},dog:{size:{unit:"cm",category:["neck","chest","animal_length"]}},dress:{size:{unit:"cm",category:["chest","waist","lower_dress_length","skirt_length"]}},foot:{size:{unit:"cm",category:["foot","foot_width","foot_length"]}},jacket:{size:{unit:"cm",category:["shoulder","chest","shirt_length","sleeve_length"]}},pants:{size:{unit:"cm",category:["waist","butt","thigh","pants_width","pants_length"]}},ring:{size:{unit:"mm",category:["ring_inner_diameter","ring_inner_circumference"]}},shirt:{size:{unit:"cm",category:["shoulder","chest","shirt_length","sleeve_length"]}},shorts:{size:{unit:"cm",category:["waist","butt","thigh","pants_width","pants_length"]}},skirt_l:{size:{unit:"cm",category:["waist","lower_dress_length","skirt_length"]}},skirt_s:{size:{unit:"cm",category:["waist","lower_dress_length","skirt_length"]}},tank:{size:{unit:"cm",category:["shoulder","chest","shirt_length"]}},tops:{size:{unit:"cm",category:["shoulder","chest","shirt_length","sleeve_length"]}},tshirt_m:{size:{unit:"cm",category:["shoulder","chest","shirt_length","sleeve_length"]}},tshirt_w:{size:{unit:"cm",category:["shoulder","chest","shirt_length","sleeve_length"]}},wrist:{size:{unit:"cm",category:["wrist"]}}}};var sizechart=exports.sizechart;exports.textMap={UNISIZE:i18n.gettext("單一尺寸")};exports.getTable=function(type,sizes,unit){var thmarkup=[];var markup="";var column=["A","B","C","D","E","F"];var columnHaveValues=[true,false,false,false,false,false];var adjustClassName="";var unit=" ("+(unit?unit:sizechart.model[type].size.unit)+")";if(sizechart.model[type].size.category.length<2){adjustClassName="two-col"}for(var i=0;i<sizes.length;i++){for(var j=0;j<sizes[i].length;j++){var value=sizes[i][j];if(j!==0&&value&&!_.isNaN(parseInt(value))){if(!columnHaveValues[j]){columnHaveValues[j]=true}}}}for(var m=0;m<sizes.length;m++){var trmarkup=[];var thTpl=['<tr data-row="<%= order %>">','<td class="<%= className %>"><%= row %></td>',"</tr>"].join("");for(var n=0;n<sizes[m].length;n++){if(columnHaveValues[n]){var item=sizes[m][n];trmarkup.push(n===0?exports.textMap[item]?exports.textMap[item]:item:item)}}markup+=_.template(thTpl,{order:m,className:adjustClassName,row:trmarkup.join("</td><td>")})}columnHaveValues.shift();for(var k=0;k<sizechart.model[type].size.category.length;k++){if(columnHaveValues[k]){thmarkup.push(column[k]+" <span>"+sizechart.size_category_map[sizechart.model[type].size.category[k]]+"</span>"+unit)}}return'<table class="m-sizechart-table"><thead><tr><th class=" '+adjustClassName+'">'+i18n.gettext("尺寸")+"</th><th>"+thmarkup.join("</th><th>")+"</th></tr></thead>"+"<tbody>"+markup+"</tbody></table>"};exports.getContent=function(str){if(cache.content){return cache}if(exports.hasSizechart(str)){return str.substring(0,str.indexOf("[SIZECHART]"))}return str};var init=function(str){if(isInited){return}isInited=true;if(exports.hasSizechart(str)){try{cache.chart=$.parseJSON(str)}catch(e){cache.chart=null}cache.type=_.reject(_.keys(cache.chart),function(prop){return prop==="picture"})[0];cache.content=str;return cache.type}};exports.getJSON=function(str){if(!isInited){init(str)}return cache.chart};exports.getType=function(str){if(!isInited){init(str)}if(!str){return"shirt"}return cache.type};exports.fromStringToTable=function(str){if(!exports.hasSizechart(str)){return str}var data=$.parseJSON(str);var key=_.reject(_.keys(data),function(prop){return prop==="picture"});if(!data||!data[key]){return str}var supportLoading=settings.get("browserLoading");var pictureMarkup=_.template(["",'<div class="m-sizechart-sample-picture-product <%= key %>-product">',"<% if (supportLoading) { %>",'<img loading="lazy" src="'+PATH+'<%= key %>.<%= fileType %>">',"<% } else { %>",'<img class="m-libs-lazy" data-src="'+PATH+'<%= key %>.<%= fileType %>">',"<% } %>","</div>"].join(""),{fileType:Modernizr.svg?"svg":"png",key:key,supportLoading:supportLoading});return _.template(["",'<div id="m-sizechart" class="m-sizechart m-sizechart-fancytable">',"<%= picture %>",'<div id="m-sizechart-table"><%= table %></div>',"</div>"].join(""),{picture:data.picture?pictureMarkup:"",table:exports.getTable(key,data[key].size.sizes,data[key].size.unit)})};exports.hasSizechart=function(str){try{if($.parseJSON(str)&&_.size($.parseJSON(str))){var json=$.parseJSON(str),keys=_.keys(json);for(var i=0;i<keys.length;i++){if(json[keys[i]].hasOwnProperty("size")){return true}}return false}return false}catch(e){return false}};exports.reset=function(){isInited=false;cache={}};exports.on=function(el){var $el=$(el);if(exports.hasSizechart($el.html())){$el.addClass("s-on")}}});define("app/modules/store-black",function(require,exports){"use strict";var i18n=require("i18n");var alertModal=require("ui/notification/alertModal");var bar=require("ui/notification/bar");exports.init=function(wrapper,sid,tid){var $wrapper=$(wrapper);var isFocused=false;$wrapper.on("click","[data-click]",function(){var $this=$(this);var type=$this.data("click");switch(type){case"save":var memo=$wrapper.find("[name=edit]").find("textarea").val();var rank_factor=parseFloat($wrapper.find('[name="rank_factor"]').val());$.ajax({type:"POST",url:"/apiv2/store/add_black",contentType:"application/json",data:JSON.stringify({sid:sid,tid:tid,memo:memo,rank_factor:rank_factor})}).done(function(resp){bar.show(resp.error?resp.error.message:i18n.gettext("已更新！"));if(!resp.error){location.reload()}});isFocused=false;break;case"delete":alertModal.show(i18n.gettext("確定要移除黑名單，沒有辦法回復喔！"),{type:"confirm",confirmCb:function(){$.ajax({type:"POST",url:"/apiv2/store/delete_black",data:{sid:sid}}).done(function(resp){bar.show(resp.error?resp.error.message:i18n.gettext("已更新！"));if(!resp.error){location.reload()}})}});break}});$("#g-store-black textarea").each(function(){this.style.height=this.scrollHeight+"px"});$('#g-store-black textarea[name="memo"]').on("focus",function(){isFocused=true});window.onbeforeunload=function(){if(isFocused){return i18n.gettext("內容有所變更，但尚未儲存。是否確定不儲存離開？")}}}});define("app/modules/url",function(require,exports){"use strict";var settings=require("settings");function getCdnHost(id,forceProd){var domain=settings.get("locale")==="zh_CN"?"pinkoichina.com":"pinkoi.com";if(forceProd||settings.get("production")){var cdnHosts=["cdn01."+domain,"cdn02."+domain]}else{var cdnHosts=["dev-cdn01."+domain,"dev-cdn02."+domain]}return cdnHosts[(id.charCodeAt(id.length-1)&id.charCodeAt(id.length-2))%cdnHosts.length]}function getDefaultAvatar(uid,size,opt){opt=opt||{};opt.seq=opt.seq||"0";size=size?size:"100x100";var url="",host=getCdnHost(uid);if(opt.protocol){url+=opt.protocol+":"}var default_avatar_idx=Number(uid.substr(-2))%12+1||1;url+="//"+host+"/user/_default/avatar/"+size+"_"+default_avatar_idx+".jpg";return url}exports.getItemImg=function(tid,size,opt){opt=opt||{};var host=getCdnHost(tid,settings.get("getProdIImgOnDev"));opt.seq=opt.seq||"0";if(tid.indexOf(".")!==-1){tid=tid.split(".");opt.seq=tid[1];tid=tid[0]}var url="";if(opt.protocol){url+=opt.protocol+":"}url+="//"+host+"/product/"+tid;if(opt.seq){url+="/"+opt.seq}if(opt.rev){url+="/"+opt.rev}url+="/"+size+".jpg";return url};exports.getItemUrl=function(tid,opt_args){opt_args=opt_args||{};var url=(opt_args.full?location.origin:"")+"/product/"+tid;if(opt_args.qryStrObj){url+="?"+$.param(opt_args.qryStrObj)}return url};exports.getStoreBannerImg=function(sid,size){var _size="";if(size){if(size==="thumbnail"){_size="banner_t"}else{_size="banner"}}if(!settings.get("production")){return location.protocol+"//s3-ap-southeast-1.amazonaws.com/pinkoi.test/"+sid+"/"+_size+".jpg"}return location.protocol+"//s3-ap-southeast-1.amazonaws.com/pinkoi.store/"+sid+"/"+_size+".jpg"};exports.getStoreUrl=function(sid,opt_args){opt_args=opt_args||{};var url=(opt_args.full?location.origin:"")+"/store/"+sid;if(opt_args.qryStrObj){url+="?"+$.param(opt_args.qryStrObj)}return url};exports.getDefaultImg=function(size,opt){if(opt.el){var tid=$(opt.el).data("tid");var src=exports.getItemImg(tid,size,opt),img=new Image;img.onload=function(){opt.el.src=src};img.onerror=function(){var _size=size.split("x")[0]+"px";$(opt.el).after('<div style="background:#FFF;height:'+_size+";width:"+_size+';"></div>').remove()};img.src=src}};exports.getAvatar=function(uid,size,opt){opt=opt||{};opt.seq=opt.seq||"0";size=size?size:"100x100";if(settings.get("geo")==="CN"&&(uid.indexOf("fb_")===0||uid.indexOf("tt_")===0)){return getDefaultAvatar(uid,size,opt)}var url="";var hostStrArr=location.host.split(".");hostStrArr[0]="api";var apiHost=hostStrArr.join(".");if(opt.protocol){url+=opt.protocol+":"}url+="//"+apiHost+"/user/avatar?uid="+uid+"&size="+size;return url};exports.getLogo=function(sid,size,opt){opt=opt||{};opt.rev=opt.rev||"0";size=size||"150x150";if(!sid){return""}return["//",getCdnHost(sid),"/store/",sid,"/logo/",opt.rev,"/",size,".jpg"].join("")};exports.getCacheLogo=function(sid,size,opt){opt=opt||{};size=size||"150x150";if(!sid){return""}return["//",getCdnHost(sid),"/store/",sid,"/logo/",size,".jpg"].join("")};exports.getFallbackAvator=function(uid,size){return getDefaultAvatar(uid,size)};exports.getCdnDomain=function(){return settings.get("locale")==="zh_CN"?"pinkoichina.com":"pinkoi.com"};exports.getS3ObjectUrl=function(path,host){return"https://"+host+"."+exports.getCdnDomain()+path};exports.fix_s3_link_in_text=function(text){return text.replace(/http[s]?:\/\/s3-ap-southeast-1\.amazonaws\.com\//g,exports.getS3ObjectUrl("/","cdn04"))};var _ZEN_DESK_LOCALE_MAP={en:"en-us",zh_TW:"zh-tw",zh_CN:"zh-cn",th:"th",ja:"ja"};var _ZENDESK_URL_MAP={"buyer-faq-root":{ja:{type:"categories",id:"115000775248"},"default":{type:"categories",id:"115000775248"}},"buyer-faq-refund":{"default":{type:"sections",id:"115000810434"}},"buyer-faq-refund-request-deduction":{"default":{type:"articles",id:"115004742673"}},"buyer-faq-refund-payment-account":{"default":{type:"articles",id:"360011633233"}},"seller-faq-root":{ja:{type:"categories",id:"115001189988"},"default":{type:"categories",id:"115001189988"}},"seller-faq-shipping-settings":{ja:{type:"sections",id:"115000962754"},"default":{type:"sections",id:"115000962754"}},"seller-faq-intl-currency-exchange-rates":{"default":{type:"articles",id:"115004710913"}},"seller-faq-refund":{"default":{type:"categories",id:"115000372833"}},"seller-faq-refund-request-deduction":{"default":{type:"articles",id:"360002369353"}},"seller-faq-transaction-fees-of-discounted-orders":{ja:{type:"articles",id:"115004321653"},"default":{type:"articles",id:"115004321653"}},"seller-faq-item-type":{ja:{type:"articles",id:"115004341674"},"default":{type:"articles",id:"115004341674"}},"seller-faq-if-customers-donot-press-received":{"default":{type:"articles",id:"115004751434"}}};exports.getZendeskUrl=function(id,locale){if(!(id in _ZENDESK_URL_MAP)){
return"#"}var z=_ZENDESK_URL_MAP[id];if(!locale){locale=settings.get("locale")}if(!(locale in _ZEN_DESK_LOCALE_MAP)){return"#"}locale=_ZEN_DESK_LOCALE_MAP[locale];var zo=null;if(locale in z){zo=z[locale]}else if("default"in z){zo=z["default"]}else{return"#"}return"https://pinkoi.zendesk.com/hc/"+locale+"/"+zo.type+"/"+zo.id}});define("app/modules/user",function(require,exports){"use strict";var settings=require("settings");var local=require("storage/local");function clearLocalData(){local.clear("g.cartNum");local.clear("g.slot.collection");local.clear("g.slot.promo");local.clear("g.slot.hasRead");local.clear("g.slot.recentShow");local.clear("g.cartShopsMessage")}function login(){clearLocalData()}function logout(){clearLocalData();document.cookie="st=; Domain=.www.pinkoi.com; expires=Thu, 01-Jan-1970 00:00:00 GMT; Path=/";document.cookie="st=; Domain=.pinkoi.com; expires=Thu, 01-Jan-1970 00:00:00 GMT; Path=/";document.cookie="sessionid=; Domain=.www.pinkoi.com; expires=Thu, 01-Jan-1970 00:00:00 GMT; Path=/";document.cookie="sessionid=; Domain=.pinkoi.com; expires=Thu, 01-Jan-1970 00:00:00 GMT; Path=/";$.post("/apiv2/account/logout").done(function(resp){local.doDelOn("logout");location.href=resp.result[0]["next"]})}function isLogin(){return!!settings.get("uid")}function notLogin(){return!settings.get("uid")}function isAdmin(){return!!settings.get("isAdmin")}function isReportTeam(){return!!settings.get("isReportTeam")}function isDRTeam(){return!!settings.get("isDRTeam")}exports.login=login;exports.logout=logout;exports.isLogin=isLogin;exports.notLogin=notLogin;exports.isAdmin=isAdmin;exports.isReportTeam=isReportTeam;exports.isDRTeam=isDRTeam});define("app/modules/visibilityChange",function(require,exports){"use strict";var hidden=void 0;var visibilityChange=void 0;var bindingFunc={};if(typeof document.hidden!=="undefined"){hidden="hidden";visibilityChange="visibilitychange"}else if(typeof document.msHidden!=="undefined"){hidden="msHidden";visibilityChange="msvisibilitychange"}else if(typeof document.webkitHidden!=="undefined"){hidden="webkitHidden";visibilityChange="webkitvisibilitychange"}var isDocumentHidden=function(){return document[hidden]};var bindVisibilityChange=function(naming,cb){if(!naming||!cb){return}bindingFunc[naming]=cb;document.addEventListener(visibilityChange,bindingFunc[naming],false)};var unbindVisibilityChange=function(naming,cb){if(!naming||!cb){return}document.removeEventListener(visibilityChange,bindingFunc[naming]);delete bindingFunc[naming]};exports.isDocumentHidden=isDocumentHidden;exports.bindVisibilityChange=bindVisibilityChange;exports.unbindVisibilityChange=unbindVisibilityChange});define("app/events",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var cs=require("external/customerService");var modal=require("ui/modal");var user=require("app/modules/user");var footerLocale=require("app/globals/footerLocale");var login=require("mapp/pages/login");var fav=require("app/modules/fav");var TrackingObserver=require("track/marketplace/TrackingObserver");var trackingObserver=TrackingObserver.instance;var CLICK_FAV_WHEN_NOT_LOGIN=TrackingObserver.CLICK_FAV_WHEN_NOT_LOGIN;var handleClickEvents=function(type,$target,evt){switch(type){case"g-fav":var tid=$target.data("tid");var price=$target.data("price");if(!tid||!price){return}if(!user.isLogin()){trackingObserver.update(CLICK_FAV_WHEN_NOT_LOGIN,{gaTrackingDataIsRequired:false});login.loginModal(modal);return}fav.addFav({tid:tid,price:price}).done(function(resp,status,xhr){if(!$target.hasClass("m-button-fav")){return}$("body").find(".m-button-fav[data-tid="+tid+"]").data("click","g-unfav").removeClass("m-button-fav").addClass("m-button-unfav").find(".text").html(i18n.gettext("已收藏商品"))});break;case"g-unfav":var tid=$target.data("tid");if(tid){fav.removeFav(tid,function(resp,status,xhr){if($target.hasClass("m-button-unfav")){$("body").find(".m-button-unfav[data-tid="+tid+"]").data("click","g-fav").removeClass("m-button-unfav").addClass("m-button-fav").find(".text").html(i18n.gettext("收藏商品"))}})}break;case"g-switch-intl":footerLocale.show(modal);break;case"g-switch-intl-specific-locale":footerLocale.show(modal,$target.data("locale"));break;case"g-logout":user.logout();break;case"g-uservoice":case"g-cs":cs.disableHelpCenter().show();break}};function konamiEvent(){var magicCode="";$(document.body).on("keydown",function(e){if(_.indexOf([37,38,39,40,65,66],e.keyCode)!==-1){if(magicCode!=="383840403739373966"){magicCode+=e.keyCode.toString()}else{if(e.keyCode===65){$(document.body).trigger("konami")}}}else{magicCode=""}})}exports.on=function(){$(document).on("click","[data-click]",function(evt){var $target=$(this);var actions=$target.data("click");actions=actions.split(",");for(var i=0,l=actions.length;i<l;++i){if(actions[i].substr(0,2)==="g-"){handleClickEvents(actions[i],$target,evt)}}});konamiEvent()}});(function(window,factory){var lazySizes=factory(window,window.document);window.lazySizes=lazySizes;if((typeof module==="undefined"?"undefined":_typeof(module))=="object"&&module.exports){module.exports=lazySizes}})(window,function l(window,document){"use strict";if(!document.getElementsByClassName){return}var lazysizes,lazySizesConfig;var docElem=document.documentElement;var Date=window.Date;var supportPicture=window.HTMLPictureElement;var _addEventListener="addEventListener";var _getAttribute="getAttribute";var addEventListener=window[_addEventListener];var setTimeout=window.setTimeout;var requestAnimationFrame=window.requestAnimationFrame||setTimeout;var requestIdleCallback=window.requestIdleCallback;var regPicture=/^picture$/i;var loadEvents=["load","error","lazyincluded","_lazyloaded"];var regClassCache={};var forEach=Array.prototype.forEach;var hasClass=function(ele,cls){if(!regClassCache[cls]){regClassCache[cls]=new RegExp("(\\s|^)"+cls+"(\\s|$)")}return regClassCache[cls].test(ele[_getAttribute]("class")||"")&&regClassCache[cls]};var addClass=function(ele,cls){if(!hasClass(ele,cls)){ele.setAttribute("class",(ele[_getAttribute]("class")||"").trim()+" "+cls)}};var removeClass=function(ele,cls){var reg;if(reg=hasClass(ele,cls)){ele.setAttribute("class",(ele[_getAttribute]("class")||"").replace(reg," "))}};var addRemoveLoadEvents=function(dom,fn,add){var action=add?_addEventListener:"removeEventListener";if(add){addRemoveLoadEvents(dom,fn)}loadEvents.forEach(function(evt){dom[action](evt,fn)})};var triggerEvent=function(elem,name,detail,noBubbles,noCancelable){var event=document.createEvent("Event");if(!detail){detail={}}detail.instance=lazysizes;event.initEvent(name,!noBubbles,!noCancelable);event.detail=detail;elem.dispatchEvent(event);return event};var updatePolyfill=function(el,full){var polyfill;if(!supportPicture&&(polyfill=window.picturefill||lazySizesConfig.pf)){if(full&&full.src&&!el[_getAttribute]("srcset")){el.setAttribute("srcset",full.src)}polyfill({reevaluate:true,elements:[el]})}else if(full&&full.src){el.src=full.src}};var getCSS=function(elem,style){return(getComputedStyle(elem,null)||{})[style]};var getWidth=function(elem,parent,width){width=width||elem.offsetWidth;while(width<lazySizesConfig.minSize&&parent&&!elem._lazysizesWidth){width=parent.offsetWidth;parent=parent.parentNode}return width};var rAF=function(){var running,waiting;var firstFns=[];var secondFns=[];var fns=firstFns;var run=function(){var runFns=fns;fns=firstFns.length?secondFns:firstFns;running=true;waiting=false;while(runFns.length){runFns.shift()()}running=false};var rafBatch=function(fn,queue){if(running&&!queue){fn.apply(this,arguments)}else{fns.push(fn);if(!waiting){waiting=true;(document.hidden?setTimeout:requestAnimationFrame)(run)}}};rafBatch._lsFlush=run;return rafBatch}();var rAFIt=function(fn,simple){return simple?function(){rAF(fn)}:function(){var that=this;var args=arguments;rAF(function(){fn.apply(that,args)})}};var throttle=function(fn){var running;var lastTime=0;var gDelay=lazySizesConfig.throttleDelay;var rICTimeout=lazySizesConfig.ricTimeout;var run=function(){running=false;lastTime=Date.now();fn()};var idleCallback=requestIdleCallback&&rICTimeout>49?function(){requestIdleCallback(run,{timeout:rICTimeout});if(rICTimeout!==lazySizesConfig.ricTimeout){rICTimeout=lazySizesConfig.ricTimeout}}:rAFIt(function(){setTimeout(run)},true);return function(isPriority){var delay;if(isPriority=isPriority===true){rICTimeout=33}if(running){return}running=true;delay=gDelay-(Date.now()-lastTime);if(delay<0){delay=0}if(isPriority||delay<9){idleCallback()}else{setTimeout(idleCallback,delay)}}};var debounce=function(func){var timeout,timestamp;var wait=99;var run=function(){timeout=null;func()};var later=function(){var last=Date.now()-timestamp;if(last<wait){setTimeout(later,wait-last)}else{(requestIdleCallback||run)(run)}};return function(){timestamp=Date.now();if(!timeout){timeout=setTimeout(later,wait)}}};(function(){var prop;var lazySizesDefaults={lazyClass:"lazyload",loadedClass:"lazyloaded",loadingClass:"lazyloading",preloadClass:"lazypreload",errorClass:"lazyerror",autosizesClass:"lazyautosizes",srcAttr:"data-src",srcsetAttr:"data-srcset",sizesAttr:"data-sizes",minSize:40,customMedia:{},init:false,expFactor:1.5,hFac:.8,loadMode:2,loadHidden:true,ricTimeout:0,throttleDelay:125};lazySizesConfig=window.lazySizesConfig||window.lazysizesConfig||{};for(prop in lazySizesDefaults){if(!(prop in lazySizesConfig)){lazySizesConfig[prop]=lazySizesDefaults[prop]}}window.lazySizesConfig=lazySizesConfig;setTimeout(function(){if(lazySizesConfig.init){init()}})})();var loader=function(){var preloadElems,isCompleted,resetPreloadingTimer,loadMode,started;var eLvW,elvH,eLtop,eLleft,eLright,eLbottom;var defaultExpand,preloadExpand,hFac;var regImg=/^img$/i;var regIframe=/^iframe$/i;var supportScroll="onscroll"in window&&!/(gle|ing)bot/.test(navigator.userAgent);var shrinkExpand=0;var currentExpand=0;var isLoading=0;var lowRuns=-1;var resetPreloading=function(e){isLoading--;if(e&&e.target){addRemoveLoadEvents(e.target,resetPreloading)}if(!e||isLoading<0||!e.target){isLoading=0}};var isNestedVisible=function(elem,elemExpand){var outerRect;var parent=elem;var visible=getCSS(document.body,"visibility")=="hidden"||getCSS(elem.parentNode,"visibility")!="hidden"&&getCSS(elem,"visibility")!="hidden";eLtop-=elemExpand;eLbottom+=elemExpand;eLleft-=elemExpand;eLright+=elemExpand;while(visible&&(parent=parent.offsetParent)&&parent!=document.body&&parent!=docElem){visible=(getCSS(parent,"opacity")||1)>0;if(visible&&getCSS(parent,"overflow")!="visible"){outerRect=parent.getBoundingClientRect();visible=eLright>outerRect.left&&eLleft<outerRect.right&&eLbottom>outerRect.top-1&&eLtop<outerRect.bottom+1}}return visible};var checkElements=function(){var eLlen,i,rect,autoLoadElem,loadedSomething,elemExpand,elemNegativeExpand,elemExpandVal,beforeExpandVal;var lazyloadElems=lazysizes.elements;if((loadMode=lazySizesConfig.loadMode)&&isLoading<8&&(eLlen=lazyloadElems.length)){i=0;lowRuns++;if(preloadExpand==null){if(!("expand"in lazySizesConfig)){lazySizesConfig.expand=docElem.clientHeight>500&&docElem.clientWidth>500?500:370}defaultExpand=lazySizesConfig.expand;preloadExpand=defaultExpand*lazySizesConfig.expFactor}if(currentExpand<preloadExpand&&isLoading<1&&lowRuns>2&&loadMode>2&&!document.hidden){currentExpand=preloadExpand;lowRuns=0}else if(loadMode>1&&lowRuns>1&&isLoading<6){currentExpand=defaultExpand}else{currentExpand=shrinkExpand}for(;i<eLlen;i++){if(!lazyloadElems[i]||lazyloadElems[i]._lazyRace){continue}if(!supportScroll){unveilElement(lazyloadElems[i]);continue}if(!(elemExpandVal=lazyloadElems[i][_getAttribute]("data-expand"))||!(elemExpand=elemExpandVal*1)){elemExpand=currentExpand}if(beforeExpandVal!==elemExpand){eLvW=innerWidth+elemExpand*hFac;elvH=innerHeight+elemExpand;elemNegativeExpand=elemExpand*-1;beforeExpandVal=elemExpand}rect=lazyloadElems[i].getBoundingClientRect();if((eLbottom=rect.bottom)>=elemNegativeExpand&&(eLtop=rect.top)<=elvH&&(eLright=rect.right)>=elemNegativeExpand*hFac&&(eLleft=rect.left)<=eLvW&&(eLbottom||eLright||eLleft||eLtop)&&(lazySizesConfig.loadHidden||getCSS(lazyloadElems[i],"visibility")!="hidden")&&(isCompleted&&isLoading<3&&!elemExpandVal&&(loadMode<3||lowRuns<4)||isNestedVisible(lazyloadElems[i],elemExpand))){unveilElement(lazyloadElems[i]);loadedSomething=true;if(isLoading>9){break}}else if(!loadedSomething&&isCompleted&&!autoLoadElem&&isLoading<4&&lowRuns<4&&loadMode>2&&(preloadElems[0]||lazySizesConfig.preloadAfterLoad)&&(preloadElems[0]||!elemExpandVal&&(eLbottom||eLright||eLleft||eLtop||lazyloadElems[i][_getAttribute](lazySizesConfig.sizesAttr)!="auto"))){autoLoadElem=preloadElems[0]||lazyloadElems[i]}}if(autoLoadElem&&!loadedSomething){unveilElement(autoLoadElem)}}};var throttledCheckElements=throttle(checkElements);var switchLoadingClass=function(e){addClass(e.target,lazySizesConfig.loadedClass);removeClass(e.target,lazySizesConfig.loadingClass);addRemoveLoadEvents(e.target,rafSwitchLoadingClass);triggerEvent(e.target,"lazyloaded")};var rafedSwitchLoadingClass=rAFIt(switchLoadingClass);var rafSwitchLoadingClass=function(e){rafedSwitchLoadingClass({target:e.target})};var changeIframeSrc=function(elem,src){try{elem.contentWindow.location.replace(src)}catch(e){elem.src=src}};var handleSources=function(source){var customMedia;var sourceSrcset=source[_getAttribute](lazySizesConfig.srcsetAttr);if(customMedia=lazySizesConfig.customMedia[source[_getAttribute]("data-media")||source[_getAttribute]("media")]){source.setAttribute("media",customMedia)}if(sourceSrcset){source.setAttribute("srcset",sourceSrcset)}};var lazyUnveil=rAFIt(function(elem,detail,isAuto,sizes,isImg){var src,srcset,parent,isPicture,event,firesLoad;if(!(event=triggerEvent(elem,"lazybeforeunveil",detail)).defaultPrevented){if(sizes){if(isAuto){addClass(elem,lazySizesConfig.autosizesClass)}else{elem.setAttribute("sizes",sizes)}}srcset=elem[_getAttribute](lazySizesConfig.srcsetAttr);src=elem[_getAttribute](lazySizesConfig.srcAttr);if(isImg){parent=elem.parentNode;isPicture=parent&&regPicture.test(parent.nodeName||"")}firesLoad=detail.firesLoad||"src"in elem&&(srcset||src||isPicture);event={target:elem};if(firesLoad){addRemoveLoadEvents(elem,resetPreloading,true);clearTimeout(resetPreloadingTimer);resetPreloadingTimer=setTimeout(resetPreloading,2500);addClass(elem,lazySizesConfig.loadingClass);addRemoveLoadEvents(elem,rafSwitchLoadingClass,true)}if(isPicture){forEach.call(parent.getElementsByTagName("source"),handleSources)}if(srcset){elem.setAttribute("srcset",srcset)}else if(src&&!isPicture){if(regIframe.test(elem.nodeName)){changeIframeSrc(elem,src)}else{elem.src=src}}if(isImg&&(srcset||isPicture)){updatePolyfill(elem,{src:src})}}if(elem._lazyRace){delete elem._lazyRace}removeClass(elem,lazySizesConfig.lazyClass);rAF(function(){if(!firesLoad||elem.complete&&elem.naturalWidth>1){if(firesLoad){resetPreloading(event)}else{isLoading--}switchLoadingClass(event)}},true)});var unveilElement=function(elem){var detail;var isImg=regImg.test(elem.nodeName);var sizes=isImg&&(elem[_getAttribute](lazySizesConfig.sizesAttr)||elem[_getAttribute]("sizes"));var isAuto=sizes=="auto";if((isAuto||!isCompleted)&&isImg&&(elem[_getAttribute]("src")||elem.srcset)&&!elem.complete&&!hasClass(elem,lazySizesConfig.errorClass)&&hasClass(elem,lazySizesConfig.lazyClass)){return}detail=triggerEvent(elem,"lazyunveilread").detail;if(isAuto){autoSizer.updateElem(elem,true,elem.offsetWidth)}elem._lazyRace=true;isLoading++;lazyUnveil(elem,detail,isAuto,sizes,isImg)};var onload=function(){if(isCompleted){return}if(Date.now()-started<999){setTimeout(onload,999);return}var afterScroll=debounce(function(){lazySizesConfig.loadMode=3;throttledCheckElements()});isCompleted=true;lazySizesConfig.loadMode=3;throttledCheckElements();addEventListener("scroll",function(){if(lazySizesConfig.loadMode==3){lazySizesConfig.loadMode=2}afterScroll()},true)};return{_:function(){started=Date.now();lazysizes.elements=document.getElementsByClassName(lazySizesConfig.lazyClass);preloadElems=document.getElementsByClassName(lazySizesConfig.lazyClass+" "+lazySizesConfig.preloadClass);hFac=lazySizesConfig.hFac;addEventListener("scroll",throttledCheckElements,true);addEventListener("resize",throttledCheckElements,true);if(window.MutationObserver){new MutationObserver(throttledCheckElements).observe(docElem,{childList:true,subtree:true,attributes:true})}else{docElem[_addEventListener]("DOMNodeInserted",throttledCheckElements,true);docElem[_addEventListener]("DOMAttrModified",throttledCheckElements,true);setInterval(throttledCheckElements,999)}addEventListener("hashchange",throttledCheckElements,true);["focus","mouseover","click","load","transitionend","animationend","webkitAnimationEnd"].forEach(function(name){document[_addEventListener](name,throttledCheckElements,true)});if(/d$|^c/.test(document.readyState)){onload()}else{addEventListener("load",onload);document[_addEventListener]("DOMContentLoaded",throttledCheckElements);setTimeout(onload,2e4)}if(lazysizes.elements.length){checkElements();rAF._lsFlush()}else{throttledCheckElements()}},checkElems:throttledCheckElements,unveil:unveilElement}}();var autoSizer=function(){var autosizesElems;var sizeElement=rAFIt(function(elem,parent,event,width){var sources,i,len;elem._lazysizesWidth=width;width+="px";elem.setAttribute("sizes",width);if(regPicture.test(parent.nodeName||"")){sources=parent.getElementsByTagName("source");for(i=0,len=sources.length;i<len;i++){sources[i].setAttribute("sizes",width)}}if(!event.detail.dataAttr){updatePolyfill(elem,event.detail)}});var getSizeElement=function(elem,dataAttr,width){var event;var parent=elem.parentNode;if(parent){width=getWidth(elem,parent,width);event=triggerEvent(elem,"lazybeforesizes",{width:width,dataAttr:!!dataAttr});if(!event.defaultPrevented){width=event.detail.width;if(width&&width!==elem._lazysizesWidth){sizeElement(elem,parent,event,width)}}}};var updateElementsSizes=function(){var i;var len=autosizesElems.length;if(len){i=0;for(;i<len;i++){getSizeElement(autosizesElems[i])}}};var debouncedUpdateElementsSizes=debounce(updateElementsSizes);return{_:function(){autosizesElems=document.getElementsByClassName(lazySizesConfig.autosizesClass);addEventListener("resize",debouncedUpdateElementsSizes)},checkElems:debouncedUpdateElementsSizes,updateElem:getSizeElement}}();var init=function(){if(!init.i){init.i=true;autoSizer._();loader._()}};lazysizes={cfg:lazySizesConfig,autoSizer:autoSizer,loader:loader,init:init,uP:updatePolyfill,aC:addClass,rC:removeClass,hC:hasClass,fire:triggerEvent,gW:getWidth,rAF:rAF};return lazysizes});define("app/postinit",function(require,exports){"use strict";var _=require("underscore");var settings=require("settings");var i18n=require("i18n");var cookie=require("net/cookie");var urlparse=require("net/urlparse");var sw=require("net/serviceWorker");var local=require("storage/local");var analytics=require("track/analytics");var events=require("app/events");var user=require("app/modules/user");var cart=require("app/modules/cart");var notification=require("app/modules/notification");var menu=require("app/globals/menu");var eventNotice=require("app/globals/eventNotice");var login=require("mapp/pages/login");var modal=require("ui/modal");var warningBar=require("ui/notification/warningBar");var facebook=require("external/facebook");var point=require("app/globals/point");var voiceInput=require("app/globals/voiceInput");var autocomplete=require("app/globals/autocomplete");var growthHack=require("app/globals/growthHack");var ftbDiscountModal=require("app/globals/ftbDiscountModal");var campaignToaster=require("app/globals/campaignToaster");var referralIntroSlides=require("ui/referralIntroSlides");var requestNotification=require("app/modules/requestNotification");var localeNotice=require("ui/localeNotice");var baseLazy=require("app/globals/baseLazy");var fbml=$(".m-fb-fbml");var rAF=require("ui/requestAnimation");var numberBadge=require("app/modules/numberBadge");baseLazy.init();menu.init();analytics.init();events.on();if(user.isLogin()){cart.updateNum();notification.init();numberBadge.listen()}var $share=$(".g-share");if($share.length){rAF(function(){setTimeout(function(){$share.addClass("s-after-onload")},1e3)})}if(!cookie.has("m2")){cookie.set("m2",Modernizr.touchevents&&!(navigator.userAgent.indexOf("Windows")>0&&window.innerWidth>768)?"1":"0","1y")}$("#g-switch-mobile").on("click",function(evt){cookie.set("m2","1","1y");cookie.del("desktop");local.del("g.ua");setTimeout(function(){location.reload()},200)});$('#gheader [data-click="login-modal"]').on("click",function(){if(location.hash==="#signup"){history.replaceState({},document.title,".");_.delay(function(){login.loginModal(modal)},10)}else{login.loginModal(modal)}});if(Modernizr.touchevents){var prevUa=local.get("g.ua");var currUa=navigator.userAgent;local.set("g.ua",currUa);if(prevUa&&prevUa!==currUa&&/mobile/i.test(navigator.userAgent)){cookie.del("desktop");local.del("g.ua");setTimeout(function(){location.reload()},200)}}local.del("g.browseHistory.product");if(fbml.length){rAF(function(){setTimeout(function(){if(settings.get("locale")!=="zh_CN"||settings.get("geo")!=="CN"){facebook.parseFBML(fbml)}},40)})}if(settings.get("uid")){point.init()}if(settings.get("production")){window.console&&console.log($("head").find('meta[name="X-Recruiting"]').attr("content"))}if(settings.get("suggestedLocale")){if(urlparse.current().paths[0]==="user"&&urlparse.current().get("onload")){localeNotice.init({delay:800})}else{localeNotice.init()}}voiceInput.init();function shouldPromptLoginModal(){var inErrorPage=!!document.querySelector("#s-skip-login-modal");var url=urlparse.current();var promptLoginModal=url.get("next")||url.get("_login");return!inErrorPage&&promptLoginModal}if(!user.isLogin()){if(shouldPromptLoginModal()){rAF(function(){login.loginModal(modal)})}else{growthHack.pageOnloadHook()}}else{var unreadCount=settings.get("unreadMsg");if(unreadCount){$("#gheader").find(".message").after('<a class="notice_unread" href="/message">'+unreadCount+"</a>")}}eventNotice.init();if(!Boolean(cookie.get("g.locale.notSynced.noticed"))&&_.contains(["my","panel"],urlparse.current().paths[0])){if(settings.get("locale")!==settings.get("userLocale")){warningBar.show(i18n.gettext("系統發現你的偏好語言是<%= lang %>，與現在瀏覽網頁的語言不同。請問你想要變更設定嗎？"),{lang:settings.get("userLocaleName"),button:{text:i18n.gettext("暸解更多"),link:"/my/setting#lang",cb:function(){cookie.set("g.locale.notSynced.noticed",-1,"1m")}}})}}if(Modernizr.chrome&&settings.get("locale")==="zh_TW"){settings.set("isInNotificationBucket",true)}sw.syncRegistration();ftbDiscountModal.init();campaignToaster.init();if(settings.get("showReferralIntroSlides")){referralIntroSlides.showSlidesModal()}requestNotification.syncUpToken();var $keyword=$("#g-header-keyword");$keyword.one("focus",function(){autocomplete.init($keyword,[])});var $searchForm=$(".g-search-form");$searchForm.on("submit",function(evt){evt.preventDefault();var $serchQ=$searchForm.find('input[name="q"]');if(!$.trim($serchQ.val())){var $form=$(evt.target);var defaultQ=$form.data("default-keyword");if(defaultQ){location.href=$form.data("default-url");return}}});window.history.replaceState({},"",urlparse.removeUrlRef())});define("app/globals/icons",function(require){"use strict";var icons={"arrow-top":{path:"M12 8.809L10.761 10 7 6.383 3.24 10 2 8.809 7 4z"},"arrow-bottom":{path:"M12 5.191L7 10 2 5.191 3.239 4l3.76 3.617L10.761 4z"},"arrow-right":{path:"M4 10.825L7.709 7 4 3.175 5.142 2 10 7l-4.858 5L4 10.825z"},"arrow-left":{path:"M10 10.825L6.291 7 10 3.175 8.858 2 4 7l4.858 5L10 10.825z"},"sleek-arrow-right":{size:20,path:"M6.33 5.471l5.455 4.532-5.45 4.529a.812.812 0 0 0-.325.536.828.828 0 0 0 .823.932.852.852 0 0 0 .504-.165l.006-.004 6.323-5.172a.812.812 0 0 0 .002-1.31L7.343 4.167l-.008-.006A.843.843 0 0 0 6.837 4c-.266 0-.51.12-.67.33A.807.807 0 0 0 6.33 5.47"},"sleek-arrow-down":{size:20,path:"M9.99673381,11.7849353 L14.5285082,6.32990576 C14.8047147,5.96389069 15.3065726,5.89190434 15.6706824,6.16695881 C15.8801448,6.32715377 16,6.57135694 16,6.83699669 C16,7.01732465 15.9457528,7.1847617 15.8388204,7.33481774 C15.8366903,7.33800426 15.8345601,7.34075625 15.832572,7.3433634 L10.6505408,13.6680227 C10.5000118,13.8751464 10.2550472,14 9.99673381,14 C9.73827838,14 9.49317176,13.8751464 9.3413647,13.6661398 L4.16941611,7.3433634 L4.16487184,7.33713521 C4.05708741,7.18896211 4,7.0147175 4,6.83352048 C4,6.56961884 4.12013917,6.32715377 4.32945966,6.16826238 C4.50043786,6.03500798 4.71472865,5.97837486 4.93157558,6.0100952 C5.14572436,6.04152586 5.34141204,6.15971672 5.4682256,6.3345407 L9.99673381,11.7849353 Z"},"heart-outline":{size:24,path:"M12 20.75c-.17 0-.339-.058-.478-.172-.247-.204-6.068-5.031-8.377-8.144-1.748-2.693-1.549-5.853.456-7.722C4.612 3.77 5.952 3.25 7.374 3.25c1.153 0 2.293.347 3.208.978.651.448 1.103.952 1.417 1.432.315-.48.767-.984 1.418-1.432.915-.631 2.055-.978 3.209-.978 1.421 0 2.761.52 3.772 1.462 2.005 1.868 2.204 5.027.482 7.683-2.334 3.152-8.155 7.979-8.402 8.183-.139.114-.308.172-.478.172zm-4.626-16c-1.041 0-2.018.376-2.75 1.059-1.464 1.364-1.565 3.737-.247 5.77 1.808 2.436 6.172 6.211 7.623 7.442 1.451-1.231 5.819-5.013 7.648-7.48 1.292-1.996 1.191-4.369-.272-5.731-.733-.684-1.71-1.06-2.75-1.06-.854 0-1.69.253-2.357.713-1.23.846-1.451 1.933-1.534 2.343-.071.349-.378.6-.734.6H12c-.356 0-.663-.25-.734-.599-.084-.41-.308-1.499-1.535-2.344-.667-.46-1.504-.713-2.357-.713z"},"heart-solid":{size:24,path:"M7.374 4.75a4.008 4.008 0 0 0-2.75 1.059c-1.464 1.364-1.565 3.737-.247 5.77 1.808 2.436 6.172 6.211 7.623 7.442 1.451-1.231 5.819-5.013 7.648-7.48 1.292-1.996 1.191-4.369-.272-5.731a4.007 4.007 0 0 0-2.75-1.06 4.18 4.18 0 0 0-2.357.713c-1.23.846-1.451 1.933-1.534 2.343a.75.75 0 0 1-.734.6H12a.748.748 0 0 1-.734-.599 3.543 3.543 0 0 0-1.535-2.344 4.182 4.182 0 0 0-2.357-.713"},"discount-tag":{size:24,path:"M16.62 4.516c1.334-2.563 3.68-4.078 5.525-3.322 1.972.807 2.407 3.814 1.138 6.7a8.785 8.785 0 0 1-1.17 1.945 7.282 7.282 0 0 1-.936.972l.107-1.475.06-.074a7.784 7.784 0 0 0 1.043-1.735c1.086-2.468.732-4.908-.625-5.464-1.242-.508-3.076.663-4.211 2.758l2.379.78c.716.235 1.237.984 1.193 1.717l-.351 5.836c-.025.407-.298.872-.647 1.101L7.626 22.44a.99.99 0 0 1-1.351-.252L.166 13.396a.927.927 0 0 1 .265-1.31L12.93 3.901c.35-.229.896-.3 1.294-.17l2.396.785zm-.966 3.353c.048-.792.236-1.64.57-2.485l-2.315-.758a.657.657 0 0 0-.436.056L.975 12.866l6.108 8.792 12.499-8.185a.62.62 0 0 0 .217-.37l.351-5.836c.019-.309-.234-.673-.536-.772l-2.468-.808a7.308 7.308 0 0 0-.516 2.168c.333.099.634.304.843.606.488.701.294 1.655-.432 2.13-.725.475-1.709.292-2.196-.409-.488-.701-.294-1.655.432-2.131.12-.078.246-.139.377-.182zm0 .789a.812.812 0 0 0-.203 1.127.848.848 0 0 0 .517.342 4.774 4.774 0 0 1-.314-1.469zm.974-.029c.03.424.113.81.244 1.142a.806.806 0 0 0-.244-1.142zM5.665 14.035a1.34 1.34 0 0 1-.246-1.151c.096-.419.337-.746.723-.982a1.816 1.816 0 0 1 1.277-.239c.465.076.828.288 1.088.637.252.338.333.717.242 1.137-.092.42-.333.749-.725.988a1.799 1.799 0 0 1-1.284.238c-.464-.08-.823-.289-1.075-.628zm1.898-2.999l2.477-1.513.699 7.844-.715.436-.579-7.001-1.412.862-.47-.628zM6.38 13.599a.808.808 0 0 0 .539.316.895.895 0 0 0 .636-.119.743.743 0 0 0 .364-.492.68.68 0 0 0-.127-.568.82.82 0 0 0-.545-.323.895.895 0 0 0-.636.118.746.746 0 0 0-.359.49.678.678 0 0 0 .128.578zm5.186 1.424a1.33 1.33 0 0 1-.241-1.144c.097-.419.338-.746.723-.981.386-.236.81-.315 1.273-.237.463.077.822.288 1.078.631.257.344.34.724.252 1.142-.089.418-.329.747-.72.986-.392.239-.82.319-1.284.238-.465-.08-.825-.292-1.081-.635zm.706-.431a.828.828 0 0 0 .542.319.896.896 0 0 0 .648-.12.74.74 0 0 0 .356-.493.681.681 0 0 0-.125-.574.81.81 0 0 0-.539-.316.894.894 0 0 0-.636.118.764.764 0 0 0-.364.492.662.662 0 0 0 .118.574z"},search:{size:20,path:"M15.237 8.75a6.25 6.25 0 1 0-12.5 0 6.25 6.25 0 0 0 12.5 0zm-.413 5.347l3.844 3.63-1.144 1.212-3.954-3.734a7.917 7.917 0 1 1 1.254-1.108z"},plus:{size:12,path:"M7 5V1H5v4H1v2h4v4h2V7h4V5z"},cross:{size:14,path:"M7 5.574L2.723 1.297A1.007 1.007 0 0 0 1 2.01c0 .267.106.524.296.713L5.575 7l-4.277 4.277a1.004 1.004 0 0 0 0 1.426 1 1 0 0 0 1.419.007L7 8.426l4.277 4.277a1.006 1.006 0 0 0 1.426 0 1.006 1.006 0 0 0 0-1.426L8.426 7l4.278-4.279a1.004 1.004 0 0 0 0-1.425 1.007 1.007 0 0 0-1.427 0L7 5.575v-.001z"},fan:{size:20,path:"M8.6,8.6 L8.6,3 L11.4,3 L11.4,8.6 L17,8.6 L17,11.4 L11.4,11.4 L11.4,17 L8.6,17 L8.6,11.4 L3,11.4 L3,8.6 L8.6,8.6 Z"},unFan:{size:20,path:"m8.65685425 11.5355339 7.53553395-7.5355339 2.1213203 2.12132034-7.5355339 7.53553386-2.12132035 2.1213204-5.65685425-5.6568543 2.12132034-2.1213203z"},contact:{size:20,path:"M11.4404438,8.96233249 C11.8718029,8.56999817 12.1426,8.00383132 12.1426,7.3744 C12.1426,6.19096393 11.1838405,5.2309 10.0011,5.2309 C8.81679448,5.2309 7.8576,6.1905291 7.8576,7.3744 C7.8576,8.00393887 8.12841363,8.56999246 8.55997495,8.96225365 C7.31957443,9.19570332 6.3815,10.2850279 6.3815,11.5935 C6.3815,11.9350881 6.65841188,12.212 7,12.212 L13,12.212 C13.3415881,12.212 13.6185,11.9350881 13.6185,11.5935 C13.6185,10.2851751 12.6806367,9.1959485 11.4404438,8.96233249 Z M5.8032,15.8666 L3.5662,15.8666 C2.15001801,15.8666 1.0002,14.7187035 1.0002,13.3036 L1.0002,4.2856 C1.0002,2.87038104 2.15013405,1.7216 3.5662,1.7216 L16.4332,1.7216 C17.8500739,1.7216 19.0002,2.87018905 19.0002,4.2856 L19.0002,13.3036 C19.0002,14.7188954 17.85019,15.8666 16.4332,15.8666 L10.4546285,15.8666 L6.59410818,18.6282601 C6.26320982,18.8649714 5.8032,18.6284488 5.8032,18.2216 L5.8032,15.8666 Z"},check:{size:12,path:"M10 2l1.5 1.5-6.99 7L0 6l1.5-1.5 3.01 3z"},album:{size:20,path:"M2 14.519v.873c0 .06.048.108.108.108h15.784c.06 0 .108-.048.108-.108v-4.47l-1.893-1.676c-.908-.81-1.945-.806-2.854-.001l-2.594 2.334a.5.5 0 0 1-.687-.018l-.628-.626c-.747-.749-1.642-.751-2.709.044L2 14.519zm0-1.259l4.033-3.08c1.449-1.079 2.898-1.074 4.018.047l.292.292 2.244-2.02c1.289-1.142 2.898-1.149 4.184 0l1.23 1.087V4.608a.108.108 0 0 0-.109-.108H2.108A.108.108 0 0 0 2 4.608v8.652zm15.892 3.24H2.108A1.108 1.108 0 0 1 1 15.392V4.608C1 3.996 1.496 3.5 2.108 3.5h15.784c.612 0 1.108.496 1.108 1.108v10.784c0 .612-.496 1.108-1.108 1.108zM5.378 7.187a.944.944 0 1 1-1.889 0 .944.944 0 0 1 1.89 0z"},copy:{size:20,path:"M7.875 6.875h3.306c1.073 0 1.944.87 1.944 1.944v3.306h2.431a.944.944 0 0 0 .944-.944V4.444a.944.944 0 0 0-.944-.944H8.819a.944.944 0 0 0-.944.944v2.431zm0 1v3.306c0 .521.423.944.944.944h3.306V8.819a.944.944 0 0 0-.944-.944H7.875zm5.25 5.25v2.431c0 1.074-.87 1.944-1.944 1.944H4.444A1.944 1.944 0 0 1 2.5 15.556V8.819c0-1.074.87-1.944 1.944-1.944h2.431V4.444c0-1.074.87-1.944 1.944-1.944h6.737c1.073 0 1.944.87 1.944 1.944v6.737c0 1.074-.87 1.944-1.944 1.944h-2.431zm-1 0H8.819a1.944 1.944 0 0 1-1.944-1.944V7.875H4.444a.944.944 0 0 0-.944.944v6.737c0 .521.423.944.944.944h6.737a.944.944 0 0 0 .944-.944v-2.431z"},location:{size:24,path:"M12 2c3.87 0 7 3.13 7 7 0 5.25-7 13-7 13S5 14.25 5 9c0-3.87 3.13-7 7-7zM7 9c0 2.85 2.92 7.21 5 9.88 2.12-2.69 5-7 5-9.88 0-2.76-2.24-5-5-5S7 6.24 7 9zm5 2.5c-1.380712 0-2.5-1.119288-2.5-2.5s1.119288-2.5 2.5-2.5 2.5 1.119288 2.5 2.5-1.119288 2.5-2.5 2.5z"},calendar:{size:16,path:"M13.545 2.525h-1.692V1.5c0-.274-.226-.5-.5-.5s-.5.226-.5.5v1.025H5.146V1.5c0-.274-.226-.5-.5-.5s-.5.226-.5.5v1.025H2.453C1.652 2.525 1 3.178 1 3.979v9.569C1 14.349 1.652 15 2.453 15h11.092c.803 0 1.455-.651 1.455-1.451v-9.57c0-.801-.652-1.454-1.455-1.454zm-9.399 1V4.5c0 .274.226.5.5.5s.5-.226.5-.5v-.975h5.706V4.5c0 .274.226.5.5.5s.5-.226.5-.5v-.975H4.146zM13.545 14H2.453h-.001A.454.454 0 0 1 2 13.549V8.226h12v5.323a.455.455 0 0 1-.453.451h-.002z"},eye:{size:24,path:"m21.8348993 11.365336s.4162566.6777317-.0731261 1.396194c-2.9519221 4.3294701-5.8025925 6.23847-9.7195299 6.23847-6.35260119 0-9.84640685-6.365336-9.84640685-6.365336s-.44063202-.5989412 0-1.269328c0 0 3.49380566-6.365336 9.84640685-6.365336 3.9169374 0 7.030112 1.8856298 9.792656 6.365336zm-9.8348993 5.134664c2.4852814 0 4.5-2.0147186 4.5-4.5 0-2.48528137-2.0147186-4.5-4.5-4.5-2.48528137 0-4.5 2.01471863-4.5 4.5 0 2.4852814 2.01471863 4.5 4.5 4.5zm0-2c-1.3807119 0-2.5-1.1192881-2.5-2.5s1.1192881-2.5 2.5-2.5 2.5 1.1192881 2.5 2.5-1.1192881 2.5-2.5 2.5z"
},cart:{size:20,path:"M17.494 4.552a.625.625 0 0 1 .105.546l-1.484 5.364a.625.625 0 0 1-.603.458H7.817l.03.088c.041.119.047.245.015.365l-.385 1.474h8.53v1.25h-9.34a.627.627 0 0 1-.605-.783l.543-2.072-2.603-7.405H2.153v-1.25h2.292c.265 0 .502.167.59.417l.457 1.302h11.505c.195 0 .38.09.497.246zM15.037 9.67l1.139-4.114H5.93L7.377 9.67zm-6.391 6.718a1.25 1.25 0 1 1-2.501 0 1.25 1.25 0 0 1 2.5 0zm7.361 0a1.25 1.25 0 1 1-2.5 0 1.25 1.25 0 0 1 2.5 0z"},user:{size:24,path:"M15.832 8.734c0 2.067-1.72 3.736-3.833 3.736-2.112 0-3.83-1.67-3.83-3.736C8.169 6.669 9.888 5 11.999 5c2.112 0 3.833 1.67 3.833 3.734zm-1 0C14.832 7.228 13.566 6 11.998 6c-1.565 0-2.83 1.228-2.83 2.734 0 1.508 1.264 2.736 2.83 2.736 1.567 0 2.833-1.228 2.833-2.736zm3.5 9.766a.5.5 0 0 1-.5.5H6.168a.5.5 0 0 1-.5-.5c0-2.792 1.78-4.865 4.456-4.865h3.574c2.701 0 4.636 2.112 4.636 4.865zM6.69 18h10.616c-.208-1.962-1.644-3.365-3.61-3.365h-3.573c-1.93 0-3.246 1.364-3.433 3.365z"},email:{size:24,path:"M17.635 16.05l-4.47-3.269-.883.705a.45.45 0 0 1-.562 0l-.884-.705-4.47 3.269zm.508-.743V8.81l-4.249 3.39zm-12.287 0l4.25-3.108-4.25-3.39zm.366-7.357l5.779 4.609 5.777-4.61zm12.821 7.85c0 .636-.514 1.15-1.149 1.15H6.106a1.15 1.15 0 0 1-1.15-1.15V8.2a1.15 1.15 0 0 1 1.15-1.15h11.788a1.15 1.15 0 0 1 1.15 1.15z"},lock:{size:24,path:"M7.96 10.877V9.516C7.96 6.893 9.691 5 12 5s4.04 1.893 4.04 4.516v1.36h.275c.732 0 1.327.596 1.327 1.329v5.469c0 .733-.595 1.326-1.327 1.326h-8.63a1.326 1.326 0 0 1-1.326-1.326v-5.47c0-.732.594-1.327 1.327-1.327zm1 0h6.08V9.516C15.04 7.426 13.735 6 12 6S8.96 7.426 8.96 9.516zm7.682 6.797v-5.47a.328.328 0 0 0-.327-.327h-8.63a.328.328 0 0 0-.326.328v5.469c0 .18.146.326.327.326h8.629c.18 0 .327-.146.327-.326z"},"lock-solid":{size:24,path:"M8.686 9.516C8.686 7.479 10.08 6 12 6c1.922 0 3.314 1.479 3.314 3.516v1.36h-6.63l.002-1.36zm7.868 1.36h-.149v-1.36C16.405 6.899 14.553 5 12.001 5 9.449 5 7.596 6.899 7.596 9.516v1.36h-.15c-.798 0-1.446.596-1.446 1.327v5.469C6 18.404 6.648 19 7.446 19h9.108C17.35 19 18 18.404 18 17.672v-5.47c0-.73-.649-1.325-1.446-1.325v-.001z"},countdown:{size:12,path:"M5.994.04c3.285 0 5.958 2.673 5.958 5.958s-2.673 5.958-5.958 5.958A5.965 5.965 0 01.566 3.537 5.985 5.985 0 012.193 1.41l.248-.195a.458.458 0 01.643.084l3.773 4.92a.457.457 0 11-.726.558L2.643 2.231A5.08 5.08 0 001.4 3.916a5.048 5.048 0 004.594 7.124c2.78 0 5.042-2.262 5.042-5.042S8.774.956 5.994.956a.458.458 0 110-.916z"},question:{size:12,path:"M6 0a6 6 0 010 12A6 6 0 016 0zm0 7.875a.625.625 0 100 1.25.625.625 0 000-1.25zm.046-4.852c-1.09 0-1.795.776-1.795 1.975h1.006c0-.742.414-1.006.768-1.006.317 0 .653.21.682.613.028.376-.148.588-.388.822l-.093.089c-.706.671-.718.996-.716 1.733h1.002c-.005-.331.016-.601.468-1.089l.19-.208c.289-.329.572-.736.578-1.303.006-.461-.142-.859-.427-1.148-.304-.308-.757-.478-1.275-.478z"},"question-circle":{size:14,path:"M7 0h.003c3.841 0 7 3.16 7 7 0 3.751-3.014 6.869-6.763 6.996L7 14c-3.84 0-7-3.16-7-7s3.16-7 7-7zm0 .875h-.004C3.636.875.871 3.64.871 7c0 3.277 2.63 6.003 5.904 6.121l.225.004c3.36 0 6.125-2.765 6.125-6.125S10.36.875 7 .875zm0 8.313c-.4 0-.729.329-.729.729 0 .4.329.729.729.729.4 0 .729-.329.729-.729 0-.4-.329-.729-.729-.729zm.054-5.661c-1.272 0-2.095.905-2.095 2.304h1.174c0-.866.483-1.174.896-1.174.37 0 .762.245.796.715.032.439-.173.686-.453.959l-.108.104c-.824.783-.838 1.162-.836 2.022h1.169c-.006-.386.019-.701.546-1.27l.222-.243c.337-.384.667-.859.674-1.52.007-.538-.165-1.002-.498-1.34-.354-.359-.883-.557-1.487-.557z"},"pcoin-circle":{size:20,path:"M9.993 1a9 9 0 015.493 16.134A8.956 8.956 0 0110.007 19 9 9 0 014.514 2.866 8.954 8.954 0 019.993 1zm.001 1l-.332.007a7.923 7.923 0 00-4.539 1.652 7.955 7.955 0 00-3.056 5.306 7.95 7.95 0 001.592 5.912A7.951 7.951 0 0010.007 18a7.92 7.92 0 004.87-1.659 7.95 7.95 0 003.055-5.306 7.949 7.949 0 00-1.591-5.912 7.948 7.948 0 00-6.047-3.118zm.53 3.76a2.978 2.978 0 012.972 2.832c.078 1.589-1.16 2.954-2.726 3.111l-.176.013-.716.03a.208.208 0 01-.203-.143l-.009-.052-.039-.914a.205.205 0 01.142-.204l.053-.01.732-.03c.91-.038 1.646-.788 1.621-1.698a1.654 1.654 0 00-1.652-1.611l-.097.003c-.86.049-1.52.768-1.555 1.616v.143l.12 2.864a2.972 2.972 0 01-1.095 2.436.422.422 0 01-.39.073l-.06-.025-.864-.452c-.116-.06-.108-.23.013-.277.612-.237 1.046-.84 1.074-1.546v-.153l-.12-2.85c-.067-1.588 1.13-2.992 2.694-3.142l.175-.011z"},"exclamation-circle":{size:14,path:"M7 0a7 7 0 01.24 13.996L7 14A7 7 0 017 0zm0 .875a6.125 6.125 0 00-.225 12.246l.225.004A6.125 6.125 0 107 .875zm0 8.75a.875.875 0 110 1.75.875.875 0 010-1.75zm-.002-7l.119.006c.63.06 1.26.598 1.19 1.351L7.83 7.878c0 .346-.28.872-.831.872h-.001l-.123-.009c-.47-.07-.709-.543-.709-.863l-.473-3.896c-.074-.8.637-1.357 1.305-1.357z"},category_0:{size:24,path:"M19.146 14.262a.5.5 0 0 0-.146.354V20.5c0 .828-.673 1.5-1.5 1.5h-10A1.5 1.5 0 0 1 6 20.5v-5.884a.5.5 0 0 0-.147-.354l-2.646-2.648 2.58-2.581c.826-.763 1.816-1.189 2.616-1.425a4.39 4.39 0 0 0 8.193 0c.8.234 1.788.66 2.603 1.412l2.593 2.594zm-3.542-6.879A3.388 3.388 0 0 1 12.5 9.422a3.388 3.388 0 0 1-3.105-2.039c1.76-.31 4.45-.31 6.21 0zm7.25 3.877l-2.962-2.961c-1.144-1.058-2.532-1.551-3.5-1.779l-.006-.002c-.882-.219-2.042-.344-3.302-.375.166-.344.551-.709.813-.908a1.92 1.92 0 1 0-3.317-1.317.499.499 0 1 0 1 0 .92.92 0 0 1 1.84 0 .965.965 0 0 1-.18.569c-.115.084-1.02.769-1.2 1.652-1.309.025-2.516.154-3.427.379l-.005.002c-.969.228-2.357.721-3.515 1.793L2.146 11.26a.5.5 0 0 0 0 .707L5 14.823V20.5C5 21.879 6.121 23 7.5 23h10c1.378 0 2.5-1.121 2.5-2.5v-5.677l2.853-2.856a.5.5 0 0 0 0-.707z"},category_1:{size:24,path:"M19.146 14.262a.5.5 0 0 0-.146.354V20.5c0 .828-.673 1.5-1.5 1.5h-10A1.5 1.5 0 0 1 6 20.5v-5.884a.5.5 0 0 0-.147-.354l-2.646-2.648 2.58-2.581c.826-.763 1.816-1.189 2.616-1.425a4.39 4.39 0 0 0 8.193 0c.8.234 1.788.66 2.603 1.412l2.593 2.594zm-3.542-6.879A3.388 3.388 0 0 1 12.5 9.422a3.388 3.388 0 0 1-3.105-2.039c1.76-.31 4.45-.31 6.21 0zm7.25 3.877l-2.962-2.961c-1.144-1.058-2.532-1.551-3.5-1.779l-.006-.002c-.882-.219-2.042-.344-3.302-.375.166-.344.551-.709.813-.908a1.92 1.92 0 1 0-3.317-1.317.499.499 0 1 0 1 0 .92.92 0 0 1 1.84 0 .965.965 0 0 1-.18.569c-.115.084-1.02.769-1.2 1.652-1.309.025-2.516.154-3.427.379l-.005.002c-.969.228-2.357.721-3.515 1.793L2.146 11.26a.5.5 0 0 0 0 .707L5 14.823V20.5C5 21.879 6.121 23 7.5 23h10c1.378 0 2.5-1.121 2.5-2.5v-5.677l2.853-2.856a.5.5 0 0 0 0-.707z"},category_2:{size:24,path:"M12.5 21.959c-4.136 0-7.5-3.364-7.5-7.5 0-3.171 1.988-5.867 4.775-6.962l1.174 1.173C8.391 9.355 6.5 11.688 6.5 14.459c0 3.309 2.691 6 6 6s6-2.691 6-6c0-2.789-1.915-5.132-4.497-5.802l1.176-1.176C17.989 8.564 20 11.271 20 14.459c0 4.136-3.364 7.5-7.5 7.5zM9.686 3h5.689l1.437 1.436-.102.101c-.022-.002-.039-.012-.061-.012H8.352c-.039 0-.075.014-.112.023l-.052-.052zm2.466 5.459L9.218 5.525h6.504l-2.935 2.934zm.348 1c2.757 0 5 2.243 5 5s-2.243 5-5 5-5-2.243-5-5 2.243-5 5-5zm3.438-2.736l1.934-1.934a.5.5 0 0 0 0-.707l-1.936-1.935A.5.5 0 0 0 15.582 2H9.479a.5.5 0 0 0-.354.147L7.128 4.143a.496.496 0 0 0 0 .707L9.02 6.741C6.071 8.075 4 11.018 4 14.459c0 4.687 3.813 8.5 8.5 8.5s8.5-3.813 8.5-8.5c0-3.457-2.091-6.411-5.062-7.736z"},category_3:{size:24,path:"M21.601 7.858l-1.656 1.656-2.24-2.24-.002-.002-2.24-2.239 1.655-1.657c.502-.502 1.38-.504 1.885.001l2.598 2.597c.252.252.39.586.39.942s-.139.69-.39.942zM4.583 16.665c.148.284.324.553.555.783.423.424.96.72 1.538.853.134.58.43 1.116.851 1.537.231.231.501.41.785.556l-3.736 1.001-.995-.994zm2.36.655a2.147 2.147 0 0 1-1.093-.586 2.173 2.173 0 0 1-.624-1.466l9.523-9.522 1.885 1.883zm12.29-7.093l-9.525 9.525a2.183 2.183 0 0 1-1.467-.626 2.171 2.171 0 0 1-.585-1.092l9.691-9.692zm3.081-4.966l-2.597-2.597c-.885-.885-2.428-.886-3.312 0l-2.01 2.01-.003.001c0 .001 0 .002-.002.003l-9.945 9.946a.475.475 0 0 0-.148.148l-.248.247a.52.52 0 0 0-.13.227L2.532 20.42v.002l-.516 1.92a.507.507 0 0 0 .13.49.513.513 0 0 0 .357.146h.001a.571.571 0 0 0 .13-.016l7.096-1.902a.507.507 0 0 0 .226-.13l.267-.266a.555.555 0 0 0 .11-.112l11.98-11.979c.442-.443.685-1.03.685-1.655a2.322 2.322 0 0 0-.685-1.656z"},category_4:{size:24,path:"M20.192 9.036A2.278 2.278 0 0 1 22 11.276a2.295 2.295 0 0 1-2.2 2.29 8.774 8.774 0 0 1-4.322 4.869 3.863 3.863 0 0 1-.847.771 3.166 3.166 0 0 1-3.138 2.812c-1.63 0-2.961-1.239-3.139-2.823a3.864 3.864 0 0 1-.839-.758 8.77 8.77 0 0 1-4.327-4.871A2.297 2.297 0 0 1 1 11.276a2.28 2.28 0 0 1 1.793-2.234c.728-4.204 4.401-7.327 8.7-7.327 1.236 0 2.417.266 3.494.735.23-.567.29-.996.291-1.008a.501.501 0 1 1 .995.12c-.002.015-.076.588-.39 1.331a8.854 8.854 0 0 1 4.309 6.143zm-.484 3.529a1.29 1.29 0 0 0 1.289-1.289c0-.703-.553-1.269-1.257-1.287a.502.502 0 0 1-.485-.438 7.834 7.834 0 0 0-3.841-5.767c-.67 1.057-1.838 2.16-3.876 2.474a.502.502 0 0 1-.153-.991c1.62-.25 2.571-1.097 3.129-1.931a7.757 7.757 0 0 0-3.021-.618c-3.926 0-7.264 2.939-7.762 6.835a.502.502 0 0 1-.48.438c-.7.023-1.248.589-1.248 1.285 0 .76.701 1.381 1.431 1.273a.65.65 0 0 1 .077-.005c.221 0 .443.137.509.347a7.757 7.757 0 0 0 2.873 3.987c-.003-.042-.012-.083-.012-.126 0-1.852 2.069-3.36 4.612-3.36 2.544 0 4.614 1.508 4.614 3.36 0 .043-.009.084-.011.126a7.763 7.763 0 0 0 2.872-3.987.502.502 0 0 1 .549-.347c.08.012.134.021.191.021zm-8.215 3.105a3.17 3.17 0 0 1 3.043 2.319c.354-.362.568-.785.568-1.237 0-1.278-1.654-2.357-3.611-2.357-1.956 0-3.609 1.079-3.609 2.357 0 .45.218.868.57 1.229.379-1.329 1.589-2.311 3.039-2.311zm0 5.345a2.173 2.173 0 0 0 2.171-2.171c0-1.197-.974-2.171-2.171-2.171s-2.171.974-2.171 2.171c0 1.198.974 2.171 2.171 2.171zM8.57 9.67a.753.753 0 1 1 0 1.505.753.753 0 0 1 0-1.505zm5.846 0a.752.752 0 1 1 0 1.503.752.752 0 0 1 0-1.503z"},category_5:{size:24,path:"M4.166 13.862L7.324 3h9.356l3.154 10.862zM16.5 21.029V22H7.517v-.971c0-.406.33-.736.736-.736h7.514c.404 0 .733.33.733.736zm4.443-6.933L17.535 2.36a.5.5 0 0 0-.48-.36H6.949a.5.5 0 0 0-.48.36l-3.45 11.862a.499.499 0 0 0 .48.64h2.287v2.12a.5.5 0 0 0 1 0v-2.12h4.716v4.431h-3.25c-.956 0-1.735.779-1.735 1.736V22.5a.5.5 0 0 0 .5.5H17a.5.5 0 0 0 .5-.5v-1.471c0-.957-.777-1.736-1.733-1.736h-3.265v-4.431h8.018a.5.5 0 0 0 .423-.766z"},category_6:{size:24,path:"M21.027 5.68a.746.746 0 0 1-.732.745c.242 1.246.916 6.17-3.073 7.998a75.137 75.137 0 0 1-3.613 1.563l.203 1.071c.216-.069.442-.117.681-.117a2.236 2.236 0 0 1 2.234 2.234 2.23 2.23 0 0 1-2.092 2.22l.191 1.002a.502.502 0 0 1-.983.187l-.26-1.373a2.224 2.224 0 0 1-1.151-2.894H3.554l-.559 4.24a.505.505 0 0 1-.56.43.501.501 0 0 1-.432-.562l2.637-19.99a.503.503 0 0 1 .585-.427C6.294 2.2 8.268 3.243 8.521 5.82l11.023-.056c-.003-.029-.016-.054-.016-.084a.75.75 0 0 1 1.5 0zm-4.22 7.835c3.25-1.49 2.777-5.492 2.54-6.75L8.05 6.82c-.298.027-.5-.22-.503-.495-.02-2.048-1.265-2.868-1.992-3.172L3.688 17.316h9.155l-.295-1.553a.499.499 0 0 1 .32-.562c.012-.006 1.37-.508 3.938-1.686zm-6.863-4.96a.75.75 0 1 1 0 1.5.75.75 0 0 1 0-1.5zm5.783 10.62c0-.68-.554-1.235-1.234-1.235-.68 0-1.235.554-1.235 1.234 0 .681.554 1.235 1.235 1.235.68 0 1.234-.554 1.234-1.235z"},category_8:{size:24,path:"M11.885 17.002a.5.5 0 0 1-.5-.5V10.65h-1.156a.499.499 0 1 1 0-1h3.312a.5.5 0 1 1 0 1h-1.156v5.852a.5.5 0 0 1-.5.5zM13.119 22a.5.5 0 0 1 0 1h-2.467a.5.5 0 0 1 0-1zm1.751-3.874a.5.5 0 0 1 0 1H8.966a.5.5 0 1 1 0-1zm0 1.937a.5.5 0 0 1 0 1H8.966a.5.5 0 1 1 0-1zM11.885 2c4.349 0 7.886 3.537 7.886 7.885a7.873 7.873 0 0 1-4.816 7.265.501.501 0 0 1-.655-.266.5.5 0 0 1 .267-.655 6.878 6.878 0 0 0 4.204-6.344C18.771 6.089 15.682 3 11.885 3A6.893 6.893 0 0 0 5 9.885a6.879 6.879 0 0 0 4.203 6.344.5.5 0 0 1-.388.921A7.872 7.872 0 0 1 4 9.885C4 5.537 7.537 2 11.885 2z"},category_9:{size:24,path:"M18.5 20.691c-1.752 0-3.194-1.298-3.447-2.98h3.977a.499.499 0 0 0 .462-.692l-1.363-3.293c.123-.013.244-.037.371-.037 1.93 0 3.5 1.571 3.5 3.502 0 1.93-1.57 3.5-3.5 3.5zm-1.355-6.729l1.137 2.75h-3.233a3.503 3.503 0 0 1 2.096-2.75zm-1.322-3.19l.94 2.268a4.495 4.495 0 0 0-2.714 3.671h-2.57zM6.5 20.691c-1.93 0-3.5-1.57-3.5-3.5A3.5 3.5 0 0 1 6.393 13.7l-.907 3.381a.501.501 0 0 0 .967.26l.943-3.52A3.497 3.497 0 0 1 10 17.19c0 1.93-1.57 3.5-3.5 3.5zm1.857-10.458h6.621l-4.176 5.708a4.492 4.492 0 0 0-3.148-3.084zM18.5 12.69c-.264 0-.518.034-.769.078l-1.217-2.94 1.142-1.563h1.222a.5.5 0 1 0 0-1h-2.943a.5.5 0 1 0 0 1h.483l-.709.97H8.625l.844-3.147c.626-2.337 1.918-2.112 2.068-2.078a.5.5 0 0 0 .253-.967c-.021-.004-2.381-.595-3.288 2.785l-.993 3.707c-.005.011-.006.024-.01.037l-.84 3.134c-.055-.002-.104-.016-.159-.016-2.481 0-4.5 2.02-4.5 4.502 0 2.481 2.019 4.5 4.5 4.5 2.304 0 4.187-1.746 4.447-3.98h3.106c.26 2.234 2.143 3.98 4.447 3.98 2.481 0 4.5-2.019 4.5-4.5a4.507 4.507 0 0 0-4.5-4.502z"},category_10:{size:24,path:"M6.86 7.83a.5.5 0 0 1-.5-.5V2.5a.5.5 0 0 1 1 0v4.83a.5.5 0 0 1-.5.5zm2.359 0a.5.5 0 0 1-.5-.5V2.5a.5.5 0 0 1 1 0v4.83a.5.5 0 0 1-.5.5zM11.578 2a.5.5 0 0 1 .5.5v6.521c0 1.219-.87 2.24-2.021 2.472v8.489c0 1.113-.906 2.018-2.018 2.018s-2.018-.905-2.018-2.018v-8.489A2.526 2.526 0 0 1 4 9.021V2.5a.5.5 0 0 1 1 0v6.521c0 .839.682 1.522 1.521 1.522a.5.5 0 0 1 .5.5v8.939a1.018 1.018 0 0 0 2.036 0v-8.939a.5.5 0 0 1 .5-.5c.838 0 1.521-.683 1.521-1.522V2.5a.5.5 0 0 1 .5-.5zM20.5 2a.5.5 0 0 1 .5.5v17.482A2.02 2.02 0 0 1 18.982 22a2.02 2.02 0 0 1-2.015-2.018v-4.575h-2.043a.5.5 0 0 1-.5-.5V7.808c0-.057.069-5.808 6.076-5.808zM20 19.982V3.015c-4.522.296-4.576 4.604-4.576 4.793v6.6h2.043a.5.5 0 0 1 .5.5v5.074a1.018 1.018 0 1 0 2.033 0z"},category_11:{size:24,path:"M21.944 18.866a2.08 2.08 0 0 1-2.078 2.078h-.858V14.02h.858a2.08 2.08 0 0 1 2.078 2.077zM12.496 5.112a6.51 6.51 0 0 0-6.504 6.503v1.349h-.858c-.031 0-.06.007-.09.008v-1.465c0-4.109 3.343-7.452 7.452-7.452s7.451 3.343 7.451 7.452v1.464c-.027 0-.053-.007-.081-.007H19v-1.349a6.51 6.51 0 0 0-6.504-6.503zM5.992 20.944h-.858a2.08 2.08 0 0 1-2.078-2.078v-2.769a2.08 2.08 0 0 1 2.078-2.077h.858v1.404zm15.011-7.759v-1.678C21.003 6.816 17.187 3 12.496 3s-8.508 3.816-8.508 8.507v1.681A3.132 3.132 0 0 0 2 16.097v2.769A3.137 3.137 0 0 0 5.134 22H6.52a.529.529 0 0 0 .528-.529v-9.856a5.453 5.453 0 0 1 5.448-5.447 5.453 5.453 0 0 1 5.448 5.447l.008 9.856c0 .292.237.529.528.529h1.386A3.137 3.137 0 0 0 23 18.866v-2.769a3.132 3.132 0 0 0-1.997-2.912z"},category_12:{size:24,path:"M16.669 11.636c2.499.432 5.331.923 5.331 6.864 0 .827-.674 1.5-1.501 1.5H4.498A1.5 1.5 0 0 1 3 18.5v-14a.5.5 0 0 1 .5-.5h8.029c.278 0 .5.224.5.5v2.305c0 .006-.002.01-.003.015 0 .006.003.011.003.016-.008.122-.152 3.013 2.403 4.217.657.31 1.424.443 2.237.583zM20.499 19a.502.502 0 0 0 .501-.5c0-.284-.009-.548-.022-.803-.006 0-.012.004-.019.004H4v.799a.5.5 0 0 0 .498.5zM4 6.305h7.029V5H4zm9.752 5.504c-.811-.439-1.395-1.007-1.793-1.614l-.994.993a.5.5 0 1 1-.707-.707l1.22-1.221a6.427 6.427 0 0 1-.443-1.955H4v9.396h16.89c-.456-3.392-2.299-3.718-4.392-4.079-.586-.101-1.185-.21-1.758-.388L13.476 13.5a.498.498 0 0 1-.707 0 .499.499 0 0 1 0-.707z"},category_13:{size:24,path:"M22.994 10.671c0 4.78-1.35 7.045-4.351 7.266V22h1.285a.5.5 0 0 1 0 1h-3.569a.5.5 0 1 1 0-1h1.285v-4.069c-.622-.047-1.175-.178-1.658-.404a7.753 7.753 0 0 1-3.149 3.152v1.792a.53.53 0 0 1-.53.529H6.628a.53.53 0 0 1-.53-.529v-1.792C3.598 19.346 2 16.709 2 13.869a.53.53 0 0 1 .529-.529h10.949a17.419 17.419 0 0 1-.185-2.669c0-2.405.406-5.966.942-8.284A.501.501 0 0 1 14.723 2h6.84c.233 0 .436.16.489.387.537 2.318.942 5.879.942 8.284zm-6.587 2.669c.293 0 .529.237.529.529 0 .964-.197 1.9-.538 2.774.549.256 1.153.316 1.745.316 1.864 0 3.852-.486 3.852-6.288 0-2.171-.359-5.446-.831-7.671h-6.04c-.473 2.225-.832 5.5-.832 7.671 0 1.064.071 1.936.194 2.669zm-4.328 6.536a6.698 6.698 0 0 0 3.777-5.477H3.08a6.701 6.701 0 0 0 3.776 5.477.53.53 0 0 1 .301.478v1.588h4.621v-1.588a.53.53 0 0 1 .301-.478z"},category_14:{size:24,path:"M7.5 3.921c1.968.25 3.5 1.914 3.5 3.949V21.5a.5.5 0 0 1-.5.5h-7a.5.5 0 0 1-.5-.5V7.87c0-2.035 1.532-3.699 3.5-3.949V2h-.203a.5.5 0 1 1 0-1h3.001a.5.5 0 0 1 0 1H7.5zm14.497 3.436l-1.234 11.065c0 .008.005.014.005.021v2.059c0 .826-.673 1.5-1.5 1.5h-3.664c-.827 0-1.5-.674-1.5-1.5v-2.059c0-.005.004-.013.004-.019L12.787 7.361a.497.497 0 0 1 .496-.56H21.5c.143 0 .278.06.373.168.095.105.14.246.124.388zm-2.73 13.645c.276 0 .5-.225.5-.5v-1.633h-4.663v1.633c0 .275.225.5.5.5zm1.675-13.201h-7.096l.2 1.676h6.709zm-5.894 10.068h4.77l.825-7.392h-6.478zM10 21V7.87c0-1.654-1.346-3-3-3s-3 1.346-3 3V21z"},category_15:{size:24,path:"M18.946 21.311l2.033-1.174-6.262-10.21-1.415.817-.068.039zM11.058 8.517c.533.31 1.15.764 1.653 1.413l1.324-.764.206-.12c-.255-.656-.378-1.466-.417-2.126zm-2.25-1.174a.507.507 0 0 1 .38-.05.504.504 0 0 1 .304.234l.173.3a.299.299 0 0 0 .402.107l3.78-2.183a2.11 2.11 0 0 1 .546-1.065c.804-.871 2.312-1.281 4.49-1.219-1.18-.642-2.512-.967-3.982-.967-3.6 0-6.787 1.946-6.82 1.965a.299.299 0 0 0-.12.41l.4.692a.5.5 0 0 1-.184.683L6.36 7.299a.501.501 0 0 1-.683-.183l-.4-.692a.297.297 0 0 0-.402-.108l-1.323.765a.289.289 0 0 0-.137.178.288.288 0 0 0 .03.224l1.877 3.252a.303.303 0 0 0 .402.108l1.324-.764a.294.294 0 0 0 .107-.402l-.347-.602a.497.497 0 0 1 .183-.683zM22.1 20.051a.504.504 0 0 1-.176.695L19 22.433a.49.49 0 0 1-.386.049.5.5 0 0 1-.303-.243L12.127 10.84c-.867-1.382-2.514-1.904-2.531-1.909-.004-.001-.007-.004-.011-.006a1.306 1.306 0 0 1-.702-.47l-.958.553.098.169a1.296 1.296 0 0 1-.474 1.768l-1.324.764c-.196.113-.42.174-.646.174a1.3 1.3 0 0 1-1.122-.647L2.579 7.983c-.173-.299-.218-.649-.13-.983s.305-.613.604-.786l1.323-.764c.597-.343 1.425-.121 1.769.474l.149.259.95-.549-.15-.259a1.296 1.296 0 0 1 .475-1.768C7.696 3.528 11.02 1.5 14.9 1.5c2.324 0 4.349.729 6.019 2.168.159.084.267.25.267.442a.51.51 0 0 1-.51.5c-.025-.002-.048-.001-.072-.004a17.89 17.89 0 0 0-2.148-.146c-2.026 0-2.915.477-3.303.877-.337.347-.332.675-.331.688 0 .01-.006.018-.007.028 0 .016.007.032.005.049-.058.607.063 2.138.5 2.898zM5.654 13.768a.5.5 0 0 1 .5.5v2.175a.5.5 0 0 1-1 0v-2.175a.5.5 0 0 1 .5-.5zm-1.905-.102a.5.5 0 0 1 .158.69L2.75 16.199a.496.496 0 0 1-.688.157.5.5 0 0 1-.158-.689l1.156-1.842a.501.501 0 0 1 .689-.158zm4.498.159l1.156 1.843a.5.5 0 0 1-.846.53L7.4 14.357a.5.5 0 1 1 .847-.531z"},shop_manager_home:{size:22,path:"M10.764 1.435a.67.67 0 01.631-.049l.099.054 2.657 1.747V2.171c0-.266.195-.487.45-.529l.086-.007h3.359c.266 0 .487.195.528.45l.007.086v3.931l1.788 1.178a.67.67 0 01.295.464l.007.096v12.026a.805.805 0 01-.705.798l-.1.006H2.135a.804.804 0 01-.8-.703l-.006-.101V7.84a.67.67 0 01.231-.507l.078-.058 9.125-5.84zm.355 1.364L2.67 8.206v11.123h4.794v-6.322a.67.67 0 01.572-.663l.099-.007h5.73a.67.67 0 01.663.571l.007.1v6.32l4.794.001V8.201l-8.21-5.402zm2.075 10.878H8.805v5.651h4.389v-5.651zm.61-4.216a.603.603 0 01.097 1.198l-.098.007H8.028a.603.603 0 01-.098-1.198l.098-.008h5.775zm3.705-6.754h-2.286v1.186l2.286 1.504v-2.69z"},question_circle:{size:26,path:"M12.8 1c6.51 0 11.807 5.295 11.807 11.804 0 6.51-5.296 11.804-11.807 11.804-6.507 0-11.8-5.295-11.8-11.804S6.293 1 12.8 1zm0 1.31c-5.786 0-10.492 4.707-10.492 10.494 0 5.788 4.706 10.495 10.492 10.495 5.789 0 10.497-4.707 10.497-10.495 0-5.787-4.708-10.495-10.497-10.495zm0 15.93c.525 0 .95.422.95.943a.945.945 0 01-.95.944.944.944 0 010-1.888zm.002-12.27a4.339 4.339 0 014.334 4.332c0 1.576-.836 3-2.195 3.772l-.198.105-.098.046c-.738.333-1.125.701-1.18 1.121l-.007.107v.5a.656.656 0 01-1.304.097l-.007-.097v-.5l.009-.198c.06-.647.439-1.471 1.738-2.122l.264-.124a3.026 3.026 0 00-1.356-5.73 3.026 3.026 0 00-3.022 3.023.654.654 0 11-1.31 0 4.338 4.338 0 014.332-4.332z"},trend_up:{size:10,path:"M7.225 5.428L4.714 2.05a.126.126 0 00-.201.001L2.025 5.429a.123.123 0 00-.011.13.123.123 0 00.11.069h1.34v3.154c0 .069.056.125.125.125h2.05a.126.126 0 00.125-.125V5.628h1.36c.048 0 .09-.026.113-.069a.127.127 0 00-.012-.131"},trend_down:{size:10,path:"M7.236 5.348a.122.122 0 00-.111-.069h-1.34V2.125A.125.125 0 005.662 2H3.61a.126.126 0 00-.125.125v3.154H2.125a.125.125 0 00-.112.069.127.127 0 00.012.131l2.51 3.378a.125.125 0 00.201-.001l2.489-3.378a.123.123 0 00.01-.13"},trend_flat:{size:10,path:"M7.842 4H2.158A.16.16 0 002 4.158v1.579a.16.16 0 00.158.158h5.684A.16.16 0 008 5.737v-1.58A.16.16 0 007.842 4"}};var getIcon=function(name){var config=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var withText=config.withText,className=config.className;var image=icons[name];if(!name||!image){return null}var path=image.path,_image$size=image.size,size=_image$size===undefined?14:_image$size;var classList=[];if(className){classList.push(className)}if(withText){classList.push("icon--with-text")}return'<svg\n                    width="'+size+'"\n                    height="'+size+'"\n                    viewBox="0 0 '+size+" "+size+'"\n                    class="'+classList.join(" ")+'"\n                    xmlns="http://www.w3.org/2000/svg"\n                >\n                    <path d="'+path+'" />\n                </svg>'};return{icons:icons,getIcon:getIcon}});define("app/globals/footerLocale",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var settings=require("settings");var request=require("net/request");var alertModal=require("ui/notification/alertModal");var isMobile=settings.get("mobile");var settingLocale=settings.get("locale");var knowMoreLink={zh_TW:"https://pinkoi.zendesk.com/hc/zh-tw/articles/360012912154",zh_CN:""};var renderInput=function(o,type,checked,isNotShowCode){o.type=type;o.value=o[type];o.valueToShow=!!isNotShowCode?"":"("+o[type]+")";o.checked=checked?"checked":"";return _.template('<input id="g-footer-<%= type %>-<%= value %>" '+'name="<%= type %>" '+'type="radio" '+'value="<%= value %>" '+"<%= checked %>>"+'<label for="g-footer-<%= type %>-<%= value %>"> '+"<%= name %> "+"<%= valueToShow %> "+"</label>",o)};var renderForm=function(o,optSpecificLocale){var locale=optSpecificLocale||o.locale.language;var res=o.result[0];var settingCurrency=settings.get("currency");var currencies=_.union(res.primary_currencies,res.secondary_currencies);var nowCurrency=_.filter(currencies,function(list){return list.currency===settingCurrency})[0];var markup="";markup+='<div class="g-footer-locale">'+"<form>"+'<div class="col col-lan">'+"<span>"+i18n.gettext("語言/Language")+"</span>"+"<ul>";if(res.lang){for(var i in res.lang){if(res.lang[i].name){markup+="<li>"+renderInput(res.lang[i],"lang",locale===res.lang[i].lang,true)+"</li>"}}}markup+="</ul>"+"</div>"+'<div class="col col-cur">'+"<span>"+i18n.gettext("貨幣/Currency")+"</span>"+"<ul>";markup+='<li class="active-currency">'+nowCurrency.name+" ("+nowCurrency.currency+") "+nowCurrency.symbol+"</li>";markup+='<li class="note">'+i18n.gettext("系統會依據你的所在地自動設定使用貨幣");if(settingLocale==="zh_TW"||settingLocale==="zh_CN"){markup+='<a href="'+knowMoreLink[settingLocale]+'" target="_blank" ref="nofollow">'+i18n.gettext("了解詳情")+"</a>"}markup+="</li></ul></div>";markup+='<div class="button-wrapper"><a class="m-br-button m-br-button--lg m-br-button--primary s-fullwidth" data-click="submit">'+i18n.gettext("確定")+"</a></div></form>";markup+="</div>";return markup};var bindingEvents=function(modal){if(!modal){throw new Error("the modal parameter is required for bindingEvents method")}modal.on("click",'[data-click="submit"]',function(e){e.preventDefault();var $form=modal.$body.find("form");var dataForRequest={locale:$form.find('[name="lang"]:checked').val()};request({type:"POST",url:"/apiv2/i18n/set_locale",data:dataForRequest}).done(function(resp){if(resp.error){return alertModal.error(resp.error.message)}if(resp.result[0]&&resp.result[0].link){if(isMobile){location.href=resp.result[0].root+"?redirect="+encodeURIComponent(resp.result[0].link);return}location.href=resp.result[0].link}modal.hide()}).fail(function(){alertModal.error();modal.hide()})});if(!isMobile){return false}};var show=function(modal,optSpecificLocale){if(!modal){throw new Error("the modal parameter is required for footerLocale.show method")}request({url:"/apiv2/i18n/get_available_locale"}).done(function(resp){if(resp.error){alertModal.error();return false}modal.show(renderForm(resp,optSpecificLocale),{className:"g-footer-locale-modal",verticalCenter:true,horizontalCenter:true,backdrop:true,isOverflowHidden:false});bindingEvents(modal)})};exports.show=show});define("app/globals/menu",function(require,exports){"use strict";var urlparse=require("net/urlparse");var path=urlparse.current()["paths"][0];var $el=$("#g-menu");var closetimer=null;var isTab=function(ele){return $(ele).hasClass("tab")};var isClicked=function(ele){return $(ele).hasClass("clicked")};var isLeaf=function(ele){return $(ele).hasClass("leaf")};var hide=function(){var clicked=$el.find("li > a.clicked"),submenu=clicked.nextAll("div"),h=submenu.height()+20;submenu.children().animate({top:-h+"px"},{queue:false,duration:100},"swing");submenu.slideUp(200);clicked.removeClass("clicked");var parentli=clicked.closest("li");parentli.removeClass("clicked");if(parentli.next()&&!parentli.next().hasClass("active")){parentli.removeClass("adjacent_active")}if(!parentli.hasClass("active")){parentli.prev().removeClass("adjacent_active")}};exports.init=function(){$el.find(".nav").append('<b class="heart"></b>');$el.find(".sub li a").wrap("<span></span>");$el.on("mouseover focus",function(e){if(closetimer){clearTimeout(closetimer);closetimer=null}if(isTab(e.target)&&!isClicked(e.target)){hide()}if(isTab(e.target)){var tab=e.target;var tabJQ=$(tab);if(isLeaf(tab)){hide()}else{hide();tabJQ.addClass("clicked");var parentli=tabJQ.closest("li");parentli.addClass("clicked adjacent_active").prev().addClass("adjacent_active");var submenu=$(tab).nextAll("div.sub");submenu.slideDown(100);submenu.children().animate({top:0},{queue:false,duration:100},"swing")}}}).on("mouseout blur",function(e){closetimer=setTimeout(function(){hide()},100)}).on("click",function(e){if(closetimer){clearTimeout(closetimer);closetimer=null}if(isTab(e.target)){var tab=e.target;var tabJQ=$(tab);if(isClicked(tab)||isLeaf(tab)){var parentli=tabJQ.closest("li");hide();parentli.addClass("adjacent_active").prev().addClass("adjacent_active")}else{var submenu=$(tab).nextAll("div");hide();tabJQ.addClass("clicked");tabJQ.closest("li").addClass("clicked");submenu.slideDown(100);submenu.children().animate({top:"0"},{queue:false,duration:100},"swing")}}});var $active;if(path&&$.inArray(path,["window","wall","magz","user","my","panel","friends"])<0){path="browse"}path=path?path:"home";$active=$el.find("li."+path).addClass("active");if($active){$active.prev().addClass("adjacent_active")}}});define("app/globals/point",function(require,exports){"use strict";var _=require("underscore");var settings=require("settings");var i18n=require("i18n");var local=require("storage/local");var transitionend=require("css/transitionend");var requestAnimation=require("ui/requestAnimation");var format=require("utils/format");var alertModal=require("ui/notification/alertModal");var render=function(point,plus,optArgs){plus=plus||0;var $el=$("#g-point");var markup='<span class="note">'+i18n.gettext("目前紅利<b><%= point %></b>點")+(optArgs.withIntroLink?' ( <a href="/page/reward" target="_blank">?</a> )':"")+"</span>";var $bar=$('<div class="point-bar"></div>');var $innerbar=$('<div class="point-bar-status"></div>');var $plus=$('<div class="point-bar-plus"></div>');var plusProgress=0;var progress=0;$innerbar.appendTo($bar);$el.append(_.template(markup,{point:format.localized(point)}));$el.append($bar);$el.width();$el.on("click",function(e){if(!$(e.target).is("a")){location.href="/my/reward"}});progress=Math.sqrt(point)>97?"95":Math.sqrt(point);if(plus){$plus.appendTo($bar);plusProgress=plus/point*progress;progress=progress-plusProgress;plusProgress=Math.floor(plusProgress);plusProgress=plusProgress<3?3:plusProgress;plusProgress=plusProgress>100?100:plusProgress}progress=Math.floor(progress);$el.parent().addClass("s-point-initialized");requestAnimation(function(){if(parseInt(plus,10)>0){transitionend($innerbar,function(){$bar.addClass("s-plus");$plus.css("width",plusProgress+"%");if(!progress){$bar.addClass("s-zero")}$bar.append('<span class="plus" style="left:'+(progress+plusProgress-7)+'%">+'+plus+"</span>")})}$innerbar.css("width",progress+"%")})};var createReward=function(options){return _.extend({now:parseInt(_.now()/1e3,10),updated:null,points:0,plus:0},options)};var getPoints=function(withPoints){var deferredPoints=$.Deferred();var localReward=local.get("g.reward");var emptyReward=createReward();if(withPoints){deferredPoints.resolve(createReward({points:withPoints}))}if(_.isEmpty(localReward)){$.ajax({type:"GET",url:"/api/user/point"}).done(function(resp){var reward=_.isEmpty(resp.result)?emptyReward:resp.result;deferredPoints.resolve(reward)}).fail(function(xhr,status,throwError){alertModal.show(i18n.gettext("伺服器出了一點小差錯，工程師正在處理中，請稍候 10–30 分鐘再試試看"),{title:i18n.gettext("向伺服器請求失敗")});deferredPoints.resolve(emptyReward)})}else{deferredPoints.resolve(localReward)}return deferredPoints.promise()};exports.init=function(options){options=$.extend({withIntroLink:true,withPlus:true,withThousandsSep:false,withPoints:0},options);if(!settings.get("uid")){return}getPoints(options.withPoints).done(function(reward){var lastUpdate=reward.updated;var isOverTime=_.now()/1e3-lastUpdate>30;var isOutdated=!!(!lastUpdate||isOverTime);var plusPoint=options.withPlus&&!isOutdated?reward.plus:0;local.set("g.reward",reward,"1M");render(reward.points,plusPoint,options)})};exports.clearCache=function(){local.del("g.reward")}});define("app/globals/voiceInput",function(require,exports){"use strict";var _=require("underscore");var settings=require("settings");var i18n=require("i18n");var tooltip=require("ui/tooltip");var render=function($el,$btn){if(!("webkitSpeechRecognition"in window)){$btn.remove();return}var recognition;var isFinal=false;tooltip.show(i18n.gettext("請允許麥克風權限"),$btn,{isWithDismiss:false,isIgnoreElWidth:true});var tooltipSetTimout=setTimeout(function(){if(tooltip.on){tooltip.close()}},5e3);var lang={zh_TW:"cmn-Hant-TW",zh_CN:"cmn-Hans-CN",ja:"ja-JP",en:"en-US",th:"th-TH"};recognition=new webkitSpeechRecognition;recognition.continuous=true;recognition.interimResults=true;recognition.lang=lang[settings.get("locale")]?lang[settings.get("locale")]:"en-US";if((settings.get("geo")==="HK"||settings.get("currency")==="HKD")&&settings.get("locale")==="zh_TW"){recognition.lang="yue-Hant-HK"}recognition.start();$btn.on("click",function(e){recognition.start()});recognition.onstart=function(){isFinal=false;$btn.addClass("s-recording");tooltip.close();clearTimeout(tooltipSetTimout)};recognition.onresult=function(e){var res=e.results,value="";for(var i=0;i<res.length;i++){for(var j=0;j<res[i].length;j++){value+=res[i][j].transcript}if(res[i].isFinal){isFinal=true;$el.attr("value",value);$btn.removeClass("s-recording");dataLayer.push({event:"ga",eventCategory:"Voice input",eventAction:"Search",eventLabel:value+" ("+recognition.lang+")",nonInteraction:true});_.delay(function(){$el.closest("form").submit()},500)}}if(value&&!isFinal){$el.attr("value",value)}}};var init=function(){if(!("webkitSpeechRecognition"in window)){return}$(".g-voiceinput-form").append('<span class="g-voiceinput"></span>');tooltip.close();$(".g-voiceinput").on("click",function(e){dataLayer.push({event:"ga",eventCategory:"Voice input",eventAction:"Start Search",eventLabel:"Click start",nonInteraction:true});render($('.g-voiceinput-form input[type="search"]'),$(e.currentTarget))})};exports.init=init});define("app/globals/eventNotice",function(require,exports){"use strict";var cookie=require("net/cookie");var local=require("storage/local");var toaster=require("ui/toaster");exports.init=function(){var kkbox=cookie.get("kkboxtw_issued"),kkboxtwNoticed=local.get("kkboxtw_noticed");if(kkbox&&!kkboxtwNoticed){if(kkbox==="1"){toaster.show("<p>50 元購物金已經加到你的帳戶，購物金可於 Pinkoi 全站使用，不限消費金額皆可折抵。</p>",{hide:false,className:"g-kkbox-toaster"})}else if(kkbox==="2"){toaster.show('<p>每個帳號僅限領取一次噢，快來逛逛能讓你越聽越 high 的個性化 3C 配件吧！</p><a class="m-button" href="http://www.pinkoi.com/browse/?category=11&subcategory=1107">好音樂不落漆→</a>',{hide:false,className:"g-kkbox-toaster"})}cookie.del("kkboxtw_issued");local.set("kkboxtw_noticed",1,"1d")}var kkboxhk=cookie.get("kkboxhk_issued"),kkboxhkNoticed=local.get("kkboxhk_noticed");if(kkboxhk&&!kkboxhkNoticed){if(kkboxhk==="1"){toaster.show("<p>台幣 50 元現金獎賞已經存入你的帳戶，現金獎賞適用於 Pinkoi 所有商品，不限消費金額皆可使用。</p>",{
hide:false,className:"g-kkbox-toaster"})}else if(kkboxhk==="2"){toaster.show('<p>每個帳號僅限領取一次噢，快來搜購能讓你越聽越high的音樂配件吧！</p><a class="m-button" href="http://www.pinkoi.com/browse/?category=11&subcategory=1107">好音樂好設計→</a>',{hide:false,className:"g-kkbox-toaster"})}cookie.del("kkboxhk_issued");local.set("kkboxhk_noticed",1,"1d")}var cityzine=cookie.get("cityzine_issued"),cityzineNoticed1=local.get("cityzine_noticed1"),cityzineNoticed2=local.get("cityzine_noticed2");if(cityzine&&!cityzineNoticed1){if(cityzine==="1"){toaster.show("<p>20 元人民币的购物金已经加到你的 Pinkoi 账户。请查收站内信了解详情。</p>",{hide:false,className:"g-cityzine-toaster"})}else if(cityzine==="2"&&cityzineNoticed2){toaster.show("<p>你已经领取过 20 元专属购物金啦！快点开始逛设计小旅行吧。</p>",{hide:false,className:"g-cityzine-toaster"})}cookie.del("cityzine_issued");local.set("cityzine_noticed1",1,"1d")}var hkonly=cookie.get("hkonly_issued"),hkonlyNoticed1=local.get("hkonly_noticed1"),hkonlyNoticed2=local.get("hkonly_noticed2"),hkonlyNoticed3=local.get("hkonly_noticed3");if(hkonly){if(hkonly==="1"&&!hkonlyNoticed1){toaster.show("<p>港幣50元購物金已經加到你的 Pinkoi 帳戶，請查收站內信以了解詳情>！</p>",{hide:false,className:"g-cityzine-toaster"});local.set("hkonly_noticed1",1,"1d")}else if(hkonly==="2"&&!hkonlyNoticed2){toaster.show('<p>你已經領取了港幣50元購物金，也把優惠分享給朋友！<a class="m-button-fb" href="https://www.facebook.com/sharer/sharer.php?u=http://pinkoi.com/event/hk_member" target="_blank">分享至 Facebook</a></p>',{hide:false,className:"g-cityzine-toaster"});local.set("hkonly_noticed2",1,"1d")}else if(hkonly==="3"&&!hkonlyNoticed3){toaster.show("<p>已經是會員的無法領取是次購物金！</p>",{hide:false,className:"g-cityzine-toaster"});local.set("hkonly_noticed3",1,"1d")}cookie.del("hkonly_issued")}}});define("app/globals/autocomplete",function(require,exports){"use strict";var _=require("underscore");var i18n=require("i18n");var local=require("storage/local");var request=require("app/modules/request");var url=require("app/modules/url");var settings=require("settings");var list,total=0,current=0,$result;var isClickOnResult=false;var _require5=require("app/globals/icons"),getIcon=_require5.getIcon;var userQueryLog="";var AUTO_TYPE_NAME={shop:i18n.gettext("設計館"),subcategory:i18n.gettext("商品分類"),keyword:i18n.gettext("關鍵字")};var getTagHtmlByType=function(suggItem,type,index,tragetValue,suggsRef){var itemHtml=null;if(!suggItem||!type){return null}var ref_params_d=suggItem.ref_params_d;var dataMatch={pos:index,displayName:suggItem.text,suggsRef:suggsRef,itemRef:ref_params_d,match:suggItem};var heightLightReplace=function(str){var highlightRegex=new RegExp(tragetValue,"gi");return str.replace(highlightRegex,"<em>"+tragetValue+"</em>")};switch(type){case"shop":{var _suggItem$shop=suggItem.shop,review_info=_suggItem$shop.review_info,logo_rev=_suggItem$shop.logo_rev,shop_name=_suggItem$shop.shop_name,shop_country_name=_suggItem$shop.shop_country_name,sid=_suggItem$shop.sid;var rating=review_info.rating,ratingCount=review_info.total;var shopPhotoSrc=url.getLogo(sid,"150x150",logo_rev?{rev:logo_rev}:{});dataMatch.displayName=shop_name;itemHtml='\n                <li class="m-search-sugg-item m-search-sugg-item--'+type+" m-search-sugg-item--"+(index+1)+"\" data-match='"+JSON.stringify(dataMatch)+'\'>\n                        <p class="m-clearfix">\n                            <span class="shop-photo"><span class="shop-photo-inner" style="background-image: url('+shopPhotoSrc+')"></span></span>\n                            <span class="shop-info">\n                                <span class="shop-name-wrap">\n                                    <span class="shop-name">'+heightLightReplace(shop_name)+'</span>\n                                    <span class="shop-local">\n                                        '+shop_country_name+'\n                                    </span>\n                                </span>\n                                <span class="shop-ratings">\n                                    <span class="g-rating-home g-rating-home-'+rating+'"></span>\n                                    <span class="shop-review-count">'+ratingCount+"</span>\n                                </span>\n                            </span>\n                        </p>\n                    </li>\n                ";break}case"keyword":case"history":{dataMatch.displayName=suggItem.text;itemHtml='\n                    <li class="m-search-sugg-item m-search-sugg-item--'+type+" m-search-sugg-item--"+(index+1)+"\" data-match='"+JSON.stringify(dataMatch)+"'>\n                        "+heightLightReplace(suggItem.text)+"\n                    </li>\n                ";break}case"subcategory":{dataMatch.displayName=suggItem.category_name+" / "+suggItem.subcategory_name;itemHtml='\n                    <li class="m-search-sugg-item m-search-sugg-item--'+type+" m-search-sugg-item--"+(index+1)+"\" data-match='"+JSON.stringify(dataMatch)+'\'>\n                        <span class="text">'+suggItem.category_name+'</span>\n                        <i class="g-icon-wrap icon">\n                            '+getIcon("sleek-arrow-right")+'\n                        </i>\n                        <span class="text">'+heightLightReplace(suggItem.subcategory_name)+"</span>\n                    </li>\n                ";break}default:break}return itemHtml};var match=function(t){request({method:"GET",url:"/apiv2/search/suggestion?q="+encodeURIComponent(t)+"&suggest_subcat=1&suggest_shop=1"}).done(function(resp){var suggestions=resp.result[0].suggestions;var suggsRef;if(resp.mine_tags){suggsRef=resp.mine_tags.ref_suggestion_keywords}var matchedList=t?suggestions:_.map(list,function(h,idx){return{text:h,type:"history"}});if(matchedList.length){if(matchedList.length>50){matchedList.slice(0,50)}total=matchedList.length;var suggGroup=_.groupBy(matchedList,function(suggItem){return suggItem.type});var elSuggsItemList=[];var order=0;_.each(suggGroup,function(group,type){if(type!=="history"){elSuggsItemList.push('<li class="m-search-sugg-title">'+AUTO_TYPE_NAME[type]+"</li>")}_.each(group,function(suggItem,index){var itemHtml=getTagHtmlByType(suggItem,type,order,t,suggsRef);order++;elSuggsItemList.push(itemHtml)})});$result.empty();if(elSuggsItemList.length){$result.append(elSuggsItemList.join(""))}}else{total=0}})};exports.init=function($el,dictionary){var $form;var $wrap=$el.parent();var resultTemplate='<ul class="g-autocomplete"></ul>';var $hiddenRef=$('<input type="hidden" value="" name="ref"/>');$wrap.addClass("g-autocomplete-wrap").append(resultTemplate);$result=$wrap.find(".g-autocomplete");$form=$result.closest("form");$form.append($hiddenRef);$form.on("submit",function(e){e.preventDefault();var query=$el.val().trim();var match=$el.data("match");var url;if(!query){$el.removeData("match");return}var refTemplate="i-<%= ref %>_e-<%= sugType %>_p-<%= position %>_v-<%= version %>";if(match&&match.match.type!=="history"){if(match.match.type==="shop"){url="/store/"+match.match.sid+"?"+$.param(_.extend({ref:_.template(refTemplate,{ref:match.suggsRef,sugType:"ss",position:match.pos,version:1})},match.itemRef))}else if(match.match.type==="subcategory"){url="/browse?"+$.param(_.extend({category:match.match.category,subcategory:match.match.subcategory,ref:_.template(refTemplate,{ref:match.suggsRef,sugType:"subcategory",position:match.pos,version:1})},match.itemRef))}else if(match.match.text.toLowerCase()===query.toLowerCase()){url="/search?"+$.param({q:query,ref:_.template(refTemplate,_.extend({ref:match.suggsRef,sugType:"a",position:match.pos,version:1},match.itemRef))})}else{url="/search?"+$.param({q:query})}}else{url="/search?"+$.param({q:query})}if(match&&_.has(AUTO_TYPE_NAME,match.match.type)&&userQueryLog){var label=null;if(match.match.type=="shop"){label=match.match.sid}else if(match.match.type=="keyword"){label=match.match.text}else if(match.match.type=="subcategory"){label=match.match.subcategory}dataLayer.push({event:"ga",eventCategory:"Search Box",eventAction:"click "+match.match.type,eventLabel:userQueryLog+"/"+label,eventValue:match.pos})}setTimeout(function(){window.location.href=url})});$result.css({width:$el.outerWidth()-2+"px",top:$el.outerHeight()+"px"}).on("click",".m-search-sugg-item",function(e){isClickOnResult=true;e.preventDefault();var item=$(e.currentTarget);var text=item.text();var itemMatch=item.data("match");if(text){$el.val(itemMatch.displayName);$el.data("match",itemMatch);$result.css("opacity",0);$form.submit()}});list=local.get("n.search.history");if(_.isEmpty(list)){list=[]}else{}list=list.reverse();var select=function(direction){current=direction==="down"?current<total?current+1:total:current<1?0:current-1;$result.find(".m-search-sugg-item").removeClass("on");var target=$result.find(".m-search-sugg-item--"+current);var itemMatch=target.data("match");target.addClass("on");if(target.text()){$el.val(itemMatch.displayName);$el.data("match",itemMatch)}};var isIMEOpened=false;var delayMatch=function(e){setTimeout(function(){if(isIMEOpened){return}current=0;$result=$wrap.find(".g-autocomplete");match(e.target.value);if(!e.target.value){total=0;userQueryLog=""}},10)};$el.on({compositionstart:function(e){isIMEOpened=true},compositionend:function(e){isIMEOpened=false},input:function(e){delayMatch(e);if(settings.get("mobile")){userQueryLog=$(e.target).val()}},keyup:function(e){if(isIMEOpened){return}if(e.keyCode===40||e.keyCode===38){e.preventDefault();select(e.keyCode===40?"down":"up")}else if(!settings.get("mobile")){userQueryLog=$(e.target).val()}},focus:function(e){delayMatch(e)},blur:function(e){var $blurResult=$el.parent().find(".g-autocomplete");var $input=$(e.target);_.delay(function(){if(!isClickOnResult){$blurResult.html("");$input.val(userQueryLog||null)}else{isClickOnResult=false}},500)}})}});define("app/globals/growthHack",function(require,exports){"use strict";var _=require("underscore");var cookie=require("net/cookie");var local=require("storage/local");var urlparse=require("net/urlparse");var modal=require("ui/modal");var user=require("app/modules/user");var login=require("mapp/pages/login");function getPageViewFromStorage(){return local.get("appglobalsgrowthHack.4th_page")}function setPageViewToStorage(pageview){local.set("appglobalsgrowthHack.4th_page",pageview,"1d")}function setCampaign(){var currentCampaign=cookie.get("campaign");if(!currentCampaign){cookie.set("campaign","4th_page","5M")}else if(currentCampaign.indexOf("4th_page_")<0){cookie.set("campaign","4th_page_"+currentCampaign,"1800S")}}exports.pageOnloadHook=function(){var MAX_PAGE_VIEW=4;var STOP_FLAG=-1;var member=user.isLogin();var pageview=getPageViewFromStorage();var whiteListPages=["","product","store","magz","window","wall"];var inWhiteList=_.indexOf(whiteListPages,urlparse.current().paths[0])!==-1;if(member||!inWhiteList){return}if(pageview){if(pageview===STOP_FLAG){return}else if(pageview>=MAX_PAGE_VIEW){setPageViewToStorage(STOP_FLAG);setCampaign();setTimeout(function(){login.loginModal(modal)},1500)}else{setPageViewToStorage(pageview+1)}}else{setPageViewToStorage(1)}}});define("app/globals/meter",function(require,exports){"use strict";var _=require("underscore");var local=require("storage/local");var settings=require("settings");var getKey=function(key){var prefixes=["g.meter",key];var uid=settings.get("uid");if(uid){prefixes.push(uid)}return prefixes.join(".")};var isValidCheckpoints=function(currentConfig){return currentConfig.checkpoints&&_.isArray(currentConfig.checkpoints)&&currentConfig.checkpoints.length};var isCheckpoint=function(count,currentConfig){if(isValidCheckpoints(currentConfig)&&currentConfig.checkpoints.indexOf(count)>-1){return true}if(currentConfig.remainder&&count%currentConfig.iteration===currentConfig.remainder){return true}if(!currentConfig.remainder&&count&&count>=currentConfig.iteration&&count%currentConfig.iteration===0){return true}return false};var terminate=function(key){if(!key){throw Error("you must provide a key to terminate a meter")}var currentConfig=local.get(getKey(key));currentConfig.count=-1;local.set(getKey(key),currentConfig,"1y");return};var count=function(key){if(!key){throw Error("you must provide a key to store a meter")}var deferred=$.Deferred();var currentConfig=local.get(getKey(key));var count;if(currentConfig===null){deferred.reject();return deferred}count=currentConfig.count;if(count===-1){deferred.reject();return deferred}deferred[isCheckpoint(count,currentConfig)?"resolve":"reject"](count);currentConfig.count=count+1;local.set(getKey(key),currentConfig,"1y");return deferred};var set=function(key,args){var currentConfig=local.get(getKey(key));var config={};if(currentConfig!=null){return}if(!args.iteration){throw Error("You must set iteration for checkpoints")}config=args;config.count=0;local.set(getKey(key),config,"1y");return};exports.set=set;exports.count=count;exports.terminate=terminate});define("app/globals/input",function(require,exports){var React=require("React");var _=require("underscore");var optionMarkup=function(option,index){return React.createElement("option",{value:option.value,key:index},option.name)};var Input=React.createClass({displayName:"Input",render:function(){var props=this.props;Object.keys(props.el).map(function(key){_.extend({},props.el[key],{value:props.values[props.el[key].name],onChange:props.onChange})});switch(props.type){case"inputText":return React.createElement("div",{className:"g-input-text"},React.createElement("input",_extends({type:"text"},props.el.input)));case"inputPassword":return React.createElement("div",{className:"g-input-text"},React.createElement("input",_extends({type:"password"},props.el.input)));case"inputNumber":return React.createElement("div",{className:"g-input-text g-input-number"},React.createElement("input",_extends({type:"number"},props.el.input)));case"textarea":return React.createElement("div",{className:"g-input-textarea"},React.createElement("textarea",props.el.input));case"inputTextDropdown":var _props$el$select=props.el.select,name=_props$el$select.name,value=_props$el$select.value,onChange=_props$el$select.onChange;return React.createElement("div",{className:"g-input-text g-input-text-dropdown"},React.createElement("select",{name:name,value:value,onChange:onChange},props.el.select.options.map(optionMarkup)),React.createElement("input",_extends({type:"text"},props.el.input)))}}});exports.Input=Input});define("app/globals/form",function(require,exports){var React=require("React");var Input=require("app/globals/input").Input;var Form=React.createClass({displayName:"Form",handleChange:function(evt){var _this6=this;var state={};state[evt.target.name]=evt.target.value;this.setState(state);setTimeout(function(){return console.log(_this6.state)},1)},getInitialState:function(){var props=this.props;var state={};Object.keys(props).map(function(i){var elementObjs=props[i].el;Object.keys(elementObjs).map(function(j){state[elementObjs[j].name]=elementObjs[j].value})});return state},render:function(){var props=this.props,state=this.state,handleChange=this.handleChange;return React.createElement("div",{className:"g-form"},Object.keys(props).map(function(key,index){return React.createElement(Input,_extends({},props[key],{key:index,values:state,onChange:handleChange}))}))}});exports.Form=Form});define("app/globals/ftbDiscountModal",function(require){"use strict";var settings=require("settings");var modal=require("ui/modal");var local=require("storage/local");var i18n=require("i18n");var urlparse=require("net/urlparse");var format=require("utils/format");var MOBILE=settings.get("mobile");var FTB_REMAIN_SEC=settings.get("firstPurchaseDiscountRemainingSec");var DEFAULT_FTB_MESSAGE=i18n.gettext("72 小時內首次購物享 95 折優惠，剩餘有效時間 <%= time %>");var FTB_MESSAGE=settings.get("firstPurchaseDiscountMessage");var FTB_MESSAGE_DISSMISSED=local.get("firstPurchaseDiscountRemainingCounterDismissed")!==null;function isValidPath(){var urls=["","product","store","browse","search","magz","window","wall"];var currentPath=urlparse.current().paths[0];var validPath=urls.indexOf(currentPath)!==-1;if(MOBILE){return validPath}else{return validPath||currentPath==="cart"}}function render(){var options=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var title=i18n.gettext("註冊成功");var description=i18n.gettext("你可以開始在 Pinkoi 探索世界各地的好設計，從中找到自己最喜歡的樣貌，並成為每天生活裡的一部分。");var actionLabel=i18n.gettext("馬上逛逛");return'\n            <div class="g-ftb-modal">\n                <h2 class="ftb-modal__title">'+title+'</h2>\n                <div class="ftb-modal__discount-message">\n                    <div class="ftb-modal__wrapper">\n                        '+options.message+'\n                    </div>\n                </div>\n                <div class="ftb-modal__wrapper">\n                    <img class="ftb-modal__img" src="//cdn04.pinkoi.com/pinkoi.site/login/+login_success.png" />\n                    <div class="ftb-modal__caption">'+description+'</div>\n                    <a\n                        role="button"\n                        class="m-br-button m-br-button--lg m-br-button--primary s-fullwidth"\n                        data-click="close"\n                    >\n                        '+actionLabel+"\n                    </a>\n                </div>\n            </div>\n        "}function handleAction(e){e.preventDefault();var el=e.target;switch(el.dataset.click){case"close":modal.hide();break}}function updateTime(el,time){var hours=parseInt(time/60/60,10);var rs=time%(60*60);var minutes=parseInt(rs/60,10);var rm=rs%60;var seconds=rm;var result=[format.pad("0",2,hours),format.pad("0",2,minutes),format.pad("0",2,seconds)];el.innerText=result.join(" : ")}function init(){if(FTB_MESSAGE_DISSMISSED||!FTB_REMAIN_SEC||!isValidPath()){return}var root=document.createElement("div");var message=FTB_MESSAGE||DEFAULT_FTB_MESSAGE;var time=FTB_REMAIN_SEC;root.innerHTML=render({message:message.replace("<%= time %>",'<span id="ftb-modal__timer"></span>')});var timeEl=root.querySelector("#ftb-modal__timer");var id=void 0;var countdown=function(){if(!timeEl||!time){return}time--;if(time<0){clearInterval(id);return}updateTime(timeEl,time)};id=setInterval(countdown,1e3);root.addEventListener("click",handleAction);modal.show(root,{className:"modal__size-ftb-modal",onShow:function(){setTimeout(modal.rePosition,300)},onHideCb:function(){clearInterval(id);root.removeEventListener("click",handleAction);local.set("firstPurchaseDiscountRemainingCounterDismissed",true,"4H")}})}return{init:function(){setTimeout(init,500)}}});define("app/globals/campaignToaster",function(require,exports){"use strict";var settings=require("settings");var local=require("storage/local");var toaster=require("ui/toaster");var urlparse=require("net/urlparse");var _=require("underscore");var campaign=require("utils/campaign");var urlsAvailable=["","product","store","browse","search","magz","window","wall"];var mobile=settings.get("mobile");if(!mobile){urlsAvailable.push("cart")}var currentPath=urlparse.current().paths[0];var campaignToasterMsg=settings.get("campaignToasterMsg");var campaignModelMsg=settings.get("campaignModelMsg");var init=function(){if(campaignToasterMsg&&local.get("campaignToasterDismissed")===null){var text='<div class="campaign-toaster">'+campaignToasterMsg+"<div>";if(campaignModelMsg){text='<div class="campaign-toaster"><a>'+campaignToasterMsg+"</a><div>"}var options={withCloseBtn:true,className:"g-campaign-toaster",closeCb:function(){local.set("campaignToasterDismissed",true,"7d")},hide:false};if(!mobile&&currentPath===""){options.className=options.className+" desktop-home-page"}return toaster.show(text,options)}};exports.init=function(){if(!_.contains(urlsAvailable,currentPath)){return false}var hideFunc=init();if(campaignModelMsg){$(".m-notification-toaster-wrap .g-campaign-toaster .campaign-toaster").click(function(){require(["ui/modal","underscore"],function(modal,_){modal.show("<div class=inner>"+campaignModelMsg+"<div>",{className:"campaign-toaster-modal"})});campaign.tag("jp-fund-201712",3*24*60*60);hideFunc()})}}});define("app/globals/baseLazy",function(require,exports){var lazySizes=require("libs/lazySizes");var settings=require("settings");var supportLoading=Modernizr.chrome&&"loading"in HTMLImageElement.prototype;settings.set("browserLoading",supportLoading);exports.init=function(){if(supportLoading){var newLazyImages=document.querySelectorAll("img.m-libs-lazy");newLazyImages.forEach(function(img){img.loading="lazy";img.classList.remove("m-libs-lazy");if(img.dataset.src){img.src=img.dataset.src}if(img.dataset.srcset){img.srcset=img.dataset.srcset}})}lazySizes.cfg.lazyClass="m-libs-lazy";lazySizes.cfg.expand=600;lazySizes.cfg.throttleDelay=70;lazySizes.cfg.loadMode=3;lazySizes.init()}});define("mapp/modules/request",function(require,exports){"use strict";var _=require("underscore");var backdrop=require("ui/backdrop");var form=require("dom/form");var types=require("utils/types");var alertModal=require("ui/notification/alertModal");var defaults={type:"POST",dataType:"json"};function request(args){var promise;args=args||{};args.type=args.type||"GET";if(args.type){args.type=args.type.toUpperCase()}if(types.isJquery(args.data)){args.data=$(args.data).get(0)}if(_.isElement(args.data)){args.data=form.pack(args.data)}if(!args.contentType&&Modernizr.ajaxfileupload){args.data=form.toFormData(args.data);var defer=$.Deferred();var req=new XMLHttpRequest;req.open(args.type,args.url,true);req.addEventListener("load",function(resp){if(req.status==200){try{var parsedResponseText=JSON.parse(resp.currentTarget.responseText)}catch(e){alertModal.show("JSON.parse Error");return}if(args.success){args.success(parsedResponseText,"success",req)}defer.resolve(parsedResponseText,"success",req);return}else{if(args.error){args.error(req,req.statusText,resp.currentTarget.responseText)}else{alertModal.show("("+req.status+") "+req.statusText)}}});if(args.progress){if("onprogress"in req){if(args.type==="POST"){req.upload.addEventListener("progress",args.progress)}else if(args.type==="GET"){req.addEventListener("progress",args.progress)}}else{throw new Error("Your browser doesn't support progress event")}}if(args.timeout&&req.timeout===0){if({}.toString.apply(args.timeout)==="[object Number]"){req.timeout=args.timeout;req.addEventListener("timeout",function(resp){if(args.error){args.error(req,req.statusText,resp.currentTarget.responseText)}else{defer.reject(req,req.statusText,resp.currentTarget.responseText)}})}if({}.toString.apply(args.timeout)==="[object String]"){args.timeout=parseInt(args.timeout,10);if(!isNaN(args.timeout)){req.timeout=args.timeout}}}req.addEventListener("error",function(resp){if(args.error){args.error(req,req.statusText,resp.currentTarget.responseText)}defer.reject(req,req.statusText,resp.currentTarget.responseText)});req.send(args.data);promise=defer}else{promise=$.ajax($.extend(defaults,args))}args.backdrop&&backdrop.show();promise.always(function(){args.backdrop&&backdrop.hide()});return promise}return request});